<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-901N2Y3CDZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-901N2Y3CDZ');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demand Letter Generator | Terms.Law</title>
    <meta name="description" content="Generate professional demand letters with state-specific legal citations, deadlines, and evidence checklists. Free templates for unpaid wages, breach of contract, security deposits, and more.">
    <link rel="canonical" href="https://terms.law/Demand-Letters/generator/">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #7c3aed;
            --success: #059669;
            --warning: #f59e0b;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ========================================
           HEADER
           ======================================== */
        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 800;
            text-decoration: none;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-nav {
            display: flex;
            gap: 24px;
        }

        .header-nav a {
            color: var(--gray-300);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        .header-nav a:hover {
            color: white;
        }

        /* ========================================
           MAIN LAYOUT - Split Pane
           ======================================== */
        .main-container {
            display: grid;
            grid-template-columns: 420px 1fr;
            min-height: calc(100vh - 64px);
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        /* ========================================
           LEFT PANEL - Form Inputs
           ======================================== */
        .form-panel {
            background: white;
            border-right: 1px solid var(--gray-200);
            overflow-y: auto;
            max-height: calc(100vh - 64px);
        }

        .form-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .form-header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .form-header p {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .form-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-100);
        }

        .form-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-400);
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            font-size: 0.9rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 4px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* State/Situation Selectors - Prominent */
        .selector-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .selector-box {
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }

        .selector-box:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .selector-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gray-400);
            margin-bottom: 8px;
        }

        .selector-select {
            width: 100%;
            padding: 8px 12px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            background: transparent;
            color: var(--gray-800);
            cursor: pointer;
        }

        .selector-select:focus {
            outline: none;
        }

        /* ========================================
           RIGHT PANEL - Live Preview
           ======================================== */
        .preview-panel {
            background: var(--gray-100);
            overflow-y: auto;
            max-height: calc(100vh - 64px);
            padding: 32px;
        }

        .preview-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .preview-toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .preview-toolbar-right {
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            background: white;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar-btn:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .toolbar-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .toolbar-btn.primary:hover {
            background: var(--primary-dark);
        }

        .toolbar-btn.active {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        /* Edit Toolbar (hidden by default) */
        .edit-toolbar {
            display: none;
            gap: 6px;
            padding: 8px;
            background: var(--gray-800);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .edit-toolbar.visible {
            display: flex;
        }

        .edit-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            background: var(--gray-700);
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }

        .edit-btn:hover {
            background: var(--gray-600);
        }

        .edit-btn.save {
            background: var(--success);
        }

        .edit-btn.cancel {
            background: var(--danger);
        }

        /* Document Preview */
        .document-wrapper {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        #documentPreview {
            font-family: 'Crimson Pro', 'Times New Roman', Georgia, serif;
            font-size: 15px;
            line-height: 1.9;
            color: #1a1a1a;
            padding: 60px;
            min-height: 600px;
        }

        #documentPreview.full-edit-mode {
            outline: 3px solid var(--primary);
            background: #fefefe;
        }

        /* Document Styles */
        .doc-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .doc-date {
            text-align: right;
            margin-bottom: 30px;
            color: var(--gray-600);
        }

        .doc-address-block {
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .doc-salutation {
            margin-bottom: 20px;
        }

        .doc-section-header {
            font-size: 15px;
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 30px;
            margin-bottom: 15px;
            color: var(--gray-800);
        }

        .doc-paragraph {
            text-align: justify;
            margin-bottom: 18px;
            text-indent: 0;
        }

        .doc-list {
            margin: 15px 0 15px 30px;
        }

        .doc-list li {
            margin-bottom: 8px;
        }

        .doc-signature-block {
            margin-top: 50px;
        }

        .doc-closing {
            margin-bottom: 50px;
        }

        .doc-signature-line {
            border-top: 1px solid #333;
            width: 250px;
            margin-top: 50px;
            padding-top: 5px;
        }

        /* CRITICAL: Highlighted Fields */
        .doc-highlight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 2px 6px;
            border-radius: 4px;
            border-bottom: 2px solid #f59e0b;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: text;
        }

        .doc-highlight.empty {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-bottom-color: #ef4444;
            color: #dc2626;
        }

        .doc-highlight:hover {
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .doc-highlight:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
        }

        /* CRITICAL: Highlight Animation */
        @keyframes highlightPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }

        .field-highlight-animation {
            animation: highlightPulse 0.6s ease-out;
            background: linear-gradient(135deg, #fde047 0%, #facc15 100%) !important;
        }

        /* Legal Citation Styling */
        .legal-cite {
            font-style: italic;
            color: var(--gray-600);
        }

        .doc-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px 16px;
            margin: 20px 0;
            font-size: 0.9em;
        }

        .doc-deadline {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
            padding: 12px 16px;
            margin: 20px 0;
            font-weight: 600;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 24px;
            background: var(--gray-800);
            color: white;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        /* Loading State */
        .loading-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .loading-indicator.visible {
            display: flex;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* State Info Box */
        .state-info-box {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .state-info-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .state-info-content {
            font-size: 0.85rem;
            color: var(--gray-700);
        }

        .state-info-content ul {
            margin: 8px 0 0 16px;
            padding: 0;
        }

        .state-info-content li {
            margin-bottom: 4px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .form-panel {
                max-height: none;
                border-right: none;
                border-bottom: 1px solid var(--gray-200);
            }

            .preview-panel {
                max-height: none;
                padding: 20px;
            }

            #documentPreview {
                padding: 30px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <a href="https://terms.law" class="logo">Terms.Law</a>
        <nav class="header-nav">
            <a href="/Demand-Letters/">Demand Letters</a>
            <a href="/Templates/">Contracts</a>
            <a href="/Trading-Legal/guides/">Trading Legal</a>
        </nav>
    </header>

    <!-- Main Container - Split Pane -->
    <div class="main-container">
        <!-- LEFT: Form Panel -->
        <div class="form-panel">
            <div class="form-header">
                <h1>Demand Letter Generator</h1>
                <p>Create your letter with state-specific citations</p>
            </div>

            <!-- State + Situation Selectors -->
            <div class="form-section">
                <div class="selector-grid">
                    <div class="selector-box">
                        <div class="selector-label">State</div>
                        <select id="stateSelect" class="selector-select" onchange="loadStateModule()">
                            <option value="">Select State...</option>
                            <option value="california" selected>California</option>
                            <option value="texas">Texas</option>
                            <option value="new-york">New York</option>
                            <option value="florida">Florida</option>
                            <!-- More states will be added -->
                        </select>
                    </div>
                    <div class="selector-box">
                        <div class="selector-label">Situation</div>
                        <select id="situationSelect" class="selector-select" onchange="loadSituationModule()">
                            <option value="">Select Type...</option>
                            <option value="unpaid-wages" selected>Unpaid Wages</option>
                            <option value="breach-of-contract">Breach of Contract</option>
                            <option value="security-deposit">Security Deposit</option>
                            <option value="unpaid-invoice">Unpaid Invoice</option>
                            <!-- More situations will be added -->
                        </select>
                    </div>
                </div>

                <!-- State Info Box (populated by state module) -->
                <div id="stateInfoBox" class="state-info-box">
                    <div class="state-info-title">California Law Summary</div>
                    <div class="state-info-content" id="stateInfoContent">
                        Loading state-specific information...
                    </div>
                </div>
            </div>

            <!-- Your Information -->
            <div class="form-section">
                <div class="form-section-title">Your Information</div>

                <div class="form-group">
                    <label class="form-label" for="senderName">Your Full Name</label>
                    <input type="text" id="senderName" class="form-input" placeholder="John Smith" oninput="trackFieldEdit('senderName')">
                </div>

                <div class="form-group">
                    <label class="form-label" for="senderAddress">Your Address</label>
                    <textarea id="senderAddress" class="form-textarea" placeholder="123 Main Street&#10;Los Angeles, CA 90001" rows="3" oninput="trackFieldEdit('senderAddress')"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="senderPhone">Phone</label>
                        <input type="tel" id="senderPhone" class="form-input" placeholder="(555) 123-4567" oninput="trackFieldEdit('senderPhone')">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="senderEmail">Email</label>
                        <input type="email" id="senderEmail" class="form-input" placeholder="john@email.com" oninput="trackFieldEdit('senderEmail')">
                    </div>
                </div>
            </div>

            <!-- Recipient Information -->
            <div class="form-section">
                <div class="form-section-title">Recipient Information</div>

                <div class="form-group">
                    <label class="form-label" for="recipientName">Recipient Name / Company</label>
                    <input type="text" id="recipientName" class="form-input" placeholder="ABC Corporation" oninput="trackFieldEdit('recipientName')">
                </div>

                <div class="form-group">
                    <label class="form-label" for="recipientAddress">Recipient Address</label>
                    <textarea id="recipientAddress" class="form-textarea" placeholder="456 Business Ave&#10;San Francisco, CA 94102" rows="3" oninput="trackFieldEdit('recipientAddress')"></textarea>
                </div>
            </div>

            <!-- Claim Details (populated by situation module) -->
            <div class="form-section" id="claimDetailsSection">
                <div class="form-section-title">Claim Details</div>
                <div id="claimDetailsFields">
                    <!-- Dynamically populated by situation module -->
                </div>
            </div>

            <!-- Demand Terms -->
            <div class="form-section">
                <div class="form-section-title">Demand Terms</div>

                <div class="form-group">
                    <label class="form-label" for="demandAmount">Amount Demanded</label>
                    <input type="text" id="demandAmount" class="form-input" placeholder="$5,000.00" oninput="trackFieldEdit('demandAmount')">
                    <div class="form-hint">Include principal + interest + penalties if applicable</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="demandDeadline">Response Deadline</label>
                    <input type="text" id="demandDeadline" class="form-input" placeholder="14 days" oninput="trackFieldEdit('demandDeadline')">
                    <div class="form-hint" id="deadlineHint">Recommended: Check state requirements</div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Preview Panel -->
        <div class="preview-panel">
            <!-- Toolbar -->
            <div class="preview-toolbar">
                <div class="preview-toolbar-left">
                    <span style="font-weight: 600; color: var(--gray-700);">Live Preview</span>
                    <div class="loading-indicator" id="loadingIndicator">
                        <div class="loading-spinner"></div>
                        <span>Updating...</span>
                    </div>
                </div>
                <div class="preview-toolbar-right">
                    <button class="toolbar-btn" id="editModeBtn" onclick="toggleFullEditMode()">
                        <span>&#9998;</span> Edit Mode
                    </button>
                    <button class="toolbar-btn" onclick="copyToClipboard()">
                        <span>&#128203;</span> Copy
                    </button>
                    <button class="toolbar-btn" onclick="printDocument()">
                        <span>&#128424;</span> Print
                    </button>
                    <button class="toolbar-btn primary" onclick="downloadDOCX()">
                        <span>&#8595;</span> Download DOCX
                    </button>
                </div>
            </div>

            <!-- Edit Toolbar (shown in edit mode) -->
            <div class="edit-toolbar" id="editToolbar">
                <button class="edit-btn" onclick="document.execCommand('bold')"><b>B</b></button>
                <button class="edit-btn" onclick="document.execCommand('italic')"><i>I</i></button>
                <button class="edit-btn" onclick="document.execCommand('underline')"><u>U</u></button>
                <button class="edit-btn" onclick="addParagraph()">+ Paragraph</button>
                <div style="flex: 1;"></div>
                <button class="edit-btn save" onclick="saveFullEdits()">Save Edits</button>
                <button class="edit-btn cancel" onclick="cancelEditMode()">Cancel</button>
            </div>

            <!-- Document Preview -->
            <div class="document-wrapper">
                <div id="documentPreview">
                    <!-- Generated letter content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- STATE MODULES -->
    <script id="stateModules">
    // State Module Registry
    const StateModules = {
        'california': {
            name: 'California',
            abbreviation: 'CA',

            // Wage claim specifics
            wageClaimInfo: {
                agency: 'California Labor Commissioner (DLSE)',
                agencyUrl: 'https://www.dir.ca.gov/dlse/',
                waitingTimePenalty: 'Up to 30 days of wages (Labor Code § 203)',
                interestRate: '10% per annum (Civil Code § 3289)',
                statuteOfLimitations: '3 years for wage claims (CCP § 338)',
                smallClaimsLimit: '$12,500 (individuals), $6,250 (businesses)'
            },

            // Key statutes for different situations
            statutes: {
                'unpaid-wages': [
                    { code: 'Labor Code § 201', desc: 'Final wages due immediately upon discharge' },
                    { code: 'Labor Code § 202', desc: 'Final wages due within 72 hours if employee quits' },
                    { code: 'Labor Code § 203', desc: 'Waiting time penalties - up to 30 days wages' },
                    { code: 'Labor Code § 226', desc: 'Itemized wage statement requirements' },
                    { code: 'Labor Code § 1194', desc: 'Recovery of unpaid minimum wages + interest + attorney fees' }
                ],
                'breach-of-contract': [
                    { code: 'Civil Code § 3289', desc: 'Interest rate on contract damages (10% if not specified)' },
                    { code: 'CCP § 337', desc: '4-year statute of limitations for written contracts' },
                    { code: 'Civil Code § 1717', desc: 'Attorney fees provision - prevailing party recovery' }
                ],
                'security-deposit': [
                    { code: 'Civil Code § 1950.5', desc: 'Security deposit rules and return requirements' },
                    { code: 'Civil Code § 1950.5(l)', desc: '21-day deadline to return deposit after move-out' },
                    { code: 'Civil Code § 1950.5(l)', desc: 'Bad faith penalty: up to 2x deposit amount' }
                ],
                'unpaid-invoice': [
                    { code: 'Commercial Code § 2709', desc: 'Seller\'s right to recover price of accepted goods' },
                    { code: 'Civil Code § 3289(b)', desc: '10% interest on unpaid amounts' },
                    { code: 'Civil Code § 1717.5', desc: 'Attorney fees for small contracts under $5,000' }
                ]
            },

            // Get summary for state info box
            getSummary: function(situation) {
                const statutes = this.statutes[situation] || [];
                let html = '<ul>';
                statutes.forEach(s => {
                    html += `<li><strong>${s.code}:</strong> ${s.desc}</li>`;
                });
                html += '</ul>';
                return html;
            },

            // Get deadline recommendation
            getDeadlineRecommendation: function(situation) {
                switch(situation) {
                    case 'unpaid-wages':
                        return 'For wage claims, 10-14 days is typical. Labor Commissioner complaints can be filed anytime within 3 years.';
                    case 'security-deposit':
                        return 'Landlord has 21 days by law. A 14-day demand deadline is reasonable before filing suit.';
                    case 'breach-of-contract':
                        return '14-30 days is standard for contract disputes.';
                    default:
                        return '14-21 days is typical for most demands.';
                }
            },

            // Get legal citations for letter
            getLegalCitations: function(situation) {
                const statutes = this.statutes[situation] || [];
                return statutes.map(s => s.code).join(', ');
            },

            // Get specific penalty language
            getPenaltyLanguage: function(situation) {
                switch(situation) {
                    case 'unpaid-wages':
                        return 'Under California Labor Code Section 203, employees are entitled to waiting time penalties of up to 30 days of wages when final wages are not paid on time. Additionally, Labor Code Section 1194 provides for recovery of attorney fees and costs.';
                    case 'security-deposit':
                        return 'Under California Civil Code Section 1950.5(l), if you fail to return the security deposit within 21 days or if you withhold amounts in bad faith, you may be liable for up to twice the amount of the deposit as statutory damages, plus actual damages.';
                    default:
                        return 'Under California Civil Code Section 3289, I am entitled to interest at the rate of 10% per annum on all amounts owed from the date payment was due.';
                }
            }
        },

        'texas': {
            name: 'Texas',
            abbreviation: 'TX',
            wageClaimInfo: {
                agency: 'Texas Workforce Commission (TWC)',
                agencyUrl: 'https://www.twc.texas.gov/',
                waitingTimePenalty: 'None (Texas has limited wage protections)',
                interestRate: '6% per annum (Tex. Fin. Code § 302.002)',
                statuteOfLimitations: '2 years for wage claims',
                smallClaimsLimit: '$20,000 (Justice Court)'
            },
            statutes: {
                'unpaid-wages': [
                    { code: 'Tex. Lab. Code § 61.001', desc: 'Definition of wages' },
                    { code: 'Tex. Lab. Code § 61.014', desc: 'Wages due on regular pay schedule' },
                    { code: 'Tex. Lab. Code § 61.018', desc: 'Wage claim filing with TWC' }
                ],
                'breach-of-contract': [
                    { code: 'Tex. Fin. Code § 302.002', desc: 'Prejudgment interest at 6%' },
                    { code: 'Tex. Civ. Prac. & Rem. § 16.004', desc: '4-year statute of limitations' }
                ],
                'security-deposit': [
                    { code: 'Tex. Prop. Code § 92.103', desc: '30-day deadline to return deposit' },
                    { code: 'Tex. Prop. Code § 92.109', desc: 'Landlord liability: 3x wrongfully withheld + $100 + attorney fees' }
                ]
            },
            getSummary: function(situation) {
                const statutes = this.statutes[situation] || [];
                let html = '<ul>';
                statutes.forEach(s => {
                    html += `<li><strong>${s.code}:</strong> ${s.desc}</li>`;
                });
                html += '</ul>';
                return html;
            },
            getDeadlineRecommendation: function(situation) {
                if (situation === 'security-deposit') {
                    return 'Texas law gives landlords 30 days. A 14-day demand is reasonable.';
                }
                return '14-21 days is typical.';
            },
            getLegalCitations: function(situation) {
                const statutes = this.statutes[situation] || [];
                return statutes.map(s => s.code).join(', ');
            },
            getPenaltyLanguage: function(situation) {
                if (situation === 'security-deposit') {
                    return 'Under Texas Property Code Section 92.109, bad faith retention of a security deposit makes you liable for the sum of $100, three times the amount of the deposit wrongfully withheld, and reasonable attorney\'s fees.';
                }
                return 'Under Texas Finance Code Section 302.002, I am entitled to prejudgment interest at 6% per annum.';
            }
        },

        'new-york': {
            name: 'New York',
            abbreviation: 'NY',
            wageClaimInfo: {
                agency: 'NY Department of Labor',
                agencyUrl: 'https://dol.ny.gov/',
                waitingTimePenalty: 'Liquidated damages up to 100% of wages owed (Labor Law § 198)',
                interestRate: '9% per annum (CPLR § 5004)',
                statuteOfLimitations: '6 years for wage claims',
                smallClaimsLimit: '$10,000 (NYC), $5,000 (outside NYC)'
            },
            statutes: {
                'unpaid-wages': [
                    { code: 'Labor Law § 191', desc: 'Frequency of wage payment requirements' },
                    { code: 'Labor Law § 198', desc: 'Liquidated damages - 100% of unpaid wages' },
                    { code: 'Labor Law § 198(1-a)', desc: 'Attorney fees to prevailing employee' }
                ],
                'security-deposit': [
                    { code: 'GOL § 7-103', desc: 'Deposit must be held in trust' },
                    { code: 'GOL § 7-108', desc: '14-day return requirement after move-out' }
                ]
            },
            getSummary: function(situation) {
                const statutes = this.statutes[situation] || [];
                let html = '<ul>';
                statutes.forEach(s => {
                    html += `<li><strong>${s.code}:</strong> ${s.desc}</li>`;
                });
                html += '</ul>';
                return html;
            },
            getDeadlineRecommendation: function(situation) {
                return '10-14 days is typical for New York claims.';
            },
            getLegalCitations: function(situation) {
                const statutes = this.statutes[situation] || [];
                return statutes.map(s => s.code).join(', ');
            },
            getPenaltyLanguage: function(situation) {
                if (situation === 'unpaid-wages') {
                    return 'Under New York Labor Law Section 198, I am entitled to recover the full amount of unpaid wages plus liquidated damages equal to 100% of the wages owed, plus reasonable attorney\'s fees and costs.';
                }
                return 'Under CPLR Section 5004, I am entitled to interest at 9% per annum.';
            }
        },

        'florida': {
            name: 'Florida',
            abbreviation: 'FL',
            wageClaimInfo: {
                agency: 'No state wage enforcement agency',
                agencyUrl: 'https://www.dol.gov/agencies/whd',
                waitingTimePenalty: 'None under state law',
                interestRate: 'Variable (F.S. § 55.03)',
                statuteOfLimitations: '5 years for written contracts (F.S. § 95.11)',
                smallClaimsLimit: '$8,000'
            },
            statutes: {
                'unpaid-wages': [
                    { code: 'F.S. § 448.08', desc: 'Recovery of wages due - attorney fees available' },
                    { code: '29 U.S.C. § 216(b)', desc: 'FLSA liquidated damages (federal law)' }
                ],
                'security-deposit': [
                    { code: 'F.S. § 83.49', desc: 'Deposit return requirements' },
                    { code: 'F.S. § 83.49(3)', desc: '15-30 day return timeline depending on claim' }
                ]
            },
            getSummary: function(situation) {
                const statutes = this.statutes[situation] || [];
                let html = '<ul>';
                statutes.forEach(s => {
                    html += `<li><strong>${s.code}:</strong> ${s.desc}</li>`;
                });
                if (situation === 'unpaid-wages') {
                    html += '<li><em>Note: Florida has no state agency for wage claims. Consider federal DOL complaint or small claims court.</em></li>';
                }
                html += '</ul>';
                return html;
            },
            getDeadlineRecommendation: function(situation) {
                return '14-21 days is typical.';
            },
            getLegalCitations: function(situation) {
                const statutes = this.statutes[situation] || [];
                return statutes.map(s => s.code).join(', ');
            },
            getPenaltyLanguage: function(situation) {
                return 'Under Florida Statutes Section 448.08, I am entitled to recover unpaid wages plus attorney\'s fees and costs. If this matter proceeds to court, I will seek all available remedies.';
            }
        }
    };
    </script>

    <!-- SITUATION MODULES -->
    <script id="situationModules">
    // Situation Module Registry
    const SituationModules = {
        'unpaid-wages': {
            name: 'Unpaid Wages',
            category: 'Employment',

            // Form fields specific to this situation
            formFields: [
                { id: 'employmentStartDate', label: 'Employment Start Date', type: 'date', placeholder: '' },
                { id: 'employmentEndDate', label: 'Employment End Date', type: 'date', placeholder: '' },
                { id: 'jobTitle', label: 'Your Job Title', type: 'text', placeholder: 'e.g., Sales Manager' },
                { id: 'hourlyRate', label: 'Hourly Rate / Salary', type: 'text', placeholder: 'e.g., $25/hour or $52,000/year' },
                { id: 'unpaidPeriod', label: 'Period of Unpaid Wages', type: 'text', placeholder: 'e.g., November 1-30, 2024' },
                { id: 'hoursOwed', label: 'Hours Worked (Unpaid)', type: 'text', placeholder: 'e.g., 80 hours' },
                { id: 'wageDescription', label: 'Description of Wages Owed', type: 'textarea', placeholder: 'Describe what wages are owed (regular pay, overtime, final paycheck, commissions, etc.)' }
            ],

            // Generate the letter body
            generateLetterBody: function(data, stateModule) {
                const stateCitations = stateModule.getLegalCitations('unpaid-wages');
                const penaltyLanguage = stateModule.getPenaltyLanguage('unpaid-wages');

                return `
<p class="doc-paragraph">I am writing to formally demand payment of wages owed to me for work performed during my employment with ${h(data.recipientName, 'Company Name', 'recipientName')}.</p>

<div class="doc-section-header">Employment Background</div>
<p class="doc-paragraph">I was employed by ${h(data.recipientName, 'Company Name', 'recipientName')} as a ${h(data.jobTitle, 'Job Title', 'jobTitle')} from ${h(data.employmentStartDate, 'Start Date', 'employmentStartDate')} to ${h(data.employmentEndDate, 'End Date', 'employmentEndDate')}. My compensation was ${h(data.hourlyRate, 'Rate/Salary', 'hourlyRate')}.</p>

<div class="doc-section-header">Wages Owed</div>
<p class="doc-paragraph">Despite performing work as required, I have not received payment for the following:</p>
<ul class="doc-list">
    <li><strong>Period:</strong> ${h(data.unpaidPeriod, 'Period', 'unpaidPeriod')}</li>
    <li><strong>Hours Worked:</strong> ${h(data.hoursOwed, 'Hours', 'hoursOwed')}</li>
    <li><strong>Description:</strong> ${h(data.wageDescription, 'Description', 'wageDescription')}</li>
</ul>

<div class="doc-section-header">Legal Basis</div>
<p class="doc-paragraph">Under ${stateModule.name} law, employers are required to pay all wages earned by employees. The applicable statutes include: <span class="legal-cite">${stateCitations}</span>.</p>

<p class="doc-paragraph">${penaltyLanguage}</p>

<div class="doc-section-header">Demand</div>
<p class="doc-paragraph">I hereby demand payment of ${h(data.demandAmount, 'Amount', 'demandAmount')} representing all wages owed, plus any applicable interest and penalties.</p>

<div class="doc-deadline">
<strong>DEADLINE:</strong> Payment must be received within ${h(data.demandDeadline, '14 days', 'demandDeadline')} of the date of this letter.
</div>

<p class="doc-paragraph">If I do not receive full payment by this deadline, I will pursue all available legal remedies, which may include filing a complaint with the ${stateModule.wageClaimInfo.agency}, filing a lawsuit in small claims court (limit: ${stateModule.wageClaimInfo.smallClaimsLimit}), and/or retaining an attorney to file a civil action seeking the full amount owed plus penalties, interest, and attorney fees.</p>

<p class="doc-paragraph">Please make payment to the address listed above, or contact me to arrange an alternative payment method.</p>
                `;
            }
        },

        'breach-of-contract': {
            name: 'Breach of Contract',
            category: 'Business',

            formFields: [
                { id: 'contractDate', label: 'Contract Date', type: 'date', placeholder: '' },
                { id: 'contractType', label: 'Type of Contract', type: 'text', placeholder: 'e.g., Service Agreement, Purchase Agreement' },
                { id: 'contractDescription', label: 'Contract Summary', type: 'textarea', placeholder: 'Briefly describe the agreement and key terms' },
                { id: 'breachDescription', label: 'Description of Breach', type: 'textarea', placeholder: 'Describe how the other party breached the contract' },
                { id: 'breachDate', label: 'Date of Breach', type: 'date', placeholder: '' },
                { id: 'damagesDescription', label: 'Damages Suffered', type: 'textarea', placeholder: 'Describe your losses resulting from the breach' }
            ],

            generateLetterBody: function(data, stateModule) {
                const stateCitations = stateModule.getLegalCitations('breach-of-contract');
                const penaltyLanguage = stateModule.getPenaltyLanguage('breach-of-contract');

                return `
<p class="doc-paragraph">I am writing to formally notify you of your breach of our agreement and to demand that you cure this breach immediately.</p>

<div class="doc-section-header">The Agreement</div>
<p class="doc-paragraph">On or about ${h(data.contractDate, 'Contract Date', 'contractDate')}, you and I entered into a ${h(data.contractType, 'Type of Contract', 'contractType')}.</p>

<p class="doc-paragraph">${h(data.contractDescription, 'Contract Summary', 'contractDescription')}</p>

<div class="doc-section-header">Your Breach</div>
<p class="doc-paragraph">On or about ${h(data.breachDate, 'Breach Date', 'breachDate')}, you breached this agreement by:</p>

<p class="doc-paragraph">${h(data.breachDescription, 'Description of Breach', 'breachDescription')}</p>

<div class="doc-section-header">Damages</div>
<p class="doc-paragraph">As a direct result of your breach, I have suffered the following damages:</p>

<p class="doc-paragraph">${h(data.damagesDescription, 'Damages Description', 'damagesDescription')}</p>

<div class="doc-section-header">Legal Basis</div>
<p class="doc-paragraph">Under ${stateModule.name} law (<span class="legal-cite">${stateCitations}</span>), I am entitled to recover damages for your breach of contract. ${penaltyLanguage}</p>

<div class="doc-section-header">Demand</div>
<p class="doc-paragraph">I hereby demand payment of ${h(data.demandAmount, 'Amount', 'demandAmount')} to compensate me for the damages caused by your breach.</p>

<div class="doc-deadline">
<strong>DEADLINE:</strong> Payment must be received within ${h(data.demandDeadline, '14 days', 'demandDeadline')} of the date of this letter.
</div>

<p class="doc-paragraph">If I do not receive payment by this deadline, I will have no choice but to pursue legal action to recover the full amount owed, plus interest, attorney fees, and court costs as permitted by law and/or our agreement.</p>
                `;
            }
        },

        'security-deposit': {
            name: 'Security Deposit',
            category: 'Landlord-Tenant',

            formFields: [
                { id: 'propertyAddress', label: 'Rental Property Address', type: 'textarea', placeholder: '123 Rental Street, Apt 4B&#10;Los Angeles, CA 90001' },
                { id: 'leaseStartDate', label: 'Lease Start Date', type: 'date', placeholder: '' },
                { id: 'leaseEndDate', label: 'Lease End Date / Move-Out Date', type: 'date', placeholder: '' },
                { id: 'depositAmount', label: 'Security Deposit Paid', type: 'text', placeholder: 'e.g., $2,500' },
                { id: 'depositDate', label: 'Date Deposit Paid', type: 'date', placeholder: '' },
                { id: 'moveOutCondition', label: 'Condition at Move-Out', type: 'textarea', placeholder: 'Describe the condition of the property when you left' },
                { id: 'landlordDeductions', label: 'Improper Deductions (if any)', type: 'textarea', placeholder: 'List any deductions the landlord took that you dispute' }
            ],

            generateLetterBody: function(data, stateModule) {
                const stateCitations = stateModule.getLegalCitations('security-deposit');
                const penaltyLanguage = stateModule.getPenaltyLanguage('security-deposit');

                return `
<p class="doc-paragraph">I am writing to demand the return of my security deposit from the property located at:</p>

<p class="doc-paragraph" style="margin-left: 40px;">${h(data.propertyAddress, 'Property Address', 'propertyAddress')}</p>

<div class="doc-section-header">Tenancy Details</div>
<p class="doc-paragraph">I resided at the above property from ${h(data.leaseStartDate, 'Start Date', 'leaseStartDate')} until ${h(data.leaseEndDate, 'Move-Out Date', 'leaseEndDate')}. On ${h(data.depositDate, 'Deposit Date', 'depositDate')}, I paid a security deposit of ${h(data.depositAmount, 'Deposit Amount', 'depositAmount')}.</p>

<div class="doc-section-header">Condition at Move-Out</div>
<p class="doc-paragraph">${h(data.moveOutCondition, 'Move-Out Condition', 'moveOutCondition')}</p>

<p class="doc-paragraph">I left the property in good condition, normal wear and tear excepted, and am entitled to a full refund of my security deposit.</p>

${data.landlordDeductions ? `
<div class="doc-section-header">Disputed Deductions</div>
<p class="doc-paragraph">I dispute the following deductions you have attempted to take from my deposit:</p>
<p class="doc-paragraph">${h(data.landlordDeductions, 'Disputed Deductions', 'landlordDeductions')}</p>
` : ''}

<div class="doc-section-header">Legal Requirements</div>
<p class="doc-paragraph">Under ${stateModule.name} law (<span class="legal-cite">${stateCitations}</span>), you are required to return my security deposit within the statutory timeframe after I vacated the premises.</p>

<p class="doc-paragraph">${penaltyLanguage}</p>

<div class="doc-section-header">Demand</div>
<p class="doc-paragraph">I hereby demand the return of ${h(data.demandAmount, 'Amount', 'demandAmount')} representing my security deposit (or the portion wrongfully withheld).</p>

<div class="doc-deadline">
<strong>DEADLINE:</strong> Payment must be received within ${h(data.demandDeadline, '14 days', 'demandDeadline')} of the date of this letter.
</div>

<p class="doc-paragraph">If I do not receive my deposit by this deadline, I will file a lawsuit in small claims court seeking the full amount owed plus statutory penalties and court costs.</p>
                `;
            }
        },

        'unpaid-invoice': {
            name: 'Unpaid Invoice',
            category: 'Business',

            formFields: [
                { id: 'invoiceNumber', label: 'Invoice Number(s)', type: 'text', placeholder: 'e.g., INV-2024-001' },
                { id: 'invoiceDate', label: 'Invoice Date', type: 'date', placeholder: '' },
                { id: 'invoiceDueDate', label: 'Original Due Date', type: 'date', placeholder: '' },
                { id: 'servicesProvided', label: 'Services/Goods Provided', type: 'textarea', placeholder: 'Describe the services or goods you provided' },
                { id: 'originalAmount', label: 'Original Invoice Amount', type: 'text', placeholder: 'e.g., $3,500' },
                { id: 'paymentHistory', label: 'Payment History', type: 'textarea', placeholder: 'Note any partial payments received or payment attempts' }
            ],

            generateLetterBody: function(data, stateModule) {
                const stateCitations = stateModule.getLegalCitations('unpaid-invoice');
                const penaltyLanguage = stateModule.getPenaltyLanguage('unpaid-invoice');

                return `
<p class="doc-paragraph">I am writing regarding your outstanding balance for services/goods provided. Despite multiple requests, payment has not been received and the account is now seriously past due.</p>

<div class="doc-section-header">Invoice Details</div>
<ul class="doc-list">
    <li><strong>Invoice Number:</strong> ${h(data.invoiceNumber, 'Invoice #', 'invoiceNumber')}</li>
    <li><strong>Invoice Date:</strong> ${h(data.invoiceDate, 'Invoice Date', 'invoiceDate')}</li>
    <li><strong>Original Due Date:</strong> ${h(data.invoiceDueDate, 'Due Date', 'invoiceDueDate')}</li>
    <li><strong>Original Amount:</strong> ${h(data.originalAmount, 'Amount', 'originalAmount')}</li>
</ul>

<div class="doc-section-header">Services/Goods Provided</div>
<p class="doc-paragraph">${h(data.servicesProvided, 'Services Description', 'servicesProvided')}</p>

${data.paymentHistory ? `
<div class="doc-section-header">Payment History</div>
<p class="doc-paragraph">${h(data.paymentHistory, 'Payment History', 'paymentHistory')}</p>
` : ''}

<div class="doc-section-header">Amount Due</div>
<p class="doc-paragraph">The services/goods were delivered as agreed. You accepted delivery and are obligated to pay the agreed price. Under ${stateModule.name} law (<span class="legal-cite">${stateCitations}</span>), I am entitled to collect the full amount plus interest.</p>

<p class="doc-paragraph">${penaltyLanguage}</p>

<div class="doc-section-header">Demand</div>
<p class="doc-paragraph">I hereby demand immediate payment of ${h(data.demandAmount, 'Amount', 'demandAmount')} representing the principal balance plus accrued interest.</p>

<div class="doc-deadline">
<strong>DEADLINE:</strong> Payment must be received within ${h(data.demandDeadline, '14 days', 'demandDeadline')} of the date of this letter.
</div>

<p class="doc-paragraph">If payment is not received by this deadline, I will pursue all available remedies including filing a lawsuit, reporting the debt to credit agencies, and seeking collection through legal channels. You will be responsible for all collection costs, court costs, and attorney fees as permitted by law.</p>
                `;
            }
        }
    };
    </script>

    <!-- MAIN ENGINE SCRIPT -->
    <script>
    // ========================================
    // STATE VARIABLES (per CONTRACT-GENERATOR-STANDARDS)
    // ========================================
    let lastEditedField = null;
    let isFullEditMode = false;
    let savedDocumentHTML = '';
    let hasCustomEdits = false;
    let currentState = null;
    let currentSituation = null;

    // Field ID to input element mapping
    const fieldInputMap = {};

    // ========================================
    // HELPER FUNCTION - Highlighted spans
    // ========================================
    function h(value, placeholder, fieldId) {
        const isEmpty = !value || value.trim() === '' || value.startsWith('[');
        const displayValue = isEmpty ? `[${placeholder}]` : value;
        const emptyClass = isEmpty ? ' empty' : '';

        // Register in field map for inline editing
        fieldInputMap[fieldId] = fieldId;

        return `<span class="doc-highlight${emptyClass}" data-field="${fieldId}" contenteditable="true">${displayValue}</span>`;
    }

    // ========================================
    // TRACK FIELD EDIT (Critical for scroll-to-view)
    // ========================================
    function trackFieldEdit(fieldId) {
        // CRITICAL: Check if user has custom edits before regenerating
        if (hasCustomEdits) {
            const proceed = confirm(
                'You have custom edits in the document preview.\n\n' +
                'Changing form inputs will regenerate the document and your custom edits will be lost.\n\n' +
                'Click OK to regenerate, or Cancel to keep your edits.'
            );
            if (!proceed) {
                return; // Don't update preview, keep their edits
            }
            hasCustomEdits = false;
        }

        lastEditedField = fieldId;
        updatePreview();
    }

    // ========================================
    // LOAD STATE MODULE
    // ========================================
    function loadStateModule() {
        const stateId = document.getElementById('stateSelect').value;
        if (!stateId) return;

        currentState = StateModules[stateId];
        if (!currentState) {
            console.error('State module not found:', stateId);
            return;
        }

        // Update state info box
        const situation = document.getElementById('situationSelect').value || 'unpaid-wages';
        document.querySelector('.state-info-title').textContent = `${currentState.name} Law Summary`;
        document.getElementById('stateInfoContent').innerHTML = currentState.getSummary(situation);

        // Update deadline hint
        document.getElementById('deadlineHint').textContent = currentState.getDeadlineRecommendation(situation);

        updatePreview();
    }

    // ========================================
    // LOAD SITUATION MODULE
    // ========================================
    function loadSituationModule() {
        const situationId = document.getElementById('situationSelect').value;
        if (!situationId) return;

        currentSituation = SituationModules[situationId];
        if (!currentSituation) {
            console.error('Situation module not found:', situationId);
            return;
        }

        // Build form fields
        const container = document.getElementById('claimDetailsFields');
        container.innerHTML = '';

        currentSituation.formFields.forEach(field => {
            const div = document.createElement('div');
            div.className = 'form-group';

            let inputHTML = '';
            if (field.type === 'textarea') {
                inputHTML = `<textarea id="${field.id}" class="form-textarea" placeholder="${field.placeholder}" oninput="trackFieldEdit('${field.id}')"></textarea>`;
            } else {
                inputHTML = `<input type="${field.type}" id="${field.id}" class="form-input" placeholder="${field.placeholder}" oninput="trackFieldEdit('${field.id}')">`;
            }

            div.innerHTML = `
                <label class="form-label" for="${field.id}">${field.label}</label>
                ${inputHTML}
            `;
            container.appendChild(div);
        });

        // Update state info for new situation
        if (currentState) {
            document.getElementById('stateInfoContent').innerHTML = currentState.getSummary(situationId);
            document.getElementById('deadlineHint').textContent = currentState.getDeadlineRecommendation(situationId);
        }

        updatePreview();
    }

    // ========================================
    // UPDATE PREVIEW
    // ========================================
    function updatePreview() {
        if (!currentState || !currentSituation) {
            document.getElementById('documentPreview').innerHTML = `
                <div style="text-align: center; padding: 60px; color: var(--gray-400);">
                    <div style="font-size: 3rem; margin-bottom: 20px;">&#128196;</div>
                    <p>Select a state and situation type to generate your letter.</p>
                </div>
            `;
            return;
        }

        // Show loading indicator briefly
        document.getElementById('loadingIndicator').classList.add('visible');

        // Collect all form data
        const data = {
            senderName: document.getElementById('senderName')?.value || '',
            senderAddress: document.getElementById('senderAddress')?.value || '',
            senderPhone: document.getElementById('senderPhone')?.value || '',
            senderEmail: document.getElementById('senderEmail')?.value || '',
            recipientName: document.getElementById('recipientName')?.value || '',
            recipientAddress: document.getElementById('recipientAddress')?.value || '',
            demandAmount: document.getElementById('demandAmount')?.value || '',
            demandDeadline: document.getElementById('demandDeadline')?.value || '14 days'
        };

        // Add situation-specific fields
        currentSituation.formFields.forEach(field => {
            const el = document.getElementById(field.id);
            data[field.id] = el ? el.value : '';
        });

        // Format today's date
        const today = new Date();
        const dateFormatted = today.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Generate the letter
        const letterBody = currentSituation.generateLetterBody(data, currentState);

        const previewHTML = `
            <div class="doc-date">${dateFormatted}</div>

            <div class="doc-address-block">
                <strong>${h(data.recipientName, 'Recipient Name', 'recipientName')}</strong><br>
                ${h(data.recipientAddress, 'Recipient Address', 'recipientAddress').replace(/\n/g, '<br>')}
            </div>

            <div class="doc-salutation">
                <strong>Re: ${currentSituation.name} - Formal Demand for Payment</strong>
            </div>

            <p class="doc-paragraph">Dear ${h(data.recipientName, 'Recipient', 'recipientName')}:</p>

            ${letterBody}

            <div class="doc-signature-block">
                <div class="doc-closing">Sincerely,</div>
                <div class="doc-signature-line">
                    ${h(data.senderName, 'Your Name', 'senderName')}<br>
                    ${data.senderAddress ? data.senderAddress.replace(/\n/g, '<br>') : ''}<br>
                    ${data.senderPhone ? `Phone: ${data.senderPhone}<br>` : ''}
                    ${data.senderEmail ? `Email: ${data.senderEmail}` : ''}
                </div>
            </div>

            <div class="doc-warning" style="margin-top: 40px;">
                <strong>NOTICE:</strong> This letter constitutes a formal legal demand. A copy of this letter and proof of delivery will be retained for use as evidence in any subsequent legal proceedings.
            </div>
        `;

        document.getElementById('documentPreview').innerHTML = previewHTML;

        // Setup inline editing
        setupInlineEditing();

        // Hide loading indicator
        setTimeout(() => {
            document.getElementById('loadingIndicator').classList.remove('visible');
        }, 100);

        // CRITICAL: Scroll to and highlight the edited field
        if (lastEditedField) {
            setTimeout(() => {
                const highlight = document.querySelector(`[data-field="${lastEditedField}"]`);
                if (highlight) {
                    // Scroll into view
                    highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Add highlight animation
                    highlight.classList.add('field-highlight-animation');
                    setTimeout(() => {
                        highlight.classList.remove('field-highlight-animation');
                    }, 1500);
                }
            }, 50);
        }
    }

    // ========================================
    // INLINE EDITING
    // ========================================
    function setupInlineEditing() {
        document.querySelectorAll('.doc-highlight[contenteditable="true"]').forEach(el => {
            el.addEventListener('blur', function() {
                handleInlineEdit(this);
            });

            el.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.blur();
                }
            });
        });
    }

    function handleInlineEdit(element) {
        const fieldId = element.dataset.field;
        const newValue = element.textContent.trim();

        // Check if it's a placeholder
        if (newValue.startsWith('[') && newValue.endsWith(']')) {
            return; // Don't sync placeholder text
        }

        const input = document.getElementById(fieldId);
        if (input) {
            input.value = newValue;
            // Update styling
            element.classList.remove('empty');
        }
    }

    // ========================================
    // FULL EDIT MODE
    // ========================================
    function toggleFullEditMode() {
        const docBody = document.getElementById('documentPreview');
        const toggleBtn = document.getElementById('editModeBtn');
        const editToolbar = document.getElementById('editToolbar');

        if (!isFullEditMode) {
            // ENTERING edit mode
            isFullEditMode = true;
            savedDocumentHTML = docBody.innerHTML;
            docBody.contentEditable = 'true';
            docBody.classList.add('full-edit-mode');
            toggleBtn.innerHTML = '<span>&#128190;</span> Save Edits';
            toggleBtn.classList.add('active');
            editToolbar.classList.add('visible');
            showToast('Edit mode enabled. Click anywhere to edit.', 'success');
        } else {
            // Save edits
            saveFullEdits();
        }
    }

    function saveFullEdits() {
        const docBody = document.getElementById('documentPreview');
        const toggleBtn = document.getElementById('editModeBtn');
        const editToolbar = document.getElementById('editToolbar');

        isFullEditMode = false;
        hasCustomEdits = true; // CRITICAL: Mark that user has custom edits
        docBody.contentEditable = 'false';
        docBody.classList.remove('full-edit-mode');
        toggleBtn.innerHTML = '<span>&#9998;</span> Edit Mode';
        toggleBtn.classList.remove('active');
        editToolbar.classList.remove('visible');

        showToast('Edits saved! Your custom changes have been preserved.', 'success');
    }

    function cancelEditMode() {
        const docBody = document.getElementById('documentPreview');
        const toggleBtn = document.getElementById('editModeBtn');
        const editToolbar = document.getElementById('editToolbar');

        if (savedDocumentHTML) {
            docBody.innerHTML = savedDocumentHTML;
        }

        isFullEditMode = false;
        hasCustomEdits = false;
        docBody.contentEditable = 'false';
        docBody.classList.remove('full-edit-mode');
        toggleBtn.innerHTML = '<span>&#9998;</span> Edit Mode';
        toggleBtn.classList.remove('active');
        editToolbar.classList.remove('visible');

        setupInlineEditing();
        showToast('Changes discarded');
    }

    function addParagraph() {
        document.execCommand('insertParagraph');
    }

    // ========================================
    // EXPORT FUNCTIONS
    // ========================================
    function copyToClipboard() {
        const preview = document.getElementById('documentPreview');
        const text = preview.innerText;

        navigator.clipboard.writeText(text).then(() => {
            showToast('Letter copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Copy failed:', err);
            showToast('Copy failed. Please select and copy manually.', 'error');
        });
    }

    function printDocument() {
        const preview = document.getElementById('documentPreview');
        const printWindow = window.open('', '_blank');

        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Demand Letter</title>
                <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet">
                <style>
                    body {
                        font-family: 'Crimson Pro', 'Times New Roman', Georgia, serif;
                        font-size: 12pt;
                        line-height: 1.8;
                        color: #000;
                        max-width: 8.5in;
                        margin: 1in auto;
                        padding: 0;
                    }
                    .doc-highlight {
                        background: none !important;
                        border: none !important;
                        padding: 0 !important;
                        font-weight: inherit !important;
                    }
                    .doc-highlight.empty {
                        color: #999;
                    }
                    .doc-title { text-align: center; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; }
                    .doc-date { text-align: right; margin-bottom: 30px; }
                    .doc-section-header { font-weight: bold; text-transform: uppercase; margin-top: 24px; margin-bottom: 12px; }
                    .doc-paragraph { text-align: justify; margin-bottom: 12pt; }
                    .doc-list { margin: 12pt 0 12pt 24pt; }
                    .doc-list li { margin-bottom: 6pt; }
                    .doc-deadline { border: 1px solid #000; padding: 10px; margin: 20px 0; font-weight: bold; }
                    .doc-warning { border-top: 1px solid #000; padding-top: 10px; margin-top: 30px; font-size: 10pt; }
                    .doc-signature-block { margin-top: 40px; }
                    .doc-closing { margin-bottom: 50px; }
                    .doc-signature-line { border-top: 1px solid #000; width: 250px; padding-top: 5px; }
                    @media print {
                        body { margin: 0; }
                    }
                </style>
            </head>
            <body>
                ${preview.innerHTML}
            </body>
            </html>
        `);

        printWindow.document.close();
        printWindow.focus();

        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    }

    function downloadDOCX() {
        // For now, create a simple HTML download that Word can open
        const preview = document.getElementById('documentPreview');
        const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <style>
                    body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.8; }
                    .doc-highlight { background: none; border: none; padding: 0; font-weight: normal; }
                    .doc-section-header { font-weight: bold; text-transform: uppercase; margin-top: 24px; margin-bottom: 12px; }
                    .doc-paragraph { text-align: justify; margin-bottom: 12pt; }
                </style>
            </head>
            <body>
                ${preview.innerHTML}
            </body>
            </html>
        `;

        const blob = new Blob([htmlContent], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'demand-letter.doc';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('Letter downloaded! Open with Microsoft Word.', 'success');
    }

    // ========================================
    // TOAST NOTIFICATION
    // ========================================
    function showToast(message, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast ' + type;
        toast.classList.add('visible');

        setTimeout(() => {
            toast.classList.remove('visible');
        }, 3000);
    }

    // ========================================
    // INITIALIZATION
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
        // Load default modules
        loadStateModule();
        loadSituationModule();
    });
    </script>
</body>
</html>
