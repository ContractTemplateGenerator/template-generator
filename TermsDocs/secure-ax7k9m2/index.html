<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
  <meta name="googlebot" content="noindex, nofollow">
  <title>Story Cannabis MSA - Redline Review | Sergei Tokmakov, Esq.</title>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a2e44;
      --primary-light: #2d4a6f;
      --accent: #8b5cf6;
      --surface: #ffffff;
      --bg: #f5f5f4;
      --border: #d4d4d4;
      --text: #1c1917;
      --text-muted: #57534e;
      --success: #166534;
      --success-bg: #dcfce7;
      --warning: #a16207;
      --warning-bg: #fef3c7;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    /* Confidential Header */
    .confidential-bar {
      background: #292524;
      color: #fafaf9;
      padding: 10px 20px;
      font-size: 0.75rem;
      text-align: center;
      letter-spacing: 0.5px;
    }

    /* Security Notice */
    .security-notice {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border-bottom: 1px solid #a7f3d0;
      padding: 14px 40px;
    }

    .security-notice-inner {
      max-width: 1100px;
      margin: 0 auto;
      font-size: 0.85rem;
      color: #065f46;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .security-notice-inner strong {
      white-space: nowrap;
    }

    .shield-icon {
      font-size: 1.2rem;
    }

    /* Letterhead */
    .letterhead {
      background: var(--primary);
      color: white;
      padding: 28px 40px;
    }

    .letterhead-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    .letterhead h1 {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 1.4rem;
      font-weight: 500;
      letter-spacing: 0.3px;
      margin-bottom: 4px;
    }

    .letterhead .subtitle {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .letterhead-date {
      text-align: right;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    /* Main Container */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 40px;
    }

    /* Matter Header */
    .matter-header {
      margin-bottom: 36px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .matter-header h2 {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 1.8rem;
      font-weight: 500;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .matter-meta {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Overview Box */
    .overview-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px 28px;
      margin-bottom: 32px;
    }

    .overview-box h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .overview-box p {
      font-size: 0.95rem;
      line-height: 1.7;
      color: var(--text);
    }

    .overview-stats {
      display: flex;
      gap: 40px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e7e5e4;
    }

    .stat {
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 600;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    /* Document Cards */
    .docs-section h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .doc-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .doc-card-header {
      padding: 20px 24px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.15s;
    }

    .doc-card-header:hover {
      background: #fafaf9;
    }

    .doc-title-area {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .doc-number {
      width: 32px;
      height: 32px;
      background: var(--primary);
      color: white;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .doc-title h4 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }

    .doc-title .doc-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .doc-header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .expand-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .doc-card.expanded .expand-hint {
      display: none;
    }

    .redline-count {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 12px;
      background: var(--warning-bg);
      color: var(--warning);
    }

    .expand-icon {
      color: var(--text-muted);
      font-size: 1.2rem;
      transition: transform 0.2s;
    }

    .doc-card.expanded .expand-icon {
      transform: rotate(180deg);
    }

    .doc-card-body {
      display: none;
      padding: 0 24px 24px 24px;
      border-top: 1px solid #e7e5e4;
    }

    .doc-card.expanded .doc-card-body {
      display: block;
    }

    /* Changes List */
    .changes-section {
      padding: 20px 0;
    }

    .changes-section h5 {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .change-item {
      padding: 10px 0;
      border-bottom: 1px solid #f5f5f4;
      font-size: 0.9rem;
    }

    .change-item:last-child {
      border-bottom: none;
    }

    .change-item strong {
      color: var(--primary);
    }

    .change-item .note {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-top: 4px;
      font-style: italic;
    }

    /* Rationale */
    .rationale-section {
      background: #fafaf9;
      border-radius: 6px;
      padding: 16px 20px;
      margin: 16px 0;
    }

    .rationale-section h5 {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .rationale-section p {
      font-size: 0.9rem;
      line-height: 1.6;
    }

    /* Actions */
    .doc-actions {
      display: flex;
      gap: 10px;
      padding-top: 16px;
      border-top: 1px solid #e7e5e4;
    }

    .btn {
      padding: 10px 16px;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-light);
    }

    .btn-secondary {
      background: white;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #fafaf9;
    }

    /* Footer */
    .footer {
      margin-top: 48px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      text-align: center;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .footer a {
      color: var(--primary);
      text-decoration: none;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .toolbar-left, .toolbar-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 0.8rem;
    }

    /* Feedback elements */
    .feedback-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e7e5e4;
    }

    .feedback-section h5 {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .feedback-item {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f4;
    }

    .feedback-item:last-child {
      border-bottom: none;
    }

    .feedback-select {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.8rem;
      min-width: 120px;
      cursor: pointer;
      background: white;
    }

    .feedback-select.status-approved {
      background: #dcfce7;
      border-color: #86efac;
      color: #166534;
    }

    .feedback-select.status-declined {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #991b1b;
    }

    .feedback-select.status-discuss {
      background: #fef3c7;
      border-color: #fcd34d;
      color: #92400e;
    }

    .feedback-label {
      flex: 1;
      font-size: 0.85rem;
      color: var(--text);
    }

    .feedback-note {
      width: 100%;
      margin-top: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
    }

    .feedback-note:focus {
      outline: none;
      border-color: var(--accent);
    }

    .feedback-note::placeholder {
      color: #a8a29e;
    }

    .save-bar {
      position: sticky;
      bottom: 0;
      background: white;
      border-top: 1px solid var(--border);
      padding: 12px 40px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
    }

    .btn-save {
      background: var(--accent);
      color: white;
    }

    .btn-save:hover {
      background: #7c3aed;
    }

    /* Issue Summary Table */
    .issues-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 20px;
    }

    .issues-table th {
      text-align: left;
      padding: 10px 12px;
      background: #f5f5f4;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }

    .issues-table td {
      padding: 12px;
      border-bottom: 1px solid #e7e5e4;
      vertical-align: top;
    }

    .issues-table tr:last-child td {
      border-bottom: none;
    }

    .check {
      color: var(--success);
      font-weight: 600;
    }

    .dash {
      color: #d4d4d4;
    }

    /* Editable text boxes with copy */
    .editable-box {
      position: relative;
    }

    .editable-content {
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 2px 4px;
      margin: -2px -4px;
      transition: border-color 0.15s, background 0.15s;
    }

    .editable-content:hover {
      border-color: #e7e5e4;
      background: #fafaf9;
    }

    .editable-content:focus {
      outline: none;
      border-color: var(--accent);
      background: white;
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 5px 10px;
      font-size: 0.7rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s;
      color: var(--text-muted);
    }

    .editable-box:hover .copy-btn,
    .copy-btn:focus {
      opacity: 1;
    }

    .copy-btn:hover {
      background: #f5f5f4;
      color: var(--text);
    }

    .copy-btn.copied {
      background: var(--success-bg);
      border-color: #86efac;
      color: var(--success);
    }

    /* Playbook Section */
    .playbook-section {
      margin-bottom: 32px;
    }

    .playbook-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .playbook-header h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin: 0;
    }

    .playbook-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .playbook-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .playbook-card-header {
      padding: 14px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fafaf9;
      border-bottom: 1px solid transparent;
      transition: background 0.15s;
    }

    .playbook-card-header:hover {
      background: #f5f5f4;
    }

    .playbook-card.expanded .playbook-card-header {
      border-bottom-color: var(--border);
    }

    .playbook-card-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }

    .playbook-tags {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .playbook-tag {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-weight: 600;
    }

    .playbook-tag.sla { background: #dbeafe; color: #1e40af; }
    .playbook-tag.ipaas { background: #fae8ff; color: #86198f; }
    .playbook-tag.pm { background: #dcfce7; color: #166534; }
    .playbook-tag.dw { background: #fef3c7; color: #92400e; }

    .playbook-expand {
      font-size: 0.75rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .playbook-card.expanded .playbook-expand {
      transform: rotate(180deg);
    }

    .playbook-card-body {
      display: none;
      padding: 16px;
    }

    .playbook-card.expanded .playbook-card-body {
      display: block;
    }

    .playbook-tier {
      margin-bottom: 14px;
    }

    .playbook-tier:last-child {
      margin-bottom: 0;
    }

    .playbook-tier-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 6px;
    }

    .playbook-tier-label.must { color: #dc2626; }
    .playbook-tier-label.prefer { color: #d97706; }
    .playbook-tier-label.fallback { color: #6b7280; }

    .playbook-tier-content {
      font-size: 0.85rem;
      color: var(--text);
      line-height: 1.5;
    }

    .playbook-tier-content ul {
      margin: 0;
      padding-left: 18px;
    }

    .playbook-tier-content li {
      margin-bottom: 4px;
    }

    .playbook-script {
      margin-top: 14px;
      padding: 12px;
      background: #f5f5f4;
      border-radius: 6px;
      border-left: 3px solid var(--accent);
      position: relative;
    }

    .playbook-script-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .playbook-script-text {
      font-size: 0.85rem;
      font-style: italic;
      color: var(--text);
      line-height: 1.5;
    }

    .playbook-copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      font-size: 0.65rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 3px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .playbook-script:hover .playbook-copy-btn {
      opacity: 1;
    }

    .playbook-copy-btn:hover {
      background: #f5f5f4;
    }

    /* Password Gate */
    .password-gate {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .password-gate.hidden {
      display: none;
    }

    .password-box {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 40px 48px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    }

    .password-box h2 {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 1.4rem;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .password-box .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    .password-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
      text-align: center;
      letter-spacing: 2px;
      margin-bottom: 16px;
    }

    .password-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .password-input.error {
      border-color: #dc2626;
      background: #fef2f2;
    }

    .password-submit {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    .password-submit:hover {
      background: var(--primary-light);
    }

    .password-error {
      color: #dc2626;
      font-size: 0.8rem;
      margin-top: 12px;
      display: none;
    }

    .password-error.show {
      display: block;
    }

    .show-pwd-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 0.75rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .show-pwd-btn:hover {
      color: var(--text);
    }

    .main-content {
      display: none;
    }

    .main-content.visible {
      display: block;
    }

    /* ========== CLIENT MESSAGING FEATURES ========== */

    /* Personalized Welcome Banner */
    .welcome-banner {
      background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
      border-bottom: 1px solid #c4b5fd;
      padding: 14px 40px;
    }

    .welcome-banner-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .welcome-text {
      font-size: 0.9rem;
      color: #5b21b6;
    }

    .welcome-text strong {
      color: #7c3aed;
    }

    .welcome-actions {
      display: flex;
      gap: 10px;
    }

    .welcome-btn {
      padding: 8px 14px;
      font-size: 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }

    .welcome-btn-primary {
      background: #7c3aed;
      color: white;
    }

    .welcome-btn-primary:hover {
      background: #6d28d9;
    }

    .welcome-btn-secondary {
      background: white;
      color: #5b21b6;
      border: 1px solid #c4b5fd;
    }

    .welcome-btn-secondary:hover {
      background: #f5f3ff;
    }

    /* Floating Chat Widget */
    .chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
    }

    .chat-fab-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .chat-fab-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 28px rgba(124, 58, 237, 0.5);
    }

    .chat-fab-btn svg {
      width: 28px;
      height: 28px;
      fill: white;
    }

    .chat-fab-label {
      position: absolute;
      right: 70px;
      top: 50%;
      transform: translateY(-50%);
      background: white;
      padding: 8px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .chat-fab:hover .chat-fab-label {
      opacity: 1;
    }

    .chat-fab-pulse {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 16px;
      height: 16px;
      background: #10b981;
      border-radius: 50%;
      border: 2px solid white;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
    }

    /* Chat Panel */
    .chat-panel {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 360px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.2);
      z-index: 999;
      display: none;
      overflow: hidden;
    }

    .chat-panel.open {
      display: block;
      animation: slideUp 0.2s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-panel-header {
      background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
      color: white;
      padding: 16px 20px;
    }

    .chat-panel-header h4 {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .chat-panel-header p {
      font-size: 0.75rem;
      opacity: 0.9;
    }

    .chat-panel-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-panel-close:hover {
      background: rgba(255,255,255,0.3);
    }

    .chat-panel-body {
      padding: 20px;
    }

    .chat-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: #f5f3ff;
      border-radius: 10px;
      margin-bottom: 12px;
      cursor: pointer;
      text-decoration: none;
      color: var(--text);
      transition: all 0.15s;
      border: 1px solid transparent;
    }

    .chat-option:hover {
      background: #ede9fe;
      border-color: #c4b5fd;
    }

    .chat-option-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .chat-option-icon.telegram { background: #e0f2fe; }
    .chat-option-icon.comment { background: #dcfce7; }

    .chat-option-text h5 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .chat-option-text p {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .chat-option-badge {
      margin-left: auto;
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: 10px;
      background: #fef3c7;
      color: #92400e;
      font-weight: 600;
    }

    /* Comments Section */
    .comments-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-top: 40px;
      overflow: hidden;
    }

    .comments-header {
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      padding: 20px 24px;
      border-bottom: 1px solid #e9d5ff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .comments-header h3 {
      font-size: 1rem;
      color: #5b21b6;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .comments-header p {
      font-size: 0.8rem;
      color: #7c3aed;
    }

    .comments-body {
      padding: 24px;
    }

    .comments-intro {
      background: #faf5ff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 0.85rem;
      color: #6b21a8;
      border-left: 4px solid #c084fc;
    }

    .comments-list {
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .comment-item {
      display: flex;
      gap: 12px;
      padding: 14px 0;
      border-bottom: 1px solid #f5f5f4;
    }

    .comment-item:last-child {
      border-bottom: none;
    }

    .comment-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #c4b5fd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #5b21b6;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .comment-avatar.sergei {
      background: #1a2e44;
      color: white;
    }

    .comment-content {
      flex: 1;
    }

    .comment-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }

    .comment-author {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text);
    }

    .comment-time {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .comment-text {
      font-size: 0.9rem;
      color: var(--text);
      line-height: 1.5;
    }

    .comment-input-area {
      display: flex;
      gap: 12px;
    }

    .comment-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      resize: none;
      min-height: 80px;
    }

    .comment-input:focus {
      outline: none;
      border-color: #a78bfa;
      box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
    }

    .comment-submit {
      align-self: flex-end;
      padding: 12px 20px;
      background: #7c3aed;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    .comment-submit:hover {
      background: #6d28d9;
    }

    .comment-submit:disabled {
      background: #d4d4d4;
      cursor: not-allowed;
    }

    .no-comments {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Comment actions (edit/delete) */
    .comment-actions {
      display: none;
      gap: 8px;
      margin-left: auto;
    }

    .comment-item:hover .comment-actions {
      display: flex;
    }

    .comment-action-btn {
      padding: 4px 8px;
      font-size: 0.7rem;
      border: 1px solid var(--border);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.15s;
    }

    .comment-action-btn:hover {
      background: #f5f5f4;
      color: var(--text);
    }

    .comment-action-btn.delete:hover {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #dc2626;
    }

    /* Edit mode */
    .comment-edit-area {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .comment-edit-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #a78bfa;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.85rem;
      resize: none;
      min-height: 60px;
    }

    .comment-edit-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
    }

    .comment-edit-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .comment-edit-save {
      padding: 6px 12px;
      background: #7c3aed;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .comment-edit-save:hover {
      background: #6d28d9;
    }

    .comment-edit-cancel {
      padding: 6px 12px;
      background: white;
      color: var(--text-muted);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .comment-edit-cancel:hover {
      background: #f5f5f4;
    }
  </style>
</head>
<body>

<!-- Password Gate -->
<div class="password-gate" id="passwordGate">
  <div class="password-box">
    <h2>Secure Client Workroom</h2>
    <div class="subtitle">Enter the access code provided by counsel</div>
    <div style="position:relative;">
      <input type="password" class="password-input" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" autofocus>
      <button type="button" class="show-pwd-btn" id="showPwdBtn" onclick="togglePasswordVisibility()">Show</button>
    </div>
    <button class="password-submit" onclick="checkPassword()">Access Workroom</button>
    <div class="password-error" id="passwordError">Incorrect access code. Please try again.</div>
  </div>
</div>

<div class="main-content" id="mainContent">

<div class="confidential-bar">
  üîí PRIVILEGED & CONFIDENTIAL ‚Äî ATTORNEY WORK PRODUCT
</div>

<div class="security-notice">
  <div class="security-notice-inner">
    <span class="shield-icon">üõ°Ô∏è</span>
    <div><strong>Secure Client Workroom</strong> ‚Äî This page is not indexed by search engines and cannot be found through browsing. Only those with the direct link and password can access it. Documents and communications here are protected by attorney-client privilege.</div>
  </div>
</div>

<header class="letterhead">
  <div class="letterhead-inner">
    <div>
      <h1>Sergei Tokmakov, Esq.</h1>
      <a href="https://apps.calbar.ca.gov/attorney/Licensee/Detail/279869" target="_blank" style="font-size:0.75rem;opacity:0.7;margin-top:2px;color:white;text-decoration:none;">California Bar #279869</a>
    </div>
    <div class="letterhead-date">
      Updated: December 16, 2025<br>
      <span style="opacity:0.7">NR-7f9x2k</span>
    </div>
  </div>
</header>

<div class="container">

  <div class="matter-header">
    <h2>Story Cannabis MSA ‚Äî Proposed Redlines</h2>
    <div class="matter-meta">
      Salve Consulting LLC ‚Üí Story Cannabis | Master Services Agreement Package (Effective 1/1/26)
    </div>
  </div>

  <!-- LATEST UPDATES -->
  <div class="overview-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b;">
    <h3 style="color: #92400e; margin-bottom: 16px;">üÜï What's New ‚Äî December 16, 2025</h3>

    <!-- TL;DR Box -->
    <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
      <div style="font-weight: 600; color: #92400e; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Bottom Line</div>
      <div style="font-size: 1rem; color: #1c1917;">
        Added <strong>Section 9: Schedule Contingency & Delay Remedies</strong> to iPaaS SOW. Story wanted delay protection ‚Üí we gave them a framework that protects <em>both</em> sides, with Salve-friendly defaults.
      </div>
    </div>

    <!-- What Story Asked For vs What They're Getting -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
      <div style="background: white; border-radius: 8px; padding: 16px;">
        <div style="font-weight: 600; color: #dc2626; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">‚ùå What Story Wanted</div>
        <ul style="margin: 0; padding-left: 18px; font-size: 0.9rem; color: #57534e;">
          <li>Financial penalties for delays</li>
          <li>Liquidated damages</li>
          <li>Open-ended liability</li>
        </ul>
      </div>
      <div style="background: white; border-radius: 8px; padding: 16px;">
        <div style="font-weight: 600; color: #166534; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">‚úì What They're Getting</div>
        <ul style="margin: 0; padding-left: 18px; font-size: 0.9rem; color: #1c1917;">
          <li>30-day cure period first</li>
          <li>Tiny capped credits (if ever)</li>
          <li>Exit right for chronic delays</li>
        </ul>
      </div>
    </div>

    <!-- Key Protections for Salve -->
    <div style="background: white; border-radius: 8px; padding: 16px;">
      <div style="font-weight: 600; color: #1a2e44; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">üõ°Ô∏è Key Protections for Salve</div>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 0.9rem;">
        <div style="display: flex; gap: 8px; align-items: flex-start;">
          <span style="color: #166534; font-weight: bold;">¬ß9.3</span>
          <span><strong>5-Point Safe Harbor</strong> ‚Äî No penalty while actively: noticing ‚Üí acknowledging ‚Üí workaround ‚Üí mitigating ‚Üí demonstrating effort</span>
        </div>
        <div style="display: flex; gap: 8px; align-items: flex-start;">
          <span style="color: #166534; font-weight: bold;">¬ß9.4</span>
          <span><strong>30-Day Cure</strong> ‚Äî Full month to fix before any credits kick in</span>
        </div>
        <div style="display: flex; gap: 8px; align-items: flex-start;">
          <span style="color: #166534; font-weight: bold;">¬ß9.5</span>
          <span><strong>Reciprocal</strong> ‚Äî If Story's delays >30 days, Salve bills extra managed services fees</span>
        </div>
        <div style="display: flex; gap: 8px; align-items: flex-start;">
          <span style="color: #166534; font-weight: bold;">¬ß9.4</span>
          <span><strong>Capped Credits</strong> ‚Äî 5% milestone / 10% monthly / 1 month/year aggregate max</span>
        </div>
        <div style="display: flex; gap: 8px; align-items: flex-start;">
          <span style="color: #166534; font-weight: bold;">¬ß9.2</span>
          <span><strong>Excused Delays</strong> ‚Äî Customer delays, third-party issues, CO-driven = no penalty</span>
        </div>
        <div style="display: flex; gap: 8px; align-items: flex-start;">
          <span style="color: #166534; font-weight: bold;">¬ß9.7</span>
          <span><strong>No LDs</strong> ‚Äî Explicitly excludes liquidated damages, lost profits, consequentials</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ORIGINAL SUMMARY -->
  <div class="overview-box editable-box">
    <h3>Original Summary ‚Äî December 15, 2025</h3>
    <button class="copy-btn" onclick="copyContent(this)">Copy</button>
    <div class="editable-content" contenteditable="true" data-field="summary">
      <p>
        The attached documents contain our proposed revisions to the Story Cannabis MSA package. The redlines fall into a few main categories: (1) clarifying payment terms and invoice timing to align cash flow with actual service delivery, (2) adding third-party integration risk allocation language‚Äîcritical given the heavy reliance on systems like Dutchie, Treez, Springbig that we don't control, (3) tightening up SLA response times and carving out appropriate exclusions, and (4) various cleanup items where the original drafts had inconsistent references or missing definitions.
      </p>
      <p style="margin-top:12px;">
        Each document below expands to show specific changes and the thinking behind them. The redlined Word files are available for download‚Äîthey're formatted as proper Track Changes so Story's counsel can review in the usual way.
      </p>
    </div>
    <div class="overview-stats">
      <div class="stat">
        <div class="stat-number">4</div>
        <div class="stat-label">Documents</div>
      </div>
      <div class="stat">
        <div class="stat-number">27</div>
        <div class="stat-label">Total Redlines</div>
      </div>
    </div>
  </div>

  <!-- Issues at a Glance -->
  <div class="overview-box">
    <h3>Issues at a Glance</h3>
    <table class="issues-table">
      <thead>
        <tr>
          <th style="width:40%">Issue</th>
          <th>SLA</th>
          <th>iPaaS</th>
          <th>PM</th>
          <th>DW</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <strong>Payment/Invoicing Structure</strong><br>
            <span style="color:var(--text-muted);font-size:0.8rem;">Setup fees at kick-off, monthly fees upon go-live, Net 30 with grace period, overage pricing</span>
          </td>
          <td class="dash">‚Äî</td>
          <td class="check">‚úì</td>
          <td class="check">‚úì</td>
          <td class="check">‚úì</td>
        </tr>
        <tr>
          <td>
            <strong>Third-Party Risk Exclusions</strong><br>
            <span style="color:var(--text-muted);font-size:0.8rem;">Carve-outs for Dutchie/Treez/Springbig outages, API changes, rate limits, credential expirations</span>
          </td>
          <td class="check">‚úì</td>
          <td class="check">‚úì</td>
          <td class="dash">‚Äî</td>
          <td class="dash">‚Äî</td>
        </tr>
        <tr>
          <td>
            <strong>Response Time / SLA Adjustments</strong><br>
            <span style="color:var(--text-muted);font-size:0.8rem;">Faster Sev 2 response (8hr‚Üí1hr), realistic Sev 3-4 windows, scope limitation clause</span>
          </td>
          <td class="check">‚úì</td>
          <td class="dash">‚Äî</td>
          <td class="dash">‚Äî</td>
          <td class="dash">‚Äî</td>
        </tr>
        <tr>
          <td>
            <strong>IP & Licensing Terms</strong><br>
            <span style="color:var(--text-muted);font-size:0.8rem;">Work product ownership, perpetual license grant, third-party component acknowledgments</span>
          </td>
          <td class="dash">‚Äî</td>
          <td class="check">‚úì</td>
          <td class="dash">‚Äî</td>
          <td class="dash">‚Äî</td>
        </tr>
        <tr>
          <td>
            <strong>Suspension/Non-Payment Rights</strong><br>
            <span style="color:var(--text-muted);font-size:0.8rem;">Provider can pause services after 45 days non-payment with 5-day notice</span>
          </td>
          <td class="dash">‚Äî</td>
          <td class="check">‚úì</td>
          <td class="check">‚úì</td>
          <td class="check">‚úì</td>
        </tr>
        <tr>
          <td>
            <strong>Effective Date / Reference Fixes</strong><br>
            <span style="color:var(--text-muted);font-size:0.8rem;">Consistent nomenclature, corrected cross-references, added Exhibit D definition</span>
          </td>
          <td class="dash">‚Äî</td>
          <td class="check">‚úì</td>
          <td class="check">‚úì</td>
          <td class="dash">‚Äî</td>
        </tr>
        <tr style="background: #fef3c7;">
          <td>
            <strong>üÜï Schedule Contingency & Delay Remedies</strong><br>
            <span style="color:var(--text-muted);font-size:0.8rem;">Delay classification, 30-day cure, capped credits, reciprocal customer delay remedy, chronic delay termination, no LDs</span>
          </td>
          <td class="dash">‚Äî</td>
          <td class="check">‚úì</td>
          <td class="dash">‚Äî</td>
          <td class="dash">‚Äî</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Negotiation Playbook -->
  <div class="playbook-section">
    <div class="playbook-header">
      <h3>Negotiation Playbook</h3>
      <span style="font-size:0.75rem;color:var(--text-muted);">Internal reference ‚Äî click cards to expand</span>
    </div>
    <div class="playbook-grid">

      <!-- Card 1: Third-Party Risk -->
      <div class="playbook-card" id="pb-thirdparty">
        <div class="playbook-card-header" onclick="togglePlaybook('pb-thirdparty')">
          <div>
            <div class="playbook-card-title">Third-Party Dependency Risk</div>
            <div class="playbook-tags">
              <span class="playbook-tag sla">SLA</span>
              <span class="playbook-tag ipaas">iPaaS</span>
            </div>
          </div>
          <span class="playbook-expand">‚ñº</span>
        </div>
        <div class="playbook-card-body">
          <div class="playbook-tier">
            <div class="playbook-tier-label must">Must Have</div>
            <div class="playbook-tier-content">
              <ul>
                <li>No SLA breach/credits for third-party outages beyond our control</li>
                <li>Provider obligations limited to: monitor ‚Üí notify ‚Üí reasonable workaround</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label prefer">Prefer</div>
            <div class="playbook-tier-content">
              <ul>
                <li>Timeline extension when third-party events block progress</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label fallback">Fallback</div>
            <div class="playbook-tier-content">
              <ul>
                <li>A: Credits only if Provider fails to communicate/triage per process</li>
                <li>B: Cap exposure with minimal credit + "sole remedy" clause</li>
              </ul>
            </div>
          </div>
          <div class="playbook-script">
            <button class="playbook-copy-btn" onclick="copyScript(this, event)">Copy</button>
            <div class="playbook-script-label">What to say</div>
            <div class="playbook-script-text">"We can't guarantee performance of systems we don't control. We'll commit to coordination and transparency, but not to financial penalties for third-party outages."</div>
          </div>
        </div>
      </div>

      <!-- Card 2: Change Orders -->
      <div class="playbook-card" id="pb-changeorders">
        <div class="playbook-card-header" onclick="togglePlaybook('pb-changeorders')">
          <div>
            <div class="playbook-card-title">Change Orders / Scope Control</div>
            <div class="playbook-tags">
              <span class="playbook-tag ipaas">iPaaS</span>
              <span class="playbook-tag pm">PM</span>
              <span class="playbook-tag dw">DW</span>
            </div>
          </div>
          <span class="playbook-expand">‚ñº</span>
        </div>
        <div class="playbook-card-body">
          <div class="playbook-tier">
            <div class="playbook-tier-label must">Must Have</div>
            <div class="playbook-tier-content">
              <ul>
                <li>No out-of-scope work without written Change Order (CO)</li>
                <li>CO must state scope, fees, and schedule impact</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label prefer">Prefer</div>
            <div class="playbook-tier-content">
              <ul>
                <li>Fast path: CO templates + 48-72h impact estimate window</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label fallback">Fallback</div>
            <div class="playbook-tier-content">
              <ul>
                <li>A: Limited T&M up to small cap for urgent work, then CO required</li>
                <li>B: Email approval for rate + hours + description (paper trail)</li>
              </ul>
            </div>
          </div>
          <div class="playbook-script">
            <button class="playbook-copy-btn" onclick="copyScript(this, event)">Copy</button>
            <div class="playbook-script-label">What to say</div>
            <div class="playbook-script-text">"This is how we prevent budget surprises for you and scope creep for us‚Äîeveryone wins."</div>
          </div>
        </div>
      </div>

      <!-- Card 3: Payment & Suspension -->
      <div class="playbook-card" id="pb-payment">
        <div class="playbook-card-header" onclick="togglePlaybook('pb-payment')">
          <div>
            <div class="playbook-card-title">Payment & Non-Payment Remedies</div>
            <div class="playbook-tags">
              <span class="playbook-tag ipaas">iPaaS</span>
              <span class="playbook-tag pm">PM</span>
              <span class="playbook-tag dw">DW</span>
            </div>
          </div>
          <span class="playbook-expand">‚ñº</span>
        </div>
        <div class="playbook-card-body">
          <div class="playbook-tier">
            <div class="playbook-tier-label must">Must Have</div>
            <div class="playbook-tier-content">
              <ul>
                <li>Clear invoice timing + Net terms</li>
                <li>Right to suspend for nonpayment after cure period</li>
                <li>Withhold deliverables until undisputed amounts paid</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label prefer">Prefer</div>
            <div class="playbook-tier-content">
              <ul>
                <li>Suspension carve-out for good faith disputes (if undisputed amounts current)</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label fallback">Fallback</div>
            <div class="playbook-tier-content">
              <ul>
                <li>A: Longer cure period (15‚Üí30 days) but keep suspension</li>
                <li>B: Remove suspension, keep deliverable release gating</li>
              </ul>
            </div>
          </div>
          <div class="playbook-script">
            <button class="playbook-copy-btn" onclick="copyScript(this, event)">Copy</button>
            <div class="playbook-script-label">What to say</div>
            <div class="playbook-script-text">"We're happy to be flexible on timing, but we need a predictable payment mechanism‚Äîespecially before releasing core deliverables."</div>
          </div>
        </div>
      </div>

      <!-- Card 4: SLA Response vs Resolution -->
      <div class="playbook-card" id="pb-sla">
        <div class="playbook-card-header" onclick="togglePlaybook('pb-sla')">
          <div>
            <div class="playbook-card-title">SLA: Response vs. Resolution</div>
            <div class="playbook-tags">
              <span class="playbook-tag sla">SLA</span>
            </div>
          </div>
          <span class="playbook-expand">‚ñº</span>
        </div>
        <div class="playbook-card-body">
          <div class="playbook-tier">
            <div class="playbook-tier-label must">Must Have</div>
            <div class="playbook-tier-content">
              <ul>
                <li>Response times = "acknowledge + triage started," not "resolved"</li>
                <li>Tie to Normal Business Hours (defined)</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label prefer">Prefer</div>
            <div class="playbook-tier-content">
              <ul>
                <li>"Commercially reasonable efforts" for resolution, no fixed resolution times</li>
                <li>Workaround standard for Sev 1 (restore first, permanent fix later)</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label fallback">Fallback</div>
            <div class="playbook-tier-content">
              <ul>
                <li>A: Resolution targets as best-efforts, excluding third-party issues</li>
                <li>B: Credits only for repeated misses (3 in 6 months), Provider-caused only</li>
              </ul>
            </div>
          </div>
          <div class="playbook-script">
            <button class="playbook-copy-btn" onclick="copyScript(this, event)">Copy</button>
            <div class="playbook-script-label">What to say</div>
            <div class="playbook-script-text">"We can commit to rapid triage; resolution timing depends on root cause, complexity, and third-party variables."</div>
          </div>
        </div>
      </div>

      <!-- Card 5: IP & Licensing -->
      <div class="playbook-card" id="pb-ip">
        <div class="playbook-card-header" onclick="togglePlaybook('pb-ip')">
          <div>
            <div class="playbook-card-title">IP Ownership & License Back</div>
            <div class="playbook-tags">
              <span class="playbook-tag ipaas">iPaaS</span>
              <span class="playbook-tag dw">DW</span>
            </div>
          </div>
          <span class="playbook-expand">‚ñº</span>
        </div>
        <div class="playbook-card-body">
          <div class="playbook-tier">
            <div class="playbook-tier-label must">Must Have</div>
            <div class="playbook-tier-content">
              <ul>
                <li>Provider retains ownership of reusable tooling/connectors/methods</li>
                <li>Customer gets internal-use license (conditioned on payment)</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label prefer">Prefer</div>
            <div class="playbook-tier-content">
              <ul>
                <li>Explicitly allow reuse of anonymized learnings and non-customer-specific components</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label fallback">Fallback</div>
            <div class="playbook-tier-content">
              <ul>
                <li>A: Broader internal license + "use for Customer's benefit" clause (avoid joint ownership)</li>
                <li>B: Assign customer-specific configs but keep underlying framework/provider IP</li>
              </ul>
            </div>
          </div>
          <div class="playbook-script">
            <button class="playbook-copy-btn" onclick="copyScript(this, event)">Copy</button>
            <div class="playbook-script-label">What to say</div>
            <div class="playbook-script-text">"We're not selling our platform IP; we are delivering configurations and outcomes you can use."</div>
          </div>
        </div>
      </div>

      <!-- Card 6: Schedule Contingency (NEW) -->
      <div class="playbook-card expanded" id="pb-delay" style="border-color: #f59e0b;">
        <div class="playbook-card-header" onclick="togglePlaybook('pb-delay')" style="background: #fef3c7;">
          <div>
            <div class="playbook-card-title">üÜï Schedule Contingency & Delays</div>
            <div class="playbook-tags">
              <span class="playbook-tag ipaas">iPaaS</span>
            </div>
          </div>
          <span class="playbook-expand">‚ñº</span>
        </div>
        <div class="playbook-card-body">
          <div class="playbook-tier">
            <div class="playbook-tier-label must">Must Have</div>
            <div class="playbook-tier-content">
              <ul>
                <li>30-day cure period before ANY financial remedy kicks in</li>
                <li>No penalty while actively: noticing ‚Üí acknowledging ‚Üí communicating workarounds ‚Üí mitigating ‚Üí demonstrating effort</li>
                <li>Reciprocal: Customer-caused delays >30 days = we can bill extra managed services fees</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label prefer">Prefer</div>
            <div class="playbook-tier-content">
              <ul>
                <li>No financial penalties at all‚Äîjust timeline extensions</li>
                <li>Higher thresholds for chronic delay termination (90+ days, not 60)</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label fallback">Fallback</div>
            <div class="playbook-tier-content">
              <ul>
                <li>A: Accept credits but keep them capped (5% milestone, 10% monthly, 1 month/year aggregate)</li>
                <li>B: If they push for resolution commitments, make them "commercially reasonable efforts" not guaranteed timelines</li>
              </ul>
            </div>
          </div>
          <div class="playbook-script">
            <button class="playbook-copy-btn" onclick="copyScript(this, event)">Copy</button>
            <div class="playbook-script-label">What to say</div>
            <div class="playbook-script-text">"We're coordinating across 11 integration partners and 6 internal departments‚Äîdelays are inevitable. What matters is how we handle them. We're committing to transparency and active mitigation; financial penalties only make sense if we're not doing that."</div>
          </div>
        </div>
      </div>

      <!-- Card 7: AI Agent Boundaries -->
      <div class="playbook-card" id="pb-ai">
        <div class="playbook-card-header" onclick="togglePlaybook('pb-ai')">
          <div>
            <div class="playbook-card-title">AI Agent Support Boundaries</div>
            <div class="playbook-tags">
              <span class="playbook-tag sla">SLA</span>
            </div>
          </div>
          <span class="playbook-expand">‚ñº</span>
        </div>
        <div class="playbook-card-body">
          <div class="playbook-tier">
            <div class="playbook-tier-label must">Must Have</div>
            <div class="playbook-tier-content">
              <ul>
                <li>AI = informational only, not advice or commitment to implement</li>
                <li>Not a substitute for formal ticketing</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label prefer">Prefer</div>
            <div class="playbook-tier-content">
              <ul>
                <li>AI output may be inaccurate; Customer responsible for validation</li>
              </ul>
            </div>
          </div>
          <div class="playbook-tier">
            <div class="playbook-tier-label fallback">Fallback</div>
            <div class="playbook-tier-content">
              <ul>
                <li>A: Keep disclaimers but soften "no reliance" phrasing</li>
                <li>B: Make AI feature "beta/pilot," subject to modification, no SLA penalties</li>
              </ul>
            </div>
          </div>
          <div class="playbook-script">
            <button class="playbook-copy-btn" onclick="copyScript(this, event)">Copy</button>
            <div class="playbook-script-label">What to say</div>
            <div class="playbook-script-text">"AI assistance is helpful but not deterministic; we're setting expectations so support remains reliable."</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="docs-section">
    <div class="toolbar">
      <h3 style="margin:0;">Documents</h3>
      <div class="toolbar-right">
        <button class="btn btn-secondary btn-sm" onclick="expandAll()">Expand All</button>
        <button class="btn btn-secondary btn-sm" onclick="collapseAll()">Collapse All</button>
        <button class="btn btn-primary btn-sm" onclick="downloadAll()">‚Üì Download All</button>
      </div>
    </div>

    <!-- SLA -->
    <div class="doc-card" id="doc-sla">
      <div class="doc-card-header" onclick="toggleCard('doc-sla')">
        <div class="doc-title-area">
          <div class="doc-number">1</div>
          <div class="doc-title">
            <h4>Service Level Agreement</h4>
            <div class="doc-subtitle">SALVE-STORY SLA (1.01.26)</div>
          </div>
        </div>
        <div class="doc-header-right">
          <span class="expand-hint">click to see details & rationale</span>
          <span class="redline-count">6 redlines</span>
          <span class="expand-icon">‚ñº</span>
        </div>
      </div>
      <div class="doc-card-body">
        <div class="changes-section editable-box">
          <h5>What Changed</h5>
          <button class="copy-btn" onclick="copyContent(this)">Copy</button>
          <div class="editable-content" contenteditable="true" data-field="sla-changes">
            <div class="change-item">
              <strong>Response Time Adjustments (Severity Levels 2-4)</strong> ‚Äî Tightened the response windows. Sev 2 goes from 8 hours down to 1 hour during business hours. Sev 3 and 4 extended slightly (1‚Üí3 days, 2‚Üí5 days) to be more realistic for lower-priority issues.
            </div>
            <div class="change-item">
              <strong>Scope Limitation Clause (new item e)</strong> ‚Äî Added language clarifying Provider makes no guarantees for inquiries outside defined scope. Customer is responsible for monitoring their own external matters.
              <div class="note">This one is important‚Äîprevents scope creep into areas we're not being paid to support.</div>
            </div>
            <div class="change-item">
              <strong>Third-Party Integration Exclusions (items m-r)</strong> ‚Äî New exclusion items after Force Majeure covering API outages, rate limiting, credential issues, and third-party policy changes for systems like Dutchie, Treez, etc.
            </div>
            <div class="change-item">
              <strong>AI Agent Disclaimer</strong> ‚Äî Added disclaimer that AI Agent support is "as-is" and doesn't constitute formal support tickets or trigger SLA commitments.
            </div>
          </div>
        </div>

        <div class="rationale-section editable-box">
          <h5>Why These Matter</h5>
          <button class="copy-btn" onclick="copyContent(this)">Copy</button>
          <div class="editable-content" contenteditable="true" data-field="sla-rationale">
            <p>
              The third-party exclusions are non-negotiable from our perspective. When Dutchie's API goes down at 2am, that's not something we can control or fix‚Äîand we shouldn't be on the hook for SLA credits because of it. The response time adjustments balance faster response for critical issues against realistic timelines for routine matters. The AI disclaimer is prophylactic; we don't want someone arguing that chatting with the AI agent counts as "opening a ticket."
            </p>
          </div>
        </div>

        <div class="doc-actions">
          <a href="SALVE-STORY%20SLA%20(1.01.26)%20-%20REDLINED.docx" class="btn btn-primary" download>
            Download Redlined Version
          </a>
        </div>

        <div class="feedback-section">
          <h5>Notes</h5>
          <textarea class="feedback-note" data-item="sla" placeholder="Questions or comments on SLA redlines..."></textarea>
        </div>
      </div>
    </div>

    <!-- iPaaS SOW -->
    <div class="doc-card" id="doc-ipaas">
      <div class="doc-card-header" onclick="toggleCard('doc-ipaas')">
        <div class="doc-title-area">
          <div class="doc-number">2</div>
          <div class="doc-title">
            <h4>iPaaS Statement of Work</h4>
            <div class="doc-subtitle">Exhibit C-5 ‚Äî Integration Platform Services</div>
          </div>
        </div>
        <div class="doc-header-right">
          <span class="expand-hint">click to see details & rationale</span>
          <span class="redline-count">17 redlines</span>
          <span class="expand-icon">‚ñº</span>
        </div>
      </div>
      <div class="doc-card-body">
        <div class="changes-section editable-box">
          <h5>What Changed</h5>
          <button class="copy-btn" onclick="copyContent(this)">Copy</button>
          <div class="editable-content" contenteditable="true" data-field="ipaas-changes">
            <div class="change-item" style="background: #fef3c7; padding: 12px; border-radius: 6px; border-left: 4px solid #f59e0b; margin-bottom: 12px;">
              <strong style="color: #92400e;">üÜï Schedule Contingency & Delay Remedies (new Section 9)</strong> ‚Äî Complete delay framework addressing Story's request for schedule protection. Seven subsections: (9.1) Baseline Project Plan referencing Exhibit D; (9.2) Delay Classification distinguishing Excused vs Provider-Caused; (9.3) Notice, Mitigation & Escalation Protocol with 5-point active mitigation requirement; (9.4) Provider Delay Remedy with 30-day cure period then capped credits (5% of milestone, max 10% monthly, 1 month/year aggregate cap); (9.5) <strong>Reciprocal Customer Delay Remedy</strong>‚Äîif Customer-caused delays exceed 30 days, Provider can bill additional managed services fees; (9.6) Chronic Delay Termination (3 missed milestones or 90+ days cumulative delay = Customer can exit with refund); (9.7) Exclusions‚Äîno LDs, no lost profits, no consequential damages.
              <div class="note">Added Dec 15 per Niki's request to get ahead of Story's lawyers on this issue.</div>
            </div>
            <div class="change-item">
              <strong>Payment Terms Restructure</strong> ‚Äî Complete rewrite of Section 6.4. Setup fees now invoiced at kick-off (due before production deployment). Monthly fees commence when integration goes live, prorated for mid-month starts. Added event volume caps (100M/month) with overage pricing.
            </div>
            <div class="change-item">
              <strong>Third-Party Integration Dependencies (new Section 6.5)</strong> ‚Äî Four subsections covering: nature of dependencies, excluded events, Provider obligations during outages, and automatic timeline extensions.
              <div class="note">This is the heart of our risk allocation for iPaaS work.</div>
            </div>
            <div class="change-item">
              <strong>Change Management Process (new Section 8)</strong> ‚Äî Formal CO process: written request ‚Üí 5-day impact assessment ‚Üí 5-day customer response ‚Üí signed CO required. No work outside scope without executed CO.
            </div>
            <div class="change-item">
              <strong>IP & License Terms (Section 7)</strong> ‚Äî Fleshed out the bare-bones IP section with work product ownership, third-party component acknowledgments, customer data rights, and reservation of rights.
            </div>
            <div class="change-item">
              <strong>Exhibit D Definition & References</strong> ‚Äî Added definition for "Exhibit D: 2026 Technical Roadmap" and fixed broken reference in Section 3.2.3 that pointed to wrong section.
            </div>
            <div class="change-item">
              <strong>PM Services Clarification</strong> ‚Äî Explicit statement that project management is separate (Exhibit C-6) and not included in iPaaS fees.
            </div>
            <div class="change-item">
              <strong>Suspension Rights</strong> ‚Äî Provider can suspend after 45 days non-payment with 5 business days notice. Covers active integrations, deliverables, platform access, and new work.
            </div>
            <div class="change-item">
              <strong>Cleanup</strong> ‚Äî Fixed "any other C-5 SOW" ‚Üí "any other SOW" and "Effective Date" ‚Üí "C-5 SOW Effective Date" for clarity.
            </div>
          </div>
        </div>

        <div class="rationale-section editable-box">
          <h5>Why These Matter</h5>
          <button class="copy-btn" onclick="copyContent(this)">Copy</button>
          <div class="editable-content" contenteditable="true" data-field="ipaas-rationale">
            <p>
              This SOW has the most redlines because it's also the most complex engagement. The payment restructure aligns cash flow with delivery milestones rather than back-loading everything. The third-party dependencies section is critical‚Äîwe're building integrations with systems we don't own, and when Treez changes their API schema without warning, that's not our breach. The change management process protects both sides from scope creep and the "oh, we assumed that was included" conversations.
            </p>
          </div>
        </div>

        <div class="doc-actions">
          <a href="SALVE-STORY%20iPAAS%20SOW%20(01.01.26)%20-%20REDLINED.docx" class="btn btn-primary" download>
            Download Redlined Version
          </a>
        </div>

        <div class="feedback-section">
          <h5>Notes</h5>
          <textarea class="feedback-note" data-item="ipaas" placeholder="Questions or comments on iPaaS SOW redlines..."></textarea>
        </div>
      </div>
    </div>

    <!-- PM SOW -->
    <div class="doc-card" id="doc-pm">
      <div class="doc-card-header" onclick="toggleCard('doc-pm')">
        <div class="doc-title-area">
          <div class="doc-number">3</div>
          <div class="doc-title">
            <h4>Project Management SOW</h4>
            <div class="doc-subtitle">Exhibit C-6 ‚Äî PM Services for iPaaS Implementation</div>
          </div>
        </div>
        <div class="doc-header-right">
          <span class="expand-hint">click to see details & rationale</span>
          <span class="redline-count">5 redlines</span>
          <span class="expand-icon">‚ñº</span>
        </div>
      </div>
      <div class="doc-card-body">
        <div class="changes-section editable-box">
          <h5>What Changed</h5>
          <button class="copy-btn" onclick="copyContent(this)">Copy</button>
          <div class="editable-content" contenteditable="true" data-field="pm-changes">
            <div class="change-item">
              <strong>Payment Terms</strong> ‚Äî Aligned with same structure as iPaaS SOW (setup at kick-off, monthly upon commencement, Net 30 with 15-day grace).
            </div>
            <div class="change-item">
              <strong>Cross-Reference to Change Management</strong> ‚Äî Added reference to C-5 SOW Section 8 for change order process.
            </div>
            <div class="change-item">
              <strong>Relationship Clarification</strong> ‚Äî This SOW supports C-5 iPaaS implementation; made that explicit.
            </div>
            <div class="change-item">
              <strong>Effective Date Fix</strong> ‚Äî Same nomenclature cleanup as iPaaS.
            </div>
            <div class="change-item">
              <strong>Suspension Language</strong> ‚Äî Mirror of iPaaS suspension rights for non-payment.
            </div>
          </div>
        </div>

        <div class="rationale-section editable-box">
          <h5>Why These Matter</h5>
          <button class="copy-btn" onclick="copyContent(this)">Copy</button>
          <div class="editable-content" contenteditable="true" data-field="pm-rationale">
            <p>
              Mostly harmonization‚Äîwe want the PM SOW and iPaaS SOW to work together seamlessly. Same payment terms, same suspension rights, clear relationship between the two. The change management cross-reference avoids having to duplicate that whole section here.
            </p>
          </div>
        </div>

        <div class="doc-actions">
          <a href="SALVE-STORY%20PM%20SOW%20(01.01.26)%20-%20REDLINED.docx" class="btn btn-primary" download>
            Download Redlined Version
          </a>
        </div>

        <div class="feedback-section">
          <h5>Notes</h5>
          <textarea class="feedback-note" data-item="pm" placeholder="Questions or comments on PM SOW redlines..."></textarea>
        </div>
      </div>
    </div>

    <!-- DW SOW -->
    <div class="doc-card" id="doc-dw">
      <div class="doc-card-header" onclick="toggleCard('doc-dw')">
        <div class="doc-title-area">
          <div class="doc-number">4</div>
          <div class="doc-title">
            <h4>Data Warehouse SOW</h4>
            <div class="doc-subtitle">Exhibit C-4 ‚Äî Analytics & Reporting Services</div>
          </div>
        </div>
        <div class="doc-header-right">
          <span class="expand-hint">click to see details & rationale</span>
          <span class="redline-count">3 redlines</span>
          <span class="expand-icon">‚ñº</span>
        </div>
      </div>
      <div class="doc-card-body">
        <div class="changes-section editable-box">
          <h5>What Changed</h5>
          <button class="copy-btn" onclick="copyContent(this)">Copy</button>
          <div class="editable-content" contenteditable="true" data-field="dw-changes">
            <div class="change-item">
              <strong>Payment Terms</strong> ‚Äî Same alignment as other SOWs. Setup invoiced at kick-off, monthly upon go-live.
            </div>
            <div class="change-item">
              <strong>Suspension Rights</strong> ‚Äî Added ability to suspend services and withhold deliverables for non-payment after 45 days.
            </div>
            <div class="change-item">
              <strong>Monthly Fee Commencement</strong> ‚Äî Clarified that ongoing fees start when DW environment is actively receiving production data.
            </div>
          </div>
        </div>

        <div class="rationale-section editable-box">
          <h5>Why These Matter</h5>
          <button class="copy-btn" onclick="copyContent(this)">Copy</button>
          <div class="editable-content" contenteditable="true" data-field="dw-rationale">
            <p>
              The DW SOW was relatively clean to begin with. Main additions are consistency with the payment/suspension terms across all SOWs. We want a single, predictable framework for how invoicing and non-payment situations work across the entire engagement.
            </p>
          </div>
        </div>

        <div class="doc-actions">
          <a href="SALVE-STORY%20DW%20SOW%20(1.01.26)%20-%20REDLINED.docx" class="btn btn-primary" download>
            Download Redlined Version
          </a>
        </div>

        <div class="feedback-section">
          <h5>Notes</h5>
          <textarea class="feedback-note" data-item="dw" placeholder="Questions or comments on DW SOW redlines..."></textarea>
        </div>
      </div>
    </div>

  </div>

  <!-- CLIENT COMMENTS SECTION -->
  <div class="comments-section" id="commentsSection">
    <div class="comments-header">
      <h3>üí¨ Questions & Comments</h3>
      <p>Leave a note or question ‚Äî Sergei will be notified</p>
    </div>
    <div class="comments-body">
      <div class="comments-intro">
        This is your space to ask questions, request changes, or leave feedback. For anything urgent, use the purple chat button (bottom right).
      </div>

      <div class="comments-list" id="commentsList">
        <div class="no-comments" id="noComments">No comments yet. Be the first to leave a note!</div>
      </div>

      <div class="comment-input-area" style="flex-direction: column; gap: 10px;">
        <div style="display: flex; gap: 10px; align-items: center;">
          <label style="font-size: 0.8rem; color: var(--text-muted);">Your name:</label>
          <input type="text" id="commentName" placeholder="Enter your name" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; width: 200px;" />
        </div>
        <div style="display: flex; gap: 12px;">
          <textarea class="comment-input" id="commentInput" placeholder="Type your question or comment here..."></textarea>
          <button class="comment-submit" id="commentSubmit" onclick="submitComment()">Send</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Floating Chat Widget -->
<div class="chat-fab" id="chatFab">
  <div class="chat-fab-label">üí¨ Quick message to Sergei</div>
  <div class="chat-fab-pulse"></div>
  <button class="chat-fab-btn" onclick="toggleChatPanel()">
    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
  </button>
</div>

<!-- Chat Panel -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-panel-header">
    <button class="chat-panel-close" onclick="toggleChatPanel()">√ó</button>
    <h4>Message Sergei</h4>
    <p>Story Cannabis MSA ‚Äî Tight deadline mode üö®</p>
  </div>
  <div class="chat-panel-body">
    <a href="https://t.me/SergeiTokmakov" target="_blank" class="chat-option">
      <div class="chat-option-icon telegram">üì±</div>
      <div class="chat-option-text">
        <h5>Telegram (Fastest)</h5>
        <p>Goes directly to my phone</p>
      </div>
      <span class="chat-option-badge">URGENT</span>
    </a>
    <div class="chat-option" onclick="scrollToComments(); toggleChatPanel();">
      <div class="chat-option-icon comment">üí¨</div>
      <div class="chat-option-text">
        <h5>Comment in Workroom</h5>
        <p>I'll see it within minutes</p>
      </div>
    </div>
    <a href="mailto:Owner@Terms.Law?subject=Story Cannabis MSA - Question" class="chat-option">
      <div class="chat-option-icon" style="background: #fef3c7;">üìß</div>
      <div class="chat-option-text">
        <h5>Email</h5>
        <p>Owner@Terms.Law</p>
      </div>
    </a>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCeACvK3MVTOOaWY4SWG1yNnrcA9ILkkaM",
  authDomain: "termsdocs.firebaseapp.com",
  databaseURL: "https://termsdocs-default-rtdb.firebaseio.com",
  projectId: "termsdocs",
  storageBucket: "termsdocs.firebasestorage.app",
  messagingSenderId: "62791617178",
  appId: "1:62791617178:web:ff79f24f40cc98e88aed23"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const workroomRef = db.ref('workrooms/NR-7f9x2k');

// Copy editable content to clipboard (preserves formatting as plain text)
function copyContent(btn) {
  const box = btn.closest('.editable-box');
  const content = box.querySelector('.editable-content');

  // Get text content (strips HTML but preserves line breaks)
  const text = content.innerText || content.textContent;

  navigator.clipboard.writeText(text).then(() => {
    const orig = btn.textContent;
    btn.textContent = 'Copied!';
    btn.style.background = '#dcfce7';
    btn.style.borderColor = '#86efac';
    btn.style.color = '#166534';
    btn.style.opacity = '1';
    setTimeout(() => {
      btn.textContent = orig;
      btn.style.background = '';
      btn.style.borderColor = '';
      btn.style.color = '';
    }, 1500);
  }).catch(err => {
    console.error('Copy failed:', err);
    btn.textContent = 'Failed';
    setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
  });
}

function toggleCard(id) {
  const card = document.getElementById(id);
  card.classList.toggle('expanded');
}

function togglePlaybook(id) {
  const card = document.getElementById(id);
  card.classList.toggle('expanded');
}

function copyScript(btn, event) {
  event.stopPropagation();
  const scriptText = btn.parentElement.querySelector('.playbook-script-text').innerText;
  navigator.clipboard.writeText(scriptText).then(() => {
    const orig = btn.textContent;
    btn.textContent = 'Copied!';
    btn.style.background = '#dcfce7';
    btn.style.borderColor = '#86efac';
    btn.style.color = '#166534';
    btn.style.opacity = '1';
    setTimeout(() => {
      btn.textContent = orig;
      btn.style.background = '';
      btn.style.borderColor = '';
      btn.style.color = '';
    }, 1500);
  });
}

function expandAll() {
  document.querySelectorAll('.doc-card').forEach(card => card.classList.add('expanded'));
}

function collapseAll() {
  document.querySelectorAll('.doc-card').forEach(card => card.classList.remove('expanded'));
}

function downloadAll() {
  const files = [
    'SALVE-STORY%20SLA%20(1.01.26)%20-%20REDLINED.docx',
    'SALVE-STORY%20iPAAS%20SOW%20(01.01.26)%20-%20REDLINED.docx',
    'SALVE-STORY%20PM%20SOW%20(01.01.26)%20-%20REDLINED.docx',
    'SALVE-STORY%20DW%20SOW%20(1.01.26)%20-%20REDLINED.docx'
  ];
  files.forEach((file, i) => {
    setTimeout(() => {
      const a = document.createElement('a');
      a.href = file;
      a.download = decodeURIComponent(file);
      a.click();
    }, i * 500);
  });
}

// Save feedback to Firebase
function saveFeedback() {
  const data = {
    selections: {},
    notes: {},
    lastUpdated: new Date().toISOString()
  };

  document.querySelectorAll('.feedback-select').forEach(sel => {
    if (sel.value) data.selections[sel.dataset.item] = sel.value;
  });
  document.querySelectorAll('.feedback-note').forEach(note => {
    if (note.value.trim()) data.notes[note.dataset.item] = note.value;
  });

  workroomRef.child('feedback').set(data)
    .then(() => showSaveConfirm())
    .catch(err => {
      console.error('Save failed:', err);
      alert('Save failed. Check console for details.');
    });
}

// Load feedback from Firebase (real-time listener)
function setupRealtimeSync() {
  // Sync feedback (notes textareas)
  workroomRef.child('feedback').on('value', (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    // Update selections
    if (data.selections) {
      document.querySelectorAll('.feedback-select').forEach(sel => {
        if (data.selections[sel.dataset.item]) {
          sel.value = data.selections[sel.dataset.item];
        } else {
          sel.value = '';
        }
        updateSelectStyle(sel);
      });
    }

    // Update notes
    if (data.notes) {
      document.querySelectorAll('.feedback-note').forEach(note => {
        if (data.notes[note.dataset.item]) {
          note.value = data.notes[note.dataset.item];
        }
      });
    }

    // Show last updated
    if (data.lastUpdated) {
      updateLastSaved(data.lastUpdated);
    }
  });

  // Sync editable content (innerHTML preserved)
  workroomRef.child('editableContent').on('value', (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    document.querySelectorAll('.editable-content[data-field]').forEach(el => {
      const field = el.dataset.field;
      if (data[field] && !el.matches(':focus')) {
        el.innerHTML = data[field];
      }
    });
  });
}

// Save editable content to Firebase (debounced, preserves HTML)
let saveTimeout = null;
function saveEditableContent(el) {
  const field = el.dataset.field;
  if (!field) return;

  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => {
    const update = {};
    update[field] = el.innerHTML;
    workroomRef.child('editableContent').update(update);
  }, 800);
}

function updateSelectStyle(sel) {
  sel.classList.remove('status-approved', 'status-declined', 'status-discuss');
  if (sel.value === 'approved') sel.classList.add('status-approved');
  if (sel.value === 'declined') sel.classList.add('status-declined');
  if (sel.value === 'discuss') sel.classList.add('status-discuss');
}

function showSaveConfirm() {
  const btn = document.getElementById('saveBtn');
  const orig = btn.textContent;
  btn.textContent = 'Saved ‚úì';
  btn.style.background = '#166534';
  setTimeout(() => {
    btn.textContent = orig;
    btn.style.background = '';
  }, 1500);
}

function updateLastSaved(isoDate) {
  const date = new Date(isoDate);
  const formatted = date.toLocaleString('en-US', {
    month: 'short', day: 'numeric',
    hour: 'numeric', minute: '2-digit',
    hour12: true
  });
  const indicator = document.getElementById('lastSaved');
  if (indicator) indicator.textContent = 'Last saved: ' + formatted;
}

// Password protection
const ACCESS_CODE = 'Story2026';

function togglePasswordVisibility() {
  const input = document.getElementById('passwordInput');
  const btn = document.getElementById('showPwdBtn');
  if (input.type === 'password') {
    input.type = 'text';
    btn.textContent = 'Hide';
  } else {
    input.type = 'password';
    btn.textContent = 'Show';
  }
}

function checkPassword() {
  const input = document.getElementById('passwordInput');
  const error = document.getElementById('passwordError');

  if (input.value === ACCESS_CODE) {
    // Store in session
    sessionStorage.setItem('workroom_auth', 'true');
    unlockWorkroom();
  } else {
    input.classList.add('error');
    error.classList.add('show');
    input.value = '';
    setTimeout(() => {
      input.classList.remove('error');
    }, 500);
  }
}

function unlockWorkroom() {
  document.getElementById('passwordGate').classList.add('hidden');
  document.getElementById('mainContent').classList.add('visible');
}

// Check if already authenticated in this session
function checkAuth() {
  if (sessionStorage.getItem('workroom_auth') === 'true') {
    unlockWorkroom();
  }
}

// Allow Enter key to submit
document.getElementById('passwordInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    checkPassword();
  }
});

// ========== CHAT & COMMENTS FUNCTIONS ==========

// Toggle chat panel
function toggleChatPanel() {
  const panel = document.getElementById('chatPanel');
  panel.classList.toggle('open');
}

// Scroll to comments section
function scrollToComments() {
  const section = document.getElementById('commentsSection');
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  // Focus the input after scrolling
  setTimeout(() => {
    document.getElementById('commentInput').focus();
  }, 500);
}

// Notification config - UPDATE THESE
const TELEGRAM_BOT_TOKEN = '7288507046:AAGw_kOqLnxZKklDkjS-lEaSp-OY1GZpbM8'; // Your bot token
const TELEGRAM_CHAT_ID = '227aboredeleted077'; // Your Telegram user ID
const NOTIFICATION_EMAIL = 'Owner@Terms.Law';
const WORKROOM_NAME = 'Story Cannabis MSA';

// Send Telegram notification
async function sendTelegramNotification(comment) {
  const message = `üí¨ *New Comment in Workroom*\n\n` +
    `*Client:* ${WORKROOM_NAME}\n` +
    `*From:* ${comment.author}\n` +
    `*Message:*\n${comment.text}\n\n` +
    `[View Workroom](https://terms.law/TermsDocs/secure-ax7k9m2/)`;

  try {
    await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: TELEGRAM_CHAT_ID,
        text: message,
        parse_mode: 'Markdown',
        disable_web_page_preview: true
      })
    });
    console.log('Telegram notification sent');
  } catch (err) {
    console.error('Telegram notification failed:', err);
  }
}

// Send email notification via EmailJS (free tier)
async function sendEmailNotification(comment) {
  // Using EmailJS - you'll need to set up an account at emailjs.com
  // For now, this is a placeholder that logs the attempt
  console.log('Email notification would be sent to:', NOTIFICATION_EMAIL);

  // If you set up EmailJS, uncomment and configure:
  /*
  try {
    await emailjs.send('service_id', 'template_id', {
      to_email: NOTIFICATION_EMAIL,
      from_name: comment.author,
      message: comment.text,
      workroom: WORKROOM_NAME
    });
  } catch (err) {
    console.error('Email notification failed:', err);
  }
  */
}

// Get/save user name
function getUserName() {
  const nameInput = document.getElementById('commentName');
  const saved = localStorage.getItem('workroom_username');
  if (saved && nameInput) {
    nameInput.value = saved;
  }
  return nameInput ? nameInput.value.trim() : 'Guest';
}

function saveUserName(name) {
  localStorage.setItem('workroom_username', name);
}

// Submit a comment
function submitComment() {
  const input = document.getElementById('commentInput');
  const nameInput = document.getElementById('commentName');
  const text = input.value.trim();
  const authorName = nameInput.value.trim() || 'Guest';

  if (!text) return;
  if (!authorName) {
    nameInput.focus();
    nameInput.style.borderColor = '#dc2626';
    setTimeout(() => { nameInput.style.borderColor = ''; }, 2000);
    return;
  }

  // Save name for next time
  saveUserName(authorName);

  const comment = {
    author: authorName,
    text: text,
    timestamp: Date.now(),
    isClient: true
  };

  // Save to Firebase
  workroomRef.child('comments').push(comment)
    .then(() => {
      input.value = '';

      // Send notifications
      sendTelegramNotification(comment);
      sendEmailNotification(comment);

      // Show confirmation
      const btn = document.getElementById('commentSubmit');
      btn.textContent = 'Sent ‚úì';
      btn.style.background = '#166534';
      setTimeout(() => {
        btn.textContent = 'Send';
        btn.style.background = '';
      }, 1500);
    })
    .catch(err => {
      console.error('Failed to save comment:', err);
      alert('Failed to send. Please try again.');
    });
}

// Render a single comment
function renderComment(data, key) {
  const comment = data;
  const time = new Date(comment.timestamp);
  const timeStr = time.toLocaleString('en-US', {
    month: 'short', day: 'numeric',
    hour: 'numeric', minute: '2-digit',
    hour12: true
  });

  const isSergei = !comment.isClient;
  const initials = isSergei ? 'ST' : (comment.author ? comment.author.charAt(0).toUpperCase() : 'G');
  const avatarClass = isSergei ? 'comment-avatar sergei' : 'comment-avatar';

  // Only show edit/delete for client comments (not Sergei's)
  const actionsHtml = comment.isClient ? `
    <div class="comment-actions">
      <button class="comment-action-btn" onclick="editComment('${key}')">Edit</button>
      <button class="comment-action-btn delete" onclick="deleteComment('${key}')">Delete</button>
    </div>
  ` : '';

  return `
    <div class="comment-item" data-key="${key}">
      <div class="${avatarClass}">${initials}</div>
      <div class="comment-content" style="flex: 1;">
        <div class="comment-meta" style="display: flex; align-items: center;">
          <span class="comment-author">${isSergei ? 'Sergei Tokmakov' : escapeHtml(comment.author)}</span>
          <span class="comment-time">${timeStr}</span>
          ${actionsHtml}
        </div>
        <div class="comment-text" id="comment-text-${key}">${escapeHtml(comment.text)}</div>
        <div class="comment-edit-area" id="comment-edit-${key}" style="display: none;"></div>
      </div>
    </div>
  `;
}

// Edit a comment
function editComment(key) {
  // Get the comment text element and edit area
  const textEl = document.getElementById(`comment-text-${key}`);
  const editArea = document.getElementById(`comment-edit-${key}`);

  if (!textEl || !editArea) return;

  // Get current text (strip HTML)
  const currentText = textEl.innerText;

  // Show edit UI
  textEl.style.display = 'none';
  editArea.style.display = 'flex';
  editArea.innerHTML = `
    <textarea class="comment-edit-input" id="edit-input-${key}">${currentText}</textarea>
    <div class="comment-edit-actions">
      <button class="comment-edit-save" onclick="saveEditedComment('${key}')">Save</button>
      <button class="comment-edit-cancel" onclick="cancelEdit('${key}')">Cancel</button>
    </div>
  `;

  // Focus the textarea
  document.getElementById(`edit-input-${key}`).focus();
}

// Save edited comment
function saveEditedComment(key) {
  const input = document.getElementById(`edit-input-${key}`);
  const newText = input.value.trim();

  if (!newText) return;

  // Update in Firebase
  workroomRef.child('comments').child(key).update({
    text: newText,
    edited: true,
    editedAt: Date.now()
  }).then(() => {
    // UI will update automatically via listener
  }).catch(err => {
    console.error('Failed to update comment:', err);
    alert('Failed to save. Please try again.');
  });
}

// Cancel edit
function cancelEdit(key) {
  const textEl = document.getElementById(`comment-text-${key}`);
  const editArea = document.getElementById(`comment-edit-${key}`);

  textEl.style.display = '';
  editArea.style.display = 'none';
  editArea.innerHTML = '';
}

// Delete a comment
function deleteComment(key) {
  if (!confirm('Delete this comment?')) return;

  workroomRef.child('comments').child(key).remove()
    .then(() => {
      // UI will update automatically via listener
    })
    .catch(err => {
      console.error('Failed to delete comment:', err);
      alert('Failed to delete. Please try again.');
    });
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML.replace(/\n/g, '<br>');
}

// Load and listen for comments
function setupCommentsSync() {
  workroomRef.child('comments').on('value', (snapshot) => {
    const comments = snapshot.val();
    const list = document.getElementById('commentsList');
    const noComments = document.getElementById('noComments');

    if (!comments) {
      list.innerHTML = '<div class="no-comments" id="noComments">No comments yet. Be the first to leave a note!</div>';
      return;
    }

    // Sort by timestamp and render
    const sorted = Object.entries(comments).sort((a, b) => a[1].timestamp - b[1].timestamp);
    let html = '';
    sorted.forEach(([key, data]) => {
      html += renderComment(data, key);
    });

    list.innerHTML = html;

    // Scroll to bottom of comments
    list.scrollTop = list.scrollHeight;
  });
}

// Allow Enter+Shift for new line, Enter alone to submit
document.addEventListener('DOMContentLoaded', function() {
  const commentInput = document.getElementById('commentInput');
  if (commentInput) {
    commentInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitComment();
      }
    });
  }
});

document.addEventListener('DOMContentLoaded', function() {
  checkAuth();
  document.getElementById('doc-sla').classList.add('expanded');
  setupRealtimeSync();
  setupCommentsSync();

  // Load saved username from localStorage
  getUserName();

  document.querySelectorAll('.feedback-select').forEach(sel => {
    sel.addEventListener('change', function() {
      updateSelectStyle(this);
    });
  });

  // Auto-save editable content on input (preserves formatting)
  document.querySelectorAll('.editable-content[data-field]').forEach(el => {
    el.addEventListener('input', function() {
      saveEditableContent(this);
    });
  });
});
</script>

</div><!-- end main-content -->

</body>
</html>
