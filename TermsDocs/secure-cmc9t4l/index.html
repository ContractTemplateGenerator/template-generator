<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>CMC v. Federal Realty — Contract Review | Terms.Law</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    :root {
      --primary: #1a2e44;
      --primary-light: #2d4a6f;
      --accent: #0891b2;
      --accent-light: #22d3ee;
      --bg: #fafaf9;
      --text: #1c1917;
      --text-muted: #78716c;
      --border: #e7e5e4;
      --surface: #ffffff;
      --highlight-original: #fef3c7;
      --highlight-suggested: #d1fae5;
      --highlight-border-original: #f59e0b;
      --highlight-border-suggested: #10b981;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    /* Confidential Bar */
    .confidential-bar {
      background: var(--primary);
      color: white;
      text-align: center;
      padding: 8px;
      font-size: 0.7rem;
      letter-spacing: 1px;
      font-weight: 500;
    }

    .security-notice {
      background: #fef3c7;
      border-bottom: 1px solid #fde68a;
      padding: 12px 24px;
    }
    .security-notice-inner {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.8rem;
      color: #92400e;
    }
    .shield-icon { font-size: 1.2rem; }

    .header {
      background: white;
      color: var(--primary);
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
    }
    .header-inner {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .attorney-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .site-link {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-decoration: none;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .site-link:hover {
      color: var(--primary);
    }
    .attorney-name {
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary);
    }
    .bar-link {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-decoration: none;
    }
    .bar-link:hover {
      color: var(--primary);
      text-decoration: underline;
    }
    .header-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* NDA Upload Section */
    .nda-section {
      background: #fefce8;
      border: 1px solid #fde047;
      border-radius: 12px;
      margin: 24px;
      max-width: 1600px;
      margin-left: auto;
      margin-right: auto;
    }
    .nda-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
    }
    .nda-header:hover {
      background: rgba(253, 224, 71, 0.2);
      border-radius: 12px 12px 0 0;
    }
    .nda-header h3 {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 1.1rem;
      color: var(--primary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nda-toggle {
      font-size: 1.2rem;
      color: var(--primary);
      transition: transform 0.2s;
    }
    .nda-section.expanded .nda-toggle {
      transform: rotate(180deg);
    }
    .nda-content {
      display: none;
      padding: 0 20px 20px;
    }
    .nda-section.expanded .nda-content {
      display: block;
    }
    .nda-upload-zone {
      border: 2px dashed #d4d4d4;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nda-upload-zone:hover, .nda-upload-zone.dragover {
      border-color: var(--accent);
      background: #ecfeff;
    }
    .nda-upload-zone.has-file {
      border-style: solid;
      border-color: #22c55e;
      background: #f0fdf4;
    }
    .nda-upload-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }
    .nda-upload-text {
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .nda-upload-hint {
      font-size: 0.8rem;
      color: #a1a1aa;
    }
    .nda-file-input {
      display: none;
    }
    .nda-preview {
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .nda-preview-header {
      background: #f5f5f4;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .nda-filename {
      font-weight: 600;
      color: var(--primary);
    }
    .nda-canvas-container {
      max-height: 500px;
      overflow-y: auto;
      padding: 20px;
      background: #e5e5e5;
    }
    .nda-canvas-container canvas {
      display: block;
      margin: 0 auto 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .nda-sign-section {
      padding: 20px;
      border-top: 1px solid var(--border);
      background: #fafafa;
    }
    .nda-sign-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3);
      transition: all 0.2s;
    }
    .nda-sign-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }
    .nda-sign-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .nda-sign-btn.signed {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    .nda-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    .nda-download-btn {
      flex: 1;
      padding: 12px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid var(--primary);
      background: white;
      color: var(--primary);
      transition: all 0.2s;
    }
    .nda-download-btn:hover {
      background: var(--primary);
      color: white;
    }
    .nda-download-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .nda-status {
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      margin-top: 16px;
      font-weight: 500;
    }
    .nda-status.signed {
      background: #dcfce7;
      color: #166534;
    }

    .welcome-banner {
      background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);
      border-bottom: 1px solid #a5f3fc;
      padding: 20px 24px;
      position: relative;
    }
    .welcome-banner.hidden {
      display: none;
    }
    .welcome-inner {
      max-width: 1600px;
      margin: 0 auto;
      position: relative;
      padding-right: 40px;
    }
    .banner-close {
      position: absolute;
      top: 0;
      right: 0;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--primary);
      cursor: pointer;
      opacity: 0.5;
      padding: 0;
      line-height: 1;
    }
    .banner-close:hover {
      opacity: 1;
    }
    .welcome-banner h2 {
      font-family: 'Crimson Pro', Georgia, serif;
      color: var(--primary);
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    .welcome-banner p {
      color: #0e7490;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .layout {
      display: grid;
      grid-template-columns: 420px 1fr;
      max-width: 1600px;
      margin: 0 auto;
      min-height: calc(100vh - 200px);
    }
    @media (max-width: 1100px) {
      .layout { grid-template-columns: 1fr; }
      .preview-panel { display: none; }
    }

    .redline-panel {
      background: var(--surface);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      max-height: calc(100vh - 140px);
      position: sticky;
      top: 0;
    }

    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: #f8fafc;
    }
    .panel-header h3 {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    .panel-header p {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .redline-list {
      padding: 12px;
    }

    .redline-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .redline-item:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(8, 145, 178, 0.1);
    }
    .redline-item.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.15);
    }

    .redline-header {
      padding: 14px 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .redline-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      font-size: 0.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .redline-info { flex: 1; }
    .redline-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text);
      margin-bottom: 4px;
    }
    .redline-section {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .priority-badge {
      font-size: 0.65rem;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 20px;
      text-transform: uppercase;
    }
    .priority-high { background: #fef2f2; color: #b91c1c; }
    .priority-medium { background: #fffbeb; color: #b45309; }
    .priority-low { background: #ecfeff; color: #0891b2; }

    .category-badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
      background: #f1f5f9;
      color: #475569;
      margin-top: 4px;
      display: inline-block;
    }
    .category-divider {
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 8px 0;
      border-radius: 6px;
    }

    .redline-body {
      padding: 0 16px 14px 56px;
      display: none;
    }
    .redline-item.expanded .redline-body { display: block; }

    .toggle-group {
      display: flex;
      gap: 0;
      margin-bottom: 12px;
      background: #f1f5f9;
      border-radius: 6px;
      padding: 3px;
    }
    .toggle-btn {
      flex: 1;
      padding: 6px 12px;
      border: none;
      background: transparent;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s ease;
    }
    .toggle-btn.active {
      background: white;
      color: var(--text);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .toggle-btn.original-btn.active { color: #b45309; }
    .toggle-btn.suggested-btn.active { color: #059669; }

    .text-box {
      padding: 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      line-height: 1.6;
      margin-bottom: 10px;
    }
    .text-original {
      background: var(--highlight-original);
      border-left: 3px solid var(--highlight-border-original);
    }
    .text-suggested {
      background: var(--highlight-suggested);
      border-left: 3px solid var(--highlight-border-suggested);
    }
    .text-hidden { display: none; }

    .rationale {
      background: #f0f9ff;
      border-radius: 8px;
      padding: 14px 16px;
      font-size: 0.85rem;
      color: #334155;
      line-height: 1.6;
      margin-bottom: 14px;
      border-left: 3px solid var(--accent);
    }
    .rationale strong {
      color: var(--primary);
      display: block;
      margin-bottom: 6px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .comparison-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 8px;
    }

    .decision-section {
      margin-top: 16px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }
    .decision-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 10px;
    }
    .decision-btns {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .decision-btn {
      flex: 1;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: 2px solid var(--border);
      background: white;
      color: var(--text-muted);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .decision-btn:hover {
      border-color: #94a3b8;
    }
    .decision-btn.accept {
      border-color: #22c55e;
      background: #f0fdf4;
      color: #15803d;
    }
    .decision-btn.accept:hover {
      background: #dcfce7;
    }
    .decision-btn.reject {
      border-color: #f97316;
      background: #fff7ed;
      color: #c2410c;
    }
    .decision-btn.reject:hover {
      background: #ffedd5;
    }
    .decision-btn.selected {
      box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
    }
    .decision-btn.accept.selected {
      background: #22c55e;
      color: white;
    }
    .decision-btn.reject.selected {
      background: #f97316;
      color: white;
    }

    .comment-box {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.8rem;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
      transition: border-color 0.2s;
    }
    .comment-box:focus {
      outline: none;
      border-color: var(--accent);
    }
    .comment-box::placeholder {
      color: #94a3b8;
    }

    .save-status {
      font-size: 0.7rem;
      color: #22c55e;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .save-status.visible {
      opacity: 1;
    }

    .sync-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border-radius: 8px;
      padding: 10px 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    .sync-indicator.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .sync-indicator.synced { color: #22c55e; }
    .sync-indicator.syncing { color: #f59e0b; }
    .sync-indicator.error { color: #ef4444; }

    .preview-panel {
      background: var(--bg);
      padding: 24px;
      overflow-y: auto;
      max-height: calc(100vh - 140px);
    }

    .preview-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .preview-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .preview-actions {
      display: flex;
      gap: 8px;
    }
    .btn {
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      transition: all 0.15s ease;
    }
    .btn:hover { border-color: var(--accent); color: var(--accent); }

    .document-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .document-header {
      background: var(--primary);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .document-title {
      color: white;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .document-status {
      font-size: 0.7rem;
      color: var(--accent-light);
    }

    .document-body {
      padding: 40px 50px;
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 13px;
      line-height: 1.8;
      color: #1f2937;
    }

    .doc-title {
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 20px;
    }
    .doc-section {
      margin-bottom: 16px;
    }
    .doc-section-num {
      font-weight: bold;
    }
    .doc-paragraph {
      margin-bottom: 12px;
      text-align: justify;
    }
    .doc-exhibit-title {
      font-weight: bold;
      font-size: 14px;
      margin: 24px 0 12px 0;
      text-transform: uppercase;
    }
    .doc-list {
      margin: 8px 0 8px 24px;
    }
    .doc-list li {
      margin-bottom: 6px;
    }

    .highlight-section {
      transition: all 0.3s ease;
      border-radius: 4px;
      padding: 2px 4px;
      margin: -2px -4px;
    }
    .highlight-section.original-mode {
      background: var(--highlight-original);
      border-bottom: 2px solid var(--highlight-border-original);
    }
    .highlight-section.suggested-mode {
      background: var(--highlight-suggested);
      border-bottom: 2px solid var(--highlight-border-suggested);
    }
    .highlight-section.flash {
      animation: flashHighlight 1.5s ease;
    }
    @keyframes flashHighlight {
      0%, 100% { box-shadow: 0 0 0 0 rgba(8, 145, 178, 0); }
      25%, 75% { box-shadow: 0 0 0 8px rgba(8, 145, 178, 0.3); }
    }

    .signature-block {
      margin-top: 40px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
    }
    .signature-col {
      border-top: 1px solid #000;
      padding-top: 8px;
    }

    .footer {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 0.8rem;
      border-top: 1px solid var(--border);
    }
    .footer a { color: var(--primary); text-decoration: none; }

    body.locked {
      overflow: hidden;
    }

    .password-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 9999;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .password-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .password-modal {
      width: 100%;
      max-width: 420px;
      background: var(--surface);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
      text-align: center;
    }
    .password-modal h2 {
      font-family: 'Crimson Pro', Georgia, serif;
      color: var(--primary);
      margin-bottom: 12px;
      font-size: 1.4rem;
    }
    .password-modal p {
      color: var(--text-muted);
      font-size: 0.95rem;
      margin-bottom: 18px;
    }
    .password-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 1rem;
      letter-spacing: 0.05em;
      color: var(--text);
      margin-bottom: 12px;
    }
    .password-button {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: white;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .password-button:hover {
      background: var(--accent-light);
    }
    .password-error {
      display: none;
      color: #b91c1c;
      font-size: 0.85rem;
      margin-top: 10px;
    }
    .password-error.visible {
      display: block;
    }
  </style>
</head>
<body class="locked">

<div class="password-overlay" id="passwordOverlay" role="dialog" aria-modal="true">
  <div class="password-modal">
    <h2>Secure client workroom</h2>
    <p>Please enter the access password to continue.</p>
    <form id="passwordForm">
      <input type="text" id="passwordInput" class="password-input" value="Sw!ghey5" autocomplete="off" autofocus>
      <button type="submit" class="password-button">Unlock Workroom</button>
      <div class="password-error" id="passwordError">Incorrect password. Please try again.</div>
    </form>
  </div>
</div>

<div class="confidential-bar">
  PRIVILEGED & CONFIDENTIAL — ATTORNEY WORK PRODUCT
</div>

<div class="security-notice">
  <div class="security-notice-inner">
    <span class="shield-icon">&#128737;</span>
    <div><strong>Secure Client Workroom</strong> — This page is not indexed by search engines. Only those with the direct link and password can access it. Documents and communications here are protected by attorney-client privilege.</div>
  </div>
</div>

<header class="header">
  <div class="header-inner">
    <div class="attorney-info">
      <a href="https://terms.law" target="_blank" class="site-link">Terms.Law</a>
      <span class="attorney-name">Sergei Tokmakov, Esq.</span>
      <a href="https://apps.calbar.ca.gov/attorney/Licensee/Detail/279869" target="_blank" class="bar-link">California Bar No. 279869</a>
    </div>
    <div class="header-meta">
      Workroom CMC-9t4l
    </div>
  </div>
</header>

<div class="welcome-banner" id="welcomeBanner">
  <div class="welcome-inner">
    <h2>Toni, here's your contract review for the Federal Realty Trash Pad License</h2>
    <p>I've identified <strong>11 key issues</strong> that need attention before CMC signs. Click any item below to see the problem and compare Federal Realty's language to my suggestion.</p>
    <button class="banner-close" onclick="closeBanner()" title="Close">&times;</button>
  </div>
</div>

<div class="layout">
  <aside class="redline-panel">
    <div class="panel-header">
      <h3>Recommended Amendments</h3>
      <p>Click each item to view changes and scroll to the provision</p>
    </div>
    <div class="redline-list" id="redlineList">
      <!-- Populated by JS -->
    </div>
  </aside>

  <main class="preview-panel">
    <div class="preview-toolbar">
      <span class="preview-title">Trash Pad License Agreement — Federal Realty</span>
      <div class="preview-actions">
        <button class="btn" onclick="downloadWord()">Download Original</button>
      </div>
    </div>
    <div class="document-container">
      <div class="document-header">
        <span class="document-title">Trash Pad License and Agreement</span>
        <span class="document-status">Under Review</span>
      </div>
      <div class="document-body" id="documentBody">

        <div class="doc-title">TRASH PAD LICENSE AND AGREEMENT</div>

        <p class="doc-paragraph">THIS TRASH PAD LICENSE AND AGREEMENT ("Agreement") is made as of _________ (the "Effective Date") by and between <strong>FEDERAL REALTY OP LP</strong>, a Delaware limited partnership ("Grantor") and <strong>COMPACTOR MANAGEMENT COMPANY, LLC</strong>, a California limited liability company ("Licensee").</p>

        <p class="doc-paragraph">IN CONSIDERATION of the mutual promises, agreements and consideration contained herein, Grantor and Licensee agree as follows:</p>

        <div class="doc-section" id="section-1">
          <p class="doc-paragraph"><span class="doc-section-num">1. LICENSE.</span> Grantor hereby grants to Licensee an exclusive, non-transferable, license to occupy and use, subject to the stated terms and conditions herein, certain portions, as shown cross-hatched on the attached Exhibit A (the "Licensed Premises"), of that shopping development commonly known as Santana Row (the "Project") in San Jose, California. Licensee does not and shall not claim any interest or estate of any kind in the Licensed Premises by virtue of this Agreement or its occupancy or use under this Agreement.</p>
        </div>

        <div class="doc-section" id="section-2">
          <p class="doc-paragraph"><span class="doc-section-num">2. USE.</span> The Licensed Premises shall be used solely for the purpose of supplying waste and recycling equipment as described in Exhibit C in the Licensed Premises as shown on Exhibit A ("Equipment") for use by those tenants of the Center whose leases require such tenants to contract for waste disposal with a contractor of Landlord's choosing or other tenants who voluntarily agree to participate as listed on Exhibit D ("Serviced Tenant(s)") by placing compactors on the Licensed Premises (the "Use"). Licensee must obtain and comply with all governmental permits. Licensee shall not use, suffer or permit any use of the Licensed Premises for any purpose other than the Use or in any manner that would be unprofessional or would violate any law, ordinance, rule or regulation.</p>
        </div>

        <div class="doc-section" id="section-3">
          <p class="doc-paragraph"><span class="doc-section-num">3. TERM.</span> Licensee shall occupy and use the Licensed Premises for the Use commencing on the Effective Date and continuing until _________ ("Term"). This Agreement shall automatically renew for period(s) of one (1) year unless and until either party gives written notice, to the non-terminating party, of its intent to terminate the Agreement no later than ninety (90) days before the end of that Term.</p>
        </div>

        <div class="doc-section" id="section-4">
          <p class="doc-paragraph"><span class="doc-section-num">4. PAD LICENSE FEE.</span> Within thirty (30) days of the last day of each calendar month during the Term, Licensee shall pay to Grantor, in consideration of Licensee's use of the Licensed Premises an amount equal to <strong>EIGHT THOUSAND AND FIVE HUNDRED DOLLARS ($8,500)</strong> per month ("License Fee"). The License Fee shall increase on the last day in January of each year during Term by an amount equal to <strong>five percent (5%)</strong> of License Fee payable as of that date. Licensee has a five (5) day grace period to cure any late payment, and if Licensee fails to make such payment, after the five (5) day grace period, Licensee shall pay a late fee to Grantor in the amount of Two Hundred Fifty and 00/100 Dollars ($250.00).</p>
          <p class="doc-paragraph" id="section-4-pricing"><span class="highlight-section original-mode" data-redline="2" data-original="Licensee shall not charge above prevailing market rates as determined by Grantor. Licensee shall not increase charges to Serviced Tenants without prior written consent of Grantor's Vice President. Any violation shall constitute a default with no notice or cure period required, and Licensee shall pay $100 per day penalty until corrected." data-suggested="Licensee may adjust tenant rates annually by the lesser of CPI or 5%, plus documented hauler pass-throughs. No approval needed for pass-throughs with documentation; 60 days' notice to tenants. If any violation, Grantor gives written notice and Licensee has 10 business days to reverse and issue credits.">Licensee may adjust tenant rates annually by the lesser of CPI or 5%, plus documented hauler pass-throughs. No approval needed for pass-throughs with documentation; 60 days' notice to tenants. If any violation, Grantor gives written notice and Licensee has 10 business days to reverse and issue credits.</span></p>
        </div>

        <div class="doc-section" id="section-5">
          <p class="doc-paragraph"><span class="doc-section-num">5. LICENSEE'S SERVICES.</span> Licensee shall provide the services and maintain the equipment as described in Exhibit B. Licensee shall bill the Serviced Tenants and the Grantor for its services rendered pursuant to this Agreement as provided in Exhibit B.</p>
        </div>

        <div class="doc-section" id="section-6">
          <p class="doc-paragraph"><span class="doc-section-num">6. LICENSEE'S DUTY TO REPORT ACTIVITY.</span> Licensee shall provide annual comprehensive reports to Grantor detailing the annual trash and recycling tonnage collected for the Licensed Premises within sixty (60) days of each calendar year. If tonnage data is unavailable, Licensee shall provide Grantor with a report containing a list of all containers servicing the property, waste type collected per container, frequency of pickup per container, and size of container within sixty (60) days of the end of each calendar year. Further, Licensee shall timely complete all required reporting on Grantor's behalf to any applicable jurisdiction, if required by law to make such reporting ("Jurisdiction Mandated Reporting").</p>
          <p class="doc-paragraph" id="section-6-reporting"><span class="highlight-section original-mode" data-redline="5" data-original="The cost of any fines, penalties, or other repercussions for Grantor's failure to make Jurisdiction Mandated Reporting shall be borne solely by Licensee." data-suggested="Fines and penalties shall be borne by Licensee to the extent caused by Licensee's failure to provide timely, accurate data. Grantor shall cooperate and timely provide data/access required for reporting.">Fines and penalties shall be borne by Licensee to the extent caused by Licensee's failure to provide timely, accurate data. Grantor shall cooperate and timely provide data/access required for reporting.</span></p>
        </div>

        <div class="doc-section" id="section-7">
          <p class="doc-paragraph"><span class="doc-section-num">7. TERMINATION.</span> <span class="highlight-section original-mode" data-redline="1" data-original="Grantor shall have the right to terminate the Agreement at any time, in its sole and absolute discretion, by giving Licensee no less than thirty (30) days written notice. Any items not removed by Licensee after the Expiration Date shall, at the option of Grantor and without notice to Licensee, be deemed abandoned." data-suggested="Grantor may terminate this Agreement for convenience only after the first twenty-four (24) months of the Term, upon not less than one hundred eighty (180) days' prior written notice. If Grantor terminates for convenience, Grantor shall reimburse Licensee for (a) the unamortized, documented out-of-pocket cost of the Work approved by Grantor, amortized straight-line over forty-eight (48) months, plus (b) reasonable, documented removal/relocation costs. Licensee may terminate this Agreement upon thirty (30) days' written notice if Grantor materially breaches and fails to cure within the applicable cure period.">Grantor may terminate this Agreement for convenience only after the first twenty-four (24) months of the Term, upon not less than one hundred eighty (180) days' prior written notice. If Grantor terminates for convenience, Grantor shall reimburse Licensee for (a) the unamortized, documented out-of-pocket cost of the Work approved by Grantor, amortized straight-line over forty-eight (48) months, plus (b) reasonable, documented removal/relocation costs. Licensee may terminate this Agreement upon thirty (30) days' written notice if Grantor materially breaches and fails to cure within the applicable cure period.</span></p>
        </div>

        <div class="doc-section" id="section-8">
          <p class="doc-paragraph"><span class="doc-section-num">8. CONDITION OF LICENSED PREMISES.</span> Licensee accepts the Licensed Premises in "as is" condition and agrees that Grantor has no obligation to improve or repair the Licensed Premises unless specifically set forth herein.</p>
          <p class="doc-paragraph" id="section-8-work"><span class="highlight-section original-mode" data-redline="1" data-original="Work requires Owner's prior written approval. Items not removed deemed abandoned at Grantor's option." data-suggested="Owner approval of Work shall not be unreasonably withheld, and Owner shall respond within 10 business days (failure to respond = deemed approval). If terminated for convenience before month 36, Grantor reimburses unamortized Work costs.">Owner approval of Work shall not be unreasonably withheld, and Owner shall respond within 10 business days (failure to respond = deemed approval). If terminated for convenience before month 36, Grantor reimburses unamortized Work costs.</span></p>
        </div>

        <div class="doc-section" id="section-9">
          <p class="doc-paragraph"><span class="doc-section-num">9. DEFAULTS.</span> <span class="highlight-section original-mode" data-redline="3" data-original="Grantor may terminate this Agreement with forty-eight (48) hours notice upon any default by Licensee. Upon termination, Grantor may take possession of all improvements, equipment, fixtures and inventory located on the Licensed Premises." data-suggested="Monetary default: 10 days to cure after notice. Non-monetary: 30 days to cure (extended if diligently curing). Grantor may terminate only after uncured default. Grantor shall have no right to seize or retain Licensee-owned equipment, inventory, or personal property. Licensee has 30 days after termination to remove property.">Monetary default: 10 days to cure after notice. Non-monetary: 30 days to cure (extended if diligently curing). Grantor may terminate only after uncured default. Grantor shall have no right to seize or retain Licensee-owned equipment, inventory, or personal property. Licensee has 30 days after termination to remove property.</span></p>
        </div>

        <div class="doc-section" id="section-10">
          <p class="doc-paragraph"><span class="doc-section-num">10. INSURANCE.</span> Licensee, at its own expense, shall obtain, pay for and keep in force at all times during the performance of the Services and, if applicable, the Work, the following insurance coverages placed with Insurance Companies having a minimum A.M. Best rating of A- VII or better:</p>
          <ul class="doc-list">
            <li>(a) Workers' Compensation Insurance as required by the laws of the State in which the Project is located.</li>
            <li>(b) Employer's Liability Insurance with limits of liability not less than $500,000 each accident.</li>
            <li>(c) Automobile Liability Insurance with combined single limit for bodily injury or property damage of not less than One Million Dollars ($1,000,000) per occurrence.</li>
            <li>(d) All-risk property damage insurance in an amount adequate to cover the cost of replacement of all contents and personal property.</li>
            <li>(e) Commercial General Liability Insurance with limits of not less than One Million Dollars ($1,000,000) per occurrence and Two Million Dollars ($2,000,000) aggregate.</li>
            <li id="section-10-umbrella">(f) Excess or Umbrella Liability Insurance on a follow-form basis with limits of liability not less than $5,000,000 per occurrence.</li>
          </ul>
          <p class="doc-paragraph"><span class="highlight-section original-mode" data-redline="8" data-original="Failure to maintain insurance as required herein shall constitute a material breach of this Agreement. Grantor may terminate this Agreement immediately without notice to cure." data-suggested="Failure to maintain insurance is material breach; provided Grantor shall give written notice and Licensee has 10 business days to cure before termination, except for immediate safety risks.">Failure to maintain insurance is material breach; provided Grantor shall give written notice and Licensee has 10 business days to cure before termination, except for immediate safety risks.</span></p>
        </div>

        <div class="doc-section" id="section-11">
          <p class="doc-paragraph"><span class="doc-section-num">11. INDEMNITY.</span> <span class="highlight-section original-mode" data-redline="7" data-original="Except for liability arising solely from the indemnified parties' negligence, Licensee will defend, indemnify and hold harmless Grantor, its partners, members, officers, directors, employees, agents and contractors from and against any and all claims, damages, losses and expenses arising out of or resulting from Licensee's use of the Licensed Premises." data-suggested="Licensee indemnifies to the extent claims arise from Licensee's negligence or willful misconduct. No indemnity to the extent caused by Grantor/tenant negligence or pre-existing site conditions not introduced by Licensee.">Licensee indemnifies to the extent claims arise from Licensee's negligence or willful misconduct. No indemnity to the extent caused by Grantor/tenant negligence or pre-existing site conditions not introduced by Licensee.</span></p>
        </div>

        <div class="doc-section" id="section-12">
          <p class="doc-paragraph"><span class="doc-section-num">12. MAINTENANCE OF LICENSED PREMISES.</span> Licensee shall maintain the Licensed Premises and every part thereof, at its own expense, in good order and repair, and in an attractive and clean condition. Grantor has no obligation to maintain or repair the Licensed Premises unless specifically set forth herein. If Licensee fails to perform its obligations hereunder, Grantor may, at its option and upon 30 days' prior written notice to Licensee, perform such obligations on Licensee's behalf and charge the cost thereof back to Licensee together with an administrative fee equal to twenty percent (20%) of such costs.</p>
        </div>

        <div class="doc-section" id="section-13">
          <p class="doc-paragraph"><span class="doc-section-num">13. END OF TERM.</span> Upon the Expiration Date or earlier termination of this Agreement, Licensee shall deliver up and surrender to Grantor possession of the Licensed Premises in at least as good condition and repair as the same shall be in as of the Commencement Date, ordinary wear and tear excepted. Licensee shall remove all of Licensee's personal property from the Licensed Premises. <span class="highlight-section original-mode" data-redline="1" data-original="Any items not removed by Licensee after the Expiration Date shall, at the option of Grantor and without notice to Licensee, be deemed abandoned and become the property of Grantor." data-suggested="Grantor shall provide 30 days' written notice before deeming any property abandoned; Licensee-owned Equipment remains Licensee's property.">Grantor shall provide 30 days' written notice before deeming any property abandoned; Licensee-owned Equipment remains Licensee's property.</span></p>
        </div>

        <div class="doc-section" id="section-14">
          <p class="doc-paragraph"><span class="doc-section-num">14. TAXES.</span> Licensee shall be solely responsible for filing all necessary tax information and reports to federal, state and local taxing authorities, including applicable workers compensation taxes.</p>
        </div>

        <div class="doc-section" id="section-15">
          <p class="doc-paragraph"><span class="doc-section-num">15. SECURITY DEPOSIT.</span> <span class="highlight-section original-mode" data-redline="4" data-original="Security Deposit shall equal three (3) months' License Fee ($25,500) or $10,000, whichever is greater. Licensee shall replenish the Security Deposit within five (5) days of any draw. Licensee must request return of Security Deposit within sixty (60) days of Term end or waive all claims thereto." data-suggested="Deposit = 1x monthly License Fee ($8,500). Replenish within 20 days after notice. Return within 30 days after Term end with itemized deductions. No waiver trap.">Deposit = 1x monthly License Fee ($8,500). Replenish within 20 days after notice. Return within 30 days after Term end with itemized deductions. No waiver trap.</span></p>
        </div>

        <div class="doc-section" id="section-16">
          <p class="doc-paragraph"><span class="doc-section-num">16. NOTICE.</span> Any notice or other communication which any party may desire or be required to give to any other party shall be in writing and shall be sent by overnight courier (e.g., FedEx, UPS, DHL), or by certified mail to the other party, return receipt requested, to the addresses set forth below:</p>
          <p class="doc-paragraph">To Grantor: Federal Realty OP LP, 909 Rose Avenue, Suite 200, North Bethesda, Maryland 20852, Attention: Legal Department</p>
          <p class="doc-paragraph">Copy To: Santana Row, 356 Santana Row, Suite 1005, San Jose, CA 95128, Attention: General Manager</p>
          <p class="doc-paragraph">To Licensee: Compactor Management Company, LLC, [ADDRESS]</p>
        </div>

        <div class="doc-section" id="section-17">
          <p class="doc-paragraph"><span class="doc-section-num">17. ASSIGNMENT.</span> <span class="highlight-section original-mode" data-redline="10" data-original="The rights granted to Licensee are personal and Licensee shall not be permitted to assign this Agreement." data-suggested="Licensee may assign without consent to affiliates or successors (merger/sale of assets), with notice. Other assignments require Grantor consent, not unreasonably withheld.">Licensee may assign without consent to affiliates or successors (merger/sale of assets), with notice. Other assignments require Grantor consent, not unreasonably withheld.</span></p>
        </div>

        <div class="doc-section" id="section-18">
          <p class="doc-paragraph"><span class="doc-section-num">18. LIMITATION ON RIGHT OF RECOVERY.</span> Licensee agrees to look solely to the interest held by Grantor in the Project for the satisfaction of any claims arising out of this Agreement and shall not seek to impose personal liability on any shareholder, partner, member, trustee, officer, employee, representative or agent of Grantor. <span class="highlight-section original-mode" data-redline="9" data-original="Licensee agrees to look solely to the interest held by Grantor in the Project for the satisfaction of any claims arising out of this Agreement and shall not seek to impose personal liability on any shareholder, partner, member, trustee, officer, employee, representative or agent of Grantor." data-suggested="Non-recourse limitation shall not apply to: (a) Security Deposit return, (b) reimbursement obligations under this Agreement, or (c) fraud/willful misconduct.">Non-recourse limitation shall not apply to: (a) Security Deposit return, (b) reimbursement obligations under this Agreement, or (c) fraud/willful misconduct.</span></p>
        </div>

        <div class="doc-section" id="section-19">
          <p class="doc-paragraph"><span class="doc-section-num">19. LAWS.</span> This Agreement shall be governed by and construed in accordance with the laws of the State of California.</p>
        </div>

        <div class="doc-section" id="section-20">
          <p class="doc-paragraph"><span class="doc-section-num">20. WAIVER.</span> Waiver by Grantor of any breach of any term, covenant or condition herein contained shall not be deemed a waiver of any subsequent breach of the same or any other term, covenant or condition herein.</p>
        </div>

        <div class="doc-section" id="section-21">
          <p class="doc-paragraph"><span class="doc-section-num">21. ATTORNEY FEES.</span> If any action at law or in equity is necessary to enforce or interpret the terms of the Agreement or to regain possession of the Licensed Premises, the prevailing party shall be entitled to reasonable attorneys' fees, costs and necessary disbursement in addition to any other relief to which such party may be entitled.</p>
        </div>

        <div class="doc-section" id="section-22">
          <p class="doc-paragraph"><span class="doc-section-num">22. ENTIRE AGREEMENT.</span> Grantor and Licensee acknowledge that this Agreement, including any Exhibits, exclusively constitutes the complete and final agreement of Grantor and Licensee. Except as herein otherwise expressly provided, no subsequent alteration, amendment, change or addition to this Agreement shall be legally binding upon Grantor or Licensee unless reduced to writing and signed by them.</p>
        </div>

        <div class="signature-block">
          <div class="signature-col">
            <p><strong>GRANTOR:</strong></p>
            <p>FEDERAL REALTY OP LP</p>
            <p style="margin-top: 30px;">By: _________________________</p>
            <p>Name:</p>
            <p>Title:</p>
          </div>
          <div class="signature-col">
            <p><strong>LICENSEE:</strong></p>
            <p>COMPACTOR MANAGEMENT COMPANY, LLC</p>
            <p style="margin-top: 30px;">By: _________________________</p>
            <p>Name:</p>
            <p>Title:</p>
          </div>
        </div>

        <!-- EXHIBITS -->
        <p class="doc-exhibit-title" style="margin-top: 60px;">EXHIBIT A — Licensed Premises</p>
        <p class="doc-paragraph">[Diagram showing cross-hatched Licensed Premises at Santana Row]</p>

        <p class="doc-exhibit-title">EXHIBIT B — Licensee Services</p>

        <p class="doc-paragraph"><strong>1.</strong> Licensee agrees that all waste and recycling equipment (the "Equipment") outlined on Exhibit C shall be maintained at the sole cost and expense of Licensee. All Equipment must be maintained in first class condition and be fully operational at all times. All Equipment shall be clearly and effectively labeled to ensure that all refuse and recycling can be placed in the appropriate location and receptacle. Said maintenance and repair shall include but not be limited to painting, sanitizing, cleaning and serving such equipment, including the control box and pump attachment of each container and the electrical power. If Licensee fails to properly respond to a request from Grantor for maintenance within twenty-four (24) hours of telephonic notice, Grantor may hire another company to make the necessary repairs and Licensee will reimburse Grantor within fifteen (15) days of receipt of said invoice.</p>

        <p class="doc-paragraph"><strong>2.</strong> Licensee agrees to provide to Grantor all services outlined in the Licensee Procedures shown in Exhibit B-1. Licensee further agrees to manage all construction waste as a separate expense to be charged and invoiced to the tenants and/or Grantor requesting such service.</p>

        <p class="doc-paragraph"><strong>3.</strong> The Equipment will be emptied on a regular schedule as approved by Owner and on "as needed basis". Licensee agrees to empty Equipment within twelve (12) hours of receipt of notice from Grantor if said notice is received on or before 10:00 am. If notice is received after 10:00am, Licensee will empty the Equipment within twenty-four (24) hours.</p>

        <p class="doc-paragraph"><strong>4.</strong> Licensee agrees to only manage solid waste material and recyclables generated by Grantor and Serviced Tenants excluding radioactive, volatile, highly flammable, explosive, toxic, special or hazardous material other than such as may be used in the ordinary course of a Tenant's business.</p>

        <p class="doc-paragraph" id="exhibit-b-billing"><strong>5.</strong> Licensee shall be responsible for billing the individual tenants at a fair share rate for the total cost of waste service management. Grantor shall have no obligation to assist Licensee in collecting fees or charges from Serviced Tenants. The minimum charge is listed on Exhibit D. <span class="highlight-section original-mode" data-redline="2" data-original="Licensee shall not charge above prevailing market rates. Any violation shall constitute a default with no notice or cure period required, and Licensee shall pay $100 per day penalty until corrected." data-suggested="If any violation, Grantor gives written notice and Licensee has 10 business days to reverse and issue credits. No automatic default or $100/day penalties.">If any violation, Grantor gives written notice and Licensee has 10 business days to reverse and issue credits. No automatic default or $100/day penalties.</span></p>

        <p class="doc-paragraph"><strong>6.</strong> Licensee will provide waste removal and recycling education for all Serviced Tenants and Grantor at the Property at the beginning of the term and at necessary intervals or upon the request of Grantor.</p>

        <p class="doc-paragraph" id="exhibit-b-tenants"><strong>7.</strong> Licensee shall be responsible for all recycling, refuse collection and disposal services for all tenants at the Property obligated under their respective lease or occupancy agreements to use the contractor selected by the Grantor. <span class="highlight-section original-mode" data-redline="6" data-original="Licensee agrees not to enter into any separate contracts with tenants. If Licensee fails to invoice within 90 days of service, Licensee waives right to payment for such services." data-suggested="Licensee shall not enter into any agreement with a Serviced Tenant that conflicts with this Agreement or the applicable tenant's lease with Grantor; provided, however, that Licensee may use standard tenant-facing service acknowledgments, work orders, and billing terms consistent with this Agreement to facilitate the Services and collections.">Licensee shall not enter into any agreement with a Serviced Tenant that conflicts with this Agreement or the applicable tenant's lease with Grantor; provided, however, that Licensee may use standard tenant-facing service acknowledgments, work orders, and billing terms consistent with this Agreement to facilitate the Services and collections.</span> Licensee agrees to be on call twenty-four (24) hours per day for emergency service at no extra charge to Grantor.</p>

        <p class="doc-exhibit-title">EXHIBIT B-1 — Licensee Procedures</p>

        <p class="doc-paragraph"><strong>Personnel:</strong> A specific Staff Operations Manager will be assigned to assist the Shopping Center Agent and Serviced Tenants by Licensee. He or she will be the main contact at the Project for the duration of the Agreement. An Operations Staff phone directory will be provided in the "Introduction Package."</p>

        <p class="doc-paragraph"><strong>Portering Service:</strong> Licensee shall provide portering service of those pieces of Equipment listed in Exhibit C placed around the Project. Licensee will provide portering service seven days a week at reasonable times as to not interfere with Project operations, including: transporting bins to appropriate waste stream compactors, emptying bins and returning them to designated locations, managing fullness of each compactor, and visiting each trash room to ensure it is free of debris.</p>

        <p class="doc-paragraph"><strong>24-Hour Service:</strong> 24-Hour toll-free number and email address to be provided. All service requests for compactor pulls and repairs outside the scheduled Services should be called in to the 24-hour toll-free number by the Shopping Center Agent.</p>

        <p class="doc-paragraph"><strong>Hazardous Waste:</strong> Neither Serviced Tenants, Shopping Center Agent, nor anyone else is allowed to deposit any item considered to be Hazardous Waste into a container at the property. Serviced Tenants may make special request for Licensee to arrange the handling of such types of waste, and Licensee will bill the tenants directly for such disposal cost.</p>

        <p class="doc-paragraph"><strong>Recycling:</strong> Shopping Center Agent is to notify all Serviced Tenants that they must follow the recycling program as directed by Licensee. All services shall meet or exceed the present guidelines as managed or determined by local government agencies.</p>

        <p class="doc-paragraph" id="exhibit-b1-collection"><strong>Collection Procedures:</strong> The Licensee has established standard procedures for timely billing Serviced Tenants for the Services. Licensee will bill Serviced Tenants monthly for waste removal and recycling services. <span class="highlight-section original-mode" data-redline="6">90-day billing waiver doesn't apply for tenant disputes, missing data, or reconciliation issues.</span> Grantor shall have no obligation to assist Licensee in collecting of charges from Serviced Tenants.</p>

        <p class="doc-paragraph"><strong>Store Openings, Closings, Transfers and Expansions:</strong> Grantor will provide notices of store openings, closings, transfers, and expansions. Licensee will coordinate special waste disposal needs and bill directly for such services.</p>

        <p class="doc-exhibit-title">EXHIBIT C — Equipment List</p>
        <p class="doc-paragraph">[Equipment specifications to be attached]</p>

        <p class="doc-exhibit-title">EXHIBIT D — Serviced Tenants & Minimum Charges</p>
        <p class="doc-paragraph">[Tenant list with minimum monthly charges to be attached]</p>

        <p class="doc-exhibit-title">EXHIBIT E — Additional Insureds</p>
        <p class="doc-paragraph">Federal Realty OP LP, Federal Realty GP LLC, Federal Realty Investment Trust, Property Manager</p>

      </div>
    </div>
  </main>
</div>

<!-- NDA Upload & Sign Section -->
<div class="nda-section" id="ndaSection">
  <div class="nda-header" onclick="toggleNdaSection()">
    <h3>📄 Upload & Sign NDA</h3>
    <span class="nda-toggle">▼</span>
  </div>
  <div class="nda-content">
    <div class="nda-upload-zone" id="ndaUploadZone" onclick="document.getElementById('ndaFileInput').click()">
      <div class="nda-upload-icon">📤</div>
      <div class="nda-upload-text">Click to upload NDA or drag & drop</div>
      <div class="nda-upload-hint">PDF files only</div>
    </div>
    <input type="file" id="ndaFileInput" class="nda-file-input" accept=".pdf" onchange="handleNdaUpload(event)">

    <div class="nda-preview" id="ndaPreview" style="display:none;">
      <div class="nda-preview-header">
        <span class="nda-filename" id="ndaFilename"></span>
        <button onclick="clearNda()" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">✕</button>
      </div>
      <div class="nda-canvas-container" id="ndaCanvasContainer"></div>
      <div class="nda-sign-section">
        <button class="nda-sign-btn" id="ndaSignBtn" onclick="signNda()">
          <span>✍️</span>
          <span>eSign NDA</span>
        </button>
        <div class="nda-actions">
          <button class="nda-download-btn" id="ndaDownloadBtn" onclick="downloadSignedNda()" disabled>
            📥 Download Signed PDF
          </button>
          <button class="nda-clear-btn" id="ndaClearBtn" onclick="clearNdaAndReupload()" style="background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:0.9rem;margin-top:10px;">
            🗑️ Remove & Re-upload
          </button>
        </div>
        <div class="nda-status" id="ndaStatus" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  Protected by attorney-client privilege. Secure workroom access only.
</div>

<div class="sync-indicator" id="syncIndicator">
  <span id="syncIcon">●</span>
  <span id="syncText">Saved</span>
</div>

<script>
(function() {
  const ACCESS_PASSWORD = 'Sw!ghey5';
  const overlay = document.getElementById('passwordOverlay');
  const form = document.getElementById('passwordForm');
  const input = document.getElementById('passwordInput');
  const error = document.getElementById('passwordError');

  if (!overlay || !form || !input) {
    return;
  }

  function unlockWorkroom() {
    overlay.classList.add('hidden');
    document.body.classList.remove('locked');
  }

  form.addEventListener('submit', (event) => {
    event.preventDefault();
    if (input.value.trim() === ACCESS_PASSWORD) {
      unlockWorkroom();
    } else if (error) {
      error.classList.add('visible');
      input.focus();
      input.select();
    }
  });

  input.addEventListener('input', () => {
    if (error) {
      error.classList.remove('visible');
    }
  });

  input.focus();
  if (typeof input.setSelectionRange === 'function') {
    const length = input.value.length;
    input.setSelectionRange(length, length);
  }
})();
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDLbmMrqBPmLJLEOHyQWpbXOWYoK3yp8AE",
  authDomain: "terms-law.firebaseapp.com",
  projectId: "terms-law",
  storageBucket: "terms-law.appspot.com",
  messagingSenderId: "1098711753957",
  appId: "1:1098711753957:web:c9f2f5e0e7e3f5a5e5e5e5"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const DOC_ID = 'cmc-9t4l'; // Unique ID for this workroom

// Client decisions storage
let clientDecisions = {};
let saveTimeout = null;

// Redline data - 11 key issues with ACTUAL section numbers
// ORIGINAL = Federal Realty's exact text
// SUGGESTED = Our proposed replacement language
const redlines = [
  // === TERMINATION & EXIT ===
  {
    id: 1,
    title: "Termination Protection + Buildout Reimbursement",
    section: "§7, §8, §13",
    category: "Exit Economics",
    priority: "high",
    original: "Grantor shall have the right to terminate the Agreement at any time, in its sole and absolute discretion, by giving Licensee no less than thirty (30) days written notice... Any items not removed by Licensee after the Expiration Date shall, at the option of Grantor and without notice to Licensee, be deemed abandoned...",
    suggested: "Grantor may terminate for convenience only after the first 24 months of the Term, upon not less than 180 days' prior written notice. If terminated for convenience, Grantor shall reimburse Licensee for unamortized Work costs (amortized over 48 months) plus reasonable relocation costs. Owner approval of Work shall not be unreasonably withheld and shall respond within 10 business days. Grantor shall provide 30 days' written notice before deeming any Licensee property abandoned; Licensee-owned Equipment remains Licensee's property.",
    rationale: "CMC is investing in pads, utilities, and enclosures. 30 days notice with no reimbursement means losing your entire buildout investment. Need protection for your capital investment."
  },

  // === PRICING & PENALTIES ===
  {
    id: 2,
    title: "Pricing Controls + Remove $100/Day Penalty",
    section: "§4 + Exhibit B",
    category: "Pricing",
    priority: "high",
    original: "Licensee shall not charge above prevailing market rates... increase charges without prior VP written consent... Default with no notice or cure period required... $100 per day penalty...",
    suggested: "Licensee may adjust tenant rates annually by the lesser of CPI or 5%, plus documented hauler pass-throughs. No approval needed for pass-throughs with documentation; 60 days' notice to tenants. If any violation, Grantor gives written notice and Licensee has 10 business days to reverse and issue credits. No automatic default or penalties.",
    rationale: "\"Market rate\" is undefined and subjective. The $100/day penalty with instant default is punitive. Replace with objective formulas and standard notice/cure."
  },

  // === DEFAULTS & REMEDIES ===
  {
    id: 3,
    title: "Default Cure Periods + No Equipment Seizure",
    section: "§9",
    category: "Defaults",
    priority: "high",
    original: "Grantor may terminate with forty-eight (48) hours notice... take possession of all improvements, equipment, fixtures and inventory...",
    suggested: "Monetary default: 10 days to cure after notice. Non-monetary: 30 days to cure (extended if diligently curing). Grantor may terminate only after uncured default. Grantor shall have no right to seize or retain Licensee-owned equipment, inventory, or personal property.",
    rationale: "48 hours is commercially unreasonable. Your compactors are yours, not Federal Realty's. Need standard cure periods and protection for your owned equipment."
  },

  // === SECURITY DEPOSIT ===
  {
    id: 4,
    title: "Security Deposit — Reduce + Fix Return",
    section: "§15",
    category: "Deposit",
    priority: "medium",
    original: "Deposit = 3x monthly ($25,500) or $10,000 (whichever greater). Replenish within 5 days. Request return within 60 days or waive...",
    suggested: "Deposit = 1x monthly License Fee ($8,500). Replenish within 20 days after notice. Return within 30 days after Term end with itemized deductions. No waiver trap.",
    rationale: "$25,500 is excessive. The 5-day replenishment and 60-day waiver are traps. Standard practice is 1x monthly with reasonable timelines."
  },

  // === REGULATORY REPORTING ===
  {
    id: 5,
    title: "Reporting Fines — Fault-Based Allocation",
    section: "§6",
    category: "Regulatory",
    priority: "high",
    original: "The cost of any fines, penalties, or other repercussions for Grantor's failure to make Jurisdiction Mandated Reporting shall be borne solely by Licensee.",
    suggested: "Fines and penalties shall be borne by Licensee to the extent caused by Licensee's failure to provide timely, accurate data. Grantor shall cooperate and timely provide data/access required for reporting.",
    rationale: "You shouldn't pay fines for Federal Realty's regulatory failures when they didn't give you the information you needed."
  },

  // === OPERATIONAL ===
  {
    id: 6,
    title: "Tenant Contracts + Billing Timing",
    section: "Exhibit B & B-1",
    category: "Operations",
    priority: "medium",
    original: "Licensee agrees not to enter into any separate contracts with tenants... If fails to invoice within 90 days, Licensee waives right to payment...",
    suggested: "Licensee may use standard work orders and billing terms consistent with this Agreement (no conflicting terms). 90-day billing waiver doesn't apply for tenant disputes, missing data, or reconciliation issues.",
    rationale: "The agreement says you bill tenants but prohibits paperwork with them. You need work orders to do the job. Hard billing waivers lose you legitimate revenue."
  },

  // === INDEMNITY ===
  {
    id: 7,
    title: "Indemnity — Comparative Fault Standard",
    section: "§11",
    category: "Risk",
    priority: "medium",
    original: "Except for liability arising solely from the indemnified parties' negligence, Licensee will defend, indemnify and hold harmless Grantor...",
    suggested: "Licensee indemnifies to the extent claims arise from Licensee's negligence or willful misconduct. No indemnity to the extent caused by Grantor/tenant negligence or pre-existing site conditions not introduced by Licensee.",
    rationale: "\"Solely from negligence\" is too narrow—you'd be liable even if Federal Realty is 90% at fault. Standard indemnities use comparative fault."
  },

  // === INSURANCE ===
  {
    id: 8,
    title: "Insurance — Add Cure Period",
    section: "§10",
    category: "Risk",
    priority: "medium",
    original: "Failure to maintain insurance is material breach. Grantor may terminate without notice to cure...",
    suggested: "Failure to maintain insurance is material breach; provided Grantor shall give written notice and Licensee has 10 business days to cure before termination, except for immediate safety risks.",
    rationale: "Insurance lapses happen—renewal timing, paperwork delays. A short cure period prevents termination over administrative issues."
  },

  // === NON-RECOURSE ===
  {
    id: 9,
    title: "Non-Recourse Carve-Outs",
    section: "§18",
    category: "Risk",
    priority: "low",
    original: "Licensee agrees to look solely to the interest held by Grantor in the Project for any claims...",
    suggested: "Non-recourse limitation shall not apply to: (a) Security Deposit return, (b) reimbursement obligations under this Agreement, or (c) fraud/willful misconduct.",
    rationale: "Non-recourse is fine generally, but Federal Realty shouldn't hide behind it to avoid paying what they owe you."
  },

  // === ASSIGNMENT ===
  {
    id: 10,
    title: "Assignment — Allow Affiliates/Successors",
    section: "§17",
    category: "Corporate",
    priority: "medium",
    original: "The rights granted to Licensee are personal and Licensee shall not be permitted to assign this Agreement.",
    suggested: "Licensee may assign without consent to affiliates or successors (merger/sale of assets), with notice. Other assignments require Grantor consent, not unreasonably withheld.",
    rationale: "A flat prohibition prevents normal business. If the Lucio family sells or restructures CMC, you'd need Federal Realty's permission."
  },

  // === BLANKS ===
  {
    id: 11,
    title: "Complete Blanks + Confirm Exhibits",
    section: "Preamble & Exhibits",
    category: "Execution",
    priority: "high",
    original: "Made as of _____ ... by and between ... and _____ ... continuing until _____ (\"Term\")...",
    suggested: "Fill in: Effective Date, \"Compactor Management Company, LLC, a California limited liability company\", Term end date (suggest 5 years). Confirm Exhibits A–E (premises, equipment, tenants, insurance) are complete and accurate.",
    rationale: "These blanks must be filled before signing. Missing exhibits create ambiguity and disputes later."
  }
];

let activeRedline = null;
let showingSuggested = {}; // true = showing suggested (default), false = showing original

function initRedlines() {
  const list = document.getElementById('redlineList');
  list.innerHTML = '';

  let currentCategory = '';

  redlines.forEach(r => {
    showingSuggested[r.id] = false; // Default to Federal Realty's original

    // Add category divider if category changed
    if (r.category && r.category !== currentCategory) {
      currentCategory = r.category;
      const divider = document.createElement('div');
      divider.className = 'category-divider';
      divider.textContent = currentCategory;
      list.appendChild(divider);
    }

    // Check for existing decision
    const decision = clientDecisions[r.id] || {};
    const acceptSelected = decision.status === 'accept' ? 'selected' : '';
    const rejectSelected = decision.status === 'reject' ? 'selected' : '';
    const savedComment = decision.comment || '';

    const item = document.createElement('div');
    item.className = 'redline-item';
    item.id = `redline-${r.id}`;
    item.innerHTML = `
      <div class="redline-header" onclick="toggleRedline(${r.id})">
        <div class="redline-number">${r.id}</div>
        <div class="redline-info">
          <div class="redline-title">${r.title}</div>
          <div class="redline-section">${r.section}</div>
        </div>
        <span class="priority-badge priority-${r.priority}">${r.priority}</span>
      </div>
      <div class="redline-body">
        <!-- Explanation FIRST -->
        <div class="rationale">
          <strong>What's the Issue?</strong>
          ${r.rationale}
        </div>

        <!-- Text comparison SECOND -->
        <div class="comparison-label">Compare Language</div>
        <div class="toggle-group">
          <button class="toggle-btn original-btn active" onclick="event.stopPropagation(); showOriginal(${r.id})">Federal Realty's Text</button>
          <button class="toggle-btn suggested-btn" onclick="event.stopPropagation(); showSuggested(${r.id})">My Suggestion</button>
        </div>
        <div class="text-box text-original" id="original-${r.id}" style="display:block;">${r.original}</div>
        <div class="text-box text-suggested" id="suggested-${r.id}" style="display:none;">${r.suggested}</div>

        <!-- Accept/Reject decision THIRD -->
        <div class="decision-section">
          <div class="decision-label">Your Decision</div>
          <div class="decision-btns">
            <button class="decision-btn accept ${acceptSelected}" id="accept-${r.id}" onclick="event.stopPropagation(); setDecision(${r.id}, 'accept')">
              <span>✓</span> Accept Change
            </button>
            <button class="decision-btn reject ${rejectSelected}" id="reject-${r.id}" onclick="event.stopPropagation(); setDecision(${r.id}, 'reject')">
              <span>✗</span> Keep Original
            </button>
          </div>
          <textarea class="comment-box" id="comment-${r.id}" placeholder="Add a note or question (optional)..." onclick="event.stopPropagation()" onchange="saveComment(${r.id})">${savedComment}</textarea>
          <div class="save-status" id="status-${r.id}">
            <span>✓</span> Saved
          </div>
        </div>
      </div>
    `;
    list.appendChild(item);
  });
}

function toggleRedline(id) {
  const item = document.getElementById(`redline-${id}`);
  const wasActive = item.classList.contains('expanded');

  // Collapse all
  document.querySelectorAll('.redline-item').forEach(el => el.classList.remove('expanded', 'active'));

  if (!wasActive) {
    item.classList.add('expanded', 'active');
    activeRedline = id;
    scrollToSection(id);
    highlightSection(id);
  } else {
    activeRedline = null;
    clearHighlights();
  }
}

function showOriginal(id) {
  showingSuggested[id] = false;
  const origEl = document.getElementById(`original-${id}`);
  const sugEl = document.getElementById(`suggested-${id}`);
  const origBtn = document.querySelector(`#redline-${id} .original-btn`);
  const sugBtn = document.querySelector(`#redline-${id} .suggested-btn`);

  if (origEl && sugEl) {
    // Force display toggle - remove all display styling first
    origEl.style.display = 'block';
    sugEl.style.display = 'none';
    origEl.classList.remove('text-hidden');
    sugEl.classList.add('text-hidden');
  }
  if (origBtn) origBtn.classList.add('active');
  if (sugBtn) sugBtn.classList.remove('active');
  updateHighlightMode(id, 'original');
}

function showSuggested(id) {
  showingSuggested[id] = true;
  const origEl = document.getElementById(`original-${id}`);
  const sugEl = document.getElementById(`suggested-${id}`);
  const origBtn = document.querySelector(`#redline-${id} .original-btn`);
  const sugBtn = document.querySelector(`#redline-${id} .suggested-btn`);

  if (origEl && sugEl) {
    // Force display toggle - remove all display styling first
    origEl.style.display = 'none';
    sugEl.style.display = 'block';
    origEl.classList.add('text-hidden');
    sugEl.classList.remove('text-hidden');
  }
  if (origBtn) origBtn.classList.remove('active');
  if (sugBtn) sugBtn.classList.add('active');
  updateHighlightMode(id, 'suggested');
}

function scrollToSection(id) {
  const section = document.querySelector(`[data-redline="${id}"]`);
  if (section) {
    section.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function highlightSection(id) {
  clearHighlights();
  const sections = document.querySelectorAll(`[data-redline="${id}"]`);
  const mode = showingSuggested[id] ? 'suggested' : 'original';
  sections.forEach(section => {
    section.classList.add(`${mode}-mode`, 'flash');
    setTimeout(() => section.classList.remove('flash'), 1500);
  });
}

function updateHighlightMode(id, mode) {
  const sections = document.querySelectorAll(`[data-redline="${id}"]`);
  sections.forEach(section => {
    section.classList.remove('original-mode', 'suggested-mode');
    section.classList.add(`${mode}-mode`);

    // Swap the actual text content in the preview
    const originalText = section.getAttribute('data-original');
    const suggestedText = section.getAttribute('data-suggested');

    if (originalText && suggestedText) {
      if (mode === 'original') {
        section.textContent = originalText;
      } else {
        section.textContent = suggestedText;
      }
    }
  });
}

function clearHighlights() {
  document.querySelectorAll('.highlight-section').forEach(el => {
    el.classList.remove('suggested-mode', 'flash');
    // Keep original-mode as default (Federal Realty's text)
    el.classList.add('original-mode');

    // Reset text to original version
    const originalText = el.getAttribute('data-original');
    if (originalText) {
      el.textContent = originalText;
    }
  });
}

// Initialize preview to show original text on page load
function initPreviewText() {
  document.querySelectorAll('.highlight-section').forEach(el => {
    const originalText = el.getAttribute('data-original');
    if (originalText) {
      el.textContent = originalText;
    }
  });
}

function downloadWord() {
  window.location.href = 'Trash%20Pad%20License%20Agmt%20-%20SR%202025.docx';
}

function closeBanner() {
  const banner = document.getElementById('welcomeBanner');
  if (banner) {
    banner.classList.add('hidden');
  }
}

// Decision management
function setDecision(id, status) {
  // Toggle: clicking same button again clears it
  if (clientDecisions[id]?.status === status) {
    delete clientDecisions[id].status;
    document.getElementById(`accept-${id}`).classList.remove('selected');
    document.getElementById(`reject-${id}`).classList.remove('selected');
  } else {
    clientDecisions[id] = clientDecisions[id] || {};
    clientDecisions[id].status = status;
    clientDecisions[id].timestamp = new Date().toISOString();

    // Update UI
    document.getElementById(`accept-${id}`).classList.toggle('selected', status === 'accept');
    document.getElementById(`reject-${id}`).classList.toggle('selected', status === 'reject');
  }

  // Show save status
  showSaveStatus(id);

  // Debounce save to Firebase
  debounceSave();
}

function saveComment(id) {
  const comment = document.getElementById(`comment-${id}`).value;
  clientDecisions[id] = clientDecisions[id] || {};
  clientDecisions[id].comment = comment;
  clientDecisions[id].timestamp = new Date().toISOString();

  showSaveStatus(id);
  debounceSave();
}

function showSaveStatus(id) {
  const status = document.getElementById(`status-${id}`);
  status.classList.add('visible');
  setTimeout(() => status.classList.remove('visible'), 2000);
}

function debounceSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveToFirebase, 1000);
}

// Firebase functions
async function saveToFirebase() {
  showSyncIndicator('syncing', 'Saving...');

  try {
    await db.collection('workrooms').doc(DOC_ID).set({
      decisions: clientDecisions,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
      client: 'Toni Lucio / CMC'
    }, { merge: true });

    showSyncIndicator('synced', 'All changes saved');

    // Also save to localStorage as backup
    localStorage.setItem(`workroom-${DOC_ID}`, JSON.stringify(clientDecisions));
  } catch (error) {
    console.error('Firebase save error:', error);
    showSyncIndicator('error', 'Save failed - stored locally');
    // Save to localStorage as fallback
    localStorage.setItem(`workroom-${DOC_ID}`, JSON.stringify(clientDecisions));
  }
}

async function loadFromFirebase() {
  showSyncIndicator('syncing', 'Loading...');

  try {
    const doc = await db.collection('workrooms').doc(DOC_ID).get();

    if (doc.exists && doc.data().decisions) {
      clientDecisions = doc.data().decisions;
      showSyncIndicator('synced', 'Loaded');
    } else {
      // Try localStorage fallback
      const local = localStorage.getItem(`workroom-${DOC_ID}`);
      if (local) {
        clientDecisions = JSON.parse(local);
        showSyncIndicator('synced', 'Loaded from cache');
      } else {
        showSyncIndicator('synced', 'Ready');
      }
    }

    // Re-render with loaded data
    initRedlines();
  } catch (error) {
    console.error('Firebase load error:', error);
    // Try localStorage fallback
    const local = localStorage.getItem(`workroom-${DOC_ID}`);
    if (local) {
      clientDecisions = JSON.parse(local);
      showSyncIndicator('synced', 'Loaded from cache');
      initRedlines();
    } else {
      showSyncIndicator('error', 'Could not load');
      initRedlines();
    }
  }
}

function showSyncIndicator(status, text) {
  const indicator = document.getElementById('syncIndicator');
  const icon = document.getElementById('syncIcon');
  const textEl = document.getElementById('syncText');

  indicator.className = 'sync-indicator visible ' + status;
  textEl.textContent = text;

  // Auto-hide after 3 seconds if synced
  if (status === 'synced') {
    setTimeout(() => indicator.classList.remove('visible'), 3000);
  }
}

// Listen for real-time updates from Firebase (so attorney sees client changes)
function setupRealtimeListener() {
  db.collection('workrooms').doc(DOC_ID).onSnapshot((doc) => {
    if (doc.exists && doc.data().decisions) {
      const serverDecisions = doc.data().decisions;

      // Only update if server has newer data
      let hasNewData = false;
      for (const id in serverDecisions) {
        if (!clientDecisions[id] ||
            (serverDecisions[id].timestamp > (clientDecisions[id].timestamp || ''))) {
          hasNewData = true;
          break;
        }
      }

      if (hasNewData) {
        clientDecisions = serverDecisions;
        initRedlines();
        showSyncIndicator('synced', 'Updated');
      }
    }
  }, (error) => {
    console.error('Realtime listener error:', error);
  });
}

// Initialize
loadFromFirebase().then(() => {
  setupRealtimeListener();
  initPreviewText(); // Set preview to show Federal Realty's original text
  loadNdaFromFirebase();
});

// ========== NDA UPLOAD & SIGN ==========
let ndaPdfBytes = null;
let ndaSignedPdfBytes = null;
let ndaFilename = '';
let ndaSigned = false;

// Set PDF.js worker
if (typeof pdfjsLib !== 'undefined') {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

function toggleNdaSection() {
  document.getElementById('ndaSection').classList.toggle('expanded');
}

function handleNdaUpload(event) {
  const file = event.target.files[0];
  if (!file || file.type !== 'application/pdf') {
    alert('Please upload a PDF file');
    return;
  }

  ndaFilename = file.name;
  const reader = new FileReader();

  reader.onload = async function(e) {
    ndaPdfBytes = new Uint8Array(e.target.result);

    // Show preview
    document.getElementById('ndaUploadZone').style.display = 'none';
    document.getElementById('ndaPreview').style.display = 'block';
    document.getElementById('ndaFilename').textContent = ndaFilename;

    // Render PDF preview
    await renderNdaPreview();

    // Save to Firebase
    saveNdaToFirebase();
  };

  reader.readAsArrayBuffer(file);
}

async function renderNdaPreview() {
  if (!ndaPdfBytes) return;

  const container = document.getElementById('ndaCanvasContainer');
  container.innerHTML = '';

  try {
    const pdf = await pdfjsLib.getDocument({ data: ndaPdfBytes.slice() }).promise;
    const numPages = pdf.numPages; // Show all pages

    for (let i = 1; i <= numPages; i++) {
      const page = await pdf.getPage(i);
      const scale = 1.2;
      const viewport = page.getViewport({ scale });

      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      canvas.style.cssText = 'margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';

      await page.render({ canvasContext: context, viewport }).promise;

      // Add page number label
      const pageLabel = document.createElement('div');
      pageLabel.style.cssText = 'text-align:center;font-size:12px;color:#666;margin-bottom:15px;';
      pageLabel.textContent = `Page ${i} of ${numPages}`;

      container.appendChild(canvas);
      container.appendChild(pageLabel);
    }
  } catch (err) {
    console.error('PDF render error:', err);
    container.innerHTML = '<p style="padding:20px;color:red;">Error rendering PDF preview</p>';
  }
}

async function signNda() {
  if (!ndaPdfBytes || ndaPdfBytes.length === 0) {
    alert('Please upload an NDA first');
    return;
  }

  const btn = document.getElementById('ndaSignBtn');
  btn.disabled = true;
  btn.innerHTML = '<span>⏳</span><span>Signing...</span>';

  try {
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    // Use slice() to create a copy and avoid buffer issues
    const pdfDoc = await PDFDocument.load(ndaPdfBytes.slice());
    const pages = pdfDoc.getPages();
    const lastPage = pages[pages.length - 1];

    // Get page dimensions
    const { width, height } = lastPage.getSize();

    // Load font
    const font = await pdfDoc.embedFont(StandardFonts.TimesRomanItalic);
    const fontBold = await pdfDoc.embedFont(StandardFonts.TimesRomanBold);

    // Signature details
    const signatureTimestamp = new Date();
    const timestampStr = signatureTimestamp.toLocaleString('en-US', {
      month: 'long', day: 'numeric', year: 'numeric',
      hour: 'numeric', minute: '2-digit', hour12: true
    });
    const verificationCode = generateVerificationCode();

    // Draw signature in Party B signature field (right column)
    // Adjusted: higher and more to the right to avoid overlapping
    const sigX = 360;  // Further right
    const sigY = 540;  // Higher up on page

    // Handwritten-style signature using italic font
    lastPage.drawText('/s/ Sergei Tokmakov, Esq.', {
      x: sigX,
      y: sigY,
      size: 14,
      font: font,  // Italic font for handwritten look
      color: rgb(0.1, 0.21, 0.36)  // Dark blue ink
    });

    // Underline flourish
    lastPage.drawLine({
      start: { x: sigX - 5, y: sigY - 5 },
      end: { x: sigX + 175, y: sigY - 5 },
      thickness: 0.75,
      color: rgb(0.1, 0.21, 0.36)
    });

    // Signed by
    lastPage.drawText('Signed by: Sergei Tokmakov, Esq.', {
      x: sigX,
      y: sigY - 22,
      size: 9,
      font: fontBold,
      color: rgb(0.08, 0.4, 0.2)  // Green
    });

    // Bar number with URL
    lastPage.drawText('CBN 279869', {
      x: sigX,
      y: sigY - 35,
      size: 8,
      font: font,
      color: rgb(0.28, 0.33, 0.41)
    });

    // Timestamp
    lastPage.drawText(timestampStr, {
      x: sigX,
      y: sigY - 47,
      size: 8,
      font: font,
      color: rgb(0.28, 0.33, 0.41)
    });

    // Verified email
    lastPage.drawText('Verified email: owner@terms.law', {
      x: sigX,
      y: sigY - 59,
      size: 8,
      font: font,
      color: rgb(0.28, 0.33, 0.41)
    });

    // Verification code
    lastPage.drawText(verificationCode, {
      x: sigX,
      y: sigY - 71,
      size: 7,
      font: font,
      color: rgb(0.58, 0.64, 0.72)
    });

    // Save signed PDF
    ndaSignedPdfBytes = await pdfDoc.save();
    ndaSigned = true;

    // Update UI
    btn.classList.add('signed');
    btn.innerHTML = '<span>✓</span><span>Signed</span>';

    document.getElementById('ndaDownloadBtn').disabled = false;

    const status = document.getElementById('ndaStatus');
    status.style.display = 'block';
    status.className = 'nda-status signed';
    status.innerHTML = `✓ Signed on ${timestampStr}<br><small>Verification: ${verificationCode}</small>`;

    // Re-render preview with signed version
    ndaPdfBytes = ndaSignedPdfBytes;
    await renderNdaPreview();

    // Save to Firebase
    saveNdaToFirebase();

    showSyncIndicator('synced', 'NDA signed & saved');

  } catch (err) {
    console.error('Signing error:', err);
    alert('Error signing PDF: ' + err.message);
    btn.disabled = false;
    btn.innerHTML = '<span>✍️</span><span>eSign NDA</span>';
  }
}

function generateVerificationCode() {
  const chars = 'ABCDEF0123456789';
  const segments = [8, 4, 4, 4, 12];
  return segments.map(len =>
    Array.from({ length: len }, () => chars[Math.floor(Math.random() * chars.length)]).join('')
  ).join('-');
}

function downloadSignedNda() {
  if (!ndaSignedPdfBytes && !ndaPdfBytes) return;

  const bytes = ndaSignedPdfBytes || ndaPdfBytes;
  const blob = new Blob([bytes], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = ndaFilename.replace('.pdf', ' - SIGNED.pdf');
  a.click();

  URL.revokeObjectURL(url);
}

function clearNda() {
  ndaPdfBytes = null;
  ndaSignedPdfBytes = null;
  ndaFilename = '';
  ndaSigned = false;

  document.getElementById('ndaUploadZone').style.display = 'block';
  document.getElementById('ndaPreview').style.display = 'none';
  document.getElementById('ndaFileInput').value = '';
  document.getElementById('ndaSignBtn').disabled = false;
  document.getElementById('ndaSignBtn').classList.remove('signed');
  document.getElementById('ndaSignBtn').innerHTML = '<span>✍️</span><span>eSign NDA</span>';
  document.getElementById('ndaDownloadBtn').disabled = true;
  document.getElementById('ndaStatus').style.display = 'none';

  // Clear from Firebase
  db.collection('workrooms').doc(DOC_ID).update({
    nda: firebase.firestore.FieldValue.delete()
  });
}

function clearNdaAndReupload() {
  if (confirm('Remove the current NDA and upload a new one?')) {
    clearNda();
  }
}

function uint8ArrayToBase64(bytes) {
  // Process in chunks to avoid call stack limit for large PDFs
  let binary = '';
  const chunkSize = 0x8000;
  for (let i = 0; i < bytes.length; i += chunkSize) {
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
  }
  return btoa(binary);
}

function saveNdaToFirebase() {
  if (!ndaPdfBytes) return;

  // Convert to base64 (handles large files)
  const base64 = uint8ArrayToBase64(ndaPdfBytes);

  db.collection('workrooms').doc(DOC_ID).set({
    nda: {
      filename: ndaFilename,
      data: base64,
      signed: ndaSigned,
      updatedAt: new Date().toISOString()
    }
  }, { merge: true });
}

async function loadNdaFromFirebase() {
  try {
    const doc = await db.collection('workrooms').doc(DOC_ID).get();
    if (doc.exists && doc.data().nda) {
      const nda = doc.data().nda;

      // Convert base64 back to Uint8Array
      const binary = atob(nda.data);
      ndaPdfBytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        ndaPdfBytes[i] = binary.charCodeAt(i);
      }

      ndaFilename = nda.filename;
      ndaSigned = nda.signed;

      if (ndaSigned) {
        ndaSignedPdfBytes = ndaPdfBytes;
      }

      // Show preview
      document.getElementById('ndaUploadZone').style.display = 'none';
      document.getElementById('ndaPreview').style.display = 'block';
      document.getElementById('ndaFilename').textContent = ndaFilename;

      // Expand section
      document.getElementById('ndaSection').classList.add('expanded');

      // Render
      await renderNdaPreview();

      // Update button state if signed
      if (ndaSigned) {
        const btn = document.getElementById('ndaSignBtn');
        btn.classList.add('signed');
        btn.innerHTML = '<span>✓</span><span>Signed</span>';
        btn.disabled = true;
        document.getElementById('ndaDownloadBtn').disabled = false;

        const status = document.getElementById('ndaStatus');
        status.style.display = 'block';
        status.className = 'nda-status signed';
        status.innerHTML = `✓ Signed and ready for download`;
      }
    }
  } catch (err) {
    console.error('Error loading NDA:', err);
  }
}

// Drag and drop support
const uploadZone = document.getElementById('ndaUploadZone');
if (uploadZone) {
  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
  });
  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
  });
  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) {
      document.getElementById('ndaFileInput').files = e.dataTransfer.files;
      handleNdaUpload({ target: { files: [file] } });
    }
  });
}
</script>

</body>
</html>
