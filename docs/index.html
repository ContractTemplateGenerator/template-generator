<!DOCTYPE html>
<html lang="en">
<head>
    <!-- NOINDEX - Confidential client portal -->
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terms.Law - Collaborative Document Workspace</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Google Font for Signatures -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Great+Vibes&family=Satisfy&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }
        .header {
            background: #1a1a2e;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-size: 20px; font-weight: 600; }
        .logo span { color: #6366f1; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #fbbf24;
        }
        .status-dot.connected { background: #22c55e; }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-secondary { background: rgba(255,255,255,0.15); color: white; }
        .btn-outline { background: transparent; border: 1px solid #e5e7eb; color: #374151; }
        .btn-outline:hover { background: #f3f4f6; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-success { background: #22c55e; color: white; }
        .btn-success:hover { background: #16a34a; }

        .main-container {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
            gap: 24px;
        }

        /* Form Panel */
        .form-panel {
            width: 380px;
            flex-shrink: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            position: sticky;
            top: 100px;
        }

        /* Document Selector */
        .doc-selector {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }
        .doc-selector label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .doc-selector select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            background: white;
            cursor: pointer;
        }
        .doc-selector select:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 20px;
            padding: 16px;
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-section:hover {
            border-color: #6366f1;
            background: #f8f7ff;
        }
        .upload-section.dragover {
            border-color: #6366f1;
            background: #ede9fe;
        }
        .upload-section input[type="file"] {
            display: none;
        }
        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .upload-text {
            font-size: 13px;
            color: #6b7280;
        }
        .upload-text strong {
            color: #6366f1;
        }

        /* Form Styles */
        .gen-form-header {
            margin-bottom: 20px;
        }
        .gen-form-header h2 {
            font-size: 18px;
            color: #1a1a2e;
            margin-bottom: 4px;
        }
        .gen-form-header p {
            font-size: 13px;
            color: #6b7280;
        }
        .gen-form-section {
            margin-bottom: 20px;
        }
        .gen-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .gen-section-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 2px;
        }
        .gen-form-group {
            margin-bottom: 12px;
        }
        .gen-form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 4px;
        }
        .gen-form-group input,
        .gen-form-group select,
        .gen-form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1.5px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        .gen-form-group input:focus,
        .gen-form-group select:focus,
        .gen-form-group textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }
        .gen-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .gen-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .gen-checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #475569;
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .gen-checkbox-label:hover {
            background: #f8f9fa;
        }
        .gen-checkbox-label input {
            width: 14px;
            height: 14px;
        }
        .gen-checkbox-label input:checked + span {
            color: #6366f1;
            font-weight: 500;
        }
        .gen-info-box {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 12px;
            color: #1e40af;
            margin-bottom: 16px;
        }
        .gen-warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 12px;
            color: #92400e;
            margin-bottom: 16px;
        }
        .gen-tip-box {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 12px;
            color: #166534;
            margin-bottom: 16px;
        }
        /* Tooltips */
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: help;
        }
        .tooltip-icon {
            width: 14px;
            height: 14px;
            background: #9ca3af;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .tooltip-trigger:hover .tooltip-icon {
            background: #6366f1;
        }
        .field-help {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
            line-height: 1.4;
        }
        .field-help a {
            color: #6366f1;
        }
        /* Expandable sections */
        .gen-expandable {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .gen-expandable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f9fafb;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
        }
        .gen-expandable-header:hover {
            background: #f3f4f6;
        }
        .gen-expandable-content {
            padding: 12px;
            display: none;
            border-top: 1px solid #e5e7eb;
        }
        .gen-expandable.open .gen-expandable-content {
            display: block;
        }
        .gen-expandable-arrow {
            transition: transform 0.2s;
        }
        .gen-expandable.open .gen-expandable-arrow {
            transform: rotate(180deg);
        }
        .blank-doc-message {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        .blank-doc-message h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #374151;
        }

        /* Preview Panel */
        .preview-panel {
            flex: 1;
            min-width: 0;
        }
        .preview-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .preview-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            flex-wrap: wrap;
            gap: 8px;
        }
        .preview-toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .preview-toolbar-title {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        .session-name-input {
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            width: 200px;
        }
        .session-name-input:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Formatting Toolbar */
        .format-toolbar {
            display: flex;
            gap: 4px;
            padding: 8px 16px;
            border-bottom: 1px solid #e5e7eb;
            background: #fafafa;
            flex-wrap: wrap;
        }
        .format-btn {
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .format-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        .format-btn.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        .format-divider {
            width: 1px;
            background: #e5e7eb;
            margin: 0 4px;
        }

        .preview-toolbar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .save-status {
            font-size: 12px;
            color: #6b7280;
        }
        .save-status.saving { color: #f59e0b; }
        .save-status.saved { color: #22c55e; }
        .preview-content {
            padding: 24px;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }

        /* Users Panel */
        .users-inline {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .users-inline .user-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 600;
            cursor: default;
            position: relative;
        }
        .users-inline .user-dot:hover::after {
            content: attr(data-name);
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a2e;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 10;
        }

        /* Document Preview Styles */
        .doc-preview {
            max-width: 850px;
            margin: 0 auto;
            background: white;
            padding: 48px;
            font-family: 'Times New Roman', Times, serif;
            font-size: 12pt;
            line-height: 1.6;
            color: #000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            min-height: 800px;
        }
        .doc-preview:focus {
            outline: 2px solid #6366f1;
            outline-offset: 2px;
        }
        .doc-preview h1 {
            text-align: center;
            font-size: 16pt;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        .doc-preview h2 {
            font-size: 12pt;
            margin-top: 20px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .doc-preview p {
            margin-bottom: 12px;
            text-align: justify;
        }
        .doc-preview .center {
            text-align: center;
        }
        .doc-preview .parties {
            margin: 20px 0;
        }
        .doc-preview .clause {
            margin-bottom: 14px;
        }
        .doc-preview .sub-clause {
            margin-left: 24px;
            margin-bottom: 8px;
        }
        .doc-preview .signature-block {
            margin-top: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        .doc-preview .signature-party h3 {
            font-size: 11pt;
            margin-bottom: 24px;
            text-transform: uppercase;
        }
        .doc-preview .signature-line {
            border-top: 1px solid #000;
            margin-top: 30px;
            padding-top: 4px;
            font-size: 10pt;
        }

        /* Highlight Styles */
        .doc-highlight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 0 3px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .doc-highlight:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
        }
        @keyframes highlightPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245,158,11,0.7); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(245,158,11,0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245,158,11,0); }
        }
        .field-highlight-active {
            animation: highlightPulse 0.6s ease-out;
            background: linear-gradient(135deg, #fde047 0%, #facc15 100%) !important;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .modal h2 { margin-bottom: 8px; color: #1a1a2e; }
        .modal p { color: #6b7280; margin-bottom: 24px; }
        .modal input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
            outline: none;
        }
        .modal input:focus { border-color: #6366f1; }
        .modal .btn { width: 100%; padding: 14px; }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #1a1a2e;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .hidden { display: none !important; }

        /* Signature Section */
        .signature-section {
            margin-top: 24px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        .signature-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sig-party-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .sig-party-tab {
            flex: 1;
            padding: 10px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .sig-party-tab.active {
            border-color: #6366f1;
            background: #ede9fe;
            color: #6366f1;
        }
        .sig-party-tab .sig-status {
            font-size: 10px;
            display: block;
            margin-top: 4px;
            color: #9ca3af;
        }
        .sig-party-tab.signed .sig-status {
            color: #22c55e;
        }
        /* Signature Type Toggle (Draw/Type) */
        .sig-type-toggle {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            background: #e5e7eb;
            padding: 4px;
            border-radius: 8px;
        }
        .sig-toggle-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #6b7280;
        }
        .sig-toggle-btn.active {
            background: white;
            color: #374151;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .sig-input-group {
            margin-bottom: 16px;
        }
        .sig-input-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 6px;
        }
        .sig-type-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .sig-type-input:focus {
            outline: none;
            border-color: #6366f1;
        }
        /* Draw Signature Canvas */
        .sig-draw-container {
            background: white;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 12px;
        }
        .sig-canvas {
            width: 100%;
            height: 100px;
            border-radius: 4px;
            cursor: crosshair;
            touch-action: none;
        }
        .sig-canvas-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }
        .sig-clear-btn {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            color: #6b7280;
            cursor: pointer;
        }
        .sig-clear-btn:hover {
            border-color: #ef4444;
            color: #ef4444;
        }
        /* Type Signature Preview */
        .sig-preview {
            background: white;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
        }
        .sig-preview-text {
            font-size: 32px;
            color: #1e3a5f;
            min-height: 45px;
        }
        .sig-font-dancing { font-family: 'Dancing Script', cursive; }
        .sig-font-vibes { font-family: 'Great Vibes', cursive; }
        .sig-font-satisfy { font-family: 'Satisfy', cursive; }
        .sig-preview-placeholder {
            color: #9ca3af;
            font-size: 14px;
            font-style: italic;
        }
        .sig-font-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .sig-font-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sig-font-btn:hover {
            border-color: #6366f1;
        }
        .sig-font-btn.active {
            border-color: #6366f1;
            background: #ede9fe;
        }
        .sig-apply-btn {
            width: 100%;
            padding: 12px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sig-apply-btn:hover {
            background: #16a34a;
        }
        .sig-apply-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        /* Email to Sign */
        .email-sign-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }
        .email-sign-row {
            display: flex;
            gap: 8px;
        }
        .email-sign-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        .email-sign-input:focus {
            outline: none;
            border-color: #6366f1;
        }
        .email-sign-btn {
            padding: 10px 16px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }
        .email-sign-btn:hover {
            background: #4f46e5;
        }

        /* Signature in Document Preview */
        .doc-signature-typed {
            font-size: 28px;
            color: #1e3a5f;
            min-height: 40px;
        }
        .doc-signature-image {
            max-height: 60px;
            max-width: 200px;
        }
        .doc-signature-timestamp {
            font-size: 9pt;
            color: #6b7280;
            margin-top: 4px;
        }
        .unsigned-placeholder {
            color: #9ca3af;
            font-style: italic;
            font-size: 12px;
        }

        /* Verification Stamp */
        .verification-stamp {
            margin-top: 40px;
            padding: 20px;
            border: 2px solid #6366f1;
            border-radius: 8px;
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            text-align: center;
        }
        .verification-stamp-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .verification-stamp-logo {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .verification-stamp-logo span {
            color: #6366f1;
        }
        .verification-stamp-title {
            font-size: 11px;
            font-weight: 600;
            color: #6366f1;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .verification-stamp-id {
            font-family: monospace;
            font-size: 10px;
            color: #6b7280;
            margin-top: 8px;
        }
        .verification-stamp-parties {
            margin-top: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            text-align: left;
            font-size: 10px;
        }
        .verification-party {
            padding: 12px;
            background: white;
            border-radius: 6px;
        }
        .verification-party-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        .verification-party-name {
            color: #1a1a2e;
        }
        .verification-party-time {
            color: #6b7280;
            font-size: 9px;
            margin-top: 2px;
        }
        .verification-party-ip {
            color: #9ca3af;
            font-size: 8px;
        }
        .verification-not-signed {
            color: #9ca3af;
            font-style: italic;
        }

        /* Email Sent Badge */
        .email-sent-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 8px;
        }

        @media (max-width: 1100px) {
            .main-container {
                flex-direction: column;
            }
            .form-panel {
                width: 100%;
                max-height: none;
                position: relative;
                top: 0;
            }
        }

        @media print {
            body * { visibility: hidden; }
            .doc-preview, .doc-preview * { visibility: visible; }
            .doc-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }
            .ai-chat-panel { display: none !important; }
        }

        /* AI Chat Panel */
        .ai-chat-panel {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 380px;
            max-height: 520px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .ai-chat-panel.minimized {
            max-height: 56px;
            width: 280px;
        }
        .ai-chat-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .ai-chat-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ai-chat-icon {
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .ai-chat-title {
            font-weight: 600;
            font-size: 14px;
        }
        .ai-chat-subtitle {
            font-size: 11px;
            opacity: 0.85;
        }
        .ai-chat-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .ai-chat-toggle:hover { opacity: 1; }

        /* Model Toggle */
        .ai-model-toggle {
            display: flex;
            padding: 8px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            gap: 8px;
            align-items: center;
        }
        .ai-model-toggle label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 500;
        }
        .model-switch {
            display: flex;
            background: #e5e7eb;
            border-radius: 6px;
            padding: 2px;
            flex: 1;
        }
        .model-switch-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            background: transparent;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #6b7280;
        }
        .model-switch-btn.active {
            background: white;
            color: #374151;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .model-switch-btn .model-badge {
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 4px;
        }
        .model-badge.free { background: #dcfce7; color: #16a34a; }
        .model-badge.premium { background: #fef3c7; color: #d97706; }

        /* Chat Messages */
        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            min-height: 200px;
        }
        .ai-chat-message {
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
            max-width: 90%;
        }
        .ai-chat-message.user {
            background: #ede9fe;
            color: #5b21b6;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-chat-message.assistant {
            background: #f3f4f6;
            color: #374151;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .ai-chat-message.assistant strong { color: #1a1a2e; }
        .ai-chat-message.assistant ul, .ai-chat-message.assistant ol {
            margin: 8px 0;
            padding-left: 20px;
        }
        .ai-chat-message.assistant li { margin: 4px 0; }
        .ai-typing {
            display: flex;
            gap: 4px;
            padding: 12px 14px;
            background: #f3f4f6;
            border-radius: 12px;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .ai-typing-dot {
            width: 6px;
            height: 6px;
            background: #9ca3af;
            border-radius: 50%;
            animation: aiTyping 1.4s infinite;
        }
        .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes aiTyping {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }

        /* Quick Actions */
        .ai-quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 16px 12px;
        }
        .ai-quick-btn {
            padding: 6px 10px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            color: #4b5563;
        }
        .ai-quick-btn:hover {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        /* Chat Input */
        .ai-chat-input-area {
            padding: 12px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }
        .ai-chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
            resize: none;
        }
        .ai-chat-input:focus { border-color: #6366f1; }
        .ai-chat-send {
            width: 40px;
            height: 40px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background 0.2s;
        }
        .ai-chat-send:hover { background: #4f46e5; }
        .ai-chat-send:disabled { background: #d1d5db; cursor: not-allowed; }

        /* Floating Chat Button (when panel closed) */
        .ai-chat-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
            z-index: 999;
            transition: transform 0.2s;
        }
        .ai-chat-fab:hover { transform: scale(1.1); }
        .ai-chat-fab.show { display: flex; }

        @media (max-width: 500px) {
            .ai-chat-panel {
                width: calc(100% - 32px);
                right: 16px;
                bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">Terms.<span>Law</span> Docs</div>
        <div class="header-actions">
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <button class="btn btn-secondary" id="copyBtn">Copy Link</button>
            <button class="btn btn-primary" id="newBtn">New Session</button>
        </div>
    </header>

    <div class="main-container">
        <!-- Form Panel -->
        <div class="form-panel">
            <!-- Document Selector -->
            <div class="doc-selector">
                <label>Document Type</label>
                <select id="docTypeSelector" onchange="loadDocumentGenerator()">
                    <option value="blank">Blank Document</option>
                    <option value="non-solicitation">Non-Solicitation Agreement</option>
                    <option value="commission">Commission Agreement</option>
                    <option value="nda">Non-Disclosure Agreement (NDA)</option>
                    <option value="piia">PIIA (Inventions Assignment)</option>
                    <option value="sublease">Sublease Agreement</option>
                </select>
            </div>

            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept=".txt,.doc,.docx,.rtf,.html" onchange="handleFileUpload(event)">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">
                    <strong>Upload a document</strong><br>
                    or drag and drop here
                </div>
            </div>

            <!-- Dynamic Form Container -->
            <div id="generatorFormContainer">
                <div class="blank-doc-message">
                    <h3>Blank Document</h3>
                    <p>Start typing in the editor, or select a document template above to auto-generate.</p>
                </div>
            </div>

            <!-- Signature Section -->
            <div class="signature-section" id="signatureSection">
                <div class="signature-section-title">
                    ‚úçÔ∏è Electronic Signatures
                </div>

                <div class="sig-party-tabs">
                    <button class="sig-party-tab active" id="sigTabPartyA" onclick="selectSignatureParty('partyA')">
                        Party A
                        <span class="sig-status" id="sigStatusA">Not signed</span>
                    </button>
                    <button class="sig-party-tab" id="sigTabPartyB" onclick="selectSignatureParty('partyB')">
                        Party B
                        <span class="sig-status" id="sigStatusB">Not signed</span>
                    </button>
                </div>

                <!-- Party A Signature -->
                <div id="sigPartyAPanel">
                    <div class="sig-input-group">
                        <label>Signer's Full Legal Name</label>
                        <input type="text" class="sig-type-input" id="sigNameA" placeholder="Your full legal name" oninput="updateSignaturePreview('A')">
                    </div>

                    <div class="sig-type-toggle">
                        <button class="sig-toggle-btn active" onclick="setSignatureMode('A', 'type')">Type</button>
                        <button class="sig-toggle-btn" onclick="setSignatureMode('A', 'draw')">Draw</button>
                    </div>

                    <!-- Type Signature -->
                    <div id="sigTypeContainerA">
                        <div class="sig-preview" id="sigPreviewA">
                            <span class="sig-preview-placeholder">Your signature will appear here</span>
                        </div>

                        <div class="sig-font-selector">
                            <button class="sig-font-btn sig-font-dancing active" onclick="selectSignatureFont('A', 'dancing')" data-font="dancing">
                                <span style="font-family: 'Dancing Script', cursive;">Abc</span>
                            </button>
                            <button class="sig-font-btn sig-font-vibes" onclick="selectSignatureFont('A', 'vibes')" data-font="vibes">
                                <span style="font-family: 'Great Vibes', cursive;">Abc</span>
                            </button>
                            <button class="sig-font-btn sig-font-satisfy" onclick="selectSignatureFont('A', 'satisfy')" data-font="satisfy">
                                <span style="font-family: 'Satisfy', cursive;">Abc</span>
                            </button>
                        </div>
                    </div>

                    <!-- Draw Signature -->
                    <div id="sigDrawContainerA" class="hidden">
                        <div class="sig-draw-container">
                            <canvas id="sigCanvasA" class="sig-canvas"></canvas>
                            <div class="sig-canvas-actions">
                                <button class="sig-clear-btn" onclick="clearCanvas('A')">Clear</button>
                            </div>
                        </div>
                    </div>

                    <button class="sig-apply-btn" id="sigApplyA" onclick="applySignature('A')" disabled>
                        Apply My Signature
                    </button>
                </div>

                <!-- Party B Signature -->
                <div id="sigPartyBPanel" class="hidden">
                    <div class="sig-input-group">
                        <label>Signer's Full Legal Name</label>
                        <input type="text" class="sig-type-input" id="sigNameB" placeholder="Counterparty's full legal name" oninput="updateSignaturePreview('B')">
                    </div>

                    <div class="sig-type-toggle">
                        <button class="sig-toggle-btn active" onclick="setSignatureMode('B', 'type')">Type</button>
                        <button class="sig-toggle-btn" onclick="setSignatureMode('B', 'draw')">Draw</button>
                    </div>

                    <!-- Type Signature -->
                    <div id="sigTypeContainerB">
                        <div class="sig-preview" id="sigPreviewB">
                            <span class="sig-preview-placeholder">Their signature will appear here</span>
                        </div>

                        <div class="sig-font-selector">
                            <button class="sig-font-btn sig-font-dancing active" onclick="selectSignatureFont('B', 'dancing')" data-font="dancing">
                                <span style="font-family: 'Dancing Script', cursive;">Abc</span>
                            </button>
                            <button class="sig-font-btn sig-font-vibes" onclick="selectSignatureFont('B', 'vibes')" data-font="vibes">
                                <span style="font-family: 'Great Vibes', cursive;">Abc</span>
                            </button>
                            <button class="sig-font-btn sig-font-satisfy" onclick="selectSignatureFont('B', 'satisfy')" data-font="satisfy">
                                <span style="font-family: 'Satisfy', cursive;">Abc</span>
                            </button>
                        </div>
                    </div>

                    <!-- Draw Signature -->
                    <div id="sigDrawContainerB" class="hidden">
                        <div class="sig-draw-container">
                            <canvas id="sigCanvasB" class="sig-canvas"></canvas>
                            <div class="sig-canvas-actions">
                                <button class="sig-clear-btn" onclick="clearCanvas('B')">Clear</button>
                            </div>
                        </div>
                    </div>

                    <button class="sig-apply-btn" id="sigApplyB" onclick="applySignature('B')" disabled>
                        Apply Signature
                    </button>

                    <div class="email-sign-section">
                        <div class="sig-input-group" style="margin-bottom: 8px;">
                            <label>Or send for signature via email</label>
                        </div>
                        <div class="email-sign-row">
                            <input type="email" class="email-sign-input" id="emailSignInput" placeholder="counterparty@email.com">
                            <button class="email-sign-btn" onclick="sendForSignature()">Send to Sign</button>
                        </div>
                        <div id="emailSentBadge" class="hidden">
                            <span class="email-sent-badge">üìß Signature request sent</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel">
            <div class="preview-container">
                <div class="preview-toolbar">
                    <div class="preview-toolbar-left">
                        <input type="text" class="session-name-input" id="sessionName" placeholder="Untitled Document">
                        <div class="users-inline" id="userList"></div>
                    </div>
                    <div class="preview-toolbar-actions">
                        <span class="save-status" id="saveStatus">All changes saved</span>
                        <button class="btn btn-outline btn-sm" onclick="printDocument()">Print</button>
                        <button class="btn btn-outline btn-sm" onclick="downloadDocument()">Download</button>
                    </div>
                </div>
                <div class="format-toolbar">
                    <button class="format-btn" onclick="formatDoc('bold')" title="Bold"><b>B</b></button>
                    <button class="format-btn" onclick="formatDoc('italic')" title="Italic"><i>I</i></button>
                    <button class="format-btn" onclick="formatDoc('underline')" title="Underline"><u>U</u></button>
                    <div class="format-divider"></div>
                    <button class="format-btn" onclick="formatDoc('justifyLeft')" title="Align Left">‚¨Ö</button>
                    <button class="format-btn" onclick="formatDoc('justifyCenter')" title="Center">‚¨å</button>
                    <button class="format-btn" onclick="formatDoc('justifyRight')" title="Align Right">‚û°</button>
                    <button class="format-btn" onclick="formatDoc('justifyFull')" title="Justify">‚ò∞</button>
                    <div class="format-divider"></div>
                    <button class="format-btn" onclick="formatDoc('insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                    <button class="format-btn" onclick="formatDoc('insertOrderedList')" title="Numbered List">1.</button>
                    <div class="format-divider"></div>
                    <select onchange="formatDoc('formatBlock', this.value); this.value='';" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #e5e7eb;">
                        <option value="">Heading</option>
                        <option value="h1">Heading 1</option>
                        <option value="h2">Heading 2</option>
                        <option value="h3">Heading 3</option>
                        <option value="p">Paragraph</option>
                    </select>
                </div>
                <div class="preview-content">
                    <div class="doc-preview" id="docPreview" contenteditable="true" oninput="handleDocumentEdit()">
                        <p>Start typing your document here, or select a template from the left panel...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="joinModal">
        <div class="modal">
            <h2>Join Session</h2>
            <p>Enter your name to collaborate</p>
            <input type="text" id="userName" placeholder="Your name" autofocus>
            <button class="btn btn-primary" id="joinBtn">Join Session</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ========== DOCUMENT GENERATORS ==========
        const documentGenerators = {
            'blank': {
                title: 'Blank Document',
                description: 'Start with a blank document',
                form: generateBlankForm,
                preview: generateBlankPreview
            },
            'non-solicitation': {
                title: 'Non-Solicitation Agreement',
                description: 'Protect your customers and employees from poaching',
                form: generateNonSolicitationForm,
                preview: generateNonSolicitationPreview
            },
            'commission': {
                title: 'Commission Agreement',
                description: 'Sales commission structure and payment terms',
                form: generateCommissionForm,
                preview: generateCommissionPreview
            },
            'nda': {
                title: 'Non-Disclosure Agreement',
                description: 'Protect confidential information in business relationships',
                form: generateNDAForm,
                preview: generateNDAPreview
            },
            'piia': {
                title: 'PIIA (Inventions Assignment)',
                description: 'Assign intellectual property and inventions to employer',
                form: generatePIIAForm,
                preview: generatePIIAPreview
            },
            'sublease': {
                title: 'Sublease Agreement',
                description: 'Sublease residential or commercial property',
                form: generateSubleaseForm,
                preview: generateSubleasePreview
            }
        };

        let lastChangedField = null;

        function loadDocumentGenerator() {
            const docType = document.getElementById('docTypeSelector').value;
            const formContainer = document.getElementById('generatorFormContainer');
            const preview = document.getElementById('docPreview');

            if (!docType || !documentGenerators[docType]) {
                formContainer.innerHTML = `
                    <div class="blank-doc-message">
                        <h3>Select a Document</h3>
                        <p>Choose a document template to get started.</p>
                    </div>
                `;
                return;
            }

            const generator = documentGenerators[docType];
            formContainer.innerHTML = generator.form();

            if (docType !== 'blank') {
                preview.innerHTML = generator.preview();
            }

            syncToFirebase();
        }

        function updateGeneratorPreview(fieldId) {
            const docType = document.getElementById('docTypeSelector').value;
            if (!docType || !documentGenerators[docType] || docType === 'blank') return;

            lastChangedField = fieldId;
            const generator = documentGenerators[docType];
            document.getElementById('docPreview').innerHTML = generator.preview();

            // Scroll to and highlight changed field
            if (fieldId) {
                setTimeout(() => {
                    const highlights = document.querySelectorAll('.doc-highlight');
                    highlights.forEach(el => {
                        if (el.dataset.field === fieldId) {
                            el.classList.add('field-highlight-active');
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            setTimeout(() => el.classList.remove('field-highlight-active'), 600);
                        }
                    });
                }, 50);
            }

            syncToFirebase();
        }

        function getGenValue(id, defaultVal = '') {
            const el = document.getElementById(id);
            if (!el) return defaultVal;
            if (el.type === 'checkbox') return el.checked;
            return el.value || defaultVal;
        }

        function formatGenDate(dateStr) {
            if (!dateStr) return '[DATE]';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function hl(value, defaultVal, fieldId = '') {
            const display = value || defaultVal;
            return `<span class="doc-highlight" data-field="${fieldId}">${display}</span>`;
        }

        // ========== BLANK DOCUMENT ==========
        function generateBlankForm() {
            return `
                <div class="blank-doc-message">
                    <h3>Blank Document</h3>
                    <p>Type directly in the editor on the right. Use the formatting toolbar to style your text.</p>
                    <p style="margin-top: 12px; font-size: 12px; color: #9ca3af;">All changes sync in real-time with collaborators.</p>
                </div>
            `;
        }

        function generateBlankPreview() {
            return `<p>Start typing your document here...</p>`;
        }

        // ========== NON-SOLICITATION GENERATOR ==========
        function generateNonSolicitationForm() {
            const today = new Date().toISOString().split('T')[0];
            return `
                <div class="gen-form-header">
                    <h2>Non-Solicitation Agreement</h2>
                    <p>Protect your business relationships and workforce</p>
                </div>

                <div class="gen-info-box">
                    <strong>Why Non-Solicitation Agreements Matter</strong><br>
                    Unlike non-competes (banned in CA, restricted elsewhere), non-solicitation agreements are enforceable in most states because they don't prevent employment‚Äîthey protect specific business relationships.
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Company Information</div>
                    <div class="gen-form-group">
                        <label class="tooltip-trigger">Company Legal Name <span class="tooltip-icon">?</span></label>
                        <input type="text" id="gen_companyName" placeholder="Acme Corporation, Inc." oninput="updateGeneratorPreview('companyName')">
                        <div class="field-help">Use your exact legal entity name as registered with the state (e.g., "Inc.", "LLC", "Corp.")</div>
                    </div>
                    <div class="gen-form-row">
                        <div class="gen-form-group">
                            <label class="tooltip-trigger">Governing State <span class="tooltip-icon">?</span></label>
                            <select id="gen_companyState" onchange="updateGeneratorPreview('companyState')">
                                <option value="">Select...</option>
                                <option value="California">California</option>
                                <option value="Delaware">Delaware</option>
                                <option value="Florida">Florida</option>
                                <option value="Illinois">Illinois</option>
                                <option value="Massachusetts">Massachusetts</option>
                                <option value="New York">New York</option>
                                <option value="Texas">Texas</option>
                                <option value="Washington">Washington</option>
                            </select>
                            <div class="field-help">State law governs enforceability. CA has strict limits; most others allow reasonable restrictions.</div>
                        </div>
                        <div class="gen-form-group">
                            <label>Effective Date</label>
                            <input type="date" id="gen_effectiveDate" value="${today}" onchange="updateGeneratorPreview('effectiveDate')">
                        </div>
                    </div>
                    <div class="gen-form-group">
                        <label>Company Address</label>
                        <input type="text" id="gen_companyAddress" placeholder="123 Business Ave, Suite 100, City, State ZIP" oninput="updateGeneratorPreview('companyAddress')">
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Individual Information</div>
                    <div class="gen-form-group">
                        <label>Individual's Full Legal Name</label>
                        <input type="text" id="gen_individualName" placeholder="John Michael Smith" oninput="updateGeneratorPreview('individualName')">
                    </div>
                    <div class="gen-form-group">
                        <label class="tooltip-trigger">Relationship Type <span class="tooltip-icon">?</span></label>
                        <select id="gen_individualType" onchange="updateGeneratorPreview('individualType')">
                            <option value="employee">Employee</option>
                            <option value="contractor">Independent Contractor</option>
                            <option value="consultant">Consultant</option>
                            <option value="officer">Officer/Director</option>
                            <option value="partner">Business Partner</option>
                        </select>
                        <div class="field-help">The agreement terms adjust based on relationship type. Officers/partners typically have broader restrictions.</div>
                    </div>
                    <div class="gen-form-group">
                        <label>Position/Title</label>
                        <input type="text" id="gen_jobTitle" placeholder="Regional Sales Director" oninput="updateGeneratorPreview('jobTitle')">
                    </div>
                    <div class="gen-form-group">
                        <label>Individual's Address</label>
                        <input type="text" id="gen_individualAddress" placeholder="456 Home Street, City, State ZIP" oninput="updateGeneratorPreview('individualAddress')">
                    </div>
                </div>

                <div class="gen-warning-box">
                    <strong>California Notice:</strong> Non-solicitation of <em>employees</em> is generally unenforceable in CA per Business & Professions Code ¬ß 16600. Customer non-solicits may be enforceable if tied to trade secrets.
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Customer Non-Solicitation</div>
                    <div class="gen-form-group">
                        <label class="tooltip-trigger">Restriction Period <span class="tooltip-icon">?</span></label>
                        <select id="gen_customerPeriod" onchange="updateGeneratorPreview('customerPeriod')">
                            <option value="6 months">6 Months</option>
                            <option value="12 months" selected>12 Months</option>
                            <option value="18 months">18 Months</option>
                            <option value="24 months">24 Months</option>
                        </select>
                        <div class="field-help">Courts favor 12-18 months. Longer periods require strong justification (trade secrets, key accounts).</div>
                    </div>
                    <div class="gen-form-group">
                        <label class="tooltip-trigger">Protected Customers <span class="tooltip-icon">?</span></label>
                        <select id="gen_customerScope" onchange="updateGeneratorPreview('customerScope')">
                            <option value="worked-with">Customers individual worked with directly</option>
                            <option value="had-contact">Customers individual had material contact with</option>
                            <option value="confidential-info">Customers about whom individual received confidential information</option>
                            <option value="all-customers">All company customers (broader - may be harder to enforce)</option>
                        </select>
                        <div class="field-help">Narrower scope = more enforceable. "Worked with directly" is strongest in court.</div>
                    </div>
                    <div class="gen-form-group">
                        <label class="tooltip-trigger">Lookback Period <span class="tooltip-icon">?</span></label>
                        <select id="gen_lookbackPeriod" onchange="updateGeneratorPreview('lookbackPeriod')">
                            <option value="12 months">Last 12 months of employment</option>
                            <option value="18 months">Last 18 months of employment</option>
                            <option value="24 months" selected>Last 24 months of employment</option>
                        </select>
                        <div class="field-help">Defines which customers are "protected" based on when the relationship existed.</div>
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Employee Non-Solicitation</div>
                    <div class="gen-form-group">
                        <label>Restriction Period</label>
                        <select id="gen_employeePeriod" onchange="updateGeneratorPreview('employeePeriod')">
                            <option value="6 months">6 Months</option>
                            <option value="12 months" selected>12 Months</option>
                            <option value="18 months">18 Months</option>
                            <option value="24 months">24 Months</option>
                        </select>
                    </div>
                    <div class="gen-form-group">
                        <label class="tooltip-trigger">Protected Personnel <span class="tooltip-icon">?</span></label>
                        <select id="gen_employeeScope" onchange="updateGeneratorPreview('employeeScope')">
                            <option value="worked-with">Employees individual worked with directly</option>
                            <option value="supervised">Employees individual supervised or managed</option>
                            <option value="department">Employees in individual's department</option>
                            <option value="all-employees">All company employees (broadest)</option>
                        </select>
                    </div>
                    <div class="gen-form-group">
                        <div class="gen-checkbox-group">
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_includeContractors" onchange="updateGeneratorPreview('includeContractors')" checked>
                                <span>Include contractors</span>
                            </label>
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_includeConsultants" onchange="updateGeneratorPreview('includeConsultants')" checked>
                                <span>Include consultants</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Additional Provisions</div>
                    <div class="gen-form-group">
                        <div class="gen-checkbox-group">
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_includeConfidentiality" onchange="updateGeneratorPreview('includeConfidentiality')" checked>
                                <span>Confidentiality clause</span>
                            </label>
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_includeNonDisparagement" onchange="updateGeneratorPreview('includeNonDisparagement')" checked>
                                <span>Non-disparagement</span>
                            </label>
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_includeInjunctiveRelief" onchange="updateGeneratorPreview('includeInjunctiveRelief')" checked>
                                <span>Injunctive relief</span>
                            </label>
                        </div>
                        <div class="field-help" style="margin-top: 8px;">Injunctive relief allows seeking court orders to stop violations without proving monetary damages first.</div>
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Consideration (What Employee Receives)</div>
                    <div class="gen-form-group">
                        <label class="tooltip-trigger">Consideration Type <span class="tooltip-icon">?</span></label>
                        <select id="gen_considerationType" onchange="updateGeneratorPreview('considerationType')">
                            <option value="employment">Initial employment (new hire)</option>
                            <option value="continued-employment">Continued employment (existing employee)</option>
                            <option value="promotion">Promotion or new position</option>
                            <option value="bonus">Signing bonus or special compensation</option>
                            <option value="equity">Stock options or equity grant</option>
                        </select>
                        <div class="field-help"><strong>Critical for enforceability:</strong> Some states (IL, NC, WA) require consideration beyond just continued employment. A bonus or raise strengthens the agreement.</div>
                    </div>
                    <div class="gen-form-group" id="considerationAmountGroup" style="display:none;">
                        <label>Consideration Amount ($)</label>
                        <input type="text" id="gen_considerationAmount" placeholder="5,000" oninput="updateGeneratorPreview('considerationAmount')">
                    </div>
                </div>

                <div class="gen-tip-box">
                    <strong>Enforceability Tips:</strong><br>
                    ‚Ä¢ Have employee sign at hire (not after starting)<br>
                    ‚Ä¢ Keep restrictions reasonable in time and scope<br>
                    ‚Ä¢ Provide real consideration (bonus, raise, promotion)<br>
                    ‚Ä¢ Review state-specific requirements annually
                </div>
            `;
        }

        function generateNonSolicitationPreview() {
            const companyName = getGenValue('gen_companyName', '[COMPANY NAME]');
            const companyState = getGenValue('gen_companyState', '[STATE]');
            const companyAddress = getGenValue('gen_companyAddress', '[COMPANY ADDRESS]');
            const effectiveDate = formatGenDate(getGenValue('gen_effectiveDate'));
            const individualName = getGenValue('gen_individualName', '[INDIVIDUAL NAME]');
            const individualAddress = getGenValue('gen_individualAddress', '[INDIVIDUAL ADDRESS]');
            const individualType = getGenValue('gen_individualType', 'employee');
            const jobTitle = getGenValue('gen_jobTitle', '[TITLE]');
            const customerPeriod = getGenValue('gen_customerPeriod', '12 months');
            const customerScope = getGenValue('gen_customerScope', 'worked-with');
            const lookbackPeriod = getGenValue('gen_lookbackPeriod', '24 months');
            const employeePeriod = getGenValue('gen_employeePeriod', '12 months');
            const employeeScope = getGenValue('gen_employeeScope', 'worked-with');
            const includeContractors = getGenValue('gen_includeContractors');
            const includeConsultants = getGenValue('gen_includeConsultants');
            const includeConfidentiality = getGenValue('gen_includeConfidentiality');
            const includeNonDisparagement = getGenValue('gen_includeNonDisparagement');
            const includeInjunctiveRelief = getGenValue('gen_includeInjunctiveRelief');
            const considerationType = getGenValue('gen_considerationType', 'employment');

            const typeLabels = {
                'employee': 'Employee',
                'contractor': 'Contractor',
                'consultant': 'Consultant',
                'officer': 'Officer',
                'partner': 'Partner'
            };
            const typeLabel = typeLabels[individualType] || 'Employee';

            const customerScopeText = {
                'worked-with': 'with whom ' + typeLabel + ' had direct business dealings or for whom ' + typeLabel + ' performed services',
                'had-contact': 'with whom ' + typeLabel + ' had material contact or about whom ' + typeLabel + ' obtained information',
                'confidential-info': 'about whom ' + typeLabel + ' received Confidential Information during the course of engagement',
                'all-customers': 'who were customers of Company'
            }[customerScope];

            const employeeScopeText = {
                'worked-with': 'with whom ' + typeLabel + ' worked directly',
                'supervised': 'whom ' + typeLabel + ' supervised, managed, or had authority over',
                'department': 'who worked in ' + typeLabel + "'s department or business unit",
                'all-employees': 'employed by Company'
            }[employeeScope];

            let personnelTypes = ['employees'];
            if (includeContractors) personnelTypes.push('independent contractors');
            if (includeConsultants) personnelTypes.push('consultants');
            const personnelText = personnelTypes.join(', ').replace(/, ([^,]*)$/, ', and $1');

            const considerationText = {
                'employment': 'the offer of employment and access to Confidential Information',
                'continued-employment': 'continued employment, access to Confidential Information, and other good and valuable consideration',
                'promotion': 'promotion to the position of ' + jobTitle + ', increased compensation, and access to Confidential Information',
                'bonus': 'special compensation, and access to Confidential Information',
                'equity': 'equity compensation, stock options, and access to Confidential Information'
            }[considerationType];

            let sectionNum = 1;
            let sections = '';

            // RECITALS
            sections += `
                <p><strong>RECITALS</strong></p>
                <p class="clause">A. Company is engaged in the business of providing products and/or services to customers and has developed valuable customer relationships, trade secrets, and goodwill.</p>
                <p class="clause">B. ${typeLabel} is or will be engaged by Company as ${hl(jobTitle, '[TITLE]', 'jobTitle')} and will have access to and become acquainted with Company's Confidential Information, customer relationships, and business operations.</p>
                <p class="clause">C. Company has a legitimate business interest in protecting its customer relationships, workforce stability, and Confidential Information from unfair competition.</p>
                <p class="clause">D. ${typeLabel} acknowledges that the restrictions in this Agreement are reasonable and necessary to protect Company's legitimate business interests.</p>
                <p style="margin-top: 16px;"><strong>NOW, THEREFORE,</strong> in consideration of ${considerationText}, the receipt and sufficiency of which are hereby acknowledged, the parties agree as follows:</p>
            `;

            // DEFINITIONS
            sections += `
                <h2>${sectionNum}. DEFINITIONS</h2>
                <p class="clause">${sectionNum}.1 <strong>"Confidential Information"</strong> means all non-public information relating to Company's business, including but not limited to: customer lists and contact information; customer preferences, requirements, and purchasing history; pricing strategies and discount structures; business plans and marketing strategies; financial information and projections; proprietary processes and methodologies; software, algorithms, and technical data; vendor and supplier relationships; and any information designated as confidential.</p>
                <p class="clause">${sectionNum}.2 <strong>"Customer"</strong> means any person or entity that: (a) purchased products or services from Company; (b) was solicited by Company; or (c) was in active negotiations with Company, in each case during the ${hl(lookbackPeriod, '24 months', 'lookbackPeriod')} preceding the termination of ${typeLabel}'s engagement.</p>
                <p class="clause">${sectionNum}.3 <strong>"Protected Customer"</strong> means any Customer ${customerScopeText} during ${typeLabel}'s engagement with Company.</p>
                <p class="clause">${sectionNum}.4 <strong>"Protected Personnel"</strong> means any ${personnelText} ${employeeScopeText} during ${typeLabel}'s engagement with Company.</p>
                <p class="clause">${sectionNum}.5 <strong>"Restricted Period"</strong> means the period during ${typeLabel}'s engagement with Company and for the applicable time period following termination as specified herein, regardless of the reason for termination.</p>
                <p class="clause">${sectionNum}.6 <strong>"Solicit"</strong> means to initiate contact, encourage, entice, or induce, directly or indirectly, whether for ${typeLabel}'s own benefit or for the benefit of any other person or entity.</p>
            `;
            sectionNum++;

            // NON-SOLICITATION OF CUSTOMERS
            sections += `
                <h2>${sectionNum}. NON-SOLICITATION OF CUSTOMERS</h2>
                <p class="clause">${sectionNum}.1 <strong>Restriction.</strong> During the Restricted Period, which shall continue for ${hl(customerPeriod, '12 months', 'customerPeriod')} following termination of ${typeLabel}'s engagement, ${typeLabel} shall not, directly or indirectly:</p>
                <p class="sub-clause">(a) Solicit any Protected Customer for the purpose of providing products or services that are competitive with those offered by Company;</p>
                <p class="sub-clause">(b) Attempt to induce any Protected Customer to reduce or terminate its business relationship with Company;</p>
                <p class="sub-clause">(c) Interfere with or disrupt any existing or prospective business relationship between Company and any Protected Customer;</p>
                <p class="sub-clause">(d) Accept business from any Protected Customer for products or services competitive with Company's offerings, regardless of who initiated the contact.</p>
                <p class="clause">${sectionNum}.2 <strong>Scope Clarification.</strong> This restriction applies to Protected Customers whether ${typeLabel} contacts them directly, through an intermediary, through a new employer, or through any entity in which ${typeLabel} has an ownership interest or serves in any capacity.</p>
                <p class="clause">${sectionNum}.3 <strong>Permitted Activities.</strong> Nothing herein shall prohibit ${typeLabel} from: (a) responding to general advertising not targeted at Protected Customers; or (b) working for a competitor in a capacity that does not involve Protected Customers.</p>
            `;
            sectionNum++;

            // NON-SOLICITATION OF EMPLOYEES
            sections += `
                <h2>${sectionNum}. NON-SOLICITATION OF PERSONNEL</h2>
                <p class="clause">${sectionNum}.1 <strong>Restriction.</strong> During the Restricted Period, which shall continue for ${hl(employeePeriod, '12 months', 'employeePeriod')} following termination, ${typeLabel} shall not, directly or indirectly:</p>
                <p class="sub-clause">(a) Solicit, recruit, hire, or engage any Protected Personnel to leave Company's employment or engagement;</p>
                <p class="sub-clause">(b) Encourage, induce, or assist any Protected Personnel in terminating their relationship with Company;</p>
                <p class="sub-clause">(c) Hire or engage any Protected Personnel on behalf of any other person or entity;</p>
                <p class="sub-clause">(d) Provide information about Protected Personnel to recruiters, competitors, or other potential employers.</p>
                <p class="clause">${sectionNum}.2 <strong>Independence of Restrictions.</strong> This restriction shall apply regardless of whether ${typeLabel} initiated the contact or whether the Protected Personnel expressed interest in leaving Company independently.</p>
            `;
            sectionNum++;

            // CONFIDENTIALITY
            if (includeConfidentiality) {
                sections += `
                    <h2>${sectionNum}. CONFIDENTIALITY</h2>
                    <p class="clause">${sectionNum}.1 <strong>Non-Disclosure.</strong> ${typeLabel} shall hold all Confidential Information in strict confidence and shall not, without prior written consent of Company, disclose any Confidential Information to any third party or use any Confidential Information for any purpose other than performing duties for Company.</p>
                    <p class="clause">${sectionNum}.2 <strong>Protection Standards.</strong> ${typeLabel} shall protect Confidential Information using at least the same degree of care used to protect ${typeLabel}'s own confidential information, but in no event less than reasonable care.</p>
                    <p class="clause">${sectionNum}.3 <strong>Return of Materials.</strong> Upon termination of engagement or upon Company's request, ${typeLabel} shall immediately return all documents, files, records, and materials containing Confidential Information, including all copies, and shall permanently delete all electronic copies from personal devices and accounts.</p>
                    <p class="clause">${sectionNum}.4 <strong>Survival.</strong> The obligations under this Section shall survive termination of this Agreement and ${typeLabel}'s engagement indefinitely with respect to trade secrets, and for a period of three (3) years with respect to other Confidential Information.</p>
                `;
                sectionNum++;
            }

            // NON-DISPARAGEMENT
            if (includeNonDisparagement) {
                sections += `
                    <h2>${sectionNum}. NON-DISPARAGEMENT</h2>
                    <p class="clause">${sectionNum}.1 ${typeLabel} agrees not to make any false, misleading, or disparaging statements about Company, its officers, directors, employees, products, services, or business practices to any third party, including but not limited to customers, suppliers, employees, competitors, or the media.</p>
                    <p class="clause">${sectionNum}.2 Nothing in this Section shall prohibit ${typeLabel} from: (a) responding truthfully to legal process or government inquiry; (b) reporting suspected violations of law to appropriate authorities; or (c) making truthful statements in the context of legal proceedings.</p>
                `;
                sectionNum++;
            }

            // INJUNCTIVE RELIEF
            if (includeInjunctiveRelief) {
                sections += `
                    <h2>${sectionNum}. REMEDIES AND ENFORCEMENT</h2>
                    <p class="clause">${sectionNum}.1 <strong>Irreparable Harm.</strong> ${typeLabel} acknowledges that a breach of this Agreement would cause irreparable harm to Company for which monetary damages would be inadequate, and that the harm would be difficult or impossible to measure.</p>
                    <p class="clause">${sectionNum}.2 <strong>Injunctive Relief.</strong> In the event of any actual or threatened breach, Company shall be entitled to seek immediate injunctive relief, including temporary restraining orders and preliminary and permanent injunctions, without the necessity of proving actual damages or posting any bond or other security.</p>
                    <p class="clause">${sectionNum}.3 <strong>Cumulative Remedies.</strong> The right to injunctive relief shall be in addition to, and not in lieu of, any other remedies available to Company at law or in equity, including monetary damages and recovery of attorneys' fees.</p>
                    <p class="clause">${sectionNum}.4 <strong>Extension of Restricted Period.</strong> If ${typeLabel} violates any provision of this Agreement, the Restricted Period shall be extended by a period equal to the duration of such violation.</p>
                `;
                sectionNum++;
            }

            // GENERAL PROVISIONS
            sections += `
                <h2>${sectionNum}. GENERAL PROVISIONS</h2>
                <p class="clause">${sectionNum}.1 <strong>Governing Law and Jurisdiction.</strong> This Agreement shall be governed by and construed in accordance with the laws of the State of ${hl(companyState, '[STATE]', 'companyState')}, without regard to its conflicts of law principles. The parties consent to the exclusive jurisdiction of the state and federal courts located in ${hl(companyState, '[STATE]', 'companyState')} for any disputes arising under this Agreement.</p>
                <p class="clause">${sectionNum}.2 <strong>Severability and Modification.</strong> If any provision of this Agreement is held to be invalid, illegal, or unenforceable, such provision shall be modified to the minimum extent necessary to make it valid and enforceable, or if modification is not possible, shall be severed from this Agreement. The invalidity of any provision shall not affect the validity of the remaining provisions.</p>
                <p class="clause">${sectionNum}.3 <strong>Entire Agreement.</strong> This Agreement constitutes the entire agreement between the parties concerning its subject matter and supersedes all prior agreements, understandings, negotiations, and discussions, whether oral or written.</p>
                <p class="clause">${sectionNum}.4 <strong>Amendment.</strong> This Agreement may not be amended or modified except by a written instrument signed by both parties.</p>
                <p class="clause">${sectionNum}.5 <strong>Waiver.</strong> No waiver of any provision of this Agreement shall be effective unless in writing. The failure of either party to enforce any provision shall not constitute a waiver of such provision or affect the right to enforce it at a later time.</p>
                <p class="clause">${sectionNum}.6 <strong>Assignment.</strong> ${typeLabel} may not assign this Agreement or any rights or obligations hereunder. Company may assign this Agreement to any successor or affiliate without consent.</p>
                <p class="clause">${sectionNum}.7 <strong>Attorneys' Fees.</strong> In any action to enforce this Agreement, the prevailing party shall be entitled to recover reasonable attorneys' fees and costs from the non-prevailing party.</p>
                <p class="clause">${sectionNum}.8 <strong>Acknowledgment.</strong> ${typeLabel} acknowledges having read this Agreement, having had the opportunity to consult with independent legal counsel, and voluntarily agreeing to all terms and conditions set forth herein.</p>
            `;

            return `
                <h1>NON-SOLICITATION AGREEMENT</h1>
                <p class="center" style="font-style: italic;">Effective Date: ${hl(effectiveDate, '[DATE]', 'effectiveDate')}</p>

                <p>This Non-Solicitation Agreement (this <strong>"Agreement"</strong>) is entered into as of the Effective Date by and between:</p>

                <div class="parties" style="margin: 24px 0; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <p><strong>${hl(companyName, '[COMPANY NAME]', 'companyName')}</strong>, a ${hl(companyState, '[STATE]', 'companyState')} corporation with its principal place of business at ${hl(companyAddress, '[COMPANY ADDRESS]', 'companyAddress')} (<strong>"Company"</strong>)</p>
                    <p style="margin-top: 12px;"><strong>${hl(individualName, '[INDIVIDUAL NAME]', 'individualName')}</strong>, an individual residing at ${hl(individualAddress, '[INDIVIDUAL ADDRESS]', 'individualAddress')} (<strong>"${typeLabel}"</strong>)</p>
                </div>

                ${sections}

                <p style="margin-top: 24px;"><strong>IN WITNESS WHEREOF,</strong> the parties have executed this Agreement as of the Effective Date.</p>

                <div class="signature-block">
                    <div class="signature-party">
                        <h3>COMPANY</h3>
                        <p>${hl(companyName, '[COMPANY NAME]', 'companyName')}</p>
                        <div class="signature-line">Signature</div>
                        <div class="signature-line">Printed Name</div>
                        <div class="signature-line">Title</div>
                        <div class="signature-line">Date</div>
                    </div>
                    <div class="signature-party">
                        <h3>${typeLabel.toUpperCase()}</h3>
                        <div class="signature-line">Signature</div>
                        <div class="signature-line">${hl(individualName, '[NAME]', 'individualName')}</div>
                        <div class="signature-line">Date</div>
                    </div>
                </div>
            `;
        }

        // ========== COMMISSION AGREEMENT GENERATOR ==========
        function generateCommissionForm() {
            const today = new Date().toISOString().split('T')[0];
            return `
                <div class="gen-form-header">
                    <h2>Commission Agreement</h2>
                    <p>Sales commission structure and payment terms</p>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Company Information</div>
                    <div class="gen-form-group">
                        <label>Company Name</label>
                        <input type="text" id="gen_companyName" placeholder="Sales Corp, Inc." oninput="updateGeneratorPreview('companyName')">
                    </div>
                    <div class="gen-form-row">
                        <div class="gen-form-group">
                            <label>State</label>
                            <select id="gen_companyState" onchange="updateGeneratorPreview('companyState')">
                                <option value="">Select...</option>
                                <option value="California">California</option>
                                <option value="Delaware">Delaware</option>
                                <option value="Florida">Florida</option>
                                <option value="New York">New York</option>
                                <option value="Texas">Texas</option>
                            </select>
                        </div>
                        <div class="gen-form-group">
                            <label>Effective Date</label>
                            <input type="date" id="gen_effectiveDate" value="${today}" onchange="updateGeneratorPreview('effectiveDate')">
                        </div>
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Salesperson Information</div>
                    <div class="gen-form-group">
                        <label>Salesperson Name</label>
                        <input type="text" id="gen_salespersonName" placeholder="Jane Sales" oninput="updateGeneratorPreview('salespersonName')">
                    </div>
                    <div class="gen-form-group">
                        <label>Title/Role</label>
                        <input type="text" id="gen_jobTitle" placeholder="Regional Sales Manager" oninput="updateGeneratorPreview('jobTitle')">
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Commission Structure</div>
                    <div class="gen-form-row">
                        <div class="gen-form-group">
                            <label>Commission Rate (%)</label>
                            <input type="number" id="gen_commissionRate" placeholder="10" min="0" max="100" step="0.5" oninput="updateGeneratorPreview('commissionRate')">
                        </div>
                        <div class="gen-form-group">
                            <label>Based On</label>
                            <select id="gen_commissionBasis" onchange="updateGeneratorPreview('commissionBasis')">
                                <option value="gross sales">Gross Sales</option>
                                <option value="net sales">Net Sales</option>
                                <option value="collected revenue">Collected Revenue</option>
                            </select>
                        </div>
                    </div>
                    <div class="gen-form-group">
                        <label>Payment Frequency</label>
                        <select id="gen_paymentFrequency" onchange="updateGeneratorPreview('paymentFrequency')">
                            <option value="monthly">Monthly</option>
                            <option value="bi-weekly">Bi-Weekly</option>
                            <option value="quarterly">Quarterly</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function generateCommissionPreview() {
            const companyName = getGenValue('gen_companyName', '[COMPANY NAME]');
            const companyState = getGenValue('gen_companyState', '[STATE]');
            const effectiveDate = formatGenDate(getGenValue('gen_effectiveDate'));
            const salespersonName = getGenValue('gen_salespersonName', '[SALESPERSON NAME]');
            const jobTitle = getGenValue('gen_jobTitle', '[TITLE]');
            const commissionRate = getGenValue('gen_commissionRate', '[RATE]');
            const commissionBasis = getGenValue('gen_commissionBasis', 'gross sales');
            const paymentFrequency = getGenValue('gen_paymentFrequency', 'monthly');

            return `
                <h1>Sales Commission Agreement</h1>
                <p class="center" style="font-style: italic;">Effective Date: ${hl(effectiveDate, '[DATE]', 'effectiveDate')}</p>

                <div class="parties">
                    <p>This Agreement is entered into by:</p>
                    <p><strong>Company:</strong> ${hl(companyName, '[COMPANY NAME]', 'companyName')}</p>
                    <p><strong>Salesperson:</strong> ${hl(salespersonName, '[SALESPERSON NAME]', 'salespersonName')}, serving as ${hl(jobTitle, '[TITLE]', 'jobTitle')}</p>
                </div>

                <h2>1. COMMISSION STRUCTURE</h2>
                <p class="clause">1.1 <strong>Commission Rate.</strong> Salesperson shall earn a commission of ${hl(commissionRate + '%', '[RATE]%', 'commissionRate')} of ${hl(commissionBasis, 'gross sales', 'commissionBasis')} for all qualifying sales.</p>
                <p class="clause">1.2 <strong>Payment.</strong> Commissions shall be paid ${hl(paymentFrequency, 'monthly', 'paymentFrequency')}, within 15 days after the end of each period.</p>

                <h2>2. GENERAL PROVISIONS</h2>
                <p class="clause">2.1 <strong>Governing Law.</strong> This Agreement is governed by the laws of ${hl(companyState, '[STATE]', 'companyState')}.</p>

                <div class="signature-block">
                    <div class="signature-party">
                        <h3>Company</h3>
                        <div class="signature-line">Signature</div>
                        <div class="signature-line">Name & Title</div>
                        <div class="signature-line">Date</div>
                    </div>
                    <div class="signature-party">
                        <h3>Salesperson</h3>
                        <div class="signature-line">Signature</div>
                        <div class="signature-line">${hl(salespersonName, '[NAME]', 'salespersonName')}</div>
                        <div class="signature-line">Date</div>
                    </div>
                </div>
            `;
        }

        // ========== NDA GENERATOR ==========
        function generateNDAForm() {
            const today = new Date().toISOString().split('T')[0];
            return `
                <div class="gen-form-header">
                    <h2>Non-Disclosure Agreement</h2>
                    <p>Protect confidential information in business relationships</p>
                </div>

                <div class="gen-info-box">
                    <strong>Choosing the Right NDA Type</strong><br>
                    <strong>Mutual:</strong> Both parties share confidential information (partnerships, joint ventures, M&A discussions).<br>
                    <strong>Unilateral:</strong> One party discloses to the other (hiring contractors, pitching to investors).
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Agreement Type</div>
                    <div class="gen-form-group">
                        <label class="tooltip-trigger">NDA Type <span class="tooltip-icon">?</span></label>
                        <select id="gen_ndaType" onchange="updateGeneratorPreview('ndaType')">
                            <option value="mutual">Mutual (Two-Way)</option>
                            <option value="unilateral">Unilateral (One-Way)</option>
                        </select>
                        <div class="field-help">Mutual NDAs protect both parties equally. Use unilateral when only one party discloses sensitive information.</div>
                    </div>
                    <div class="gen-form-group">
                        <label class="tooltip-trigger">Purpose of Disclosure <span class="tooltip-icon">?</span></label>
                        <select id="gen_purpose" onchange="updateGeneratorPreview('purpose')">
                            <option value="business-relationship">Evaluating potential business relationship</option>
                            <option value="partnership">Exploring strategic partnership</option>
                            <option value="investment">Investment discussions</option>
                            <option value="acquisition">M&A or acquisition discussions</option>
                            <option value="employment">Employment or contractor engagement</option>
                            <option value="vendor">Vendor or supplier evaluation</option>
                            <option value="licensing">Technology licensing discussions</option>
                        </select>
                        <div class="field-help">Defining the purpose limits how disclosed information can be used.</div>
                    </div>
                    <div class="gen-form-row">
                        <div class="gen-form-group">
                            <label>Governing State</label>
                            <select id="gen_governingState" onchange="updateGeneratorPreview('governingState')">
                                <option value="">Select...</option>
                                <option value="California">California</option>
                                <option value="Delaware">Delaware</option>
                                <option value="Florida">Florida</option>
                                <option value="Illinois">Illinois</option>
                                <option value="New York">New York</option>
                                <option value="Texas">Texas</option>
                            </select>
                        </div>
                        <div class="gen-form-group">
                            <label>Effective Date</label>
                            <input type="date" id="gen_effectiveDate" value="${today}" onchange="updateGeneratorPreview('effectiveDate')">
                        </div>
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Disclosing Party (Party A)</div>
                    <div class="gen-form-group">
                        <label>Legal Entity Name</label>
                        <input type="text" id="gen_disclosingParty" placeholder="ABC Corporation, Inc." oninput="updateGeneratorPreview('disclosingParty')">
                    </div>
                    <div class="gen-form-group">
                        <label>Entity Type</label>
                        <select id="gen_disclosingType" onchange="updateGeneratorPreview('disclosingType')">
                            <option value="corporation">Corporation</option>
                            <option value="llc">LLC</option>
                            <option value="partnership">Partnership</option>
                            <option value="individual">Individual</option>
                        </select>
                    </div>
                    <div class="gen-form-group">
                        <label>State of Formation/Residence</label>
                        <input type="text" id="gen_disclosingState" placeholder="Delaware" oninput="updateGeneratorPreview('disclosingState')">
                    </div>
                    <div class="gen-form-group">
                        <label>Address</label>
                        <input type="text" id="gen_disclosingAddress" placeholder="123 Main Street, Suite 100, City, State ZIP" oninput="updateGeneratorPreview('disclosingAddress')">
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Receiving Party (Party B)</div>
                    <div class="gen-form-group">
                        <label>Legal Entity Name</label>
                        <input type="text" id="gen_receivingParty" placeholder="XYZ Company LLC" oninput="updateGeneratorPreview('receivingParty')">
                    </div>
                    <div class="gen-form-group">
                        <label>Entity Type</label>
                        <select id="gen_receivingType" onchange="updateGeneratorPreview('receivingType')">
                            <option value="corporation">Corporation</option>
                            <option value="llc">LLC</option>
                            <option value="partnership">Partnership</option>
                            <option value="individual">Individual</option>
                        </select>
                    </div>
                    <div class="gen-form-group">
                        <label>State of Formation/Residence</label>
                        <input type="text" id="gen_receivingState" placeholder="California" oninput="updateGeneratorPreview('receivingState')">
                    </div>
                    <div class="gen-form-group">
                        <label>Address</label>
                        <input type="text" id="gen_receivingAddress" placeholder="456 Oak Avenue, City, State ZIP" oninput="updateGeneratorPreview('receivingAddress')">
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Term & Duration</div>
                    <div class="gen-form-row">
                        <div class="gen-form-group">
                            <label class="tooltip-trigger">Agreement Term <span class="tooltip-icon">?</span></label>
                            <select id="gen_termYears" onchange="updateGeneratorPreview('termYears')">
                                <option value="1">1 Year</option>
                                <option value="2" selected>2 Years</option>
                                <option value="3">3 Years</option>
                                <option value="5">5 Years</option>
                                <option value="indefinite">Indefinite (until terminated)</option>
                            </select>
                            <div class="field-help">How long parties can share information under this NDA.</div>
                        </div>
                        <div class="gen-form-group">
                            <label class="tooltip-trigger">Confidentiality Survival <span class="tooltip-icon">?</span></label>
                            <select id="gen_survivalYears" onchange="updateGeneratorPreview('survivalYears')">
                                <option value="2">2 Years</option>
                                <option value="3" selected>3 Years</option>
                                <option value="5">5 Years</option>
                                <option value="indefinite">Indefinite (trade secrets)</option>
                            </select>
                            <div class="field-help">How long confidentiality obligations last after the agreement ends. Trade secrets should be protected indefinitely.</div>
                        </div>
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Additional Protections</div>
                    <div class="gen-form-group">
                        <div class="gen-checkbox-group">
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_includeNonCircumvent" onchange="updateGeneratorPreview('includeNonCircumvent')" checked>
                                <span>Non-Circumvention</span>
                            </label>
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_includeNonSolicitation" onchange="updateGeneratorPreview('includeNonSolicitation')">
                                <span>Non-Solicitation</span>
                            </label>
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_includeNonCompete" onchange="updateGeneratorPreview('includeNonCompete')">
                                <span>Non-Compete (limited)</span>
                            </label>
                        </div>
                        <div class="field-help" style="margin-top: 8px;">
                            <strong>Non-Circumvention:</strong> Prevents parties from bypassing each other to deal directly with disclosed contacts.<br>
                            <strong>Non-Solicitation:</strong> Prevents hiring each other's employees.<br>
                            <strong>Non-Compete:</strong> Limits using information to compete (use cautiously, often unenforceable).
                        </div>
                    </div>
                    <div class="gen-form-group">
                        <div class="gen-checkbox-group">
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_includeInjunctive" onchange="updateGeneratorPreview('includeInjunctive')" checked>
                                <span>Injunctive Relief</span>
                            </label>
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_includeIndemnification" onchange="updateGeneratorPreview('includeIndemnification')" checked>
                                <span>Indemnification</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Permitted Disclosures</div>
                    <div class="gen-form-group">
                        <label class="tooltip-trigger">Who can receive confidential information? <span class="tooltip-icon">?</span></label>
                        <div class="gen-checkbox-group">
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_permitEmployees" onchange="updateGeneratorPreview('permitEmployees')" checked>
                                <span>Employees (need-to-know)</span>
                            </label>
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_permitContractors" onchange="updateGeneratorPreview('permitContractors')" checked>
                                <span>Contractors</span>
                            </label>
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_permitAdvisors" onchange="updateGeneratorPreview('permitAdvisors')" checked>
                                <span>Legal/Financial Advisors</span>
                            </label>
                            <label class="gen-checkbox-label">
                                <input type="checkbox" id="gen_permitAffiliates" onchange="updateGeneratorPreview('permitAffiliates')">
                                <span>Affiliates/Subsidiaries</span>
                            </label>
                        </div>
                        <div class="field-help" style="margin-top: 8px;">All permitted recipients must be bound by confidentiality obligations at least as protective as this NDA.</div>
                    </div>
                </div>

                <div class="gen-warning-box">
                    <strong>Legal Compliance Note:</strong> This NDA includes standard exceptions for legally required disclosures (subpoenas, court orders). The receiving party must provide advance notice when possible.
                </div>

                <div class="gen-tip-box">
                    <strong>Best Practices:</strong><br>
                    ‚Ä¢ Mark confidential documents clearly ("CONFIDENTIAL")<br>
                    ‚Ä¢ Confirm oral disclosures in writing within 10 days<br>
                    ‚Ä¢ Keep records of what information was shared<br>
                    ‚Ä¢ Review annually and update as needed
                </div>
            `;
        }

        function generateNDAPreview() {
            const ndaType = getGenValue('gen_ndaType', 'mutual');
            const governingState = getGenValue('gen_governingState', '[STATE]');
            const effectiveDate = formatGenDate(getGenValue('gen_effectiveDate'));
            const purpose = getGenValue('gen_purpose', 'business-relationship');
            const disclosingParty = getGenValue('gen_disclosingParty', '[PARTY A NAME]');
            const disclosingType = getGenValue('gen_disclosingType', 'corporation');
            const disclosingState = getGenValue('gen_disclosingState', '[STATE]');
            const disclosingAddress = getGenValue('gen_disclosingAddress', '[ADDRESS]');
            const receivingParty = getGenValue('gen_receivingParty', '[PARTY B NAME]');
            const receivingType = getGenValue('gen_receivingType', 'corporation');
            const receivingState = getGenValue('gen_receivingState', '[STATE]');
            const receivingAddress = getGenValue('gen_receivingAddress', '[ADDRESS]');
            const termYears = getGenValue('gen_termYears', '2');
            const survivalYears = getGenValue('gen_survivalYears', '3');
            const includeNonCircumvent = getGenValue('gen_includeNonCircumvent');
            const includeNonSolicitation = getGenValue('gen_includeNonSolicitation');
            const includeNonCompete = getGenValue('gen_includeNonCompete');
            const includeInjunctive = getGenValue('gen_includeInjunctive');
            const includeIndemnification = getGenValue('gen_includeIndemnification');
            const permitEmployees = getGenValue('gen_permitEmployees');
            const permitContractors = getGenValue('gen_permitContractors');
            const permitAdvisors = getGenValue('gen_permitAdvisors');
            const permitAffiliates = getGenValue('gen_permitAffiliates');

            const isMutual = ndaType === 'mutual';
            const partyA = isMutual ? 'Party A' : 'Disclosing Party';
            const partyB = isMutual ? 'Party B' : 'Receiving Party';
            const parties = isMutual ? 'each party' : 'Receiving Party';
            const Parties = isMutual ? 'Each party' : 'Receiving Party';
            const otherParty = isMutual ? 'the other party' : 'Disclosing Party';

            const entityTypes = {
                'corporation': 'corporation',
                'llc': 'limited liability company',
                'partnership': 'partnership',
                'individual': 'individual'
            };

            const purposeText = {
                'business-relationship': 'evaluating a potential business relationship between the parties',
                'partnership': 'exploring a potential strategic partnership or joint venture',
                'investment': 'evaluating a potential investment opportunity',
                'acquisition': 'evaluating a potential merger, acquisition, or similar transaction',
                'employment': 'evaluating a potential employment or contractor engagement',
                'vendor': 'evaluating a potential vendor or supplier relationship',
                'licensing': 'evaluating a potential technology licensing arrangement'
            }[purpose];

            // Build permitted recipients
            let permittedRecipients = [];
            if (permitEmployees) permittedRecipients.push('employees who have a need to know');
            if (permitContractors) permittedRecipients.push('contractors and consultants');
            if (permitAdvisors) permittedRecipients.push('legal counsel, accountants, and financial advisors');
            if (permitAffiliates) permittedRecipients.push('affiliates and subsidiaries');
            const recipientsText = permittedRecipients.length > 0 ? permittedRecipients.join('; ') : 'employees with a need to know';

            const termText = termYears === 'indefinite' ? 'until terminated by either party upon thirty (30) days written notice' : `for a period of ${termYears} year${termYears > 1 ? 's' : ''} from the Effective Date`;
            const survivalText = survivalYears === 'indefinite' ? 'shall survive indefinitely' : `shall survive for a period of ${survivalYears} year${survivalYears > 1 ? 's' : ''} following termination or expiration of this Agreement`;

            let sectionNum = 1;
            let sections = '';

            // DEFINITIONS
            sections += `
                <h2>${sectionNum}. DEFINITIONS</h2>
                <p class="clause">${sectionNum}.1 <strong>"Confidential Information"</strong> means any and all non-public, proprietary, or confidential information disclosed by ${isMutual ? 'either party' : 'Disclosing Party'} to ${isMutual ? 'the other party' : 'Receiving Party'}, whether disclosed orally, in writing, electronically, or by any other means, and whether or not marked as confidential, including but not limited to:</p>
                <p class="sub-clause">(a) Trade secrets, inventions, ideas, processes, formulas, algorithms, software, source code, data, know-how, improvements, discoveries, and developments;</p>
                <p class="sub-clause">(b) Information regarding plans for research, development, new products, marketing, and selling;</p>
                <p class="sub-clause">(c) Business plans, budgets, financial statements, projections, prices, costs, and pricing strategies;</p>
                <p class="sub-clause">(d) Customer lists, customer data, supplier information, and vendor relationships;</p>
                <p class="sub-clause">(e) Information regarding employees, contractors, and organizational structure;</p>
                <p class="sub-clause">(f) Information disclosed during the course of ${purposeText}.</p>
                <p class="clause">${sectionNum}.2 <strong>"Representatives"</strong> means ${recipientsText}, in each case who are bound by confidentiality obligations at least as protective as those contained herein.</p>
            `;
            sectionNum++;

            // EXCLUSIONS
            sections += `
                <h2>${sectionNum}. EXCLUSIONS FROM CONFIDENTIAL INFORMATION</h2>
                <p class="clause">${sectionNum}.1 Confidential Information shall not include information that:</p>
                <p class="sub-clause">(a) Is or becomes publicly available through no fault or breach by ${parties};</p>
                <p class="sub-clause">(b) Was rightfully in ${parties}'s possession prior to disclosure, as evidenced by written records;</p>
                <p class="sub-clause">(c) Is independently developed by ${parties} without use of or reference to the Confidential Information;</p>
                <p class="sub-clause">(d) Is rightfully obtained from a third party without restriction on disclosure;</p>
                <p class="sub-clause">(e) Is disclosed with the prior written approval of ${otherParty}.</p>
                <p class="clause">${sectionNum}.2 The burden of proving any exclusion shall rest with the party claiming such exclusion.</p>
            `;
            sectionNum++;

            // OBLIGATIONS
            sections += `
                <h2>${sectionNum}. CONFIDENTIALITY OBLIGATIONS</h2>
                <p class="clause">${sectionNum}.1 <strong>Non-Disclosure.</strong> ${Parties} agrees to hold all Confidential Information in strict confidence and not to disclose any Confidential Information to any third party except as expressly permitted herein.</p>
                <p class="clause">${sectionNum}.2 <strong>Limited Use.</strong> ${Parties} shall use Confidential Information solely for the purpose of ${purposeText} (the <strong>"Permitted Purpose"</strong>) and for no other purpose whatsoever.</p>
                <p class="clause">${sectionNum}.3 <strong>Standard of Care.</strong> ${Parties} shall protect Confidential Information using the same degree of care it uses to protect its own confidential information of a similar nature, but in no event less than reasonable care.</p>
                <p class="clause">${sectionNum}.4 <strong>Permitted Disclosures.</strong> ${Parties} may disclose Confidential Information to its Representatives who: (a) have a need to know for the Permitted Purpose; and (b) are bound by confidentiality obligations at least as restrictive as those herein. ${Parties} shall be responsible for any breach of this Agreement by its Representatives.</p>
                <p class="clause">${sectionNum}.5 <strong>No Copies.</strong> ${Parties} shall not copy, reproduce, or duplicate any Confidential Information except as reasonably necessary for the Permitted Purpose.</p>
            `;
            sectionNum++;

            // REQUIRED DISCLOSURES
            sections += `
                <h2>${sectionNum}. LEGALLY REQUIRED DISCLOSURES</h2>
                <p class="clause">${sectionNum}.1 If ${parties} is required by law, regulation, or valid legal process (including subpoena, civil investigative demand, or similar process) to disclose any Confidential Information, ${parties} shall:</p>
                <p class="sub-clause">(a) Provide ${otherParty} with prompt written notice of such requirement (to the extent legally permitted) so that ${otherParty} may seek a protective order or other appropriate remedy;</p>
                <p class="sub-clause">(b) Cooperate with ${otherParty}'s efforts to obtain such protective order or remedy;</p>
                <p class="sub-clause">(c) Disclose only that portion of Confidential Information that is legally required; and</p>
                <p class="sub-clause">(d) Use reasonable efforts to obtain assurances that confidential treatment will be accorded to the disclosed information.</p>
            `;
            sectionNum++;

            // RETURN OF INFORMATION
            sections += `
                <h2>${sectionNum}. RETURN OR DESTRUCTION OF INFORMATION</h2>
                <p class="clause">${sectionNum}.1 Upon the earlier of: (a) termination or expiration of this Agreement; (b) ${otherParty}'s written request; or (c) completion of the Permitted Purpose, ${parties} shall promptly:</p>
                <p class="sub-clause">(a) Return to ${otherParty} all documents, materials, and other tangible items containing Confidential Information;</p>
                <p class="sub-clause">(b) Permanently destroy all copies, extracts, and summaries of Confidential Information in any form;</p>
                <p class="sub-clause">(c) Delete all electronic copies from computer systems, servers, and backup media; and</p>
                <p class="sub-clause">(d) Upon request, provide written certification of compliance with this Section.</p>
                <p class="clause">${sectionNum}.2 Notwithstanding the foregoing, ${parties} may retain one copy of Confidential Information solely for legal archival purposes, subject to continued confidentiality obligations.</p>
            `;
            sectionNum++;

            // NON-CIRCUMVENTION
            if (includeNonCircumvent) {
                sections += `
                    <h2>${sectionNum}. NON-CIRCUMVENTION</h2>
                    <p class="clause">${sectionNum}.1 ${Parties} agrees not to circumvent, avoid, bypass, or obviate ${otherParty}, directly or indirectly, to avoid payment of fees or commissions, or to gain any benefit from the use of Confidential Information, including but not limited to contacts, sources, or business opportunities disclosed hereunder.</p>
                    <p class="clause">${sectionNum}.2 ${Parties} shall not make direct contact with any contacts, sources, associates, or affiliates of ${otherParty} that are disclosed as Confidential Information without the prior written consent of ${otherParty}.</p>
                `;
                sectionNum++;
            }

            // NON-SOLICITATION
            if (includeNonSolicitation) {
                sections += `
                    <h2>${sectionNum}. NON-SOLICITATION</h2>
                    <p class="clause">${sectionNum}.1 During the term of this Agreement and for a period of one (1) year thereafter, ${parties} shall not, directly or indirectly, solicit, recruit, or hire any employee or contractor of ${otherParty} with whom ${parties} had contact or about whom ${parties} received Confidential Information.</p>
                `;
                sectionNum++;
            }

            // NON-COMPETE
            if (includeNonCompete) {
                sections += `
                    <h2>${sectionNum}. LIMITED NON-COMPETITION</h2>
                    <p class="clause">${sectionNum}.1 During the term of this Agreement and for a period of six (6) months thereafter, ${parties} agrees not to use Confidential Information to develop, market, or sell products or services that directly compete with ${otherParty}'s products or services as disclosed in the Confidential Information.</p>
                    <p class="clause">${sectionNum}.2 This restriction shall not prevent ${parties} from engaging in its general business activities that do not utilize Confidential Information.</p>
                `;
                sectionNum++;
            }

            // NO LICENSE / NO WARRANTIES
            sections += `
                <h2>${sectionNum}. NO LICENSE; NO WARRANTIES</h2>
                <p class="clause">${sectionNum}.1 <strong>No License.</strong> Nothing in this Agreement grants ${parties} any right, title, interest, or license in or to any Confidential Information, intellectual property, or proprietary rights of ${otherParty}.</p>
                <p class="clause">${sectionNum}.2 <strong>No Warranties.</strong> ALL CONFIDENTIAL INFORMATION IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT.</p>
                <p class="clause">${sectionNum}.3 <strong>No Obligation.</strong> Neither party is obligated by this Agreement to disclose any particular information, enter into any additional agreement, or proceed with any transaction.</p>
            `;
            sectionNum++;

            // TERM
            sections += `
                <h2>${sectionNum}. TERM AND TERMINATION</h2>
                <p class="clause">${sectionNum}.1 <strong>Term.</strong> This Agreement shall remain in effect ${hl(termText, 'for 2 years from the Effective Date', 'termYears')}.</p>
                <p class="clause">${sectionNum}.2 <strong>Survival.</strong> The confidentiality obligations set forth herein ${hl(survivalText, 'shall survive for 3 years', 'survivalYears')}. Obligations with respect to trade secrets shall continue for as long as such information remains a trade secret under applicable law.</p>
                <p class="clause">${sectionNum}.3 <strong>Effect of Termination.</strong> Termination of this Agreement shall not affect any rights or obligations that accrued prior to termination.</p>
            `;
            sectionNum++;

            // REMEDIES
            if (includeInjunctive) {
                sections += `
                    <h2>${sectionNum}. REMEDIES</h2>
                    <p class="clause">${sectionNum}.1 <strong>Irreparable Harm.</strong> ${Parties} acknowledges that any unauthorized disclosure or use of Confidential Information may cause irreparable harm to ${otherParty} for which monetary damages would be an inadequate remedy.</p>
                    <p class="clause">${sectionNum}.2 <strong>Injunctive Relief.</strong> In addition to any other remedies available at law or in equity, ${otherParty} shall be entitled to seek injunctive relief, including temporary restraining orders, preliminary injunctions, and permanent injunctions, without the necessity of proving actual damages or posting any bond.</p>
                    <p class="clause">${sectionNum}.3 <strong>Cumulative Remedies.</strong> All remedies are cumulative and not exclusive of any other remedies provided by law or equity.</p>
                `;
                sectionNum++;
            }

            // INDEMNIFICATION
            if (includeIndemnification) {
                sections += `
                    <h2>${sectionNum}. INDEMNIFICATION</h2>
                    <p class="clause">${sectionNum}.1 ${Parties} shall indemnify, defend, and hold harmless ${otherParty} and its officers, directors, employees, agents, and successors from and against any and all claims, damages, losses, costs, and expenses (including reasonable attorneys' fees) arising out of or relating to any breach of this Agreement by ${parties} or its Representatives.</p>
                `;
                sectionNum++;
            }

            // GENERAL PROVISIONS
            sections += `
                <h2>${sectionNum}. GENERAL PROVISIONS</h2>
                <p class="clause">${sectionNum}.1 <strong>Governing Law.</strong> This Agreement shall be governed by and construed in accordance with the laws of the State of ${hl(governingState, '[STATE]', 'governingState')}, without regard to its conflicts of law principles.</p>
                <p class="clause">${sectionNum}.2 <strong>Jurisdiction.</strong> The parties consent to the exclusive jurisdiction of the state and federal courts located in ${hl(governingState, '[STATE]', 'governingState')} for any action arising out of this Agreement.</p>
                <p class="clause">${sectionNum}.3 <strong>Entire Agreement.</strong> This Agreement constitutes the entire agreement between the parties concerning its subject matter and supersedes all prior discussions, negotiations, and agreements.</p>
                <p class="clause">${sectionNum}.4 <strong>Amendment.</strong> This Agreement may not be amended except by a written instrument signed by both parties.</p>
                <p class="clause">${sectionNum}.5 <strong>Waiver.</strong> No waiver of any provision shall be effective unless in writing. A waiver in one instance shall not constitute a waiver of any other provision or subsequent breach.</p>
                <p class="clause">${sectionNum}.6 <strong>Severability.</strong> If any provision is found invalid or unenforceable, the remaining provisions shall continue in full force and effect.</p>
                <p class="clause">${sectionNum}.7 <strong>Assignment.</strong> Neither party may assign this Agreement without the prior written consent of the other party, except that either party may assign to a successor in connection with a merger, acquisition, or sale of all or substantially all of its assets.</p>
                <p class="clause">${sectionNum}.8 <strong>Notices.</strong> All notices shall be in writing and delivered by hand, overnight courier, or certified mail to the addresses set forth above.</p>
                <p class="clause">${sectionNum}.9 <strong>Counterparts.</strong> This Agreement may be executed in counterparts, each of which shall be deemed an original and all of which together shall constitute one instrument. Electronic signatures shall be deemed valid and binding.</p>
            `;

            return `
                <h1>${isMutual ? 'MUTUAL ' : ''}NON-DISCLOSURE AGREEMENT</h1>
                <p class="center" style="font-style: italic;">Effective Date: ${hl(effectiveDate, '[DATE]', 'effectiveDate')}</p>

                <p>This ${isMutual ? 'Mutual ' : ''}Non-Disclosure Agreement (this <strong>"Agreement"</strong>) is entered into as of the Effective Date by and between:</p>

                <div class="parties" style="margin: 24px 0; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <p><strong>${hl(disclosingParty, '[PARTY A NAME]', 'disclosingParty')}</strong>, a ${hl(disclosingState, '[STATE]', 'disclosingState')} ${entityTypes[disclosingType]}, with its principal place of business at ${hl(disclosingAddress, '[ADDRESS]', 'disclosingAddress')} (<strong>"${partyA}"</strong>)</p>
                    <p style="text-align: center; margin: 8px 0;">and</p>
                    <p><strong>${hl(receivingParty, '[PARTY B NAME]', 'receivingParty')}</strong>, a ${hl(receivingState, '[STATE]', 'receivingState')} ${entityTypes[receivingType]}, with its principal place of business at ${hl(receivingAddress, '[ADDRESS]', 'receivingAddress')} (<strong>"${partyB}"</strong>)</p>
                </div>

                <p><strong>RECITALS</strong></p>
                <p class="clause">WHEREAS, the parties wish to explore ${purposeText} (the <strong>"Purpose"</strong>); and</p>
                <p class="clause">WHEREAS, in connection with the Purpose, ${isMutual ? 'each party' : partyA} may disclose certain confidential and proprietary information to ${isMutual ? 'the other party' : partyB}; and</p>
                <p class="clause">WHEREAS, the parties desire to protect such confidential information from unauthorized use and disclosure;</p>
                <p style="margin-top: 16px;"><strong>NOW, THEREFORE,</strong> in consideration of the mutual covenants and agreements herein, and for other good and valuable consideration, the receipt and sufficiency of which are hereby acknowledged, the parties agree as follows:</p>

                ${sections}

                <p style="margin-top: 24px;"><strong>IN WITNESS WHEREOF,</strong> the parties have executed this Agreement as of the Effective Date.</p>

                <div class="signature-block">
                    <div class="signature-party">
                        <h3>${partyA.toUpperCase()}</h3>
                        <p>${hl(disclosingParty, '[PARTY A NAME]', 'disclosingParty')}</p>
                        <div class="signature-line">Signature</div>
                        <div class="signature-line">Printed Name</div>
                        <div class="signature-line">Title</div>
                        <div class="signature-line">Date</div>
                    </div>
                    <div class="signature-party">
                        <h3>${partyB.toUpperCase()}</h3>
                        <p>${hl(receivingParty, '[PARTY B NAME]', 'receivingParty')}</p>
                        <div class="signature-line">Signature</div>
                        <div class="signature-line">Printed Name</div>
                        <div class="signature-line">Title</div>
                        <div class="signature-line">Date</div>
                    </div>
                </div>
            `;
        }

        // ========== PIIA GENERATOR ==========
        function generatePIIAForm() {
            const today = new Date().toISOString().split('T')[0];
            return `
                <div class="gen-form-header">
                    <h2>PIIA</h2>
                    <p>Proprietary Information and Inventions Assignment</p>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Company Information</div>
                    <div class="gen-form-group">
                        <label>Company Name</label>
                        <input type="text" id="gen_companyName" placeholder="Tech Corp, Inc." oninput="updateGeneratorPreview('companyName')">
                    </div>
                    <div class="gen-form-row">
                        <div class="gen-form-group">
                            <label>State</label>
                            <select id="gen_companyState" onchange="updateGeneratorPreview('companyState')">
                                <option value="">Select...</option>
                                <option value="California">California</option>
                                <option value="Delaware">Delaware</option>
                                <option value="New York">New York</option>
                                <option value="Texas">Texas</option>
                            </select>
                        </div>
                        <div class="gen-form-group">
                            <label>Effective Date</label>
                            <input type="date" id="gen_effectiveDate" value="${today}" onchange="updateGeneratorPreview('effectiveDate')">
                        </div>
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Employee Information</div>
                    <div class="gen-form-group">
                        <label>Employee Name</label>
                        <input type="text" id="gen_employeeName" placeholder="John Developer" oninput="updateGeneratorPreview('employeeName')">
                    </div>
                    <div class="gen-form-group">
                        <label>Position/Title</label>
                        <input type="text" id="gen_jobTitle" placeholder="Software Engineer" oninput="updateGeneratorPreview('jobTitle')">
                    </div>
                </div>
            `;
        }

        function generatePIIAPreview() {
            const companyName = getGenValue('gen_companyName', '[COMPANY NAME]');
            const companyState = getGenValue('gen_companyState', '[STATE]');
            const effectiveDate = formatGenDate(getGenValue('gen_effectiveDate'));
            const employeeName = getGenValue('gen_employeeName', '[EMPLOYEE NAME]');
            const jobTitle = getGenValue('gen_jobTitle', '[TITLE]');

            return `
                <h1>Proprietary Information and Inventions Assignment Agreement</h1>
                <p class="center" style="font-style: italic;">Effective Date: ${hl(effectiveDate, '[DATE]', 'effectiveDate')}</p>

                <div class="parties">
                    <p>This Agreement is entered into by:</p>
                    <p><strong>Company:</strong> ${hl(companyName, '[COMPANY NAME]', 'companyName')}</p>
                    <p><strong>Employee:</strong> ${hl(employeeName, '[EMPLOYEE NAME]', 'employeeName')}, serving as ${hl(jobTitle, '[TITLE]', 'jobTitle')}</p>
                </div>

                <h2>1. CONFIDENTIAL INFORMATION</h2>
                <p class="clause">1.1 Employee agrees to hold all Confidential Information in strict confidence.</p>

                <h2>2. ASSIGNMENT OF INVENTIONS</h2>
                <p class="clause">2.1 Employee assigns to Company all inventions developed using Company resources or relating to Company's business.</p>

                <h2>3. GOVERNING LAW</h2>
                <p class="clause">3.1 This Agreement is governed by the laws of ${hl(companyState, '[STATE]', 'companyState')}.</p>

                <div class="signature-block">
                    <div class="signature-party">
                        <h3>Company</h3>
                        <div class="signature-line">Signature</div>
                        <div class="signature-line">Name & Title</div>
                        <div class="signature-line">Date</div>
                    </div>
                    <div class="signature-party">
                        <h3>Employee</h3>
                        <div class="signature-line">Signature</div>
                        <div class="signature-line">${hl(employeeName, '[NAME]', 'employeeName')}</div>
                        <div class="signature-line">Date</div>
                    </div>
                </div>
            `;
        }

        // ========== SUBLEASE GENERATOR ==========
        function generateSubleaseForm() {
            const today = new Date().toISOString().split('T')[0];
            return `
                <div class="gen-form-header">
                    <h2>Sublease Agreement</h2>
                    <p>Sublease property to a subtenant</p>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Property Information</div>
                    <div class="gen-form-group">
                        <label>Property Address</label>
                        <input type="text" id="gen_propertyAddress" placeholder="123 Main St, Apt 4B" oninput="updateGeneratorPreview('propertyAddress')">
                    </div>
                    <div class="gen-form-group">
                        <label>Governing State</label>
                        <select id="gen_governingState" onchange="updateGeneratorPreview('governingState')">
                            <option value="">Select...</option>
                            <option value="California">California</option>
                            <option value="Florida">Florida</option>
                            <option value="New York">New York</option>
                            <option value="Texas">Texas</option>
                        </select>
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Parties</div>
                    <div class="gen-form-group">
                        <label>Sublessor Name</label>
                        <input type="text" id="gen_sublessorName" placeholder="Original Tenant" oninput="updateGeneratorPreview('sublessorName')">
                    </div>
                    <div class="gen-form-group">
                        <label>Sublessee Name</label>
                        <input type="text" id="gen_sublesseeName" placeholder="New Subtenant" oninput="updateGeneratorPreview('sublesseeName')">
                    </div>
                </div>

                <div class="gen-form-section">
                    <div class="gen-section-title">Lease Terms</div>
                    <div class="gen-form-row">
                        <div class="gen-form-group">
                            <label>Start Date</label>
                            <input type="date" id="gen_startDate" value="${today}" onchange="updateGeneratorPreview('startDate')">
                        </div>
                        <div class="gen-form-group">
                            <label>End Date</label>
                            <input type="date" id="gen_endDate" onchange="updateGeneratorPreview('endDate')">
                        </div>
                    </div>
                    <div class="gen-form-row">
                        <div class="gen-form-group">
                            <label>Monthly Rent ($)</label>
                            <input type="number" id="gen_monthlyRent" placeholder="1500" oninput="updateGeneratorPreview('monthlyRent')">
                        </div>
                        <div class="gen-form-group">
                            <label>Security Deposit ($)</label>
                            <input type="number" id="gen_securityDeposit" placeholder="1500" oninput="updateGeneratorPreview('securityDeposit')">
                        </div>
                    </div>
                </div>
            `;
        }

        function generateSubleasePreview() {
            const propertyAddress = getGenValue('gen_propertyAddress', '[PROPERTY ADDRESS]');
            const governingState = getGenValue('gen_governingState', '[STATE]');
            const sublessorName = getGenValue('gen_sublessorName', '[SUBLESSOR NAME]');
            const sublesseeName = getGenValue('gen_sublesseeName', '[SUBLESSEE NAME]');
            const startDate = formatGenDate(getGenValue('gen_startDate'));
            const endDate = formatGenDate(getGenValue('gen_endDate'));
            const monthlyRent = getGenValue('gen_monthlyRent', '[AMOUNT]');
            const securityDeposit = getGenValue('gen_securityDeposit', '[AMOUNT]');

            return `
                <h1>Sublease Agreement</h1>

                <div class="parties">
                    <p>This Agreement is entered into by:</p>
                    <p><strong>Sublessor:</strong> ${hl(sublessorName, '[SUBLESSOR]', 'sublessorName')}</p>
                    <p><strong>Sublessee:</strong> ${hl(sublesseeName, '[SUBLESSEE]', 'sublesseeName')}</p>
                </div>

                <h2>1. PREMISES</h2>
                <p class="clause">1.1 Sublessor agrees to sublease the property at: ${hl(propertyAddress, '[ADDRESS]', 'propertyAddress')}</p>

                <h2>2. TERM</h2>
                <p class="clause">2.1 The sublease begins on ${hl(startDate, '[START DATE]', 'startDate')} and ends on ${hl(endDate, '[END DATE]', 'endDate')}.</p>

                <h2>3. RENT</h2>
                <p class="clause">3.1 Monthly rent: ${hl('$' + monthlyRent, '$[AMOUNT]', 'monthlyRent')}</p>
                <p class="clause">3.2 Security deposit: ${hl('$' + securityDeposit, '$[AMOUNT]', 'securityDeposit')}</p>

                <h2>4. GOVERNING LAW</h2>
                <p class="clause">4.1 This Agreement is governed by the laws of ${hl(governingState, '[STATE]', 'governingState')}.</p>

                <div class="signature-block">
                    <div class="signature-party">
                        <h3>Sublessor</h3>
                        <div class="signature-line">Signature</div>
                        <div class="signature-line">${hl(sublessorName, '[NAME]', 'sublessorName')}</div>
                        <div class="signature-line">Date</div>
                    </div>
                    <div class="signature-party">
                        <h3>Sublessee</h3>
                        <div class="signature-line">Signature</div>
                        <div class="signature-line">${hl(sublesseeName, '[NAME]', 'sublesseeName')}</div>
                        <div class="signature-line">Date</div>
                    </div>
                </div>
            `;
        }

        // ========== FORMATTING ==========
        function formatDoc(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('docPreview').focus();
            syncToFirebase();
        }

        // ========== FILE UPLOAD ==========
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const preview = document.getElementById('docPreview');

                // Handle different file types
                if (file.name.endsWith('.html') || file.name.endsWith('.htm')) {
                    preview.innerHTML = content;
                } else {
                    // Plain text - preserve line breaks
                    preview.innerHTML = content.split('\n').map(line => `<p>${line || '&nbsp;'}</p>`).join('');
                }

                // Switch to blank document mode
                document.getElementById('docTypeSelector').value = 'blank';
                document.getElementById('generatorFormContainer').innerHTML = `
                    <div class="blank-doc-message">
                        <h3>Uploaded: ${file.name}</h3>
                        <p>Edit the document directly in the editor. Changes sync in real-time.</p>
                    </div>
                `;

                syncToFirebase();
                showToast('Document uploaded!');
            };
            reader.readAsText(file);
        }

        // Setup drag and drop
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                document.getElementById('fileInput').files = e.dataTransfer.files;
                handleFileUpload({ target: { files: [file] } });
            }
        });

        // ========== DOCUMENT ACTIONS ==========
        function printDocument() {
            window.print();
        }

        function downloadDocument() {
            const content = document.getElementById('docPreview').innerHTML;
            const docType = document.getElementById('docTypeSelector').value || 'document';
            const sessionName = document.getElementById('sessionName').value || 'document';

            const html = `
                <html>
                <head><meta charset="utf-8"><title>${sessionName}</title>
                <style>
                    body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.6; padding: 1in; }
                    h1 { text-align: center; font-size: 16pt; text-transform: uppercase; }
                    h2 { font-size: 12pt; text-transform: uppercase; margin-top: 18pt; }
                    p { margin-bottom: 12pt; text-align: justify; }
                    .signature-block { margin-top: 36pt; }
                    .signature-line { border-top: 1px solid black; margin-top: 30pt; padding-top: 4pt; }
                </style></head>
                <body>${content}</body></html>
            `;
            const blob = new Blob([html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sessionName.replace(/[^a-z0-9]/gi, '-')}.doc`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleDocumentEdit() {
            syncToFirebase();
        }

        // ========== FIREBASE & COLLABORATION ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCeACvK3MVTOOaWY4SWG1yNnrcA9ILkkaM",
            authDomain: "termsdocs.firebaseapp.com",
            databaseURL: "https://termsdocs-default-rtdb.firebaseio.com",
            projectId: "termsdocs",
            storageBucket: "termsdocs.firebasestorage.app",
            messagingSenderId: "62791617178",
            appId: "1:62791617178:web:ff79f24f40cc98e88aed23",
            measurementId: "G-PBGF06LDTM"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let userName = '';
        let userColor = '';
        let roomId = '';
        let myUserId = '';
        let contentRef, usersRef, myUserRef, metaRef;
        let isLocalUpdate = false;
        let saveTimeout = null;
        const userColors = ['#ef4444', '#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#ec4899'];

        // Get or create room ID
        const urlParams = new URLSearchParams(window.location.search);
        roomId = urlParams.get('room');
        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 14);
            window.history.replaceState({}, '', `?room=${roomId}`);
        }

        myUserId = Math.random().toString(36).substring(2, 10);

        const savedName = localStorage.getItem('terms-law-name');
        if (savedName) document.getElementById('userName').value = savedName;

        // Event listeners
        document.getElementById('userName').addEventListener('keypress', e => {
            if (e.key === 'Enter') joinSession();
        });
        document.getElementById('joinBtn').addEventListener('click', joinSession);
        document.getElementById('copyBtn').addEventListener('click', copyLink);
        document.getElementById('newBtn').addEventListener('click', () => {
            window.location.href = `?room=${Math.random().toString(36).substring(2, 14)}`;
        });

        function joinSession() {
            userName = document.getElementById('userName').value.trim();
            if (!userName) return document.getElementById('userName').focus();

            localStorage.setItem('terms-law-name', userName);
            userColor = userColors[Math.floor(Math.random() * userColors.length)];
            document.getElementById('joinModal').classList.add('hidden');

            initFirebase();
        }

        function initFirebase() {
            contentRef = db.ref(`rooms/${roomId}/content`);
            usersRef = db.ref(`rooms/${roomId}/users`);
            metaRef = db.ref(`rooms/${roomId}/meta`);
            myUserRef = usersRef.child(myUserId);

            const preview = document.getElementById('docPreview');
            const sessionNameInput = document.getElementById('sessionName');

            myUserRef.set({
                name: userName,
                color: userColor,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            myUserRef.onDisconnect().remove();

            contentRef.on('value', (snapshot) => {
                if (isLocalUpdate) return;
                const content = snapshot.val();
                if (content !== null && content !== undefined) {
                    preview.innerHTML = content;
                }
            });

            metaRef.child('name').on('value', (snapshot) => {
                const name = snapshot.val();
                if (name && document.activeElement !== sessionNameInput) {
                    sessionNameInput.value = name;
                }
            });

            usersRef.on('value', (snapshot) => {
                updateUsers(snapshot.val() || {});
            });

            db.ref('.info/connected').on('value', (snapshot) => {
                const connected = snapshot.val();
                document.getElementById('statusDot').classList.toggle('connected', connected);
                document.getElementById('statusText').textContent = connected ? 'Connected' : 'Connecting...';
                if (connected) showToast(`Joined as ${userName}`);
            });

            sessionNameInput.addEventListener('input', () => {
                metaRef.child('name').set(sessionNameInput.value);
            });
        }

        function syncToFirebase() {
            const preview = document.getElementById('docPreview');
            const saveStatus = document.getElementById('saveStatus');

            saveStatus.textContent = 'Saving...';
            saveStatus.className = 'save-status saving';

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                isLocalUpdate = true;
                contentRef.set(preview.innerHTML).then(() => {
                    isLocalUpdate = false;
                    saveStatus.textContent = 'All changes saved';
                    saveStatus.className = 'save-status saved';
                });
            }, 300);
        }

        function updateUsers(users) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            const userEntries = Object.entries(users);

            userEntries.forEach(([id, user]) => {
                const isYou = id === myUserId;
                const dot = document.createElement('div');
                dot.className = 'user-dot';
                dot.style.background = user.color;
                dot.dataset.name = user.name + (isYou ? ' (you)' : '');
                dot.textContent = user.name.charAt(0).toUpperCase();
                userList.appendChild(dot);
            });
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href)
                .then(() => showToast('Link copied!'))
                .catch(() => prompt('Copy:', window.location.href));
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ========== SIGNATURE FUNCTIONALITY ==========
        const signatures = {
            A: { name: '', font: 'dancing', mode: 'type', applied: false, timestamp: null, dataUrl: null, ip: null },
            B: { name: '', font: 'dancing', mode: 'type', applied: false, timestamp: null, dataUrl: null, ip: null }
        };
        let signaturesRef = null;
        let canvasContexts = {};
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let documentId = null;

        // Get internet time from WorldTimeAPI
        async function getInternetTime() {
            try {
                const response = await fetch('https://worldtimeapi.org/api/ip');
                const data = await response.json();
                return data.datetime;
            } catch (e) {
                // Fallback to local time if API fails, but mark it
                console.warn('Could not fetch internet time, using local time');
                return new Date().toISOString();
            }
        }

        // Get user's IP address
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (e) {
                return 'Unknown';
            }
        }

        // Generate unique document ID
        function generateDocumentId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let id = 'TL-';
            for (let i = 0; i < 8; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id + '-' + Date.now().toString(36).toUpperCase();
        }

        function initSignatures() {
            if (!roomId) return;
            signaturesRef = db.ref(`rooms/${roomId}/signatures`);

            // Generate or retrieve document ID
            signaturesRef.child('documentId').once('value', (snapshot) => {
                if (snapshot.val()) {
                    documentId = snapshot.val();
                } else {
                    documentId = generateDocumentId();
                    signaturesRef.child('documentId').set(documentId);
                }
            });

            signaturesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.A) {
                        signatures.A = { ...signatures.A, ...data.A };
                        updateSignatureUI('A');
                    }
                    if (data.B) {
                        signatures.B = { ...signatures.B, ...data.B };
                        updateSignatureUI('B');
                    }
                    if (data.documentId) {
                        documentId = data.documentId;
                    }
                    // Update verification stamp if any signatures exist
                    if (signatures.A.applied || signatures.B.applied) {
                        updateVerificationStamp();
                    }
                }
            });

            // Initialize canvases
            initSignatureCanvases();
        }

        function initSignatureCanvases() {
            ['A', 'B'].forEach(party => {
                const canvas = document.getElementById(`sigCanvas${party}`);
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                canvasContexts[party] = ctx;

                // Set canvas resolution
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * 2;
                canvas.height = rect.height * 2;
                ctx.scale(2, 2);

                // Style settings
                ctx.strokeStyle = '#1a365d';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                // Mouse events
                canvas.addEventListener('mousedown', (e) => startDrawing(e, party));
                canvas.addEventListener('mousemove', (e) => draw(e, party));
                canvas.addEventListener('mouseup', () => stopDrawing(party));
                canvas.addEventListener('mouseout', () => stopDrawing(party));

                // Touch events for mobile
                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    startDrawing(touch, party);
                });
                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    draw(touch, party);
                });
                canvas.addEventListener('touchend', () => stopDrawing(party));
            });
        }

        function startDrawing(e, party) {
            isDrawing = true;
            const canvas = document.getElementById(`sigCanvas${party}`);
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function draw(e, party) {
            if (!isDrawing) return;

            const canvas = document.getElementById(`sigCanvas${party}`);
            const ctx = canvasContexts[party];
            const rect = canvas.getBoundingClientRect();

            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();

            lastX = x;
            lastY = y;

            // Enable apply button when drawing
            document.getElementById('sigApply' + party).disabled = !document.getElementById('sigName' + party).value.trim();
        }

        function stopDrawing(party) {
            if (isDrawing) {
                isDrawing = false;
                // Save canvas data
                const canvas = document.getElementById(`sigCanvas${party}`);
                signatures[party].dataUrl = canvas.toDataURL('image/png');
            }
        }

        function clearCanvas(party) {
            const canvas = document.getElementById(`sigCanvas${party}`);
            const ctx = canvasContexts[party];
            const rect = canvas.getBoundingClientRect();
            ctx.clearRect(0, 0, rect.width * 2, rect.height * 2);
            signatures[party].dataUrl = null;
        }

        function setSignatureMode(party, mode) {
            signatures[party].mode = mode;

            // Update toggle buttons
            const panel = document.getElementById('sigParty' + party + 'Panel');
            panel.querySelectorAll('.sig-toggle-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', (idx === 0 && mode === 'type') || (idx === 1 && mode === 'draw'));
            });

            // Show/hide containers
            document.getElementById('sigTypeContainer' + party).classList.toggle('hidden', mode !== 'type');
            document.getElementById('sigDrawContainer' + party).classList.toggle('hidden', mode !== 'draw');

            // Re-init canvas if switching to draw mode
            if (mode === 'draw') {
                setTimeout(() => initSignatureCanvases(), 100);
            }
        }

        function selectSignatureParty(party) {
            const isA = party === 'partyA';
            document.getElementById('sigTabPartyA').classList.toggle('active', isA);
            document.getElementById('sigTabPartyB').classList.toggle('active', !isA);
            document.getElementById('sigPartyAPanel').classList.toggle('hidden', !isA);
            document.getElementById('sigPartyBPanel').classList.toggle('hidden', isA);

            // Re-init canvases when switching
            setTimeout(() => initSignatureCanvases(), 100);
        }

        function updateSignaturePreview(party) {
            const nameInput = document.getElementById('sigName' + party);
            const preview = document.getElementById('sigPreview' + party);
            const applyBtn = document.getElementById('sigApply' + party);
            const name = nameInput.value.trim();

            if (name) {
                const fontClass = 'sig-font-' + signatures[party].font;
                preview.innerHTML = `<span class="sig-preview-text ${fontClass}">${name}</span>`;
                applyBtn.disabled = false;
            } else {
                preview.innerHTML = '<span class="sig-preview-placeholder">Your signature will appear here</span>';
                applyBtn.disabled = true;
            }
        }

        function selectSignatureFont(party, font) {
            signatures[party].font = font;

            // Update button states
            const container = document.getElementById('sigParty' + party + 'Panel');
            container.querySelectorAll('.sig-font-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.font === font);
            });

            // Update preview
            updateSignaturePreview(party);
        }

        async function applySignature(party) {
            const nameInput = document.getElementById('sigName' + party);
            const name = nameInput.value.trim();

            if (!name) return;

            showToast('Applying signature...');

            // Get internet time and IP
            const [internetTime, userIP] = await Promise.all([
                getInternetTime(),
                getUserIP()
            ]);

            signatures[party].name = name;
            signatures[party].applied = true;
            signatures[party].timestamp = internetTime;
            signatures[party].ip = userIP;

            // If draw mode, ensure dataUrl is captured
            if (signatures[party].mode === 'draw') {
                const canvas = document.getElementById(`sigCanvas${party}`);
                signatures[party].dataUrl = canvas.toDataURL('image/png');
            }

            // Save to Firebase
            if (signaturesRef) {
                signaturesRef.child(party).set(signatures[party]);
            }

            updateSignatureUI(party);
            updateDocumentSignatures();
            updateVerificationStamp();
            showToast('Signature applied with verification stamp!');
        }

        function updateSignatureUI(party) {
            const tab = document.getElementById('sigTabParty' + party);
            const status = document.getElementById('sigStatus' + party);

            if (signatures[party].applied) {
                tab.classList.add('signed');
                status.textContent = '‚úì Signed';
                status.style.color = '#22c55e';
            } else {
                tab.classList.remove('signed');
                status.textContent = 'Not signed';
                status.style.color = '#9ca3af';
            }
        }

        function formatTimestamp(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            });
        }

        function updateDocumentSignatures() {
            const preview = document.getElementById('docPreview');
            const sigBlocks = preview.querySelectorAll('.signature-party');

            ['A', 'B'].forEach((party, idx) => {
                if (sigBlocks.length > idx && signatures[party].applied) {
                    const sigLine = sigBlocks[idx].querySelector('.signature-line');
                    if (sigLine) {
                        let sigHtml = '';

                        if (signatures[party].mode === 'draw' && signatures[party].dataUrl) {
                            sigHtml = `<img src="${signatures[party].dataUrl}" class="doc-signature-image" alt="Signature">`;
                        } else {
                            const fontClass = 'sig-font-' + signatures[party].font;
                            sigHtml = `<div class="doc-signature-typed ${fontClass}">${signatures[party].name}</div>`;
                        }

                        sigHtml += `<div class="doc-signature-timestamp">${formatTimestamp(signatures[party].timestamp)}</div>`;
                        sigLine.innerHTML = sigHtml;
                    }
                }
            });

            syncToFirebase();
        }

        function updateVerificationStamp() {
            // Remove existing stamp if any
            let existingStamp = document.querySelector('.verification-stamp');
            if (existingStamp) existingStamp.remove();

            // Only add if at least one signature
            if (!signatures.A.applied && !signatures.B.applied) return;

            const preview = document.getElementById('docPreview');

            const stampHtml = `
                <div class="verification-stamp">
                    <div class="verification-stamp-header">
                        <div class="verification-stamp-logo">Terms.<span>Law</span></div>
                    </div>
                    <div class="verification-stamp-title">Electronic Signature Verification</div>
                    <div class="verification-stamp-id">Document ID: ${documentId || 'Generating...'}</div>

                    <div class="verification-stamp-parties">
                        <div class="verification-party">
                            <div class="verification-party-label">Party A</div>
                            ${signatures.A.applied ? `
                                <div class="verification-party-name">${signatures.A.name}</div>
                                <div class="verification-party-time">${formatTimestamp(signatures.A.timestamp)}</div>
                                <div class="verification-party-ip">IP: ${signatures.A.ip || 'N/A'}</div>
                            ` : '<div class="verification-not-signed">Not yet signed</div>'}
                        </div>
                        <div class="verification-party">
                            <div class="verification-party-label">Party B</div>
                            ${signatures.B.applied ? `
                                <div class="verification-party-name">${signatures.B.name}</div>
                                <div class="verification-party-time">${formatTimestamp(signatures.B.timestamp)}</div>
                                <div class="verification-party-ip">IP: ${signatures.B.ip || 'N/A'}</div>
                            ` : '<div class="verification-not-signed">Not yet signed</div>'}
                        </div>
                    </div>
                </div>
            `;

            preview.insertAdjacentHTML('beforeend', stampHtml);
        }

        function sendForSignature() {
            const emailInput = document.getElementById('emailSignInput');
            const email = emailInput.value.trim();

            if (!email || !email.includes('@')) {
                showToast('Please enter a valid email address');
                return;
            }

            const signUrl = window.location.href;
            const sessionName = document.getElementById('sessionName').value || 'Document';

            const subject = encodeURIComponent(`Action Required: Sign "${sessionName}" - Terms.Law`);
            const body = encodeURIComponent(`Hello,

You have been requested to review and electronically sign a legal document.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìÑ Document: ${sessionName}
üîó Document ID: ${documentId || 'Will be assigned'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Please click the secure link below to access the document:
${signUrl}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
HOW TO SIGN:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1. Click the link above to open the document
2. Review the document carefully
3. Scroll down to the "Electronic Signatures" section
4. Click on "Party B" tab
5. Enter your full legal name
6. Choose to TYPE or DRAW your signature
7. Click "Apply Signature"

Your signature will be timestamped and verified by Terms.Law.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

This is an official electronic signature request.
By signing, you agree to the terms contained in the document.

Questions? Contact the sender of this email.

Powered by Terms.Law Docs
`);

            window.open(`mailto:${email}?subject=${subject}&body=${body}`);

            document.getElementById('emailSentBadge').classList.remove('hidden');

            if (signaturesRef) {
                signaturesRef.child('emailSent').set({
                    email: email,
                    sentAt: new Date().toISOString(),
                    sentBy: userName,
                    documentId: documentId
                });
            }

            showToast('Signature request email opened!');
        }

        // Initialize signatures after Firebase is ready
        setTimeout(initSignatures, 1500);

        window.addEventListener('beforeunload', () => {
            if (myUserRef) myUserRef.remove();
        });

        // ========================================
        // AI DOCUMENT CHAT
        // ========================================
        const aiChat = {
            messages: [],
            conversationHistory: [],
            isLoading: false,
            isOpen: true,
            isMinimized: false,
            selectedModel: 'llama' // 'llama' or 'sonnet'
        };

        const aiChatApiUrls = [
            'https://terms.law/api/document-chat',
            'https://template-generator-aob3.vercel.app/api/document-chat',
            '/api/document-chat'
        ];

        // Direct Groq API fallback (for local testing when server APIs are unavailable)
        // Get a free key at https://console.groq.com/keys
        const GROQ_API_KEY_FALLBACK = localStorage.getItem('groq_api_key') || '';

        async function callGroqDirectly(message, documentText, documentType, conversationHistory) {
            if (!GROQ_API_KEY_FALLBACK) {
                throw new Error('No Groq API key - set via localStorage.setItem("groq_api_key", "your-key")');
            }

            const systemPrompt = `You are an expert legal document analyst helping users understand contracts and legal agreements.

CURRENT DOCUMENT:
Type: ${documentType}
${documentText ? `Content:\n${documentText.substring(0, 6000)}` : 'No document loaded.'}

Be direct, reference specific clauses, use **bold** for key terms. Note this is AI assistance, not legal advice.`;

            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${GROQ_API_KEY_FALLBACK}`
                },
                body: JSON.stringify({
                    model: 'llama-3.3-70b-versatile',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        ...conversationHistory.slice(-6),
                        { role: 'user', content: message }
                    ],
                    max_tokens: 1500,
                    temperature: 0.3
                })
            });

            if (!response.ok) throw new Error('Groq API failed');
            const data = await response.json();
            return { response: data.choices[0].message.content };
        }

        function initAiChat() {
            const panel = document.getElementById('aiChatPanel');
            const fab = document.getElementById('aiChatFab');

            // Add welcome message
            addAiMessage('assistant', "Hi! I'm your document assistant. I can help you understand this document, identify risks, or answer questions. Try asking:\n\n‚Ä¢ \"Summarize this document\"\n‚Ä¢ \"What are the risks?\"\n‚Ä¢ \"Should I sign this?\"\n‚Ä¢ \"Explain [specific clause]\"");
        }

        function toggleAiChat() {
            const panel = document.getElementById('aiChatPanel');
            const fab = document.getElementById('aiChatFab');

            if (aiChat.isOpen) {
                panel.style.display = 'none';
                fab.classList.add('show');
                aiChat.isOpen = false;
            } else {
                panel.style.display = 'flex';
                fab.classList.remove('show');
                aiChat.isOpen = true;
            }
        }

        function minimizeAiChat() {
            const panel = document.getElementById('aiChatPanel');
            aiChat.isMinimized = !aiChat.isMinimized;
            panel.classList.toggle('minimized', aiChat.isMinimized);

            const toggleBtn = document.getElementById('aiChatToggleBtn');
            toggleBtn.textContent = aiChat.isMinimized ? '+' : '‚àí';
        }

        function selectAiModel(model) {
            aiChat.selectedModel = model;

            document.querySelectorAll('.model-switch-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.model === model);
            });

            // Show indicator in header
            const subtitle = document.querySelector('.ai-chat-subtitle');
            subtitle.textContent = model === 'sonnet' ? 'Claude Sonnet 4 (Premium)' : 'Llama 3.3 (Free)';
        }

        function addAiMessage(type, content) {
            aiChat.messages.push({ type, content });
            renderAiMessages();
        }

        function renderAiMessages() {
            const container = document.getElementById('aiChatMessages');

            let html = aiChat.messages.map(msg => {
                const formattedContent = formatAiMessage(msg.content);
                return `<div class="ai-chat-message ${msg.type}">${formattedContent}</div>`;
            }).join('');

            if (aiChat.isLoading) {
                html += `
                    <div class="ai-typing">
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                    </div>
                `;
            }

            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        function formatAiMessage(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^### (.*$)/gim, '<strong>$1</strong><br>')
                .replace(/^## (.*$)/gim, '<strong>$1</strong><br>')
                .replace(/^# (.*$)/gim, '<strong>$1</strong><br>')
                .replace(/^- (.*$)/gim, '‚Ä¢ $1<br>')
                .replace(/^\d+\. (.*$)/gim, '‚Ä¢ $1<br>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
        }

        function getDocumentText() {
            const preview = document.getElementById('docPreview');
            if (!preview) return '';
            return preview.innerText || preview.textContent || '';
        }

        function getDocumentType() {
            const select = document.getElementById('documentType');
            if (!select) return 'Legal Document';
            return select.options[select.selectedIndex]?.text || 'Legal Document';
        }

        async function sendAiMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();

            if (!message || aiChat.isLoading) return;

            input.value = '';
            addAiMessage('user', message);

            aiChat.isLoading = true;
            renderAiMessages();

            try {
                const documentText = getDocumentText();
                const documentType = getDocumentType();

                let response = null;
                for (const url of aiChatApiUrls) {
                    try {
                        response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message,
                                documentText,
                                documentType,
                                model: aiChat.selectedModel,
                                conversationHistory: aiChat.conversationHistory.slice(-6)
                            })
                        });

                        if (response.ok) break;
                        response = null;
                    } catch (e) {
                        response = null;
                    }
                }

                let data = null;
                if (!response) {
                    // Try direct Groq fallback for local testing
                    if (GROQ_API_KEY_FALLBACK && aiChat.selectedModel === 'llama') {
                        data = await callGroqDirectly(message, documentText, documentType, aiChat.conversationHistory);
                    } else {
                        throw new Error('All API endpoints failed. For local testing, set your Groq key: localStorage.setItem("groq_api_key", "your-key-here")');
                    }
                } else {
                    data = await response.json();
                }

                // Update conversation history
                aiChat.conversationHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: data.response }
                );

                addAiMessage('assistant', data.response);

            } catch (error) {
                console.error('AI Chat error:', error);
                if (error.message.includes('Groq key')) {
                    addAiMessage('assistant', 'API unavailable. To enable locally:\n\n1. Get free key at console.groq.com\n2. Open browser console (F12)\n3. Run: `localStorage.setItem("groq_api_key", "your-key")`\n4. Refresh page');
                } else {
                    addAiMessage('assistant', 'Sorry, I encountered an error. Please try again.');
                }
            } finally {
                aiChat.isLoading = false;
                renderAiMessages();
            }
        }

        function sendQuickAiQuestion(question) {
            const input = document.getElementById('aiChatInput');
            input.value = question;
            sendAiMessage();
        }

        function handleAiKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAiMessage();
            }
        }

        // Initialize AI chat on load
        setTimeout(initAiChat, 500);
    </script>

    <!-- AI Chat Panel -->
    <div class="ai-chat-panel" id="aiChatPanel">
        <div class="ai-chat-header" onclick="minimizeAiChat()">
            <div class="ai-chat-header-left">
                <div class="ai-chat-icon">AI</div>
                <div>
                    <div class="ai-chat-title">Document Assistant</div>
                    <div class="ai-chat-subtitle">Llama 3.3 (Free)</div>
                </div>
            </div>
            <button class="ai-chat-toggle" id="aiChatToggleBtn" onclick="event.stopPropagation(); toggleAiChat();">√ó</button>
        </div>

        <div class="ai-model-toggle">
            <label>Model:</label>
            <div class="model-switch">
                <button class="model-switch-btn active" data-model="llama" onclick="selectAiModel('llama')">
                    Llama 3.3<span class="model-badge free">FREE</span>
                </button>
                <button class="model-switch-btn" data-model="sonnet" onclick="selectAiModel('sonnet')">
                    Sonnet 4<span class="model-badge premium">PRO</span>
                </button>
            </div>
        </div>

        <div class="ai-chat-messages" id="aiChatMessages"></div>

        <div class="ai-quick-actions">
            <button class="ai-quick-btn" onclick="sendQuickAiQuestion('Summarize this document')">Summarize</button>
            <button class="ai-quick-btn" onclick="sendQuickAiQuestion('What are the risks for me?')">Risks</button>
            <button class="ai-quick-btn" onclick="sendQuickAiQuestion('Should I sign this?')">Should I sign?</button>
            <button class="ai-quick-btn" onclick="sendQuickAiQuestion('What\\'s missing from this document?')">What's missing?</button>
        </div>

        <div class="ai-chat-input-area">
            <textarea
                class="ai-chat-input"
                id="aiChatInput"
                placeholder="Ask about this document..."
                rows="1"
                onkeypress="handleAiKeyPress(event)"
            ></textarea>
            <button class="ai-chat-send" onclick="sendAiMessage()">‚Üí</button>
        </div>
    </div>

    <!-- Floating Action Button (when chat closed) -->
    <button class="ai-chat-fab" id="aiChatFab" onclick="toggleAiChat()">AI</button>
</body>
</html>
