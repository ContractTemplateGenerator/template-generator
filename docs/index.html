<!DOCTYPE html>
<html lang="en">
<head>
    <!-- NOINDEX - Confidential client portal -->
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terms.Law - Collaborative Document Editor</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }
        .header {
            background: #1a1a2e;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-size: 20px; font-weight: 600; }
        .logo span { color: #6366f1; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #fbbf24;
        }
        .status-dot.connected { background: #22c55e; }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-secondary { background: rgba(255,255,255,0.15); color: white; }
        .btn-outline { background: transparent; border: 1px solid #e5e7eb; color: #374151; }
        .btn-outline:hover { background: #f3f4f6; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }

        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            gap: 24px;
        }
        .editor-section {
            flex: 1;
            min-width: 0;
        }
        .comments-section {
            width: 320px;
            flex-shrink: 0;
        }

        .toolbar {
            background: white;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .toolbar-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: #e5e7eb;
        }
        .session-name {
            flex: 1;
            min-width: 200px;
        }
        .session-name input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }
        .session-name input:focus { border-color: #6366f1; }
        .save-status {
            font-size: 13px;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .save-status.saving { color: #f59e0b; }
        .save-status.saved { color: #22c55e; }

        .users-panel {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .users-panel h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
            text-transform: uppercase;
        }
        .user-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 20px;
            font-size: 14px;
        }
        .user-badge .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .user-badge.you {
            background: #ecfdf5;
            border: 1px solid #22c55e;
        }
        .editor-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        #editor {
            width: 100%;
            min-height: 600px;
            padding: 24px;
            font-size: 16px;
            line-height: 1.7;
            border: none;
            outline: none;
            font-family: inherit;
            resize: vertical;
        }

        /* Comments Panel */
        .comments-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .comments-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .comments-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
        }
        .comment-count {
            background: #6366f1;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .comments-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .comment-item {
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
        }
        .comment-item:last-child { border-bottom: none; }
        .comment-author {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .comment-author .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .comment-author-name {
            font-weight: 500;
            font-size: 14px;
            color: #374151;
        }
        .comment-time {
            font-size: 12px;
            color: #9ca3af;
            margin-left: auto;
        }
        .comment-text {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.5;
        }
        .comment-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        .comment-action-btn {
            background: none;
            border: none;
            font-size: 12px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .comment-action-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        .comment-action-btn.resolve { color: #22c55e; }
        .comment-action-btn.delete { color: #ef4444; }
        .add-comment {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
        }
        .add-comment textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
        }
        .add-comment textarea:focus { border-color: #6366f1; }
        .add-comment-btn {
            margin-top: 8px;
            width: 100%;
        }
        .no-comments {
            padding: 32px 16px;
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
        }

        /* Template Modal */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        .template-card {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        .template-card:hover {
            border-color: #6366f1;
            background: #f8f7ff;
        }
        .template-card h4 {
            font-size: 14px;
            color: #1a1a2e;
            margin-bottom: 4px;
        }
        .template-card p {
            font-size: 12px;
            color: #6b7280;
        }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .modal.wide { max-width: 600px; text-align: left; }
        .modal h2 { margin-bottom: 8px; color: #1a1a2e; }
        .modal p { color: #6b7280; margin-bottom: 24px; }
        .modal input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
            outline: none;
        }
        .modal input:focus { border-color: #6366f1; }
        .modal .btn { width: 100%; padding: 14px; }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .modal-actions .btn { flex: 1; }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #1a1a2e;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .hidden { display: none !important; }

        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
            }
            .comments-section {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">Terms.<span>Law</span> Docs</div>
        <div class="header-actions">
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <button class="btn btn-secondary" id="copyBtn">Copy Link</button>
            <button class="btn btn-primary" id="newBtn">New Session</button>
        </div>
    </header>

    <div class="main-container">
        <div class="editor-section">
            <div class="toolbar">
                <div class="toolbar-group">
                    <button class="btn btn-outline btn-sm" id="templateBtn">+ Template</button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="session-name">
                    <input type="text" id="sessionName" placeholder="Untitled Session">
                </div>
                <div class="toolbar-divider"></div>
                <div class="save-status" id="saveStatus">
                    <span>All changes saved</span>
                </div>
            </div>

            <div class="users-panel">
                <h3>Connected Users</h3>
                <div class="user-list" id="userList">
                    <span style="color: #9ca3af;">Waiting...</span>
                </div>
            </div>

            <div class="editor-container">
                <textarea id="editor" placeholder="Start typing... Changes sync in real-time."></textarea>
            </div>
        </div>

        <div class="comments-section">
            <div class="comments-panel">
                <div class="comments-header">
                    <h3>Comments</h3>
                    <span class="comment-count" id="commentCount">0</span>
                </div>
                <div class="comments-list" id="commentsList">
                    <div class="no-comments">No comments yet. Add a comment to start a discussion.</div>
                </div>
                <div class="add-comment">
                    <textarea id="newComment" rows="3" placeholder="Add a comment..."></textarea>
                    <button class="btn btn-primary btn-sm add-comment-btn" id="addCommentBtn">Add Comment</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="joinModal">
        <div class="modal">
            <h2>Join Session</h2>
            <p>Enter your name to join</p>
            <input type="text" id="userName" placeholder="Your name" autofocus>
            <button class="btn btn-primary" id="joinBtn">Join Session</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="templateModal">
        <div class="modal wide">
            <h2>Choose a Template</h2>
            <p>Start with a pre-built template or blank document</p>
            <div class="template-grid">
                <div class="template-card" data-template="blank">
                    <h4>Blank Document</h4>
                    <p>Start from scratch</p>
                </div>
                <div class="template-card" data-template="stripe">
                    <h4>Stripe Demand Letter</h4>
                    <p>Fund release demand template</p>
                </div>
                <div class="template-card" data-template="nda">
                    <h4>NDA Template</h4>
                    <p>Mutual confidentiality agreement</p>
                </div>
                <div class="template-card" data-template="llc">
                    <h4>LLC Operating Agreement</h4>
                    <p>Single-member LLC template</p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" id="cancelTemplateBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCeACvK3MVTOOaWY4SWG1yNnrcA9ILkkaM",
            authDomain: "termsdocs.firebaseapp.com",
            databaseURL: "https://termsdocs-default-rtdb.firebaseio.com",
            projectId: "termsdocs",
            storageBucket: "termsdocs.firebasestorage.app",
            messagingSenderId: "62791617178",
            appId: "1:62791617178:web:ff79f24f40cc98e88aed23",
            measurementId: "G-PBGF06LDTM"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let userName = '';
        let userColor = '';
        let roomId = '';
        let myUserId = '';
        let contentRef, usersRef, myUserRef, commentsRef, metaRef;
        let isLocalUpdate = false;
        let saveTimeout = null;
        const userColors = ['#ef4444', '#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#ec4899'];

        // Templates
        const templates = {
            blank: '',
            stripe: `[YOUR COMPANY NAME]
[YOUR ADDRESS]
[CITY], [STATE] [ZIP]
[PHONE]
[EMAIL]

[DATE]

VIA CERTIFIED MAIL & EMAIL
complaints@stripe.com

Legal Department
Stripe, Inc.
354 Oyster Point Boulevard
South San Francisco, CA 94080

Re: [YOUR COMPANY NAME] - Demand for Release of Withheld Funds
    Account ID: [YOUR STRIPE ACCOUNT ID]
    Amount at Issue: $[AMOUNT]

To Whom It May Concern:

This letter serves as formal notice pursuant to Section 13.3(a) of the Stripe Services Agreement ("SSA") of my intent to commence arbitration proceedings against Stripe, Inc. and Stripe Payments Company unless this matter is resolved within 30 days.

I am writing regarding Stripe's continued withholding of $[AMOUNT] in customer payments belonging to [YOUR COMPANY NAME]. Despite [your promise to release funds by DATE / the passage of significant time], your company continues to hold these funds without providing any reasonable timeline for release.

FACTUAL BACKGROUND

[YOUR COMPANY NAME] operated as a [BUSINESS TYPE] business for [DURATION] with Stripe, maintaining [DISPUTE RATE]% dispute rate throughout our relationship. On [DATE], Stripe terminated/froze my merchant account, citing only vague "risk" concerns without identifying any specific violations of your Services Agreement.

Since that date, Stripe has failed to:
- Provide specific justification for the continued withholding beyond general references to "risk"
- Establish any concrete timeline for releasing the held funds
- Identify any specific Service Agreement violations that would justify indefinite withholding

LEGAL CLAIMS

Stripe's actions constitute multiple breaches of the SSA, including but not limited to:

1. BREACH OF CONTRACT: Stripe has materially breached the SSA by withholding funds for an unreasonable period without contractual authority.

2. CONVERSION: Stripe has wrongfully exercised dominion over $[AMOUNT] belonging to [YOUR COMPANY NAME], depriving us of our rightful property beyond any reasonable period necessary for risk management.

3. BREACH OF IMPLIED COVENANT OF GOOD FAITH AND FAIR DEALING: Stripe's arbitrary withholding of funds without substantial justification violates this fundamental contractual obligation.

4. VIOLATION OF CALIFORNIA BUSINESS & PROFESSIONS CODE ยง 17200: Stripe's systematic withholding of merchant funds without clear contractual authority constitutes an unfair business practice under California law.

DEMAND FOR RESOLUTION

To resolve this matter without proceeding to arbitration, I demand:

1. Immediate release of the $[AMOUNT] in withheld funds
2. Accounting of any interest earned on these funds while held by Stripe
3. Written confirmation of the release timeline

If I do not receive a satisfactory response within 14 days, I intend to file an arbitration demand upon the expiration of the 30-day notice period required by Section 13.3(a) of the SSA.

Sincerely,

[YOUR NAME]
[YOUR COMPANY NAME]`,
            nda: `MUTUAL NON-DISCLOSURE AGREEMENT

This Mutual Non-Disclosure Agreement ("Agreement") is entered into as of [DATE] by and between:

Party A: [PARTY A NAME]
Address: [PARTY A ADDRESS]

Party B: [PARTY B NAME]
Address: [PARTY B ADDRESS]

WHEREAS, the parties wish to explore a potential business relationship and in connection therewith, may disclose to each other certain confidential and proprietary information.

NOW, THEREFORE, in consideration of the mutual covenants and agreements contained herein, the parties agree as follows:

1. DEFINITION OF CONFIDENTIAL INFORMATION

"Confidential Information" means any information disclosed by one party ("Disclosing Party") to the other party ("Receiving Party"), either directly or indirectly, in writing, orally, or by inspection of tangible objects, that is designated as "Confidential," "Proprietary," or some similar designation, or that reasonably should be understood to be confidential given the nature of the information and circumstances of disclosure.

2. OBLIGATIONS OF RECEIVING PARTY

The Receiving Party agrees to:
(a) Hold the Confidential Information in strict confidence;
(b) Not disclose the Confidential Information to any third parties without prior written consent;
(c) Use the Confidential Information only for the Purpose;
(d) Protect the Confidential Information using the same degree of care it uses to protect its own confidential information, but in no event less than reasonable care.

3. EXCLUSIONS

Confidential Information does not include information that:
(a) Was publicly known at the time of disclosure;
(b) Becomes publicly known through no fault of the Receiving Party;
(c) Was rightfully in the Receiving Party's possession prior to disclosure;
(d) Is rightfully obtained by the Receiving Party from a third party without breach of any confidentiality obligation;
(e) Is independently developed by the Receiving Party without use of the Confidential Information.

4. TERM

This Agreement shall remain in effect for a period of [DURATION] years from the Effective Date.

5. RETURN OF INFORMATION

Upon termination of this Agreement or upon request, each party shall return or destroy all Confidential Information received from the other party.

6. GOVERNING LAW

This Agreement shall be governed by the laws of [STATE/JURISDICTION].

IN WITNESS WHEREOF, the parties have executed this Agreement as of the date first written above.

PARTY A:                          PARTY B:

_____________________            _____________________
Signature                         Signature

_____________________            _____________________
Name:                            Name:
Title:                           Title:
Date:                            Date:`,
            llc: `OPERATING AGREEMENT
OF
[LLC NAME], LLC

A [STATE] LIMITED LIABILITY COMPANY

This Operating Agreement ("Agreement") of [LLC NAME], LLC (the "Company"), is entered into effective as of [DATE], by the Member(s) listed below.

ARTICLE I - ORGANIZATION

1.1 Formation. The Company was formed on [FORMATION DATE] by filing Articles of Organization with the [STATE] Secretary of State.

1.2 Name. The name of the Company is [LLC NAME], LLC.

1.3 Principal Office. The principal office of the Company shall be located at:
[ADDRESS]
[CITY], [STATE] [ZIP]

1.4 Registered Agent. The registered agent of the Company is:
[REGISTERED AGENT NAME]
[REGISTERED AGENT ADDRESS]

1.5 Term. The Company shall continue until dissolved in accordance with this Agreement or by law.

ARTICLE II - PURPOSE

The Company is organized for the purpose of [BUSINESS PURPOSE] and any other lawful business activity.

ARTICLE III - MEMBERS AND CAPITAL CONTRIBUTIONS

3.1 Initial Member(s):

Name: [MEMBER NAME]
Address: [MEMBER ADDRESS]
Initial Contribution: $[AMOUNT]
Membership Interest: [PERCENTAGE]%

3.2 Additional Contributions. No Member shall be required to make any additional capital contributions.

ARTICLE IV - ALLOCATIONS AND DISTRIBUTIONS

4.1 Allocations. Profits and losses shall be allocated to the Members in proportion to their Membership Interests.

4.2 Distributions. Distributions shall be made to the Members at such times and in such amounts as determined by the Members, in proportion to their Membership Interests.

ARTICLE V - MANAGEMENT

5.1 Management. The Company shall be managed by its Member(s).

5.2 Authority. The Member(s) shall have full authority to manage and control the business and affairs of the Company.

ARTICLE VI - DISSOLUTION

The Company shall be dissolved upon:
(a) The written consent of all Members;
(b) The occurrence of any event that makes it unlawful to continue the Company's business;
(c) Any other event specified by law.

ARTICLE VII - MISCELLANEOUS

7.1 Governing Law. This Agreement shall be governed by the laws of [STATE].

7.2 Amendments. This Agreement may be amended only by written consent of all Members.

7.3 Entire Agreement. This Agreement constitutes the entire agreement among the Members.

IN WITNESS WHEREOF, the undersigned have executed this Operating Agreement as of the date first written above.

MEMBER(S):

_____________________
[MEMBER NAME]
Date:`
        };

        // Get or create room ID
        const urlParams = new URLSearchParams(window.location.search);
        roomId = urlParams.get('room');
        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 14);
            window.history.replaceState({}, '', `?room=${roomId}`);
        }

        // Generate unique user ID
        myUserId = Math.random().toString(36).substring(2, 10);

        // Load saved name
        const savedName = localStorage.getItem('terms-law-name');
        if (savedName) document.getElementById('userName').value = savedName;

        // Event listeners
        document.getElementById('userName').addEventListener('keypress', e => {
            if (e.key === 'Enter') joinSession();
        });
        document.getElementById('joinBtn').addEventListener('click', joinSession);
        document.getElementById('copyBtn').addEventListener('click', copyLink);
        document.getElementById('newBtn').addEventListener('click', () => {
            window.location.href = `?room=${Math.random().toString(36).substring(2, 14)}`;
        });
        document.getElementById('templateBtn').addEventListener('click', () => {
            document.getElementById('templateModal').classList.remove('hidden');
        });
        document.getElementById('cancelTemplateBtn').addEventListener('click', () => {
            document.getElementById('templateModal').classList.add('hidden');
        });
        document.getElementById('addCommentBtn').addEventListener('click', addComment);
        document.getElementById('newComment').addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addComment();
            }
        });

        // Template selection
        document.querySelectorAll('.template-card').forEach(card => {
            card.addEventListener('click', () => {
                const templateKey = card.dataset.template;
                const editor = document.getElementById('editor');
                if (templates[templateKey] !== undefined) {
                    editor.value = templates[templateKey];
                    updateContent();
                }
                document.getElementById('templateModal').classList.add('hidden');
                showToast('Template loaded!');
            });
        });

        function joinSession() {
            userName = document.getElementById('userName').value.trim();
            if (!userName) return document.getElementById('userName').focus();

            localStorage.setItem('terms-law-name', userName);
            userColor = userColors[Math.floor(Math.random() * userColors.length)];
            document.getElementById('joinModal').classList.add('hidden');

            initFirebase();
        }

        function initFirebase() {
            contentRef = db.ref(`rooms/${roomId}/content`);
            usersRef = db.ref(`rooms/${roomId}/users`);
            commentsRef = db.ref(`rooms/${roomId}/comments`);
            metaRef = db.ref(`rooms/${roomId}/meta`);
            myUserRef = usersRef.child(myUserId);

            const editor = document.getElementById('editor');
            const sessionNameInput = document.getElementById('sessionName');

            // Add this user to presence
            myUserRef.set({
                name: userName,
                color: userColor,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Remove user on disconnect
            myUserRef.onDisconnect().remove();

            // Listen for content changes
            contentRef.on('value', (snapshot) => {
                if (isLocalUpdate) return;

                const content = snapshot.val() || '';
                const cursorPos = editor.selectionStart;

                editor.value = content;
                editor.setSelectionRange(Math.min(cursorPos, content.length), Math.min(cursorPos, content.length));
            });

            // Listen for session name changes
            metaRef.child('name').on('value', (snapshot) => {
                const name = snapshot.val();
                if (name && document.activeElement !== sessionNameInput) {
                    sessionNameInput.value = name;
                }
            });

            // Listen for user changes
            usersRef.on('value', (snapshot) => {
                updateUsers(snapshot.val() || {});
            });

            // Listen for comments
            commentsRef.on('value', (snapshot) => {
                updateComments(snapshot.val() || {});
            });

            // Connection state
            db.ref('.info/connected').on('value', (snapshot) => {
                const connected = snapshot.val();
                document.getElementById('statusDot').classList.toggle('connected', connected);
                document.getElementById('statusText').textContent = connected ? 'Connected' : 'Connecting...';

                if (connected) {
                    showToast(`Joined as ${userName}`);
                }
            });

            // Editor input -> Firebase
            editor.addEventListener('input', updateContent);

            // Session name change
            sessionNameInput.addEventListener('input', () => {
                metaRef.child('name').set(sessionNameInput.value);
            });
        }

        function updateContent() {
            const editor = document.getElementById('editor');
            const saveStatus = document.getElementById('saveStatus');

            saveStatus.innerHTML = '<span>Saving...</span>';
            saveStatus.className = 'save-status saving';

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                isLocalUpdate = true;
                contentRef.set(editor.value).then(() => {
                    isLocalUpdate = false;
                    saveStatus.innerHTML = '<span>All changes saved</span>';
                    saveStatus.className = 'save-status saved';
                });
            }, 100);
        }

        function updateUsers(users) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            const userEntries = Object.entries(users);

            if (userEntries.length === 0) {
                userList.innerHTML = '<span style="color:#9ca3af;">Waiting...</span>';
                return;
            }

            userEntries.forEach(([id, user]) => {
                const isYou = id === myUserId;
                const badge = document.createElement('div');
                badge.className = `user-badge${isYou ? ' you' : ''}`;
                badge.innerHTML = `<span class="dot" style="background:${user.color}"></span>
                    <span>${user.name}${isYou ? ' (you)' : ''}</span>`;
                userList.appendChild(badge);
            });
        }

        function updateComments(comments) {
            const commentsList = document.getElementById('commentsList');
            const commentCount = document.getElementById('commentCount');
            const commentEntries = Object.entries(comments).sort((a, b) => b[1].timestamp - a[1].timestamp);

            commentCount.textContent = commentEntries.length;

            if (commentEntries.length === 0) {
                commentsList.innerHTML = '<div class="no-comments">No comments yet. Add a comment to start a discussion.</div>';
                return;
            }

            commentsList.innerHTML = '';
            commentEntries.forEach(([id, comment]) => {
                const isOwner = comment.userId === myUserId;
                const timeAgo = getTimeAgo(comment.timestamp);

                const item = document.createElement('div');
                item.className = 'comment-item';
                item.innerHTML = `
                    <div class="comment-author">
                        <span class="dot" style="background:${comment.color}"></span>
                        <span class="comment-author-name">${comment.author}</span>
                        <span class="comment-time">${timeAgo}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                    ${isOwner ? `
                    <div class="comment-actions">
                        <button class="comment-action-btn delete" onclick="deleteComment('${id}')">Delete</button>
                    </div>
                    ` : ''}
                `;
                commentsList.appendChild(item);
            });
        }

        function addComment() {
            const input = document.getElementById('newComment');
            const text = input.value.trim();
            if (!text) return;

            commentsRef.push({
                text: text,
                author: userName,
                userId: myUserId,
                color: userColor,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            input.value = '';
            showToast('Comment added');
        }

        function deleteComment(commentId) {
            commentsRef.child(commentId).remove();
            showToast('Comment deleted');
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href)
                .then(() => showToast('Link copied!'))
                .catch(() => prompt('Copy:', window.location.href));
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (myUserRef) myUserRef.remove();
        });
    </script>
</body>
</html>
