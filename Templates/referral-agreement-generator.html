<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-901N2Y3CDZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-901N2Y3CDZ');
    </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Referral Agreement Generator | Commission & Fee Agreement | Terms.Law</title>
  <meta name="description" content="Free Referral Agreement generator. Create professional referral and commission agreements with clear fee structures, payment terms, and non-circumvention clauses.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --color-primary: #1e40af;
      --color-primary-dark: #1e3a8a;
      --color-primary-light: #3b82f6;
      --color-accent: #dc2626;
      --color-accent-light: #f87171;
      --color-success: #059669;
      --color-warning: #d97706;
      --color-danger: #dc2626;
      --color-bg: #f8fafc;
      --color-surface: #ffffff;
      --color-border: #e2e8f0;
      --color-border-light: #f1f5f9;
      --color-text: #0f172a;
      --color-text-muted: #64748b;
      --color-text-light: #94a3b8;
      --color-dark: #0f172a;
      --color-dark-surface: #1e293b;
      --doc-bg: #fefefe;
      --doc-text: #1f2937;
      --doc-clause-title: #1e40af;
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-full: 9999px;
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --font-serif: Georgia, 'Times New Roman', serif;
      --transition-fast: 150ms ease;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }
    body { font-family: var(--font-sans); font-size: 16px; line-height: 1.6; color: var(--color-text); background: var(--color-bg); }

    .site-header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 0; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); }
    .header-content { display: flex; align-items: center; justify-content: center; height: 52px; }
    .header-nav { display: flex; align-items: center; gap: 0; height: 100%; }
    .nav-link { color: #94a3b8; font-size: 0.85rem; font-weight: 600; padding: 16px 24px; transition: all 150ms ease; text-decoration: none; height: 100%; display: flex; align-items: center; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid transparent; }
    .nav-link:hover { color: #ffffff; background: rgba(255, 255, 255, 0.05); }
    .nav-link.active { color: #ffffff; background: rgba(255, 255, 255, 0.08); border-bottom-color: #3b82f6; }
    .nav-link.home-logo { padding: 12px 20px; font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em; text-transform: none; }
    .nav-link.home-logo .logo-text { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    .hero { background: linear-gradient(135deg, #0f172a 0%, #7f1d1d 50%, #991b1b 100%); padding: 2rem 2rem; position: relative; }
    .hero-content { max-width: 800px; }
    .hero-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; background: rgba(220, 38, 38, 0.15); border: 1px solid rgba(220, 38, 38, 0.3); border-radius: var(--radius-full); font-size: 0.8rem; color: #fca5a5; margin-bottom: 1rem; }
    .hero h1 { font-size: 2rem; font-weight: 800; color: #fff; line-height: 1.2; margin-bottom: 0.75rem; }
    .hero h1 .highlight { background: linear-gradient(135deg, #fca5a5, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .hero-subtitle { font-size: 1rem; color: #94a3b8; line-height: 1.6; }

    .builder-layout { display: grid; grid-template-columns: 420px 1fr; gap: 0; min-height: calc(100vh - 200px); }
    @media (max-width: 1024px) { .builder-layout { grid-template-columns: 1fr; } }

    .builder-sidebar { background: var(--color-surface); border-right: 1px solid var(--color-border); padding: 1.5rem; overflow-y: auto; max-height: calc(100vh - 150px); position: sticky; top: 52px; }
    .builder-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border-light); }
    .builder-section:last-child { border-bottom: none; margin-bottom: 0; }
    .builder-section-title { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-muted); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }

    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--color-text); margin-bottom: 0.35rem; }
    .form-input, .form-textarea, .form-select { width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 0.9rem; font-family: inherit; transition: all var(--transition-fast); background: var(--color-surface); }
    .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1); }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-hint { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

    .checkbox-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; margin-bottom: 0.5rem; }
    .checkbox-item input[type="checkbox"] { width: 16px; height: 16px; }

    .preview-panel { background: var(--color-bg); padding: 1.5rem; overflow-y: auto; }
    .preview-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
    .preview-title { font-size: 0.8rem; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .preview-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); border: none; }
    .btn-primary { background: var(--color-primary); color: #fff; }
    .btn-primary:hover { background: var(--color-primary-dark); }
    .btn-secondary { background: var(--color-surface); color: var(--color-text); border: 1px solid var(--color-border); }
    .btn-secondary:hover { border-color: var(--color-primary); color: var(--color-primary); }

    .document-container { background: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); overflow: hidden; }
    .document-header { background: linear-gradient(135deg, var(--color-dark) 0%, var(--color-dark-surface) 100%); padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: space-between; }
    .document-title { color: #fff; font-size: 0.85rem; font-weight: 600; }
    .document-status { font-size: 0.7rem; color: var(--color-accent-light); }
    .document-body { padding: 50px 60px; background: var(--doc-bg); font-family: var(--font-serif); font-size: 13px; line-height: 1.8; color: var(--doc-text); }
    .document-body.full-edit-mode { outline: 3px solid var(--color-primary); background: #fffef8; }

    .doc-title { text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
    .doc-subtitle { text-align: center; font-size: 11px; color: var(--color-text-muted); margin-bottom: 30px; font-family: var(--font-sans); }
    .doc-section-header { font-size: 13px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-top: 25px; margin-bottom: 12px; color: var(--doc-clause-title); border-bottom: 1px solid var(--color-border); padding-bottom: 5px; }
    .doc-paragraph { margin-bottom: 14px; text-align: justify; }
    .doc-list { margin: 12px 0 12px 25px; padding-left: 15px; }
    .doc-list li { margin-bottom: 8px; text-align: justify; }

    .doc-highlight { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1px 5px; border-radius: 3px; border-bottom: 2px solid #f59e0b; font-weight: 600; cursor: text; }
    .doc-highlight:hover { background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%); }
    .doc-highlight:focus { outline: none; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3); }
    .doc-highlight.empty { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-bottom-color: #ef4444; color: #dc2626; }

    @keyframes highlightPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
      50% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
    }
    .field-highlight-animation { animation: highlightPulse 0.6s ease-out; background: linear-gradient(135deg, #fde047 0%, #facc15 100%) !important; }

    @keyframes flashContainer {
      0%, 100% { background: transparent; }
      25% { background: rgba(251, 191, 36, 0.2); box-shadow: 0 0 12px rgba(251, 191, 36, 0.3); }
      50% { background: rgba(253, 230, 138, 0.3); }
      75% { background: rgba(251, 191, 36, 0.15); }
    }
    ul.field-highlight-animation, div.field-highlight-animation { animation: flashContainer 1.5s ease; border-radius: 8px; }

    .doc-signature-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; margin-top: 50px; }
    .doc-signature-party-title { font-weight: bold; font-size: 11px; text-transform: uppercase; margin-bottom: 20px; color: var(--color-text-muted); }
    .doc-signature-line { display: flex; align-items: flex-end; margin-bottom: 10px; min-height: 35px; }
    .signature-label { width: 70px; font-size: 10px; color: var(--color-text-muted); }
    .signature-value { flex: 1; border-bottom: 1px solid #333; min-height: 30px; display: flex; align-items: flex-end; padding-bottom: 3px; }

    .toast { position: fixed; bottom: 20px; right: 20px; background: var(--color-dark); color: #fff; padding: 12px 18px; border-radius: var(--radius-md); font-size: 0.85rem; box-shadow: var(--shadow-xl); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1000; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: var(--color-success); }

    .site-footer { background: var(--color-dark); color: #94a3b8; padding: 2rem; text-align: center; }
    .footer-brand { font-size: 1.1rem; font-weight: 800; margin-bottom: 0.5rem; }
    .footer-brand .logo-text { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    @media print {
      .site-header, .hero, .builder-sidebar, .preview-toolbar, .document-header, .site-footer, .toast { display: none !important; }
      .builder-layout { display: block; }
      .preview-panel { padding: 0; }
      .document-container { box-shadow: none; }
      .document-body { padding: 0.5in; }
      .doc-highlight { background: none !important; border: none !important; padding: 0 !important; }
    }

    @media (max-width: 768px) {
      .document-body { padding: 25px 20px; }
      .doc-signature-row { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-content">
      <nav class="header-nav">
        <a href="/" class="nav-link home-logo"><span class="logo-text">Terms.Law</span></a>
        <a href="/Demand-Letters/demand-letters-landing.html" class="nav-link">Demands</a>
        <a href="contract-library-landing.html" class="nav-link active">Contracts</a>
        <a href="/INC/formation-landing.html" class="nav-link">Incorporation</a>
        <a href="/Blog/blog-landing.html" class="nav-link">Blog</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="hero-content">
      <div class="hero-badge">üí∞ Revenue Sharing</div>
      <h1><span class="highlight">Referral</span> Agreement Generator</h1>
      <p class="hero-subtitle">Create professional referral and commission agreements. Define referral fees, payment triggers, non-circumvention, and exclusivity terms.</p>
    </div>
  </section>

  <main class="builder-layout">
    <aside class="builder-sidebar">

      <!-- COMPANY (Paying referral fees) -->
      <div class="builder-section">
        <h3 class="builder-section-title">üè¢ Company</h3>
        <div class="form-group">
          <label class="form-label">Company Name</label>
          <input type="text" id="companyName" class="form-input" placeholder="Acme Services, Inc." oninput="trackFieldEdit('companyName')">
        </div>
        <div class="form-group">
          <label class="form-label">State of Formation</label>
          <select id="companyState" class="form-select" onchange="trackFieldEdit('companyState')">
            <option value="">Select state...</option>
            <option value="Delaware">Delaware</option>
            <option value="California">California</option>
            <option value="New York">New York</option>
            <option value="Texas">Texas</option>
            <option value="Florida">Florida</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Company Address</label>
          <input type="text" id="companyAddress" class="form-input" placeholder="123 Business Ave, City, State ZIP" oninput="trackFieldEdit('companyAddress')">
        </div>
      </div>

      <!-- REFERRER -->
      <div class="builder-section">
        <h3 class="builder-section-title">ü§ù Referrer</h3>
        <div class="form-group">
          <label class="form-label">Referrer Name</label>
          <input type="text" id="referrerName" class="form-input" placeholder="John Smith or Smith Partners LLC" oninput="trackFieldEdit('referrerName')">
        </div>
        <div class="form-group">
          <label class="form-label">Referrer Address</label>
          <input type="text" id="referrerAddress" class="form-input" placeholder="456 Main St, City, State ZIP" oninput="trackFieldEdit('referrerAddress')">
        </div>
        <div class="form-group">
          <label class="form-label">Referrer Email</label>
          <input type="email" id="referrerEmail" class="form-input" placeholder="john@referrer.com" oninput="trackFieldEdit('referrerEmail')">
        </div>
      </div>

      <!-- REFERRAL TERMS -->
      <div class="builder-section">
        <h3 class="builder-section-title">üíµ Referral Fee Structure</h3>
        <div class="form-group">
          <label class="form-label">Fee Type</label>
          <select id="feeType" class="form-select" onchange="updateFeeFields(); trackFieldEdit('feeType')">
            <option value="percentage">Percentage of Revenue</option>
            <option value="flat">Flat Fee per Referral</option>
            <option value="tiered">Tiered Commission</option>
          </select>
        </div>
        <div class="form-group" id="percentageGroup">
          <label class="form-label">Referral Fee (%)</label>
          <input type="number" id="feePercentage" class="form-input" placeholder="10" min="0" max="100" step="0.5" oninput="trackFieldEdit('feePercentage')">
        </div>
        <div class="form-group" id="flatGroup" style="display:none;">
          <label class="form-label">Flat Fee Amount ($)</label>
          <input type="number" id="flatFee" class="form-input" placeholder="500" oninput="trackFieldEdit('flatFee')">
        </div>
        <div class="form-group">
          <label class="form-label">Fee Basis</label>
          <select id="feeBasis" class="form-select" onchange="trackFieldEdit('feeBasis')">
            <option value="first_sale">First Sale/Contract Only</option>
            <option value="first_year">First Year Revenue</option>
            <option value="lifetime">Lifetime Revenue (while customer remains)</option>
            <option value="recurring">Recurring (each renewal)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Payment Trigger</label>
          <select id="paymentTrigger" class="form-select" onchange="trackFieldEdit('paymentTrigger')">
            <option value="signed">When contract is signed</option>
            <option value="paid">When Company receives payment</option>
            <option value="delivered">When services are delivered</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Payment Timing</label>
          <select id="paymentTiming" class="form-select" onchange="trackFieldEdit('paymentTiming')">
            <option value="net30">Net 30 from trigger</option>
            <option value="net15">Net 15 from trigger</option>
            <option value="monthly">Monthly (next billing cycle)</option>
            <option value="quarterly">Quarterly</option>
          </select>
        </div>
      </div>

      <!-- TERM & EXCLUSIVITY -->
      <div class="builder-section">
        <h3 class="builder-section-title">üìÖ Term & Territory</h3>
        <div class="form-group">
          <label class="form-label">Effective Date</label>
          <input type="date" id="effectiveDate" class="form-input" oninput="trackFieldEdit('effectiveDate')">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Initial Term</label>
            <select id="initialTerm" class="form-select" onchange="trackFieldEdit('initialTerm')">
              <option value="1 year">1 Year</option>
              <option value="2 years">2 Years</option>
              <option value="ongoing">Ongoing (no fixed term)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Notice Period</label>
            <select id="noticePeriod" class="form-select" onchange="trackFieldEdit('noticePeriod')">
              <option value="30">30 Days</option>
              <option value="60">60 Days</option>
              <option value="90">90 Days</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="checkbox-item">
            <input type="checkbox" id="exclusive" onchange="trackFieldEdit('exclusive')">
            <span>Exclusive referral arrangement</span>
          </label>
          <span class="form-hint">If checked, Company won't work with other referrers in same territory</span>
        </div>
        <div class="form-group" id="territoryGroup" style="display:none;">
          <label class="form-label">Exclusive Territory</label>
          <input type="text" id="territory" class="form-input" placeholder="e.g., California, Western US, Nationwide" oninput="trackFieldEdit('territory')">
        </div>
      </div>

      <!-- PROTECTIONS -->
      <div class="builder-section">
        <h3 class="builder-section-title">üõ°Ô∏è Protections</h3>
        <div class="form-group">
          <label class="checkbox-item">
            <input type="checkbox" id="nonCircumvention" checked onchange="trackFieldEdit('nonCircumvention')">
            <span>Non-circumvention clause</span>
          </label>
          <span class="form-hint">Prevents Company from bypassing Referrer</span>
        </div>
        <div class="form-group">
          <label class="checkbox-item">
            <input type="checkbox" id="nonSolicitation" onchange="trackFieldEdit('nonSolicitation')">
            <span>Non-solicitation of Referrer's contacts</span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">Referral Credit Period</label>
          <select id="creditPeriod" class="form-select" onchange="trackFieldEdit('creditPeriod')">
            <option value="6">6 months</option>
            <option value="12">12 months</option>
            <option value="24">24 months</option>
          </select>
          <span class="form-hint">How long after introduction Referrer gets credit</span>
        </div>
        <div class="form-group">
          <label class="form-label">Governing Law</label>
          <select id="governingLaw" class="form-select" onchange="trackFieldEdit('governingLaw')">
            <option value="">Same as Company State</option>
            <option value="Delaware">Delaware</option>
            <option value="California">California</option>
            <option value="New York">New York</option>
          </select>
        </div>
      </div>

    </aside>

    <section class="preview-panel">
      <div class="preview-toolbar">
        <span class="preview-title">üìÑ Live Document Preview</span>
        <div class="preview-actions">
          <button class="btn btn-secondary" onclick="toggleFullEditMode()" id="editModeBtn">‚úèÔ∏è Edit Mode</button>
          <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
          <button class="btn btn-primary" onclick="downloadWord()">üì• Download Word</button>
        </div>
      </div>

      <div class="document-container">
        <div class="document-header">
          <span class="document-title">Referral Agreement</span>
          <span class="document-status">‚óè Live Preview</span>
        </div>
        <div class="document-body" id="documentPreview"></div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-brand"><span class="logo-text">Terms.Law</span></div>
    <p>Attorney-drafted legal documents for businesses</p>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    let lastEditedField = null;
    let isFullEditMode = false;
    let savedDocumentHTML = '';
    let hasCustomEdits = false;

    const fieldInputMap = {
      'companyName': 'companyName',
      'companyState': 'companyState',
      'referrerName': 'referrerName',
      'feePercentage': 'feePercentage',
      'flatFee': 'flatFee',
      'effectiveDate': 'effectiveDate',
      'governingLaw': 'governingLaw'
    };

    function updateFeeFields() {
      const type = document.getElementById('feeType').value;
      document.getElementById('percentageGroup').style.display = type === 'percentage' || type === 'tiered' ? 'block' : 'none';
      document.getElementById('flatGroup').style.display = type === 'flat' ? 'block' : 'none';
    }

    document.getElementById('exclusive').addEventListener('change', function() {
      document.getElementById('territoryGroup').style.display = this.checked ? 'block' : 'none';
    });

    function trackFieldEdit(fieldId) {
      if (hasCustomEdits) {
        const proceed = confirm('You have custom edits. Continue?');
        if (!proceed) return;
        hasCustomEdits = false;
      }
      lastEditedField = fieldId;
      updatePreview();
    }

    function updatePreview() {
      if (isFullEditMode) return;

      const h = (value, placeholder, fieldId) => {
        const isEmpty = !value || value.startsWith('[');
        const displayValue = isEmpty ? `[${placeholder}]` : value;
        const emptyClass = isEmpty ? ' empty' : '';
        return `<span class="doc-highlight${emptyClass}" data-field="${fieldId}" contenteditable="true">${displayValue}</span>`;
      };

      const companyName = document.getElementById('companyName').value || '';
      const companyState = document.getElementById('companyState').value || '';
      const companyAddress = document.getElementById('companyAddress').value || '';
      const referrerName = document.getElementById('referrerName').value || '';
      const referrerAddress = document.getElementById('referrerAddress').value || '';
      const referrerEmail = document.getElementById('referrerEmail').value || '';
      const feeType = document.getElementById('feeType').value || 'percentage';
      const feePercentage = document.getElementById('feePercentage').value || '';
      const flatFee = document.getElementById('flatFee').value || '';
      const feeBasis = document.getElementById('feeBasis').value || 'first_sale';
      const paymentTrigger = document.getElementById('paymentTrigger').value || 'paid';
      const paymentTiming = document.getElementById('paymentTiming').value || 'net30';
      const effectiveDate = document.getElementById('effectiveDate').value || '';
      const initialTerm = document.getElementById('initialTerm').value || '1 year';
      const noticePeriod = document.getElementById('noticePeriod').value || '30';
      const exclusive = document.getElementById('exclusive').checked;
      const territory = document.getElementById('territory').value || '';
      const nonCircumvention = document.getElementById('nonCircumvention').checked;
      const nonSolicitation = document.getElementById('nonSolicitation').checked;
      const creditPeriod = document.getElementById('creditPeriod').value || '12';
      const governingLaw = document.getElementById('governingLaw').value || companyState;

      const formatDate = (d) => d ? new Date(d + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
      const formattedDate = formatDate(effectiveDate);

      // Fee description
      let feeText = '';
      if (feeType === 'percentage') {
        feeText = `${h(feePercentage + '%', 'Percentage', 'feePercentage')} of the revenue`;
      } else if (feeType === 'flat') {
        feeText = `a flat fee of ${h('$' + flatFee, 'Flat Fee', 'flatFee')}`;
      } else {
        feeText = `a tiered commission starting at ${h(feePercentage + '%', 'Percentage', 'feePercentage')} of revenue`;
      }

      // Fee basis text
      const feeBasisText = {
        'first_sale': 'the first sale or contract value',
        'first_year': 'the first year of revenue from the referred customer',
        'lifetime': 'all revenue from the referred customer for as long as they remain a customer',
        'recurring': 'each contract renewal or recurring payment from the referred customer'
      }[feeBasis];

      // Payment trigger text
      const triggerText = {
        'signed': 'when a contract with the referred customer is signed',
        'paid': 'when Company receives payment from the referred customer',
        'delivered': 'when services are delivered to the referred customer'
      }[paymentTrigger];

      // Payment timing text
      const timingText = {
        'net30': 'within thirty (30) days',
        'net15': 'within fifteen (15) days',
        'monthly': 'on the next monthly billing cycle',
        'quarterly': 'on the next quarterly payment cycle'
      }[paymentTiming];

      let html = `
        <div class="doc-title">REFERRAL AGREEMENT</div>
        <p class="doc-subtitle">Effective as of ${h(formattedDate, 'Effective Date', 'effectiveDate')}</p>

        <p class="doc-paragraph">
          This Referral Agreement (this "<strong>Agreement</strong>") is entered into as of the date set forth above,
          by and between ${h(companyName, 'Company Name', 'companyName')}, a ${h(companyState, 'State', 'companyState')} corporation
          with its principal place of business at ${h(companyAddress, 'Company Address', 'companyAddress')} ("<strong>Company</strong>"),
          and ${h(referrerName, 'Referrer Name', 'referrerName')}, with an address at ${h(referrerAddress, 'Referrer Address', 'referrerAddress')} ("<strong>Referrer</strong>").
        </p>

        <p class="doc-paragraph">
          <strong>WHEREAS</strong>, Company desires to expand its customer base and Referrer has relationships with potential customers who may benefit from Company's products and services; and
        </p>

        <p class="doc-paragraph">
          <strong>WHEREAS</strong>, the parties desire to establish a referral arrangement whereby Referrer will introduce potential customers to Company in exchange for referral fees;
        </p>

        <p class="doc-paragraph">
          <strong>NOW, THEREFORE</strong>, in consideration of the mutual covenants and agreements hereinafter set forth, the parties agree as follows:
        </p>

        <div class="doc-section-header">1. Referral Services</div>
        <p class="doc-paragraph">
          <strong>1.1 Referral Obligation.</strong> Referrer agrees to use reasonable efforts to identify and introduce to Company potential customers for Company's products and services (each, a "<strong>Prospect</strong>"). For a Prospect to be eligible for a referral fee, Referrer must submit the Prospect's contact information to Company prior to Company having any existing relationship with such Prospect.
        </p>
        <p class="doc-paragraph">
          <strong>1.2 Qualified Referral.</strong> A "<strong>Qualified Referral</strong>" means a Prospect submitted by Referrer who: (a) has not previously been a customer of Company; (b) is not already in Company's active sales pipeline; and (c) enters into a binding agreement with Company for products or services within ${h(creditPeriod, 'Credit Period', 'creditPeriod')} months of the initial introduction by Referrer.
        </p>
        ${exclusive ? `
        <p class="doc-paragraph">
          <strong>1.3 Exclusivity.</strong> This is an exclusive referral arrangement. During the term of this Agreement, Company shall not engage any other referral partners for the following territory: ${h(territory, 'Territory', 'territory')}. Referrer shall be the exclusive source of referrals within this territory.
        </p>
        ` : `
        <p class="doc-paragraph">
          <strong>1.3 Non-Exclusivity.</strong> This is a non-exclusive referral arrangement. Company may engage other referral partners and pursue leads from any source.
        </p>
        `}

        <div class="doc-section-header">2. Referral Fees</div>
        <p class="doc-paragraph" data-field="feePercentage">
          <strong>2.1 Fee Amount.</strong> For each Qualified Referral, Company shall pay Referrer ${feeText} based on ${feeBasisText}.
        </p>
        <p class="doc-paragraph">
          <strong>2.2 Payment Trigger.</strong> Referral fees shall become due and payable ${triggerText}.
        </p>
        <p class="doc-paragraph">
          <strong>2.3 Payment Timing.</strong> Company shall pay all referral fees ${timingText} of the payment trigger date. Company shall provide Referrer with a written statement detailing each Qualified Referral and the fees earned.
        </p>
        <p class="doc-paragraph">
          <strong>2.4 Taxes.</strong> Referrer is solely responsible for all taxes arising from the referral fees received under this Agreement. Company may require Referrer to provide a completed W-9 form prior to any payment.
        </p>

        <div class="doc-section-header">3. Term and Termination</div>
        <p class="doc-paragraph">
          <strong>3.1 Term.</strong> This Agreement shall commence on the Effective Date and continue for an initial term of ${h(initialTerm, 'Initial Term', 'initialTerm')}, unless earlier terminated in accordance with this Section 3.
        </p>
        <p class="doc-paragraph">
          <strong>3.2 Termination for Convenience.</strong> Either party may terminate this Agreement at any time upon ${h(noticePeriod, 'Notice Period', 'noticePeriod')} days' prior written notice to the other party.
        </p>
        <p class="doc-paragraph">
          <strong>3.3 Effect of Termination.</strong> Upon termination: (a) Referrer shall be entitled to referral fees for all Qualified Referrals submitted prior to the termination date, provided such Prospects become customers within ${h(creditPeriod, 'Credit Period', 'creditPeriod')} months of their introduction; and (b) Referrer's right to submit new Prospects shall immediately cease.
        </p>

        ${nonCircumvention ? `
        <div class="doc-section-header">4. Non-Circumvention</div>
        <p class="doc-paragraph">
          <strong>4.1</strong> Company agrees that it will not circumvent, avoid, bypass, or obviate Referrer's involvement in any business relationship with any Prospect introduced by Referrer. Company shall not directly or indirectly contact, deal with, or enter into any business relationship with any Prospect introduced by Referrer except through Referrer, without Referrer's prior written consent.
        </p>
        <p class="doc-paragraph">
          <strong>4.2</strong> This non-circumvention obligation shall survive the termination of this Agreement for a period of ${h(creditPeriod, 'Credit Period', 'creditPeriod')} months with respect to any Prospects introduced during the term of this Agreement.
        </p>
        ` : ''}

        ${nonSolicitation ? `
        <div class="doc-section-header">${nonCircumvention ? '5' : '4'}. Non-Solicitation</div>
        <p class="doc-paragraph">
          During the term of this Agreement and for twelve (12) months thereafter, Company agrees not to solicit or attempt to solicit business from any contact or business relationship of Referrer that was disclosed to Company in connection with this Agreement, except for Prospects that become customers of Company through Referrer's introduction.
        </p>
        ` : ''}

        <div class="doc-section-header">${nonCircumvention && nonSolicitation ? '6' : nonCircumvention || nonSolicitation ? '5' : '4'}. Confidentiality</div>
        <p class="doc-paragraph">
          Each party agrees to maintain the confidentiality of all non-public information received from the other party in connection with this Agreement, including customer information, pricing, and business strategies. This confidentiality obligation shall survive the termination of this Agreement for a period of two (2) years.
        </p>

        <div class="doc-section-header">${nonCircumvention && nonSolicitation ? '7' : nonCircumvention || nonSolicitation ? '6' : '5'}. Independent Contractor</div>
        <p class="doc-paragraph">
          Referrer is an independent contractor and not an employee, partner, or agent of Company. Referrer has no authority to bind Company or make any representations on Company's behalf. Nothing in this Agreement creates any employment, agency, partnership, or joint venture relationship between the parties.
        </p>

        <div class="doc-section-header">${nonCircumvention && nonSolicitation ? '8' : nonCircumvention || nonSolicitation ? '7' : '6'}. General Provisions</div>
        <p class="doc-paragraph" data-field="governingLaw">
          <strong>Governing Law.</strong> This Agreement shall be governed by and construed in accordance with the laws of the State of ${h(governingLaw || companyState || 'Delaware', 'State', 'governingLaw')}, without regard to its conflicts of laws principles.
        </p>
        <p class="doc-paragraph">
          <strong>Entire Agreement.</strong> This Agreement constitutes the entire agreement between the parties with respect to the subject matter hereof and supersedes all prior agreements and understandings.
        </p>
        <p class="doc-paragraph">
          <strong>Amendment.</strong> This Agreement may not be amended except by a written instrument signed by both parties.
        </p>
        <p class="doc-paragraph">
          <strong>Notices.</strong> All notices shall be in writing and shall be deemed given when delivered by email to the addresses set forth above or such other addresses as the parties may designate.
        </p>
        <p class="doc-paragraph">
          <strong>Assignment.</strong> Neither party may assign this Agreement without the prior written consent of the other party.
        </p>

        <p class="doc-paragraph" style="margin-top: 40px;">
          <strong>IN WITNESS WHEREOF</strong>, the parties have executed this Agreement as of the date first written above.
        </p>

        <div class="doc-signature-row">
          <div class="doc-signature-party">
            <div class="doc-signature-party-title">COMPANY</div>
            <div style="font-weight: bold; margin-bottom: 15px;">${companyName || '[Company Name]'}</div>
            <div class="doc-signature-line">
              <span class="signature-label">Signature:</span>
              <span class="signature-value"></span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Name:</span>
              <span class="signature-value">______________________</span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Title:</span>
              <span class="signature-value">______________________</span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Date:</span>
              <span class="signature-value">______________________</span>
            </div>
          </div>

          <div class="doc-signature-party">
            <div class="doc-signature-party-title">REFERRER</div>
            <div style="font-weight: bold; margin-bottom: 15px;">${referrerName || '[Referrer Name]'}</div>
            <div class="doc-signature-line">
              <span class="signature-label">Signature:</span>
              <span class="signature-value"></span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Name:</span>
              <span class="signature-value">______________________</span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Email:</span>
              <span class="signature-value">${referrerEmail || '______________________'}</span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Date:</span>
              <span class="signature-value">______________________</span>
            </div>
          </div>
        </div>
      `;

      document.getElementById('documentPreview').innerHTML = html;
      setupInlineEditing();

      if (lastEditedField) {
        setTimeout(() => {
          const highlight = document.querySelector(`[data-field="${lastEditedField}"]`);
          if (highlight) {
            highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
            highlight.classList.add('field-highlight-animation');
            setTimeout(() => highlight.classList.remove('field-highlight-animation'), 1500);
          }
          lastEditedField = null;
        }, 50);
      }
    }

    function setupInlineEditing() {
      document.querySelectorAll('.doc-highlight[contenteditable="true"]').forEach(el => {
        el.addEventListener('blur', function() { handleInlineEdit(this); });
        el.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); this.blur(); } });
        el.addEventListener('focus', function() {
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(this);
          selection.removeAllRanges();
          selection.addRange(range);
        });
      });
    }

    function handleInlineEdit(element) {
      const fieldId = element.dataset.field;
      const newValue = element.textContent.trim();
      const inputId = fieldInputMap[fieldId];
      if (inputId) {
        const input = document.getElementById(inputId);
        if (input && !newValue.startsWith('[') && !newValue.endsWith(']')) {
          input.value = newValue;
        }
      }
    }

    function toggleFullEditMode() {
      const docBody = document.getElementById('documentPreview');
      const toggleBtn = document.getElementById('editModeBtn');
      if (!isFullEditMode) {
        isFullEditMode = true;
        savedDocumentHTML = docBody.innerHTML;
        docBody.contentEditable = 'true';
        docBody.classList.add('full-edit-mode');
        toggleBtn.innerHTML = 'üíæ Save Edits';
        showToast('Edit mode enabled.');
      } else {
        isFullEditMode = false;
        hasCustomEdits = true;
        docBody.contentEditable = 'false';
        docBody.classList.remove('full-edit-mode');
        toggleBtn.innerHTML = '‚úèÔ∏è Edit Mode';
        showToast('Edits saved!');
      }
    }

    function downloadWord() {
      const content = document.getElementById('documentPreview').innerHTML;
      const companyName = document.getElementById('companyName').value || 'Company';
      const referrerName = document.getElementById('referrerName').value || 'Referrer';

      const html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
        <head><meta charset='utf-8'><title>Referral Agreement</title></head>
        <body style="font-family: Georgia, serif; font-size: 12pt; line-height: 1.6;">${content}</body></html>`;

      const blob = new Blob([html], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Referral Agreement - ${companyName} - ${referrerName}.doc`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Document downloaded!', 'success');
    }

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => { toast.className = 'toast'; }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('effectiveDate').value = today;
      updatePreview();
    });
  </script>
</body>
</html>
