<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-901N2Y3CDZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-901N2Y3CDZ');
    </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Master Services Agreement (MSA) Generator | Terms.Law</title>
  <meta name="description" content="Free Master Services Agreement generator. Create professional MSAs for consulting, development, and service engagements. Attorney-drafted with real-time preview.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ============================================
       CSS VARIABLES - Professional Theme
       ============================================ */
    :root {
      --color-primary: #1e40af;
      --color-primary-dark: #1e3a8a;
      --color-primary-light: #3b82f6;
      --color-accent: #059669;
      --color-accent-light: #10b981;
      --color-success: #059669;
      --color-warning: #d97706;
      --color-danger: #dc2626;

      --color-bg: #f8fafc;
      --color-surface: #ffffff;
      --color-border: #e2e8f0;
      --color-border-light: #f1f5f9;
      --color-text: #0f172a;
      --color-text-secondary: #334155;
      --color-text-muted: #64748b;
      --color-text-light: #94a3b8;

      --color-dark: #0f172a;
      --color-dark-surface: #1e293b;

      --doc-bg: #fefefe;
      --doc-border: #d1d5db;
      --doc-highlight: #fef3c7;
      --doc-highlight-border: #fcd34d;
      --doc-text: #1f2937;
      --doc-clause-title: #1e40af;
      --doc-section-num: #6366f1;

      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;
      --radius-full: 9999px;

      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --font-serif: Georgia, 'Times New Roman', serif;
      --max-width: 1280px;

      --transition-fast: 150ms ease;
      --transition-base: 200ms ease;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }
    body { font-family: var(--font-sans); font-size: 16px; line-height: 1.6; color: var(--color-text); background: var(--color-bg); }

    /* ============================================
       HEADER
       ============================================ */
    .site-header {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .header-content { display: flex; align-items: center; justify-content: center; height: 52px; }
    .header-nav { display: flex; align-items: center; gap: 0; height: 100%; }
    .nav-link {
      color: #94a3b8; font-size: 0.85rem; font-weight: 600; padding: 16px 24px;
      transition: all 150ms ease; text-decoration: none; height: 100%;
      display: flex; align-items: center; text-transform: uppercase;
      letter-spacing: 0.05em; border-bottom: 2px solid transparent;
    }
    .nav-link:hover { color: #ffffff; background: rgba(255, 255, 255, 0.05); }
    .nav-link.active { color: #ffffff; background: rgba(255, 255, 255, 0.08); border-bottom-color: #3b82f6; }
    .nav-link.home-logo { padding: 12px 20px; font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em; text-transform: none; }
    .nav-link.home-logo .logo-text { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    /* ============================================
       HERO
       ============================================ */
    .hero {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #064e3b 100%);
      padding: 2rem 2rem;
      position: relative;
    }
    .hero-content { max-width: 800px; }
    .hero-badge {
      display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px;
      background: rgba(5, 150, 105, 0.15); border: 1px solid rgba(5, 150, 105, 0.3);
      border-radius: var(--radius-full); font-size: 0.8rem; color: #6ee7b7; margin-bottom: 1rem;
    }
    .hero h1 { font-size: 2rem; font-weight: 800; color: #fff; line-height: 1.2; margin-bottom: 0.75rem; }
    .hero h1 .highlight { background: linear-gradient(135deg, #6ee7b7, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .hero-subtitle { font-size: 1rem; color: #94a3b8; line-height: 1.6; }

    /* ============================================
       BUILDER LAYOUT
       ============================================ */
    .builder-layout { display: grid; grid-template-columns: 420px 1fr; gap: 0; min-height: calc(100vh - 200px); }
    @media (max-width: 1024px) { .builder-layout { grid-template-columns: 1fr; } }

    .builder-sidebar {
      background: var(--color-surface); border-right: 1px solid var(--color-border);
      padding: 1.5rem; overflow-y: auto; max-height: calc(100vh - 150px);
      position: sticky; top: 52px;
    }
    .builder-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border-light); }
    .builder-section:last-child { border-bottom: none; margin-bottom: 0; }
    .builder-section-title {
      font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.05em; color: var(--color-text-muted); margin-bottom: 0.75rem;
      display: flex; align-items: center; gap: 0.5rem;
    }

    /* Form Elements */
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--color-text); margin-bottom: 0.35rem; }
    .form-input, .form-textarea, .form-select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--color-border);
      border-radius: var(--radius-md); font-size: 0.9rem; font-family: inherit;
      transition: all var(--transition-fast); background: var(--color-surface);
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none; border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-hint { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

    /* Checkbox styling */
    .checkbox-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .checkbox-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; }
    .checkbox-item input[type="checkbox"] { width: 16px; height: 16px; }

    /* Preview Panel */
    .preview-panel { background: var(--color-bg); padding: 1.5rem; overflow-y: auto; }
    .preview-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
    .preview-title { font-size: 0.8rem; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .preview-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px;
      border-radius: var(--radius-md); font-size: 0.85rem; font-weight: 600;
      cursor: pointer; transition: all var(--transition-fast); border: none;
    }
    .btn-primary { background: var(--color-primary); color: #fff; }
    .btn-primary:hover { background: var(--color-primary-dark); }
    .btn-secondary { background: var(--color-surface); color: var(--color-text); border: 1px solid var(--color-border); }
    .btn-secondary:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .btn-success { background: var(--color-success); color: #fff; }
    .btn-success:hover { background: #047857; }

    /* Document Container */
    .document-container { background: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); overflow: hidden; }
    .document-header {
      background: linear-gradient(135deg, var(--color-dark) 0%, var(--color-dark-surface) 100%);
      padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: space-between;
    }
    .document-title { color: #fff; font-size: 0.85rem; font-weight: 600; }
    .document-status { font-size: 0.7rem; color: var(--color-accent-light); }
    .document-body {
      padding: 50px 60px; background: var(--doc-bg);
      font-family: var(--font-serif); font-size: 13px; line-height: 1.8; color: var(--doc-text);
    }
    .document-body.full-edit-mode { outline: 3px solid var(--color-primary); background: #fffef8; }

    /* Document Formatting */
    .doc-title { text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
    .doc-subtitle { text-align: center; font-size: 11px; color: var(--color-text-muted); margin-bottom: 30px; font-family: var(--font-sans); }
    .doc-section-header {
      font-size: 13px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
      margin-top: 25px; margin-bottom: 12px; color: var(--doc-clause-title);
      border-bottom: 1px solid var(--color-border); padding-bottom: 5px;
    }
    .doc-paragraph { margin-bottom: 14px; text-align: justify; }
    .doc-list { margin: 12px 0 12px 25px; padding-left: 15px; }
    .doc-list li { margin-bottom: 8px; text-align: justify; }

    /* Highlighted Editable Fields - CRITICAL */
    .doc-highlight {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      padding: 1px 5px; border-radius: 3px; border-bottom: 2px solid #f59e0b;
      font-weight: 600; cursor: text;
    }
    .doc-highlight:hover { background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%); }
    .doc-highlight:focus { outline: none; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3); }
    .doc-highlight.empty { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-bottom-color: #ef4444; color: #dc2626; }

    /* CRITICAL: Field highlight animation for scroll-to-view */
    @keyframes highlightPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
      50% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
    }
    .field-highlight-animation {
      animation: highlightPulse 0.6s ease-out;
      background: linear-gradient(135deg, #fde047 0%, #facc15 100%) !important;
    }

    /* Container/list highlight animation */
    @keyframes flashContainer {
      0%, 100% { background: transparent; }
      25% { background: rgba(251, 191, 36, 0.2); box-shadow: 0 0 12px rgba(251, 191, 36, 0.3); }
      50% { background: rgba(253, 230, 138, 0.3); }
      75% { background: rgba(251, 191, 36, 0.15); }
    }
    ul.field-highlight-animation, ol.field-highlight-animation, div.field-highlight-animation {
      animation: flashContainer 1.5s ease;
      border-radius: 8px;
    }

    /* Signature Blocks */
    .doc-signature-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; margin-top: 50px; }
    .doc-signature-party-title { font-weight: bold; font-size: 11px; text-transform: uppercase; margin-bottom: 20px; color: var(--color-text-muted); }
    .doc-signature-line { display: flex; align-items: flex-end; margin-bottom: 10px; min-height: 35px; }
    .signature-label { width: 70px; font-size: 10px; color: var(--color-text-muted); }
    .signature-value { flex: 1; border-bottom: 1px solid #333; min-height: 30px; display: flex; align-items: flex-end; padding-bottom: 3px; }
    .typed-sig { font-family: 'Dancing Script', cursive; font-size: 24px; }

    /* Toast Notification */
    .toast {
      position: fixed; bottom: 20px; right: 20px; background: var(--color-dark);
      color: #fff; padding: 12px 18px; border-radius: var(--radius-md);
      font-size: 0.85rem; box-shadow: var(--shadow-xl);
      transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1000;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: var(--color-success); }

    /* Footer */
    .site-footer { background: var(--color-dark); color: #94a3b8; padding: 2rem; text-align: center; }
    .footer-brand { font-size: 1.1rem; font-weight: 800; margin-bottom: 0.5rem; }
    .footer-brand .logo-text { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    /* Print Styles */
    @media print {
      .site-header, .hero, .builder-sidebar, .preview-toolbar, .document-header, .site-footer, .toast { display: none !important; }
      .builder-layout { display: block; }
      .preview-panel { padding: 0; }
      .document-container { box-shadow: none; }
      .document-body { padding: 0.5in; }
      .doc-highlight { background: none !important; border: none !important; padding: 0 !important; }
    }

    @media (max-width: 768px) {
      .document-body { padding: 25px 20px; }
      .doc-signature-row { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-content">
      <nav class="header-nav">
        <a href="/" class="nav-link home-logo"><span class="logo-text">Terms.Law</span></a>
        <a href="/Demand-Letters/" class="nav-link">Demands</a>
        <a href="/Templates/" class="nav-link active">Contracts</a>
        <a href="/INC/formation-landing.html" class="nav-link">Incorporation</a>
        <a href="/Blog/" class="nav-link">Blog</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="hero-content">
      <div class="hero-badge">ü§ù Business Essential</div>
      <h1>Master Services <span class="highlight">Agreement</span> Generator</h1>
      <p class="hero-subtitle">Create professional MSAs for consulting, development, and service engagements. Define scope, payment terms, IP ownership, and liability.</p>
    </div>
  </section>

  <main class="builder-layout">
    <aside class="builder-sidebar">

      <!-- PARTIES SECTION -->
      <div class="builder-section">
        <h3 class="builder-section-title">üìã Service Provider</h3>
        <div class="form-group">
          <label class="form-label">Company/Provider Name</label>
          <input type="text" id="providerName" class="form-input" placeholder="Acme Consulting, LLC" oninput="trackFieldEdit('providerName')">
        </div>
        <div class="form-group">
          <label class="form-label">State of Formation</label>
          <select id="providerState" class="form-select" onchange="trackFieldEdit('providerState')">
            <option value="">Select state...</option>
            <option value="Delaware">Delaware</option>
            <option value="California">California</option>
            <option value="New York">New York</option>
            <option value="Texas">Texas</option>
            <option value="Florida">Florida</option>
            <option value="Wyoming">Wyoming</option>
            <option value="Nevada">Nevada</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Provider Address</label>
          <input type="text" id="providerAddress" class="form-input" placeholder="123 Main St, City, State ZIP" oninput="trackFieldEdit('providerAddress')">
        </div>
      </div>

      <!-- CLIENT SECTION -->
      <div class="builder-section">
        <h3 class="builder-section-title">üè¢ Client</h3>
        <div class="form-group">
          <label class="form-label">Client Name</label>
          <input type="text" id="clientName" class="form-input" placeholder="Client Corp." oninput="trackFieldEdit('clientName')">
        </div>
        <div class="form-group">
          <label class="form-label">Client Address</label>
          <input type="text" id="clientAddress" class="form-input" placeholder="456 Business Ave, City, State ZIP" oninput="trackFieldEdit('clientAddress')">
        </div>
      </div>

      <!-- AGREEMENT DETAILS -->
      <div class="builder-section">
        <h3 class="builder-section-title">üìÖ Agreement Details</h3>
        <div class="form-group">
          <label class="form-label">Effective Date</label>
          <input type="date" id="effectiveDate" class="form-input" oninput="trackFieldEdit('effectiveDate')">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Initial Term</label>
            <select id="initialTerm" class="form-select" onchange="trackFieldEdit('initialTerm')">
              <option value="1 year">1 Year</option>
              <option value="2 years">2 Years</option>
              <option value="3 years">3 Years</option>
              <option value="ongoing">Ongoing (no fixed term)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Auto-Renewal</label>
            <select id="autoRenewal" class="form-select" onchange="trackFieldEdit('autoRenewal')">
              <option value="yes">Yes, auto-renew</option>
              <option value="no">No auto-renewal</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notice Period for Termination</label>
          <select id="noticePeriod" class="form-select" onchange="trackFieldEdit('noticePeriod')">
            <option value="30 days">30 Days</option>
            <option value="60 days">60 Days</option>
            <option value="90 days">90 Days</option>
          </select>
        </div>
      </div>

      <!-- SERVICES & PAYMENT -->
      <div class="builder-section">
        <h3 class="builder-section-title">üí∞ Payment Terms</h3>
        <div class="form-group">
          <label class="form-label">Payment Terms</label>
          <select id="paymentTerms" class="form-select" onchange="trackFieldEdit('paymentTerms')">
            <option value="net30">Net 30</option>
            <option value="net15">Net 15</option>
            <option value="net45">Net 45</option>
            <option value="net60">Net 60</option>
            <option value="due_on_receipt">Due on Receipt</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Late Payment Interest Rate (%)</label>
          <input type="number" id="lateInterest" class="form-input" placeholder="1.5" step="0.5" min="0" max="18" oninput="trackFieldEdit('lateInterest')">
          <span class="form-hint">Monthly interest on overdue amounts</span>
        </div>
      </div>

      <!-- IP & CONFIDENTIALITY -->
      <div class="builder-section">
        <h3 class="builder-section-title">üîí IP & Confidentiality</h3>
        <div class="form-group">
          <label class="form-label">Work Product Ownership</label>
          <select id="ipOwnership" class="form-select" onchange="trackFieldEdit('ipOwnership')">
            <option value="client">Client owns all work product</option>
            <option value="provider">Provider retains ownership, grants license</option>
            <option value="joint">Joint ownership</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Confidentiality Period</label>
          <select id="confidentialityPeriod" class="form-select" onchange="trackFieldEdit('confidentialityPeriod')">
            <option value="2 years">2 Years after termination</option>
            <option value="3 years">3 Years after termination</option>
            <option value="5 years">5 Years after termination</option>
            <option value="perpetual">Perpetual (trade secrets)</option>
          </select>
        </div>
      </div>

      <!-- LIABILITY -->
      <div class="builder-section">
        <h3 class="builder-section-title">‚öñÔ∏è Liability & Indemnification</h3>
        <div class="form-group">
          <label class="form-label">Limitation of Liability</label>
          <select id="liabilityLimit" class="form-select" onchange="trackFieldEdit('liabilityLimit')">
            <option value="fees_12mo">12 months of fees paid</option>
            <option value="fees_paid">Total fees paid under agreement</option>
            <option value="50000">$50,000 cap</option>
            <option value="100000">$100,000 cap</option>
            <option value="unlimited">No limitation (not recommended)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Governing Law State</label>
          <select id="governingLaw" class="form-select" onchange="trackFieldEdit('governingLaw')">
            <option value="">Same as Provider State</option>
            <option value="Delaware">Delaware</option>
            <option value="California">California</option>
            <option value="New York">New York</option>
            <option value="Texas">Texas</option>
          </select>
        </div>
      </div>

      <!-- SIGNATURES -->
      <div class="builder-section">
        <h3 class="builder-section-title">‚úçÔ∏è Signatories</h3>
        <div class="form-group">
          <label class="form-label">Provider Signatory Name</label>
          <input type="text" id="providerSignatory" class="form-input" placeholder="John Smith" oninput="trackFieldEdit('providerSignatory')">
        </div>
        <div class="form-group">
          <label class="form-label">Provider Signatory Title</label>
          <input type="text" id="providerSignatoryTitle" class="form-input" placeholder="Managing Partner" oninput="trackFieldEdit('providerSignatoryTitle')">
        </div>
        <div class="form-group">
          <label class="form-label">Client Signatory Name</label>
          <input type="text" id="clientSignatory" class="form-input" placeholder="Jane Doe" oninput="trackFieldEdit('clientSignatory')">
        </div>
        <div class="form-group">
          <label class="form-label">Client Signatory Title</label>
          <input type="text" id="clientSignatoryTitle" class="form-input" placeholder="CEO" oninput="trackFieldEdit('clientSignatoryTitle')">
        </div>
      </div>

    </aside>

    <section class="preview-panel">
      <div class="preview-toolbar">
        <span class="preview-title">üìÑ Live Document Preview</span>
        <div class="preview-actions">
          <button class="btn btn-secondary" onclick="toggleFullEditMode()" id="editModeBtn">‚úèÔ∏è Edit Mode</button>
          <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
          <button class="btn btn-primary" onclick="downloadWord()">üì• Download Word</button>
        </div>
      </div>

      <div class="document-container">
        <div class="document-header">
          <span class="document-title">Master Services Agreement</span>
          <span class="document-status">‚óè Live Preview</span>
        </div>
        <div class="document-body" id="documentPreview">
          <!-- Document content generated by JavaScript -->
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-brand"><span class="logo-text">Terms.Law</span></div>
    <p>Attorney-drafted legal documents for businesses</p>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    // ============================================
    // STATE VARIABLES
    // ============================================
    let lastEditedField = null;
    let isFullEditMode = false;
    let savedDocumentHTML = '';
    let hasCustomEdits = false;

    // Field to input ID mapping for inline editing
    const fieldInputMap = {
      'providerName': 'providerName',
      'providerState': 'providerState',
      'providerAddress': 'providerAddress',
      'clientName': 'clientName',
      'clientAddress': 'clientAddress',
      'effectiveDate': 'effectiveDate',
      'initialTerm': 'initialTerm',
      'noticePeriod': 'noticePeriod',
      'paymentTerms': 'paymentTerms',
      'governingLaw': 'governingLaw'
    };

    // ============================================
    // TRACK FIELD EDIT - CRITICAL FOR SCROLL + HIGHLIGHT
    // ============================================
    function trackFieldEdit(fieldId) {
      if (hasCustomEdits) {
        const proceed = confirm(
          'You have custom edits in the document preview.\n\n' +
          'Changing form inputs will regenerate the document and your custom edits will be lost.\n\n' +
          'Click OK to regenerate, or Cancel to keep your edits.'
        );
        if (!proceed) return;
        hasCustomEdits = false;
      }

      lastEditedField = fieldId;
      updatePreview();
    }

    // ============================================
    // UPDATE PREVIEW - Main rendering function
    // ============================================
    function updatePreview() {
      if (isFullEditMode) return;

      // Helper function for highlighted editable fields
      const h = (value, placeholder, fieldId) => {
        const isEmpty = !value || value.startsWith('[');
        const displayValue = isEmpty ? `[${placeholder}]` : value;
        const emptyClass = isEmpty ? ' empty' : '';
        return `<span class="doc-highlight${emptyClass}" data-field="${fieldId}" contenteditable="true">${displayValue}</span>`;
      };

      // Get all form values
      const providerName = document.getElementById('providerName').value || '';
      const providerState = document.getElementById('providerState').value || '';
      const providerAddress = document.getElementById('providerAddress').value || '';
      const clientName = document.getElementById('clientName').value || '';
      const clientAddress = document.getElementById('clientAddress').value || '';
      const effectiveDate = document.getElementById('effectiveDate').value || '';
      const initialTerm = document.getElementById('initialTerm').value || '1 year';
      const autoRenewal = document.getElementById('autoRenewal').value || 'yes';
      const noticePeriod = document.getElementById('noticePeriod').value || '30 days';
      const paymentTerms = document.getElementById('paymentTerms').value || 'net30';
      const lateInterest = document.getElementById('lateInterest').value || '1.5';
      const ipOwnership = document.getElementById('ipOwnership').value || 'client';
      const confidentialityPeriod = document.getElementById('confidentialityPeriod').value || '3 years';
      const liabilityLimit = document.getElementById('liabilityLimit').value || 'fees_12mo';
      const governingLaw = document.getElementById('governingLaw').value || providerState;
      const providerSignatory = document.getElementById('providerSignatory').value || '';
      const providerSignatoryTitle = document.getElementById('providerSignatoryTitle').value || '';
      const clientSignatory = document.getElementById('clientSignatory').value || '';
      const clientSignatoryTitle = document.getElementById('clientSignatoryTitle').value || '';

      // Format date
      const formattedDate = effectiveDate ? new Date(effectiveDate + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';

      // Payment terms text
      const paymentTermsText = {
        'net30': 'thirty (30) days',
        'net15': 'fifteen (15) days',
        'net45': 'forty-five (45) days',
        'net60': 'sixty (60) days',
        'due_on_receipt': 'upon receipt'
      }[paymentTerms] || 'thirty (30) days';

      // Liability limit text
      const liabilityLimitText = {
        'fees_12mo': 'the total fees paid by Client to Provider during the twelve (12) month period preceding the claim',
        'fees_paid': 'the total fees paid by Client to Provider under this Agreement',
        '50000': 'Fifty Thousand Dollars ($50,000)',
        '100000': 'One Hundred Thousand Dollars ($100,000)',
        'unlimited': 'no limitation'
      }[liabilityLimit] || 'the total fees paid by Client to Provider during the twelve (12) month period preceding the claim';

      // IP ownership text
      let ipOwnershipText = '';
      if (ipOwnership === 'client') {
        ipOwnershipText = `All Work Product created by Provider in connection with the Services shall be the sole and exclusive property of Client. Provider hereby assigns to Client all right, title, and interest in and to such Work Product, including all intellectual property rights therein.`;
      } else if (ipOwnership === 'provider') {
        ipOwnershipText = `Provider shall retain all right, title, and interest in and to all Work Product created in connection with the Services. Provider hereby grants to Client a non-exclusive, perpetual, royalty-free license to use, modify, and distribute such Work Product for Client's internal business purposes.`;
      } else {
        ipOwnershipText = `All Work Product created by Provider in connection with the Services shall be jointly owned by Provider and Client. Each party shall have the right to use, license, and exploit such Work Product without accounting to the other party.`;
      }

      // Renewal text
      const renewalText = autoRenewal === 'yes'
        ? `This Agreement shall automatically renew for successive ${initialTerm} periods unless either party provides written notice of non-renewal at least ${noticePeriod} prior to the end of the then-current term.`
        : `This Agreement shall not automatically renew. Any extension of this Agreement must be agreed to in writing by both parties.`;

      // Generate document HTML
      let html = `
        <div class="doc-title">MASTER SERVICES AGREEMENT</div>
        <p class="doc-subtitle">Effective as of ${h(formattedDate, 'Effective Date', 'effectiveDate')}</p>

        <p class="doc-paragraph">
          This Master Services Agreement (this "<strong>Agreement</strong>") is entered into as of the date set forth above,
          by and between ${h(providerName, 'Provider Name', 'providerName')}, a ${h(providerState, 'State', 'providerState')} limited liability company
          with offices at ${h(providerAddress, 'Provider Address', 'providerAddress')} ("<strong>Provider</strong>"),
          and ${h(clientName, 'Client Name', 'clientName')}, with offices at ${h(clientAddress, 'Client Address', 'clientAddress')} ("<strong>Client</strong>").
        </p>

        <p class="doc-paragraph">
          <strong>WHEREAS</strong>, Provider is engaged in the business of providing professional services; and
        </p>

        <p class="doc-paragraph">
          <strong>WHEREAS</strong>, Client desires to engage Provider to perform certain services, and Provider desires to perform such services, subject to the terms and conditions set forth herein;
        </p>

        <p class="doc-paragraph">
          <strong>NOW, THEREFORE</strong>, in consideration of the mutual covenants and agreements hereinafter set forth and for other good and valuable consideration, the receipt and sufficiency of which are hereby acknowledged, the parties agree as follows:
        </p>

        <div class="doc-section-header">1. Services</div>

        <p class="doc-paragraph">
          <strong>1.1 Scope of Services.</strong> Provider agrees to perform the services described in one or more Statements of Work ("<strong>SOW</strong>") executed by both parties and attached hereto (the "<strong>Services</strong>"). Each SOW shall describe the specific services to be performed, deliverables, timeline, fees, and any other terms applicable to such Services.
        </p>

        <p class="doc-paragraph">
          <strong>1.2 Performance Standards.</strong> Provider shall perform the Services in a professional and workmanlike manner, consistent with industry standards and in accordance with the specifications set forth in the applicable SOW.
        </p>

        <p class="doc-paragraph">
          <strong>1.3 Changes.</strong> Either party may request changes to the Services by written notice to the other party. No change shall be effective unless agreed to in writing by both parties, including any adjustment to fees or timeline.
        </p>

        <div class="doc-section-header">2. Term and Termination</div>

        <p class="doc-paragraph">
          <strong>2.1 Term.</strong> This Agreement shall commence on the Effective Date and continue for an initial term of ${h(initialTerm, 'Initial Term', 'initialTerm')} (the "<strong>Initial Term</strong>"), unless earlier terminated in accordance with this Section 2.
        </p>

        <p class="doc-paragraph">
          <strong>2.2 Renewal.</strong> ${renewalText}
        </p>

        <p class="doc-paragraph">
          <strong>2.3 Termination for Convenience.</strong> Either party may terminate this Agreement or any SOW at any time upon ${h(noticePeriod, 'Notice Period', 'noticePeriod')} prior written notice to the other party.
        </p>

        <p class="doc-paragraph">
          <strong>2.4 Termination for Cause.</strong> Either party may terminate this Agreement immediately upon written notice if the other party: (a) materially breaches this Agreement and fails to cure such breach within thirty (30) days after receipt of written notice; or (b) becomes insolvent, files for bankruptcy, or ceases to operate in the ordinary course of business.
        </p>

        <p class="doc-paragraph">
          <strong>2.5 Effect of Termination.</strong> Upon termination: (a) Client shall pay Provider for all Services performed through the effective date of termination; (b) each party shall return or destroy all Confidential Information of the other party; and (c) any provisions that by their nature should survive termination shall survive.
        </p>

        <div class="doc-section-header">3. Compensation and Payment</div>

        <p class="doc-paragraph">
          <strong>3.1 Fees.</strong> Client shall pay Provider the fees set forth in each SOW. Unless otherwise specified in a SOW, fees are exclusive of all taxes, which shall be the responsibility of Client.
        </p>

        <p class="doc-paragraph">
          <strong>3.2 Invoicing.</strong> Provider shall invoice Client for Services in accordance with the payment schedule set forth in the applicable SOW. If no schedule is specified, Provider shall invoice Client monthly in arrears.
        </p>

        <p class="doc-paragraph" data-field="paymentTerms">
          <strong>3.3 Payment Terms.</strong> Client shall pay all undisputed invoices within ${paymentTermsText} of receipt. Any amounts not paid when due shall bear interest at the rate of ${h(lateInterest, '1.5', 'lateInterest')}% per month (or the maximum rate permitted by law, if less).
        </p>

        <p class="doc-paragraph">
          <strong>3.4 Expenses.</strong> Client shall reimburse Provider for all pre-approved, reasonable out-of-pocket expenses incurred in connection with the Services, provided that Provider submits documentation of such expenses.
        </p>

        <div class="doc-section-header">4. Intellectual Property</div>

        <p class="doc-paragraph" data-field="ipOwnership">
          <strong>4.1 Work Product.</strong> ${ipOwnershipText}
        </p>

        <p class="doc-paragraph">
          <strong>4.2 Pre-Existing IP.</strong> Each party shall retain all right, title, and interest in and to its pre-existing intellectual property. To the extent Provider incorporates any of its pre-existing intellectual property into the Work Product, Provider hereby grants to Client a non-exclusive, perpetual, royalty-free license to use such pre-existing intellectual property solely as part of the Work Product.
        </p>

        <p class="doc-paragraph">
          <strong>4.3 Third-Party Materials.</strong> Provider shall not incorporate any third-party materials into the Work Product without Client's prior written consent. If third-party materials are incorporated with Client's consent, Provider shall ensure that Client receives a license to use such materials on terms acceptable to Client.
        </p>

        <div class="doc-section-header">5. Confidentiality</div>

        <p class="doc-paragraph">
          <strong>5.1 Definition.</strong> "<strong>Confidential Information</strong>" means any information disclosed by one party to the other that is marked as confidential or that reasonably should be understood to be confidential given the nature of the information and circumstances of disclosure.
        </p>

        <p class="doc-paragraph">
          <strong>5.2 Obligations.</strong> The receiving party shall: (a) hold the disclosing party's Confidential Information in strict confidence; (b) not disclose such Confidential Information to any third party except as expressly permitted herein; and (c) use such Confidential Information only for the purposes of this Agreement.
        </p>

        <p class="doc-paragraph" data-field="confidentialityPeriod">
          <strong>5.3 Duration.</strong> The obligations of confidentiality shall survive the termination of this Agreement for a period of ${h(confidentialityPeriod, 'Confidentiality Period', 'confidentialityPeriod')}, except with respect to trade secrets, which shall be protected for as long as they remain trade secrets under applicable law.
        </p>

        <div class="doc-section-header">6. Representations and Warranties</div>

        <p class="doc-paragraph">
          <strong>6.1 Mutual Representations.</strong> Each party represents and warrants that: (a) it has full power and authority to enter into this Agreement; (b) its execution of this Agreement does not violate any other agreement to which it is a party; and (c) it will comply with all applicable laws in performing its obligations hereunder.
        </p>

        <p class="doc-paragraph">
          <strong>6.2 Provider Warranties.</strong> Provider represents and warrants that: (a) the Services will be performed in a professional manner consistent with industry standards; (b) the Work Product will conform to the specifications set forth in the applicable SOW; and (c) the Work Product will not infringe any third-party intellectual property rights.
        </p>

        <p class="doc-paragraph">
          <strong>6.3 Disclaimer.</strong> EXCEPT AS EXPRESSLY SET FORTH IN THIS AGREEMENT, PROVIDER MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING ANY IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
        </p>

        <div class="doc-section-header">7. Limitation of Liability</div>

        <p class="doc-paragraph" data-field="liabilityLimit">
          <strong>7.1 Limitation.</strong> EXCEPT FOR BREACHES OF CONFIDENTIALITY OBLIGATIONS OR INDEMNIFICATION OBLIGATIONS, IN NO EVENT SHALL EITHER PARTY'S TOTAL LIABILITY TO THE OTHER PARTY FOR ALL CLAIMS ARISING OUT OF OR RELATING TO THIS AGREEMENT EXCEED ${liabilityLimitText}.
        </p>

        <p class="doc-paragraph">
          <strong>7.2 Exclusion of Damages.</strong> IN NO EVENT SHALL EITHER PARTY BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES, INCLUDING LOSS OF PROFITS, REVENUE, DATA, OR BUSINESS OPPORTUNITIES, REGARDLESS OF WHETHER SUCH PARTY WAS ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.
        </p>

        <div class="doc-section-header">8. Indemnification</div>

        <p class="doc-paragraph">
          <strong>8.1 Provider Indemnification.</strong> Provider shall indemnify, defend, and hold harmless Client from and against any claims, damages, losses, and expenses arising out of: (a) Provider's negligence or willful misconduct; (b) Provider's breach of this Agreement; or (c) any claim that the Work Product infringes any third-party intellectual property rights.
        </p>

        <p class="doc-paragraph">
          <strong>8.2 Client Indemnification.</strong> Client shall indemnify, defend, and hold harmless Provider from and against any claims, damages, losses, and expenses arising out of: (a) Client's negligence or willful misconduct; (b) Client's breach of this Agreement; or (c) Client's use of the Work Product in a manner not contemplated by this Agreement.
        </p>

        <div class="doc-section-header">9. General Provisions</div>

        <p class="doc-paragraph">
          <strong>9.1 Independent Contractor.</strong> Provider is an independent contractor and nothing in this Agreement shall be construed to create an employment, partnership, joint venture, or agency relationship between the parties.
        </p>

        <p class="doc-paragraph" data-field="governingLaw">
          <strong>9.2 Governing Law.</strong> This Agreement shall be governed by and construed in accordance with the laws of the State of ${h(governingLaw || providerState || 'Delaware', 'Governing State', 'governingLaw')}, without regard to its conflicts of laws principles.
        </p>

        <p class="doc-paragraph">
          <strong>9.3 Dispute Resolution.</strong> Any dispute arising out of or relating to this Agreement shall be resolved by binding arbitration in accordance with the rules of the American Arbitration Association, and judgment on the award may be entered in any court of competent jurisdiction.
        </p>

        <p class="doc-paragraph">
          <strong>9.4 Entire Agreement.</strong> This Agreement, together with all SOWs, constitutes the entire agreement between the parties with respect to the subject matter hereof and supersedes all prior agreements and understandings, whether written or oral.
        </p>

        <p class="doc-paragraph">
          <strong>9.5 Amendment.</strong> This Agreement may not be amended except by a written instrument signed by both parties.
        </p>

        <p class="doc-paragraph">
          <strong>9.6 Severability.</strong> If any provision of this Agreement is held to be invalid or unenforceable, the remaining provisions shall continue in full force and effect.
        </p>

        <p class="doc-paragraph">
          <strong>9.7 Waiver.</strong> The failure of either party to enforce any provision of this Agreement shall not be deemed a waiver of such provision or the right to enforce it at a later time.
        </p>

        <p class="doc-paragraph">
          <strong>9.8 Notices.</strong> All notices under this Agreement shall be in writing and shall be deemed given when delivered personally, sent by confirmed email, or sent by certified mail, return receipt requested, to the addresses set forth above.
        </p>

        <p class="doc-paragraph">
          <strong>9.9 Assignment.</strong> Neither party may assign this Agreement without the prior written consent of the other party, except that either party may assign this Agreement to a successor in connection with a merger, acquisition, or sale of all or substantially all of its assets.
        </p>

        <p class="doc-paragraph">
          <strong>9.10 Counterparts.</strong> This Agreement may be executed in counterparts, each of which shall be deemed an original and all of which together shall constitute one and the same instrument. Electronic signatures shall be deemed valid and binding.
        </p>

        <p class="doc-paragraph" style="margin-top: 40px;">
          <strong>IN WITNESS WHEREOF</strong>, the parties have executed this Agreement as of the date first written above.
        </p>

        <!-- Signature Blocks -->
        <div class="doc-signature-row">
          <div class="doc-signature-party">
            <div class="doc-signature-party-title">PROVIDER</div>
            <div style="font-weight: bold; margin-bottom: 15px;">${providerName || '[Provider Name]'}</div>
            <div class="doc-signature-line">
              <span class="signature-label">Signature:</span>
              <span class="signature-value"></span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Name:</span>
              <span class="signature-value">${providerSignatory || '______________________'}</span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Title:</span>
              <span class="signature-value">${providerSignatoryTitle || '______________________'}</span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Date:</span>
              <span class="signature-value">______________________</span>
            </div>
          </div>

          <div class="doc-signature-party">
            <div class="doc-signature-party-title">CLIENT</div>
            <div style="font-weight: bold; margin-bottom: 15px;">${clientName || '[Client Name]'}</div>
            <div class="doc-signature-line">
              <span class="signature-label">Signature:</span>
              <span class="signature-value"></span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Name:</span>
              <span class="signature-value">${clientSignatory || '______________________'}</span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Title:</span>
              <span class="signature-value">${clientSignatoryTitle || '______________________'}</span>
            </div>
            <div class="doc-signature-line">
              <span class="signature-label">Date:</span>
              <span class="signature-value">______________________</span>
            </div>
          </div>
        </div>
      `;

      document.getElementById('documentPreview').innerHTML = html;

      // Setup inline editing
      setupInlineEditing();

      // CRITICAL: Scroll to and highlight the edited field
      if (lastEditedField) {
        setTimeout(() => {
          const highlight = document.querySelector(`[data-field="${lastEditedField}"]`);
          if (highlight) {
            // Scroll into view
            highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Add highlight animation
            highlight.classList.add('field-highlight-animation');
            setTimeout(() => {
              highlight.classList.remove('field-highlight-animation');
            }, 1500);
          }
          lastEditedField = null;
        }, 50);
      }
    }

    // ============================================
    // INLINE EDITING
    // ============================================
    function setupInlineEditing() {
      document.querySelectorAll('.doc-highlight[contenteditable="true"]').forEach(el => {
        el.addEventListener('blur', function() {
          handleInlineEdit(this);
        });

        el.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            this.blur();
          }
        });

        el.addEventListener('focus', function() {
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(this);
          selection.removeAllRanges();
          selection.addRange(range);
        });
      });
    }

    function handleInlineEdit(element) {
      const fieldId = element.dataset.field;
      const newValue = element.textContent.trim();
      const inputId = fieldInputMap[fieldId];

      if (inputId) {
        const input = document.getElementById(inputId);
        if (input && !newValue.startsWith('[') && !newValue.endsWith(']')) {
          input.value = newValue;
        }
      }
    }

    // ============================================
    // FULL EDIT MODE
    // ============================================
    function toggleFullEditMode() {
      const docBody = document.getElementById('documentPreview');
      const toggleBtn = document.getElementById('editModeBtn');

      if (!isFullEditMode) {
        isFullEditMode = true;
        savedDocumentHTML = docBody.innerHTML;
        docBody.contentEditable = 'true';
        docBody.classList.add('full-edit-mode');
        toggleBtn.innerHTML = 'üíæ Save Edits';
        toggleBtn.classList.add('active');
        showToast('Edit mode enabled. Make any changes you need.');
      } else {
        isFullEditMode = false;
        hasCustomEdits = true;
        docBody.contentEditable = 'false';
        docBody.classList.remove('full-edit-mode');
        toggleBtn.innerHTML = '‚úèÔ∏è Edit Mode';
        toggleBtn.classList.remove('active');
        showToast('Edits saved! Your custom changes have been preserved.');
      }
    }

    // ============================================
    // DOWNLOAD WORD
    // ============================================
    function downloadWord() {
      const content = document.getElementById('documentPreview').innerHTML;
      const providerName = document.getElementById('providerName').value || 'MSA';
      const clientName = document.getElementById('clientName').value || 'Agreement';

      const html = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
        <head><meta charset='utf-8'><title>Master Services Agreement</title></head>
        <body style="font-family: Georgia, serif; font-size: 12pt; line-height: 1.6;">
        ${content}
        </body></html>
      `;

      const blob = new Blob([html], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `MSA - ${providerName} - ${clientName}.doc`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Document downloaded!', 'success');
    }

    // ============================================
    // TOAST NOTIFICATION
    // ============================================
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }

    // ============================================
    // INITIALIZE
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('effectiveDate').value = today;

      // Initial render
      updatePreview();
    });
  </script>
</body>
</html>
