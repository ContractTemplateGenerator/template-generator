// Function to generate MS Word document
window.generateWordDoc = function(ndaText, formData) {
  try {
    console.log("Starting Word document generation...");
    
    // Check if docx library is available
    if (typeof docx === 'undefined') {
      console.error("docx library is not available");
      alert("Word document generation library is not available. Please refresh the page and try again.");
      return;
    }
    
    // Check if FileSaver is available
    if (typeof saveAs === 'undefined') {
      console.error("FileSaver library is not available");
      alert("File saving library is not available. Please refresh the page and try again.");
      return;
    }
    
    console.log("Libraries loaded successfully");
    
    // Split main agreement text and side letter
    let mainText = ndaText;
    let sideLetterText = '';
    
    if (formData.usePseudonyms) {
      const parts = ndaText.split(/\f/);
      mainText = parts[0];
      sideLetterText = parts.length > 1 ? parts[1] : '';
    }
    
    console.log("Text processed successfully");
    
    // Create document with proper styling
    const doc = new docx.Document({
      creator: "Strategic NDA Generator",
      title: "Non-Disclosure Agreement",
      description: "Generated by Strategic NDA Generator",
      styles: {
        paragraphStyles: [
          {
            id: "Normal",
            name: "Normal",
            run: {
              size: 24, // 12pt
              font: "Calibri",
            },
            paragraph: {
              spacing: {
                line: 360, // 1.5 line spacing
              },
            },
          },
          {
            id: "Heading1",
            name: "Heading 1",
            basedOn: "Normal",
            next: "Normal",
            run: {
              size: 32, // 16pt
              bold: true,
              font: "Calibri",
            },
            paragraph: {
              spacing: {
                before: 240, // 12pt before
                after: 120, // 6pt after
              },
              alignment: docx.AlignmentType.CENTER,
            },
          },
        ],
      },
    });
    
    console.log("Document created successfully");
    
    // Create paragraphs for main document
    const mainParagraphs = [];
    
    // Title
    mainParagraphs.push(
      new docx.Paragraph({
        text: "MUTUAL NON-DISCLOSURE AGREEMENT",
        heading: docx.HeadingLevel.HEADING_1,
        alignment: docx.AlignmentType.CENTER,
        spacing: {
          before: 200,
          after: 200
        }
      })
    );
    
    // Process main text
    mainText.split('\n\n').forEach(para => {
      if (para.trim()) {
        mainParagraphs.push(
          new docx.Paragraph({
            text: para,
            spacing: { after: 240 }
          })
        );
      }
    });
    
    console.log("Main document paragraphs created");
    
    // Add main document section
    doc.addSection({
      properties: {},
      children: mainParagraphs
    });
    
    // Add side letter if applicable
    if (formData.usePseudonyms && sideLetterText) {
      const sideLetterParagraphs = [];
      
      // Add page break
      sideLetterParagraphs.push(
        new docx.Paragraph({
          children: [
            new docx.PageBreak()
          ]
        })
      );
      
      // Side letter title
      sideLetterParagraphs.push(
        new docx.Paragraph({
          text: "EXHIBIT A - IDENTITY CONFIRMATION LETTER",
          heading: docx.HeadingLevel.HEADING_1,
          alignment: docx.AlignmentType.LEFT,
          spacing: {
            before: 240,
            after: 120
          }
        })
      );
      
      // Process side letter text
      sideLetterText.split('\n\n').forEach(para => {
        if (para.trim() && para !== "EXHIBIT A - IDENTITY CONFIRMATION LETTER") {
          sideLetterParagraphs.push(
            new docx.Paragraph({
              text: para,
              spacing: { after: 240 }
            })
          );
        }
      });
      
      console.log("Side letter paragraphs created");
      
      // Add side letter section
      doc.addSection({
        properties: {},
        children: sideLetterParagraphs
      });
    }
    
    console.log("Packing document...");
    
    // Generate and save document
    docx.Packer.toBlob(doc)
      .then(blob => {
        console.log("Document packed successfully, saving...");
        saveAs(blob, "NDA-Agreement.docx");
        console.log("Document saved successfully");
      })
      .catch(error => {
        console.error("Error packing document:", error);
        alert("Error creating Word document. Please try again or use the copy option.");
      });
      
  } catch (error) {
    console.error("Error in generateWordDoc:", error);
    alert("Error generating Word document. Please try again or use the copy option.");
  }
};
