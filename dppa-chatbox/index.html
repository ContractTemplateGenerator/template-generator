<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPPA Legal Assistant | Driver's Privacy Protection Act Expert</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            min-height: calc(100vh - 40px);
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .attorney-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.95rem;
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 200px);
        }

        .left-panel {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
        }

        .right-panel {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .key-point-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .key-point-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .key-point-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .key-point-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .key-point-icon {
            font-size: 1.5rem;
            color: #3498db;
        }

        .key-point-content {
            color: #555;
            line-height: 1.6;
            display: none;
        }

        .key-point-content.active {
            display: block;
        }

        .faq-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
            cursor: pointer;
        }

        .faq-question {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .faq-answer {
            color: #555;
            margin-top: 15px;
            line-height: 1.6;
            display: none;
        }

        .faq-answer.active {
            display: block;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 15px;
            border: 1px solid #e9ecef;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .welcome-message {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 1px solid #e9ecef;
        }

        .welcome-message h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .quick-questions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .quick-question-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            text-align: left;
        }

        .quick-question-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 85%;
        }

        .message.user {
            background: #e3f2fd;
            color: #1565c0;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .calendly-container {
            margin-top: 30px;
            text-align: center;
        }

        .consult-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .consult-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .left-panel, .right-panel {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> DPPA Legal Assistant</h1>
            <p>Expert Guidance on Driver's Privacy Protection Act (2025)</p>
            <div class="attorney-info">
                <strong>Attorney Sergei Tokmakov</strong> | CA Bar #279869 | Licensed since 2011<br>
                Specializing in Privacy Law, Technology Compliance & Business Regulatory Matters
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="section-title">
                    <i class="fas fa-key"></i> Key DPPA Points (2025)
                </div>
                <div class="key-point-card" onclick="toggleCard(this)">
                    <div class="key-point-header">
                        <div class="key-point-title">⚖️ DPPA Penalties & Damages</div>
                        <i class="fas fa-chevron-down key-point-icon"></i>
                    </div>
                    <div class="key-point-content">
                        <strong>Criminal Penalties:</strong> Federal fines for knowing violations<br>
                        <strong>Civil Damages:</strong> Minimum $2,500 per violation + attorney fees<br>
                        <strong>Punitive Damages:</strong> Available for willful/reckless conduct<br>
                        <strong>Class Actions:</strong> Multiply damages across affected individuals<br>
                        Major settlements have reached $50+ million for data broker violations.
                    </div>
                </div>

                <div class="key-point-card" onclick="toggleCard(this)">
                    <div class="key-point-header">
                        <div class="key-point-title">📋 14 Permissible Uses Explained</div>
                        <i class="fas fa-chevron-down key-point-icon"></i>
                    </div>
                    <div class="key-point-content">
                        <strong>Most Common:</strong> Law enforcement, insurance, legal proceedings, recalls<br>
                        <strong>Business Uses:</strong> Fraud prevention, debt collection, employment screening<br>
                        <strong>Restricted Uses:</strong> Marketing requires express opt-in consent<br>
                        <strong>Certification Required:</strong> All requesters must justify their purpose<br>
                        Each use has specific limitations and record-keeping requirements.
                    </div>
                </div>

                <div class="key-point-card" onclick="toggleCard(this)">
                    <div class="key-point-header">
                        <div class="key-point-title">🚨 2024-2025 Enforcement Trends</div>
                        <i class="fas fa-chevron-down key-point-icon"></i>
                    </div>
                    <div class="key-point-content">
                        <strong>Extended Warranty Mailers:</strong> Major violation area under scrutiny<br>
                        <strong>Skip Tracing:</strong> Debt collectors facing increased lawsuits<br>
                        <strong>Parking Companies:</strong> Questions about legitimate DMV access<br>
                        <strong>Data Monetization:</strong> States reconsidering revenue from data sales<br>
                        Enhanced enforcement by both federal prosecutors and private attorneys.
                    </div>
                </div>

                <div class="key-point-card" onclick="toggleCard(this)">
                    <div class="key-point-header">
                        <div class="key-point-title">📱 Technology & Privacy Issues</div>
                        <i class="fas fa-chevron-down key-point-icon"></i>
                    </div>
                    <div class="key-point-content">
                        <strong>ALPR Systems:</strong> License plate readers and DMV data matching<br>
                        <strong>Digital Privacy:</strong> Intersection with modern privacy laws<br>
                        <strong>AI & Automation:</strong> Automated decision-making using DMV data<br>
                        <strong>Mobile Apps:</strong> License scanning vs. DMV database access<br>
                        Technology creates new compliance challenges and enforcement questions.
                    </div>
                </div>

                <div class="key-point-card" onclick="toggleCard(this)">
                    <div class="key-point-header">
                        <div class="key-point-title">🗺️ State Law Variations</div>
                        <i class="fas fa-chevron-down key-point-icon"></i>
                    </div>
                    <div class="key-point-content">
                        <strong>California:</strong> Strictest photo/medical protection, immigration privacy<br>
                        <strong>New York:</strong> Court orders required for highly restricted data<br>
                        <strong>Florida:</strong> Automatic protection, includes email addresses<br>
                        <strong>Indiana/Wisconsin:</strong> Transparency requirements for data sales<br>
                        States can exceed DPPA protections but cannot weaken them.
                    </div>
                </div>

                <div class="key-point-card" onclick="toggleCard(this)">
                    <div class="key-point-header">
                        <div class="key-point-title">🔐 Protected Personal Information</div>
                        <i class="fas fa-chevron-down key-point-icon"></i>
                    </div>
                    <div class="key-point-content">
                        <strong>Standard Protection:</strong> Name, address, phone, license number<br>
                        <strong>Highly Restricted:</strong> Photos, SSN, medical/disability info<br>
                        <strong>Not Protected:</strong> Driving violations, accident history, license status<br>
                        <strong>State Additions:</strong> Some states protect email, emergency contacts<br>
                        Understanding what's covered is crucial for compliance.
                    </div>
                </div>

                <div class="section-title" style="margin-top: 40px;">
                    <i class="fas fa-question-circle"></i> Expert FAQ
                </div>
                <div class="faq-item" onclick="toggleFAQ(this)">
                    <div class="faq-question">
                        💰 What damages can I recover in a DPPA lawsuit?
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        DPPA provides robust monetary remedies: minimum $2,500 per violation (liquidated damages), actual damages if higher, punitive damages for willful violations, and attorney fees for prevailing plaintiffs. In class actions, these amounts multiply across all affected individuals. Recent settlements have reached tens of millions, making DPPA violations extremely costly for defendants.
                    </div>
                </div>

                <div class="faq-item" onclick="toggleFAQ(this)">
                    <div class="faq-question">
                        💼 Can attorneys use DMV data for client solicitation?
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        No. The Supreme Court in Maracich v. Spears (2013) clearly held that using DMV data to solicit clients violates the DPPA. The litigation exception requires connection to an actual proceeding, not fishing for potential clients. Attorneys can access data for existing cases but cannot use DMV records for marketing or business development purposes.
                    </div>
                </div>

                <div class="faq-item" onclick="toggleFAQ(this)">
                    <div class="faq-question">
                        📧 How do businesses ensure DPPA compliance?
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        Businesses must: (1) Identify a valid permissible use before accessing data, (2) Certify their purpose to DMV, (3) Use data only for stated purpose, (4) Maintain 5-year records of any redisclosures, (5) Train employees on access limitations, (6) Implement audit trails and access controls. Extended warranty companies and skip tracers face particular scrutiny in 2024-2025.
                    </div>
                </div>

                <div class="faq-item" onclick="toggleFAQ(this)">
                    <div class="faq-question">
                        🔍 Does DPPA cover license plate reader technology?
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        ALPR technology itself doesn't violate DPPA since it captures public information. However, when ALPR data is matched against DMV databases to identify vehicle owners, DPPA applies. Law enforcement use is permitted, but private entities need valid permissible uses. The key distinction is between observing plates publicly versus accessing DMV records for personal information.
                    </div>
                </div>

                <div class="calendly-container">
                    <a href="https://terms.law/call/" target="_blank" class="consult-btn">
                        <i class="fas fa-calendar-alt"></i> Schedule Legal Consultation
                    </a>
                </div>
            </div>

            <div class="right-panel">
                <div class="chat-container">
                    <div class="chat-header">
                        <h3><i class="fas fa-robot"></i> AI-Powered DPPA Assistant</h3>
                        <p>Get instant expert analysis on Driver's Privacy Protection Act questions</p>
                    </div>

                    <div class="welcome-message">
                        <h3>Ask the DPPA Expert</h3>
                        <p>I'm your specialized legal assistant with deep expertise in the Driver's Privacy Protection Act. I can help with compliance questions, enforcement trends, litigation strategy, and the latest 2025 developments.</p>
                        
                        <div class="quick-questions" id="quickQuestions">
                            <button class="quick-question-btn" onclick="askQuestion(this)">
                                Can extended warranty companies legally mail me using DMV data?
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion(this)">
                                Is skip tracing for debt collection a DPPA violation?
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion(this)">
                                Can parking enforcement companies access my DMV records?
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion(this)">
                                What are typical DPPA lawsuit damages and settlement amounts?
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion(this)">
                                Do license plate readers violate DPPA privacy protections?
                            </button>
                            <button class="quick-question-btn" onclick="askQuestion(this)">
                                Can employers check driving records for background screening?
                            </button>
                        </div>
                    </div>

                    <div class="messages" id="messages"></div>

                    <div class="input-container">
                        <div class="input-row">
                            <input 
                                type="text" 
                                class="message-input" 
                                id="messageInput" 
                                placeholder="Ask your DPPA question..."
                                onkeypress="handleKeyPress(event)"
                            >
                            <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: #666;">
                            Long conversation? <a href="javascript:void(0)" onclick="clearConversation()" style="color: #667eea;">Start fresh</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let messages = [];

        // Fallback responses for when AI is unavailable
        const fallbackResponses = {
            "Can extended warranty companies legally mail me using DMV data?": "<strong>Extended Warranty Mailer DPPA Analysis</strong><br><br>Extended warranty companies cannot legally mail you using DMV data without your express consent. This is a major DPPA violation area in 2024-2025.<br><br><strong>Key Legal Issues:</strong><br>- Marketing use requires explicit opt-in consent under 18 U.S.C. § 2721(b)(12)<br>- Cannot use permissible use exemptions as pretexts for marketing<br>- Many states don't even offer marketing opt-ins<br><br><strong>Enforcement Trend:</strong><br>Extended warranty mailers are facing increased class action lawsuits and regulatory scrutiny. Recent cases have resulted in significant settlements.<br><br><strong>Your Rights:</strong><br>If you received such mailings without consent, you may have a DPPA claim for $2,500+ per violation plus attorney fees.<br><br><strong>Recommendation:</strong> Document the mailings and consult with a DPPA attorney about potential legal action.",

            "Is skip tracing for debt collection a DPPA violation?": "<strong>Skip Tracing & DPPA Compliance Analysis</strong><br><br>Skip tracing can be DPPA-compliant if done properly under the legitimate business need exception (18 U.S.C. § 2721(b)(3)), but many practices violate the law.<br><br><strong>Legal Requirements:</strong><br>- Must have pre-existing transaction with the debtor<br>- Can only verify/correct information or locate for debt collection<br>- Cannot use as general fishing expedition<br>- Must maintain proper documentation<br><br><strong>Common Violations:</strong><br>- Using DMV data for marketing lists<br>- Accessing data without valid debt relationship<br>- Reselling information for non-debt purposes<br><br><strong>2024-2025 Trend:</strong><br>Increased DPPA lawsuits against skip tracing companies. Courts scrutinizing whether the 'legitimate business need' exception applies.<br><br><strong>Compliance Tips:</strong><br>Document the debt relationship, limit data use to collection purposes only, and maintain detailed records of permissible use.",

            "Can parking enforcement companies access my DMV records?": "<strong>Parking Enforcement & DMV Data Access</strong><br><br>Parking enforcement companies' access to DMV data is legally questionable and varies by state arrangement.<br><br><strong>Potential Legal Bases:</strong><br>- State-authorized use exception (18 U.S.C. § 2721(b)(14))<br>- Private toll facility exception (for certain types)<br>- Government contractor status<br><br><strong>Legal Challenges:</strong><br>- Must be related to motor vehicle operation or public safety<br>- State authorization must be explicit<br>- Cannot be used for general revenue generation<br><br><strong>Common Issues:</strong><br>- Private companies claiming government authority<br>- Using data beyond parking enforcement<br>- Lack of proper state authorization<br><br><strong>2025 Developments:</strong><br>Courts increasingly scrutinizing private parking companies' DMV access. Several class actions pending.<br><br><strong>Your Rights:</strong><br>If contacted by parking enforcement using your DMV info, verify their legal authority and consider consulting an attorney about potential DPPA violations.",

            "What are typical DPPA lawsuit damages and settlement amounts?": "<strong>DPPA Damages & Settlement Landscape</strong><br><br>DPPA provides substantial monetary remedies that have resulted in significant settlements and judgments.<br><br><strong>Statutory Damages:</strong><br>- Minimum $2,500 per violation (liquidated damages)<br>- Actual damages if higher than statutory minimum<br>- Punitive damages for willful/reckless violations<br>- Attorney fees for prevailing plaintiffs<br><br><strong>Notable Settlements:</strong><br>- Kehoe v. Fidelity Federal: ~$50 million class action<br>- Various data broker cases: $10-30 million ranges<br>- Individual officer misconduct cases: $25,000-100,000+<br><br><strong>Class Action Multiplier Effect:</strong><br>$2,500 × thousands of affected individuals = massive exposure<br><br><strong>2024-2025 Trends:</strong><br>- Increased willingness to pursue DPPA claims<br>- Higher settlement values due to privacy concerns<br>- More punitive damage awards<br><br><strong>Litigation Strategy:</strong><br>Strong cases often settle pre-trial due to clear statutory damages and fee-shifting provisions. Defendants face significant exposure with limited defenses.",

            "Do license plate readers violate DPPA privacy protections?": "<strong>License Plate Readers & DPPA Analysis</strong><br><br>ALPR (Automated License Plate Reader) technology creates complex DPPA compliance issues depending on implementation.<br><br><strong>ALPR Itself:</strong><br>- Reading plates in public doesn't violate DPPA<br>- No expectation of privacy for visible license plates<br>- Technology captures publicly observable information<br><br><strong>DPPA Trigger:</strong><br>- When ALPR data is matched against DMV databases<br>- Accessing owner information requires permissible use<br>- Law enforcement use is clearly permitted<br><br><strong>Private Entity Issues:</strong><br>- Must justify DMV database access<br>- Limited permissible uses for private companies<br>- Parking enforcement claims often questionable<br><br><strong>Compliance Framework:</strong><br>- Separate ALPR capture from DMV data access<br>- Ensure valid permissible use before database queries<br>- Maintain records of access and justification<br><br><strong>2025 Developments:</strong><br>Increased scrutiny of private ALPR systems accessing DMV data. Several jurisdictions implementing stricter controls.",

            "Can employers check driving records for background screening?": "<strong>Employment Background Checks & DPPA</strong><br><br>Employers can check driving records under specific DPPA exceptions, but compliance requires careful attention to requirements.<br><br><strong>Permissible Uses for Employers:</strong><br>- Commercial driver employment screening (18 U.S.C. § 2721(b)(9))<br>- Legitimate business need verification (18 U.S.C. § 2721(b)(3))<br>- With employee consent (18 U.S.C. § 2721(b)(13))<br><br><strong>Commercial Driver Exception:</strong><br>- Limited to CDL holders and driving positions<br>- Must relate to commercial driving requirements<br>- Includes verification of license status and driving history<br><br><strong>General Employment:</strong><br>- Most non-driving positions require employee consent<br>- Must be job-related (delivery drivers, company vehicles, etc.)<br>- Cannot be used for general background checks<br><br><strong>Best Practices:</strong><br>- Obtain written consent before accessing records<br>- Limit use to driving-related positions<br>- Document job-related necessity<br>- Use authorized screening services<br><br><strong>Compliance Warning:</strong><br>Using DMV data for general background screening without consent or job-relatedness may violate DPPA."
        };

        function toggleCard(card) {
            const content = card.querySelector('.key-point-content');
            const icon = card.querySelector('.key-point-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('active');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function toggleFAQ(item) {
            const answer = item.querySelector('.faq-answer');
            const icon = item.querySelector('.fas');
            
            if (answer.classList.contains('active')) {
                answer.classList.remove('active');
                icon.style.transform = 'rotate(0deg)';
            } else {
                answer.classList.add('active');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function askQuestion(button) {
            const question = button.textContent.trim();
            
            // Hide all quick question buttons
            document.getElementById('quickQuestions').style.display = 'none';
            
            // Add user message
            addMessage(question, 'user');
            
            // Send to AI or use fallback
            sendToAI(question);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            sendToAI(message);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(content, role) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            if (role === 'assistant') {
                messageDiv.innerHTML = content;
            } else {
                messageDiv.textContent = content;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            messages.push({ role, content });
        }

        function showLoading() {
            const messagesContainer = document.getElementById('messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loading';
            loadingDiv.innerHTML = '<div class="spinner"></div> Analyzing your DPPA question...';
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.remove();
            }
        }

        async function sendToAI(message) {
            showLoading();
            
            try {
                // Limit client-side message history to prevent excessive growth
                // Keep only the last 10 exchanges (20 messages) to maintain context
                const recentMessages = messages.slice(-20);
                
                const response = await fetch('https://template-generator-aob3.vercel.app/api/dppa-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: [...recentMessages, { role: 'user', content: message }],
                    }),
                });

                hideLoading();

                if (!response.ok) {
                    if (response.status === 413) {
                        throw new Error('Request too large - this conversation has gotten quite long. Consider starting a new conversation for optimal performance.');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.response) {
                    addMessage(data.response, 'assistant');
                } else {
                    throw new Error('No response received');
                }
            } catch (error) {
                hideLoading();
                console.error('AI request failed:', error);
                
                // Enhanced error messaging
                if (error.message.includes('Request too large')) {
                    const errorResponse = `<strong>Conversation Length Notice</strong><br><br>This conversation has become quite extensive. For optimal performance, you may want to start a new conversation.<br><br>Your question: "${message}"<br><br>For immediate assistance with this specific question, please consider starting a fresh conversation or <a href="https://terms.law/call/" target="_blank">schedule a consultation</a> for detailed analysis.`;
                    addMessage(errorResponse, 'assistant');
                    return;
                }
                
                // Use fallback response if available
                if (fallbackResponses[message]) {
                    addMessage(fallbackResponses[message], 'assistant');
                } else {
                    // Generic fallback
                    const genericResponse = `<strong>Technical Difficulties - Fallback Mode</strong><br><br>I'm experiencing technical difficulties accessing the AI system. However, I can provide some general guidance on your DPPA question.<br><br>The Driver's Privacy Protection Act (18 U.S.C. §§ 2721-2725) protects personal information in motor vehicle records. For specific legal advice on your situation, I recommend:<br><br>1. Consulting the DPPA statute directly<br>2. Reviewing your state's DMV privacy policies<br>3. Speaking with a qualified attorney<br><br><strong>For immediate legal consultation:</strong><br><a href="https://terms.law/call/" target="_blank">Schedule a consultation with Attorney Sergei Tokmakov</a><br><br>This system will be back online shortly. Thank you for your patience.`;
                    addMessage(genericResponse, 'assistant');
                }
            }
        }

        function clearConversation() {
            messages = [];
            document.getElementById('messages').innerHTML = '';
            document.getElementById('quickQuestions').style.display = 'grid';
            console.log('Conversation cleared');
        }

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DPPA Legal Assistant initialized');
        });
    </script>

    <!-- Calendly popup widget -->
    <link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet">
    <script src="https://assets.calendly.com/assets/external/widget.js" type="text/javascript" async></script>
    <script type="text/javascript">
        window.onload = function() { 
            Calendly.initBadgeWidget({ 
                url: 'https://calendly.com/sergei-tokmakov/30-minute-zoom-meeting?hide_gdpr_banner=1', 
                text: 'Schedule consultation', 
                color: '#e74c3c', 
                textColor: '#ffffff' 
            }); 
        }
    </script>

</body>
</html>